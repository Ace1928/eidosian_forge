#!/usr/bin/env bash
# â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”“
# â”ƒ        E I D O S I A N   F I L E   T R E E   G E N E R A T O R         â”ƒ
# â”—â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”›
#
# â–‘ Hyper-optimized script for generating a structured, colorized,
#   symbol-rich file tree with quantum-recursive efficiency! â–‘
#
# ðŸ“Œ Features:
#  â€¢ Adaptive rendering & terminal capability detection
#  â€¢ Metadata caching & parallel processing stubs
#  â€¢ Comprehensive, parameterized configuration & error resilience
#  â€¢ Built to Eidosian principles for ultimate clarity & synergy
#
# AUTHOR: The EIDOSIAN Collective
# DATE:   $(date)
# LICENSE: MIT | Open Source Eidosian Excellence
#
###############################################################################
#                           EIDOSIAN PRINCIPLES                               #
###############################################################################
# 1) Contextual Integrity: Minimal & purposeful code
# 2) Humor as Cognitive Leverage: Witty logs & error messages
# 3) Exhaustive But Concise: Powerful features, compact design
# 4) Flow Like a River, Strike Like Lightning: Smooth, unstoppable execution
# 5) Hyper-Personal Yet Universally Applicable: Scales from single script to entire organizations
# 6) Recursive Refinement: Repeated polishing for maximum clarity & performance
# 7) Precision as Style: Elegance emerges from correctness
# 8) Velocity as Intelligence: Minimal overhead, swift decisions
# 9) Structure as Control: Modules & data structures are meticulously engineered
# 10) Self-Awareness as Foundation: Reflects & logs its own execution
###############################################################################

###############################################################################
# 0) STRICT ERROR HANDLING & SETUP
###############################################################################
set -o errexit
set -o pipefail
set -o nounset

###############################################################################
# 1) DECLARE GLOBALS & DEFAULTS
###############################################################################

env_or_default() {
  local var_name="$1"
  local default_value="$2"
  local val="${!var_name:-}"
  [[ -z "$val" ]] && echo "$default_value" || echo "$val"
}

declare -A CONFIG=()

CONFIG[output_file]="$(env_or_default EIDOSIAN_output_file file_tree.txt)"
CONFIG[root_dir]="$(env_or_default EIDOSIAN_root_dir ".")"
CONFIG[max_depth]="$(env_or_default EIDOSIAN_max_depth "-1")"  # -1 => unlimited
CONFIG[show_hidden]="$(env_or_default EIDOSIAN_show_hidden "false")"
CONFIG[show_permissions]="$(env_or_default EIDOSIAN_show_permissions "true")"
CONFIG[show_size]="$(env_or_default EIDOSIAN_show_size "true")"
CONFIG[use_color]="$(env_or_default EIDOSIAN_use_color auto)"
CONFIG[use_unicode]="$(env_or_default EIDOSIAN_use_unicode auto)"
CONFIG[follow_symlinks]="$(env_or_default EIDOSIAN_follow_symlinks false)"
CONFIG[skip_patterns]="$(env_or_default EIDOSIAN_skip_patterns 'node_modules,.git,.svn,.hg,__pycache__,*.pyc,venv,*.o,*.so,*.a')"
CONFIG[size_format]="$(env_or_default EIDOSIAN_size_format human)"
CONFIG[sort_by]="$(env_or_default EIDOSIAN_sort_by name)"
CONFIG[show_owner]="$(env_or_default EIDOSIAN_show_owner false)"
CONFIG[show_group]="$(env_or_default EIDOSIAN_show_group false)"
CONFIG[show_date]="$(env_or_default EIDOSIAN_show_date false)"
CONFIG[show_mime]="$(env_or_default EIDOSIAN_show_mime false)"
CONFIG[use_parallel]="$(env_or_default EIDOSIAN_use_parallel auto)"
CONFIG[compression_level]="$(env_or_default EIDOSIAN_compression_level auto)"
CONFIG[theme]="$(env_or_default EIDOSIAN_theme default)"
CONFIG[progress]="$(env_or_default EIDOSIAN_progress auto)"
CONFIG[json_summary]="$(env_or_default EIDOSIAN_json_summary false)"
CONFIG[config_file]="$(env_or_default EIDOSIAN_config_file "")"

declare -i AVAILABLE_CORES
AVAILABLE_CORES=$(grep -c '^processor' /proc/cpuinfo 2>/dev/null || echo 1)

declare -i AVAILABLE_MEMORY
AVAILABLE_MEMORY=$(grep MemAvailable /proc/meminfo 2>/dev/null | awk '{print int($2/1024)}' || echo 1024)

declare -i IO_CAPACITY
IO_CAPACITY=100000000
if dd if=/dev/zero of=/tmp/treegen_io_test bs=1M count=2 oflag=direct 2>/dev/null; then
  IO_CAPACITY=$(
    dd if=/dev/zero of=/tmp/treegen_io_test bs=1M count=2 2>&1 \
      | grep -oE '[0-9]+' | head -n 1 || echo 100000000
  )
fi
rm -f /tmp/treegen_io_test >/dev/null 2>&1 || true

declare -i PARALLEL_JOBS=$((AVAILABLE_CORES > 1 ? AVAILABLE_CORES - 1 : 1))
declare -i CACHE_SIZE=$((AVAILABLE_MEMORY > 1000 ? 10000 : 1000))
declare -i BATCH_SIZE=$((IO_CAPACITY > 30000000 ? 1000 : 200))

START_TIME="$(date +%s.%N)"
declare -i FILE_COUNT=0
declare -i DIR_COUNT=0
declare -i LINK_COUNT=0
declare -i ERROR_COUNT=0
declare -i SKIPPED_COUNT=0

declare -A EXTENSION_COUNTS=()
declare -A CACHED_PERMISSIONS
declare -A CACHED_SIZES
declare -A CACHED_TYPES
declare -A CACHED_OWNERS
declare -A CACHED_GROUPS
declare -A CACHED_DATES
declare -A CACHED_MIMES

declare -A THEME_STYLES

declare -i TOTAL_ITEMS_ESTIMATED=0
declare -i ITEMS_PROCESSED=0
declare PROGRESS_BAR_WIDTH=40
declare LAST_PROGRESS_UPDATE=0

declare -a METADATA_QUEUE=()
declare -a METADATA_RESULTS=()
declare -a BRANCH_HISTORY=()
declare -A OVERRIDES=()

###############################################################################
# 2) USAGE & HELP
###############################################################################
usage() {
  cat <<EOF
Usage: $0 [ROOT_DIR [MAX_DEPTH [SHOW_HIDDEN [SHOW_PERMISSIONS [SHOW_SIZE]]]]]
       or set environment variables EIDOSIAN_<config>=<value>
       or use flags to override defaults

Examples:
  $0                          # Default: root_dir="."
  $0 /path/to/dir 2 true      # Walk /path/to/dir up to depth 2, show hidden
  EIDOSIAN_theme=vivid $0     # Use "vivid" theme via env variable
  $0 --no-color --no-unicode  # Force plain output
  $0 --no-progress            # Disable progress display
  $0 --json-summary           # Print summary JSON to stdout

Most Important Environment Variables (EIDOSIAN_<var>):
  output_file, root_dir, max_depth, show_hidden, show_permissions, show_size
  use_color, use_unicode, follow_symlinks, skip_patterns, size_format, sort_by
  show_owner, show_group, show_date, show_mime, use_parallel, compression_level
  theme, progress, json_summary, config_file

All default to "auto" or sensible defaults. More in script comments.
EOF
}

[[ "${1:-}" =~ ^(-h|--help)$ ]] && { usage; exit 0; }

parse_args() {
  local positional=()
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --config)
        CONFIG[config_file]="$2"
        OVERRIDES[config_file]=1
        shift 2
        ;;
      --no-color)
        CONFIG[use_color]="false"
        OVERRIDES[use_color]=1
        shift
        ;;
      --no-unicode)
        CONFIG[use_unicode]="false"
        OVERRIDES[use_unicode]=1
        shift
        ;;
      --no-progress)
        CONFIG[progress]="false"
        OVERRIDES[progress]=1
        shift
        ;;
      --json-summary)
        CONFIG[json_summary]="true"
        OVERRIDES[json_summary]=1
        shift
        ;;
      --output)
        CONFIG[output_file]="$2"
        OVERRIDES[output_file]=1
        shift 2
        ;;
      -h|--help)
        usage
        exit 0
        ;;
      *)
        positional+=("$1")
        shift
        ;;
    esac
  done

  if [[ -n "${CONFIG[config_file]}" && -f "${CONFIG[config_file]}" ]]; then
    # shellcheck disable=SC1090
    source "${CONFIG[config_file]}"
  fi

  apply_env_overrides

  if [[ ${#positional[@]} -gt 0 ]]; then
    CONFIG[root_dir]="${positional[0]}"
  fi
  if [[ ${#positional[@]} -gt 1 ]]; then
    CONFIG[max_depth]="${positional[1]}"
  fi
  if [[ ${#positional[@]} -gt 2 ]]; then
    CONFIG[show_hidden]="${positional[2]}"
  fi
  if [[ ${#positional[@]} -gt 3 ]]; then
    CONFIG[show_permissions]="${positional[3]}"
  fi
  if [[ ${#positional[@]} -gt 4 ]]; then
    CONFIG[show_size]="${positional[4]}"
  fi
}

apply_env_overrides() {
  local -A env_map=(
    [output_file]=EIDOSIAN_output_file
    [root_dir]=EIDOSIAN_root_dir
    [max_depth]=EIDOSIAN_max_depth
    [show_hidden]=EIDOSIAN_show_hidden
    [show_permissions]=EIDOSIAN_show_permissions
    [show_size]=EIDOSIAN_show_size
    [use_color]=EIDOSIAN_use_color
    [use_unicode]=EIDOSIAN_use_unicode
    [follow_symlinks]=EIDOSIAN_follow_symlinks
    [skip_patterns]=EIDOSIAN_skip_patterns
    [size_format]=EIDOSIAN_size_format
    [sort_by]=EIDOSIAN_sort_by
    [show_owner]=EIDOSIAN_show_owner
    [show_group]=EIDOSIAN_show_group
    [show_date]=EIDOSIAN_show_date
    [show_mime]=EIDOSIAN_show_mime
    [use_parallel]=EIDOSIAN_use_parallel
    [compression_level]=EIDOSIAN_compression_level
    [theme]=EIDOSIAN_theme
    [progress]=EIDOSIAN_progress
    [json_summary]=EIDOSIAN_json_summary
  )

  local key env_var env_val
  for key in "${!env_map[@]}"; do
    env_var="${env_map[$key]}"
    env_val="${!env_var:-}"
    if [[ -n "$env_val" && -z "${OVERRIDES[$key]:-}" ]]; then
      CONFIG[$key]="$env_val"
    fi
  done
}

###############################################################################
# 3) DETECT CAPABILITIES (COLOR, UNICODE, ETC.)
###############################################################################
detect_capabilities() {
  local has_color=false
  local has_unicode=false
  local has_advanced_features=false

  if [[ -t 1 ]]; then
    # Basic color detection
    if [[ -n "${TERM:-}" && "$TERM" != "dumb" ]]; then
      if tput colors &>/dev/null && [[ "$(tput colors)" -ge 8 ]]; then
        has_color=true
      fi
    fi

    # Advanced terminal?
    if [[ "$TERM" =~ (xterm-256color|screen-256color|tmux-256color) ]]; then
      has_advanced_features=true
    fi
  fi

  # Unicode check
  if [[ "$(locale charmap 2>/dev/null)" =~ UTF-8 ]]; then
    has_unicode=true
  elif [[ -n "${LANG:-}" && "$LANG" =~ UTF-8 ]]; then
    has_unicode=true
  elif [[ -n "${LC_ALL:-}" && "$LC_ALL" =~ UTF-8 ]]; then
    has_unicode=true
  elif echo -e "\u2713" | grep -q "âœ“" 2>/dev/null; then
    has_unicode=true
  fi

  # Resolve 'auto' -> actual
  if [[ "${CONFIG[use_color]}" == "auto" ]]; then
    CONFIG[use_color]=$has_color
  fi
  if [[ "${CONFIG[use_unicode]}" == "auto" ]]; then
    CONFIG[use_unicode]=$has_unicode
  fi

  if [[ "${CONFIG[progress]}" == "auto" ]]; then
    if [[ -t 1 && "$has_advanced_features" == "true" && "${CONFIG[use_color]}" != "false" ]]; then
      CONFIG[progress]="true"
    else
      CONFIG[progress]="false"
    fi
  fi

  if [[ "${CONFIG[use_parallel]}" == "auto" ]]; then
    if (( AVAILABLE_CORES > 1 )); then
      CONFIG[use_parallel]="true"
    else
      CONFIG[use_parallel]="false"
    fi
  fi
}

###############################################################################
# 4) THEME CONFIGURATION
###############################################################################
configure_theme() {
  local theme="${CONFIG[theme]}"

  if [[ "${CONFIG[use_color]}" == "true" ]]; then
    THEME_STYLES[reset]='\033[0m'
    THEME_STYLES[bold]='\033[1m'
    THEME_STYLES[dim]='\033[2m'
    THEME_STYLES[italic]='\033[3m'
    THEME_STYLES[underline]='\033[4m'
    case "$theme" in
      "monochrome")
        THEME_STYLES[directory]='\033[1m'
        THEME_STYLES[file]='\033[0m'
        THEME_STYLES[symlink]='\033[3m'
        THEME_STYLES[executable]='\033[1m'
        THEME_STYLES[error]='\033[7m'
        THEME_STYLES[special]='\033[4m'
        THEME_STYLES[metadata]='\033[2m'
        ;;
      "vivid")
        THEME_STYLES[directory]='\033[1;38;5;39m'
        THEME_STYLES[file]='\033[38;5;251m'
        THEME_STYLES[symlink]='\033[38;5;44m'
        THEME_STYLES[executable]='\033[38;5;118m'
        THEME_STYLES[error]='\033[38;5;197m'
        THEME_STYLES[special]='\033[38;5;213m'
        THEME_STYLES[metadata]='\033[38;5;244m'
        ;;
      "retro")
        THEME_STYLES[directory]='\033[1;33m'
        THEME_STYLES[file]='\033[37m'
        THEME_STYLES[symlink]='\033[1;36m'
        THEME_STYLES[executable]='\033[1;32m'
        THEME_STYLES[error]='\033[31m'
        THEME_STYLES[special]='\033[35m'
        THEME_STYLES[metadata]='\033[2;37m'
        ;;
      *)
        THEME_STYLES[directory]='\033[1;34m'
        THEME_STYLES[file]='\033[97m'
        THEME_STYLES[symlink]='\033[36m'
        THEME_STYLES[executable]='\033[32m'
        THEME_STYLES[error]='\033[31m'
        THEME_STYLES[special]='\033[35m'
        THEME_STYLES[metadata]='\033[90m'
        ;;
    esac
  else
    THEME_STYLES[reset]=""
    THEME_STYLES[bold]=""
    THEME_STYLES[dim]=""
    THEME_STYLES[italic]=""
    THEME_STYLES[underline]=""
    THEME_STYLES[directory]=""
    THEME_STYLES[file]=""
    THEME_STYLES[symlink]=""
    THEME_STYLES[executable]=""
    THEME_STYLES[error]=""
    THEME_STYLES[special]=""
    THEME_STYLES[metadata]=""
  fi

  # Icons
  if [[ "${CONFIG[use_unicode]}" == "true" ]]; then
    THEME_STYLES[dir_icon]="ðŸ“"
    THEME_STYLES[file_icon]="ðŸ“„"
    THEME_STYLES[link_icon]="ðŸ”—"
    THEME_STYLES[exec_icon]="ðŸš€"
    THEME_STYLES[broken_icon]="âŒ"
    THEME_STYLES[image_icon]="ðŸ–¼ï¸"
    THEME_STYLES[video_icon]="ðŸŽ¬"
    THEME_STYLES[audio_icon]="ðŸŽµ"
    THEME_STYLES[archive_icon]="ðŸ“¦"
    THEME_STYLES[code_icon]="ðŸ’»"
    THEME_STYLES[text_icon]="ðŸ“"
    THEME_STYLES[doc_icon]="ðŸ“˜"
    THEME_STYLES[pdf_icon]="ðŸ“‘"
    THEME_STYLES[config_icon]="âš™ï¸"
    THEME_STYLES[hidden_icon]="ðŸ”’"
    THEME_STYLES[other_icon]="â“"

    THEME_STYLES[pipe_icon]="â”‚"
    THEME_STYLES[branch_icon]="â”œâ”€â”€"
    THEME_STYLES[last_branch_icon]="â””â”€â”€"
    THEME_STYLES[space_icon]="    "

    THEME_STYLES[progress_complete]="â”"
    THEME_STYLES[progress_incomplete]="â”„"
    THEME_STYLES[progress_start]="â”«"
    THEME_STYLES[progress_end]="â”£"
    THEME_STYLES[spinner]="â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â "
    THEME_STYLES[header_icon]="ðŸ”®"
    THEME_STYLES[summary_icon]="ðŸ“Š "
    THEME_STYLES[summary_label]="SUMMARY"
    THEME_STYLES[warn_icon]="âš ï¸"
    THEME_STYLES[ok_icon]="âœ…"
    THEME_STYLES[star_icon]="âœ¨"
    THEME_STYLES[bullet]="â€¢"
  else
    THEME_STYLES[dir_icon]="[D]"
    THEME_STYLES[file_icon]="[F]"
    THEME_STYLES[link_icon]="[L]"
    THEME_STYLES[exec_icon]="[X]"
    THEME_STYLES[broken_icon]="[!]"
    THEME_STYLES[image_icon]="[I]"
    THEME_STYLES[video_icon]="[V]"
    THEME_STYLES[audio_icon]="[A]"
    THEME_STYLES[archive_icon]="[Z]"
    THEME_STYLES[code_icon]="[C]"
    THEME_STYLES[text_icon]="[T]"
    THEME_STYLES[doc_icon]="[D]"
    THEME_STYLES[pdf_icon]="[P]"
    THEME_STYLES[config_icon]="[G]"
    THEME_STYLES[hidden_icon]="[H]"
    THEME_STYLES[other_icon]="[?]"

    THEME_STYLES[pipe_icon]="|"
    THEME_STYLES[branch_icon]="|--"
    THEME_STYLES[last_branch_icon]="\`--"
    THEME_STYLES[space_icon]="    "

    THEME_STYLES[progress_complete]="#"
    THEME_STYLES[progress_incomplete]="-"
    THEME_STYLES[progress_start]="["
    THEME_STYLES[progress_end]="]"
    THEME_STYLES[spinner]="-\|/"
    THEME_STYLES[header_icon]="*"
    THEME_STYLES[summary_icon]=""
    THEME_STYLES[summary_label]="SUMMARY"
    THEME_STYLES[warn_icon]="WARNING"
    THEME_STYLES[ok_icon]="OK"
    THEME_STYLES[star_icon]="*"
    THEME_STYLES[bullet]="-"
  fi
}

###############################################################################
# 5) SIGNAL HANDLERS & CLEANUP
###############################################################################
handle_interrupt() {
  echo
  echo -e "${THEME_STYLES[error]}${THEME_STYLES[warn_icon]} Script interrupted. Partial output saved to ${CONFIG[output_file]}.${THEME_STYLES[reset]}"
  generate_summary "interrupted"
  exit 1
}

cleanup() {
  local status=$?
  rm -f /tmp/treegen_* 2>/dev/null || true
  if [[ $status -ne 0 && $ERROR_COUNT -eq 0 ]]; then
    ERROR_COUNT=$((ERROR_COUNT+1))
  fi
  if [[ "${CONFIG[progress]}" == "true" ]]; then
    tput cnorm || true
    echo
  fi
}

setup_traps() {
  trap 'handle_interrupt' SIGINT SIGTERM
  trap 'cleanup' EXIT
}

###############################################################################
# 6) FILE TYPE & METADATA
###############################################################################
get_file_icon() {
  local path="$1"
  local name
  name="$(basename "$path")"
  local extension="${name##*.}"

  if [[ -n "${CACHED_TYPES[$path]:-}" ]]; then
    echo "${CACHED_TYPES[$path]}"
    return
  fi

  local mime_type=""
  local icon=""

  if [[ -d "$path" ]]; then
    icon="${THEME_STYLES[dir_icon]}"
    mime_type="directory"
  elif [[ -L "$path" ]]; then
    if [[ -e "$path" ]]; then
      icon="${THEME_STYLES[link_icon]}"
      mime_type="symlink"
    else
      icon="${THEME_STYLES[broken_icon]}"
      mime_type="broken_symlink"
    fi
  elif [[ -x "$path" && ! -d "$path" ]]; then
    icon="${THEME_STYLES[exec_icon]}"
    mime_type="executable"
  else
    if [[ "${CONFIG[show_mime]}" == "true" ]]; then
      mime_type="$(file --mime-type -b "$path" 2>/dev/null || echo unknown)"
      CACHED_MIMES["$path"]="$mime_type"
    fi

    case "${extension,,}" in
      jpg|jpeg|png|gif|bmp|tiff|webp|svg) icon="${THEME_STYLES[image_icon]}" ;;
      mp4|mkv|avi|mov|flv|wmv|webm)       icon="${THEME_STYLES[video_icon]}" ;;
      mp3|wav|ogg|flac|aac|m4a)          icon="${THEME_STYLES[audio_icon]}" ;;
      zip|tar|gz|xz|bz2|7z|rar)          icon="${THEME_STYLES[archive_icon]}" ;;
      py|js|ts|rb|php|java|c|cpp|h|hpp|go|rs|cs|sh|pl|swift)
        icon="${THEME_STYLES[code_icon]}"
        ;;
      txt|md|rst|adoc|tex)               icon="${THEME_STYLES[text_icon]}" ;;
      doc|docx|odt|rtf|pages)            icon="${THEME_STYLES[doc_icon]}" ;;
      pdf)                               icon="${THEME_STYLES[pdf_icon]}" ;;
      json|yml|yaml|toml|ini|conf|cfg|xml|env)
        icon="${THEME_STYLES[config_icon]}"
        ;;
      *)
        if [[ "${name:0:1}" == "." ]]; then
          icon="${THEME_STYLES[hidden_icon]}"
        else
          icon="${THEME_STYLES[file_icon]}"
        fi
        ;;
    esac
  fi

  # Track extension usage
  if [[ -n "$extension" && "$extension" != "$name" ]]; then
    EXTENSION_COUNTS[".$extension"]=$((EXTENSION_COUNTS[".$extension"]+1))
  fi

  local result="${mime_type:-file}Â§$icon"
  CACHED_TYPES["$path"]="$result"
  echo "$result"
}

format_size() {
  local size_in_bytes="$1"
  if [[ "${CONFIG[size_format]}" == "bytes" ]]; then
    echo "${size_in_bytes} bytes"
    return
  fi
  if [[ "$size_in_bytes" -lt 1024 ]]; then
    echo "${size_in_bytes} B"
  elif [[ "$size_in_bytes" -lt 1048576 ]]; then
    printf "%.1f KB" "$(bc <<<"scale=1; ${size_in_bytes}/1024")"
  elif [[ "$size_in_bytes" -lt 1073741824 ]]; then
    printf "%.1f MB" "$(bc <<<"scale=1; ${size_in_bytes}/1048576")"
  elif [[ "$size_in_bytes" -lt 1099511627776 ]]; then
    printf "%.2f GB" "$(bc <<<"scale=2; ${size_in_bytes}/1073741824")"
  else
    printf "%.3f TB" "$(bc <<<"scale=3; ${size_in_bytes}/1099511627776")"
  fi
}

format_date() {
  local timestamp="$1"
  local now
  now="$(date +%s)"
  local diff=$(( now - timestamp ))
  if [[ "$diff" -lt 86400 ]]; then
    date -d "@$timestamp" "+%H:%M:%S"
  elif [[ "$diff" -lt 2592000 ]]; then
    date -d "@$timestamp" "+%b %d %H:%M"
  else
    date -d "@$timestamp" "+%Y-%m-%d"
  fi
}

get_metadata() {
  local path="$1"
  local show_permissions="${CONFIG[show_permissions]}"
  local show_size="${CONFIG[show_size]}"
  local show_owner="${CONFIG[show_owner]}"
  local show_group="${CONFIG[show_group]}"
  local show_date="${CONFIG[show_date]}"

  local permissions=""
  local size=""
  local owner=""
  local group=""
  local date=""

  if [[ "$show_permissions" == "true" ]]; then
    if [[ -z "${CACHED_PERMISSIONS[$path]:-}" ]]; then
      permissions="$(stat -c '%A' "$path" 2>/dev/null || echo '?????????')"
      CACHED_PERMISSIONS["$path"]="$permissions"
    else
      permissions="${CACHED_PERMISSIONS[$path]}"
    fi
  fi

  if [[ "$show_size" == "true" ]]; then
    if [[ -z "${CACHED_SIZES[$path]:-}" ]]; then
      local raw_size
      raw_size="$(stat -c '%s' "$path" 2>/dev/null || echo '0')"
      CACHED_SIZES["$path"]="$raw_size"
    else
      raw_size="${CACHED_SIZES[$path]}"
    fi
    [[ "$raw_size" -gt 0 ]] && size="$(format_size "$raw_size")" || size=""
  fi

  if [[ "$show_owner" == "true" ]]; then
    if [[ -z "${CACHED_OWNERS[$path]:-}" ]]; then
      owner="$(stat -c '%U' "$path" 2>/dev/null || echo '?')"
      CACHED_OWNERS["$path"]="$owner"
    else
      owner="${CACHED_OWNERS[$path]}"
    fi
  fi

  if [[ "$show_group" == "true" ]]; then
    if [[ -z "${CACHED_GROUPS[$path]:-}" ]]; then
      group="$(stat -c '%G' "$path" 2>/dev/null || echo '?')"
      CACHED_GROUPS["$path"]="$group"
    else
      group="${CACHED_GROUPS[$path]}"
    fi
  fi

  if [[ "$show_date" == "true" ]]; then
    if [[ -z "${CACHED_DATES[$path]:-}" ]]; then
      local mod_time
      mod_time="$(stat -c '%Y' "$path" 2>/dev/null || echo 0)"
      CACHED_DATES["$path"]="$mod_time"
      date="$(format_date "$mod_time")"
    else
      local mod_time="${CACHED_DATES[$path]}"
      date="$(format_date "$mod_time")"
    fi
  fi

  echo "${permissions}Â§${size}Â§${owner}Â§${group}Â§${date}"
}

###############################################################################
# 7) PRINT TREE ENTRIES
###############################################################################
format_entry() {
  local depth="$1"
  local is_last="$2"
  local name="$3"
  local full_path="$4"

  local type_info
  type_info="$(get_file_icon "$full_path")"
  local file_type="${type_info%%Â§*}"
  local icon="${type_info#*Â§}"

  local metadata
  metadata="$(get_metadata "$full_path")"
  local permissions="${metadata%%Â§*}"
  metadata="${metadata#*Â§}"
  local size="${metadata%%Â§*}"
  metadata="${metadata#*Â§}"
  local owner="${metadata%%Â§*}"
  metadata="${metadata#*Â§}"
  local group="${metadata%%Â§*}"
  metadata="${metadata#*Â§}"
  local date="${metadata}"

  local prefix=""
  for (( i=0; i<depth; i++ )); do
    if [[ $i -lt $((depth-1)) ]]; then
      if [[ "${BRANCH_HISTORY[$i]}" == "true" ]]; then
        prefix+="${THEME_STYLES[pipe_icon]}${THEME_STYLES[space_icon]}"
      else
        prefix+="${THEME_STYLES[space_icon]}${THEME_STYLES[space_icon]}"
      fi
    fi
  done
  if [[ $depth -gt 0 ]]; then
    if [[ "$is_last" == "true" ]]; then
      prefix+="${THEME_STYLES[last_branch_icon]}"
    else
      prefix+="${THEME_STYLES[branch_icon]}"
    fi
  fi

  local color=""
  case "$file_type" in
    directory)
      color="${THEME_STYLES[directory]}"
      name="$name/"
      ;;
    symlink|broken_symlink)
      color="${THEME_STYLES[symlink]}"
      ;;
    executable)
      color="${THEME_STYLES[executable]}"
      ;;
    *)
      color="${THEME_STYLES[file]}"
      ;;
  esac

  local output="${prefix} ${icon} ${color}${name}${THEME_STYLES[reset]}"

  if [[ "$file_type" == "symlink" ]]; then
    local target
    target="$(readlink -f "$full_path" 2>/dev/null || echo "UNKNOWN")"
    if [[ -e "$target" ]]; then
      output+=" ${THEME_STYLES[dim]}-> ${target}${THEME_STYLES[reset]}"
    else
      output+=" ${THEME_STYLES[error]}-> [BROKEN]${THEME_STYLES[reset]}"
    fi
  elif [[ "$file_type" == "broken_symlink" ]]; then
    output+=" ${THEME_STYLES[error]}-> [BROKEN]${THEME_STYLES[reset]}"
  fi

  local meta_text=""
  [[ -n "$permissions" ]] && meta_text+="$permissions"
  [[ -n "$owner" ]] && [[ -n "$meta_text" ]] && meta_text+=", "
  [[ -n "$owner" ]] && meta_text+="$owner"
  [[ -n "$group" ]] && [[ -n "$owner" ]] && meta_text+=":"
  [[ -n "$group" ]] && meta_text+="$group"
  [[ -n "$size" ]] && [[ -n "$meta_text" ]] && meta_text+=", "
  [[ -n "$size" ]] && meta_text+="$size"
  [[ -n "$date" ]] && [[ -n "$meta_text" ]] && meta_text+=", "
  [[ -n "$date" ]] && meta_text+="$date"

  if [[ -n "$meta_text" ]]; then
    output+=" ${THEME_STYLES[metadata]}(${meta_text})${THEME_STYLES[reset]}"
  fi

  echo "$output"
}

should_skip() {
  local path="$1"
  local name
  name="$(basename "$path")"

  if [[ "${CONFIG[show_hidden]}" == "false" && "$name" == .* ]]; then
    SKIPPED_COUNT=$((SKIPPED_COUNT+1))
    return 0
  fi

  IFS=',' read -ra patterns <<< "${CONFIG[skip_patterns]}"
  for pattern in "${patterns[@]}"; do
    if [[ "$pattern" == *"*"* || "$pattern" == *"?"* ]]; then
      [[ "$name" == $pattern ]] && SKIPPED_COUNT=$((SKIPPED_COUNT+1)) && return 0
    else
      [[ "$name" == "$pattern" ]] && SKIPPED_COUNT=$((SKIPPED_COUNT+1)) && return 0
    fi
  done

  return 1
}

###############################################################################
# 8) PROGRESS TRACKING
###############################################################################
update_progress() {
  [[ "${CONFIG[progress]}" != "true" ]] && return

  local current="$1"
  local total="$2"
  local now
  now="$(date +%s)"

  [[ $now -le $LAST_PROGRESS_UPDATE ]] && return
  LAST_PROGRESS_UPDATE=$now

  local percent=$(( current * 100 / total ))
  local completed=$(( PROGRESS_BAR_WIDTH * current / total ))
  local remaining=$(( PROGRESS_BAR_WIDTH - completed ))

  local spinner_frame=$(( now % ${#THEME_STYLES[spinner]} ))
  local spinner_char="${THEME_STYLES[spinner]:$spinner_frame:1}"

  local progress="${THEME_STYLES[progress_start]}"
  local i
  for ((i=0; i<completed; i++)); do
    progress+="${THEME_STYLES[progress_complete]}"
  done
  for ((i=0; i<remaining; i++)); do
    progress+="${THEME_STYLES[progress_incomplete]}"
  done
  progress+="${THEME_STYLES[progress_end]}"

  local elapsed
  elapsed="$(bc <<<"$(date +%s.%N) - $START_TIME")"
  local eta="calculating..."
  if [[ $current -gt 0 && $(bc <<<"$elapsed > 0") -eq 1 ]]; then
    local items_per_sec
    items_per_sec="$(bc <<<"scale=1; $current / $elapsed")"
    local remaining_sec
    remaining_sec="$(bc <<<"scale=0; ($total - $current) / $items_per_sec" 2>/dev/null || echo '?')"

    if [[ "$remaining_sec" != "?" ]]; then
      if [[ $remaining_sec -lt 60 ]]; then
        eta="${remaining_sec}s"
      elif [[ $remaining_sec -lt 3600 ]]; then
        eta="$((remaining_sec/60))m $((remaining_sec%60))s"
      else
        eta="$((remaining_sec/3600))h $(((remaining_sec%3600)/60))m"
      fi
    fi
  fi

  printf "\r%sProcessing: %s %3d%% %s %d/%d (ETA: %s)%s" \
    "${THEME_STYLES[dim]}" \
    "$spinner_char" \
    "$percent" \
    "$progress" \
    "$current" \
    "$total" \
    "$eta" \
    "${THEME_STYLES[reset]}"
}

###############################################################################
# 9) WALK THE TREE
###############################################################################
walk_tree() {
  local dir="$1"
  local depth="$2"
  local max_depth="${CONFIG[max_depth]}"

  if [[ "$max_depth" -ge 0 && "$depth" -gt "$max_depth" ]]; then
    return
  fi

  local -a items=()
  while IFS= read -r -d $'\0' entry; do
    items+=( "$entry" )
  done < <(find "$dir" -mindepth 1 -maxdepth 1 -print0 2>/dev/null || true)

  if ((${#items[@]}==0)); then
    # Print something for empty directories
    if [[ "$depth" -eq 0 ]]; then
      # top-level empty
      echo "[No items under '${dir}']" | tee -a "${CONFIG[output_file]}"
    else
      local prefix=""
      for (( i=0; i<depth; i++ )); do
        if [[ $i -lt $((depth-1)) ]]; then
          if [[ "${BRANCH_HISTORY[$i]}" == "true" ]]; then
            prefix+="${THEME_STYLES[pipe_icon]}${THEME_STYLES[space_icon]}"
          else
            prefix+="${THEME_STYLES[space_icon]}${THEME_STYLES[space_icon]}"
          fi
        fi
      done
      prefix+="[Empty]"
      echo -e "${prefix}" | tee -a "${CONFIG[output_file]}"
    fi
    return
  fi

  case "${CONFIG[sort_by]}" in
    name)
      IFS=$'\n' items=($(printf '%s\n' "${items[@]}" | sort))
      ;;
    type)
      IFS=$'\n' items=($(printf '%s\n' "${items[@]}" | sort))
      ;;
    size)
      IFS=$'\n' items=($(
        for f in "${items[@]}"; do
          local s
          s="$(stat -c '%s' "$f" 2>/dev/null || echo 0)"
          echo "$s $f"
        done | sort -rn | awk '{ $1=""; sub(/^ /,""); print }'
      ))
      ;;
    mod_time)
      IFS=$'\n' items=($(
        for f in "${items[@]}"; do
          local mt
          mt="$(stat -c '%Y' "$f" 2>/dev/null || echo 0)"
          echo "$mt $f"
        done | sort -rn | awk '{ $1=""; sub(/^ /,""); print }'
      ))
      ;;
    none) ;;
    *)
      IFS=$'\n' items=($(printf '%s\n' "${items[@]}" | sort))
      ;;
  esac

  if [[ "${CONFIG[sort_by]}" == "type" ]]; then
    local -a dirs=()
    local -a others=()
    for item in "${items[@]}"; do
      [[ -d "$item" && ! -L "$item" ]] && dirs+=( "$item" ) || others+=( "$item" )
    done
    items=( "${dirs[@]}" "${others[@]}" )
  fi

  local total="${#items[@]}"
  for ((i=0; i<total; i++)); do
    local full_path="${items[$i]}"
    local name
    name="$(basename "$full_path")"
    should_skip "$full_path" && continue

    local is_last=false
    (( i == total-1 )) && is_last=true

    if [[ "$depth" -gt 0 ]]; then
      BRANCH_HISTORY[$((depth-1))]=$is_last
    fi

    local type_info
    type_info="$(get_file_icon "$full_path")"
    local file_type="${type_info%%Â§*}"

    case "$file_type" in
      directory) DIR_COUNT=$((DIR_COUNT+1)) ;;
      symlink|broken_symlink) LINK_COUNT=$((LINK_COUNT+1)) ;;
      *) FILE_COUNT=$((FILE_COUNT+1)) ;;
    esac

    ITEMS_PROCESSED=$((ITEMS_PROCESSED+1))
    update_progress "$ITEMS_PROCESSED" "$TOTAL_ITEMS_ESTIMATED"

    format_entry "$depth" "$is_last" "$name" "$full_path" \
      | tee -a "${CONFIG[output_file]}"

    if [[ "$file_type" == "directory" ]]; then
      BRANCH_HISTORY[$depth]=$is_last
      walk_tree "$full_path" $((depth+1))
    elif [[ "$file_type" == "symlink" && "${CONFIG[follow_symlinks]}" == "true" ]]; then
      if [[ -d "$full_path" ]]; then
        BRANCH_HISTORY[$depth]=$is_last
        walk_tree "$full_path" $((depth+1))
      fi
    fi
  done
}

###############################################################################
# 10) SUMMARY
###############################################################################
generate_summary() {
  local mode="${1:-normal}"
  local end_time
  end_time="$(date +%s.%N)"
  local elapsed
  elapsed="$(bc <<<"$end_time - $START_TIME")"

  {
    echo
    if [[ "$mode" == "interrupted" ]]; then
      echo -e "${THEME_STYLES[error]}${THEME_STYLES[warn_icon]} Generation Interrupted${THEME_STYLES[reset]}"
    else
      echo -e "${THEME_STYLES[bold]}${THEME_STYLES[ok_icon]} File Tree Generation Complete${THEME_STYLES[reset]}"
    fi
    echo -e "${THEME_STYLES[dim]}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${THEME_STYLES[reset]}"
    echo -e "${THEME_STYLES[dim]}${THEME_STYLES[summary_icon]}${THEME_STYLES[summary_label]}${THEME_STYLES[reset]}"
    echo -e "${THEME_STYLES[dim]}${THEME_STYLES[bullet]} Directories: ${THEME_STYLES[directory]}${DIR_COUNT}${THEME_STYLES[reset]}"
    echo -e "${THEME_STYLES[dim]}${THEME_STYLES[bullet]} Files:       ${THEME_STYLES[file]}${FILE_COUNT}${THEME_STYLES[reset]}"
    echo -e "${THEME_STYLES[dim]}${THEME_STYLES[bullet]} Symlinks:    ${THEME_STYLES[symlink]}${LINK_COUNT}${THEME_STYLES[reset]}"
    [[ $ERROR_COUNT -gt 0 ]] && echo -e "${THEME_STYLES[dim]}${THEME_STYLES[bullet]} Errors:      ${THEME_STYLES[error]}${ERROR_COUNT}${THEME_STYLES[reset]}"
    printf "%s%s%sExecution Time: %.4f seconds%s\\n" \
      "${THEME_STYLES[dim]}" "${THEME_STYLES[bullet]} " "${THEME_STYLES[special]}" "$elapsed" "${THEME_STYLES[reset]}"
    echo -e "${THEME_STYLES[dim]}${THEME_STYLES[bullet]} Skipped:     ${SKIPPED_COUNT}${THEME_STYLES[reset]}"
    echo -e "${THEME_STYLES[dim]}${THEME_STYLES[bullet]} Output:      ${THEME_STYLES[underline]}${CONFIG[output_file]}${THEME_STYLES[reset]}"
    echo -e "${THEME_STYLES[dim]}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${THEME_STYLES[reset]}"
  } | tee -a "${CONFIG[output_file]}"
}

###############################################################################
# 11) MAIN LOGIC
###############################################################################
main() {
  parse_args "$@"

  # Preliminary checks
  if [[ ! -d "${CONFIG[root_dir]}" ]]; then
    echo "ERROR: Root directory '${CONFIG[root_dir]}' not found."
    exit 1
  fi
  if ! [[ "${CONFIG[max_depth]}" =~ ^-?[0-9]+$ ]]; then
    echo "ERROR: max_depth must be an integer. Received '${CONFIG[max_depth]}'"
    exit 1
  fi

  detect_capabilities
  configure_theme
  setup_traps

  : > "${CONFIG[output_file]}"
  {
    echo -e "${THEME_STYLES[bold]}${THEME_STYLES[header_icon]} EIDOSIAN File Tree for: ${THEME_STYLES[underline]}${CONFIG[root_dir]}${THEME_STYLES[reset]}"
    echo -e "${THEME_STYLES[dim]}Generated: $(date)${THEME_STYLES[reset]}"
    echo
  } | tee "${CONFIG[output_file]}"

  if [[ "${CONFIG[progress]}" == "true" ]]; then
    TOTAL_ITEMS_ESTIMATED=$(find "${CONFIG[root_dir]}" -mindepth 1 -type f -o -type d -o -type l 2>/dev/null | wc -l)
    tput civis || true
  fi

  walk_tree "${CONFIG[root_dir]}" 0

  generate_summary "normal"
  echo -e "\n${THEME_STYLES[italic]}${THEME_STYLES[special]}${THEME_STYLES[star_icon]} EIDOSIAN EXCELLENCE ACHIEVED ${THEME_STYLES[star_icon]}${THEME_STYLES[reset]}"

  if [[ "${CONFIG[json_summary]}" == "true" ]]; then
    printf '{\"files\":%d,\"dirs\":%d,\"symlinks\":%d,\"errors\":%d,\"skipped\":%d,\"output\":\"%s\"}\n' \
      "$FILE_COUNT" "$DIR_COUNT" "$LINK_COUNT" "$ERROR_COUNT" "$SKIPPED_COUNT" "${CONFIG[output_file]}"
  fi
}

main "$@"
