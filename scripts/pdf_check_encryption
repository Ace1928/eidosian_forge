#!/usr/bin/env python3
"""
pdf_check_encryption

Check if a PDF is encrypted using pdftotext error signals.
"""
from __future__ import annotations

import argparse
import os
import subprocess
import sys
import tkinter as tk
from tkinter import filedialog, messagebox

from lib.py_lib import require_cmd, log_error


def is_encrypted(pdf_file: str) -> bool:
    result = subprocess.run(
        ["pdftotext", pdf_file, "-"],
        capture_output=True,
        text=True,
        check=False,
    )
    if result.returncode == 0:
        return False
    error = (result.stderr or "").lower()
    return "password" in error or "encrypt" in error


def cli_main() -> int:
    parser = argparse.ArgumentParser(description="Check if a PDF is encrypted")
    parser.add_argument("--file", help="Path to PDF file")
    parser.add_argument("--json", action="store_true", help="Machine-readable output")
    args = parser.parse_args()

    require_cmd("pdftotext")

    if args.file:
        try:
            encrypted = is_encrypted(args.file)
        except Exception as exc:
            if args.json:
                print(f'{{"ok": false, "error": "{str(exc)}"}}')
            else:
                log_error(str(exc))
            return 1
        if args.json:
            print(f'{{"ok": true, "encrypted": {str(encrypted).lower()}}}')
        else:
            print("encrypted" if encrypted else "not_encrypted")
        return 0

    return gui_main()


def gui_main() -> int:
    root = tk.Tk()
    root.title("Check PDF Encryption")

    def check_encryption() -> None:
        pdf_file = filedialog.askopenfilename(
            title="Select a PDF",
            filetypes=[("PDF Files", "*.pdf")],
            initialdir=os.path.expanduser("~/Documents"),
        )
        if not pdf_file:
            return

        if is_encrypted(pdf_file):
            messagebox.showwarning("Encrypted", "The PDF is encrypted or password-protected.")
        else:
            messagebox.showinfo("Result", "The PDF is not encrypted.")

    tk.Button(root, text="Check If PDF Is Encrypted", command=check_encryption).pack(
        padx=20, pady=20
    )
    root.mainloop()
    return 0


if __name__ == "__main__":
    sys.exit(cli_main())
