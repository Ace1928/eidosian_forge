import numpy as np
from patsy.util import (have_pandas, atleast_2d_column_default,
from patsy.state import stateful_transform
def test_te_2smooths():
    from patsy.highlevel import incr_dbuilder, build_design_matrices
    x1 = (-1.5) ** np.arange(20)
    x2 = 1.6 ** np.arange(20)
    dmatrix_R_nocons = np.array([[-4.4303024184609255e-06, 7.988443838723014e-06, 9.798775819479772e-06, -7.289421324547521e-08, 1.5907686862964494e-09, -3.2565884983072595e-11, 0.017074960785587467, -0.03078849983596585, -0.03776575435735246, 0.000280943762998268, -6.13102907473492e-06, 1.2551314933193443e-07, -0.26012671685838207, 0.46904420337437874, 0.5753384627946153, -0.004280008581470045, 9.340252573348487e-05, -1.912117038993752e-06, -0.09043122404894478, 0.16305991924427923, 0.20001237112941642, -0.0014879148887003383, 3.2470731316462736e-05, -6.647340436591413e-07, 2.0447857920168825e-05, -3.687029669505099e-05, -4.522580104540902e-05, 3.3643990293641666e-07, -7.342120020001588e-09, 1.5030635073660743e-10], [-0.0009400613060265379, 0.0007868139806916373, 0.00024573006857381437, -0.00014524712230452725, 7.821674135310633e-05, -0.00031304283003914265, 3.6231183382798338, -3.032483247617417, -0.9470755917821114, 0.5598012693749258, -0.3014574774434233, 1.2065077148806895, -35.17561267504181, 29.441339255948005, 9.194831932078213, -5.43491842882452, 2.926747203509645, -11.713569391233907, 34.02756268639764, -28.480442582712723, -8.894734054815157, 5.257535362376293, -2.831224998259253, 11.331265795534764, 0.7946215884507898, -0.6650836186367062, -0.20771242914526858, 0.12277550230353954, -0.06611559358842004, 0.2646110304340214]])
    dmatrix_R_cons = np.array([[0.0032999860632386725, 0.00016537431155796577, -0.00012392262709790753, 6.540530416670678e-05, -6.676404579953762e-05, -0.13864310817637263, 0.12429728380086431, -0.035487293655619825, -0.0030527115315785902, 0.000520092476433116, -0.0038420399230170267, -0.058901915802819435, 0.2664223584916489, 0.5739281693874088, -0.0013171008503525844, 0.0008257345663187891, 0.006673083345301696, -0.1467677784718445, 0.22075765093483748, 0.19831276878801718, -0.0016269930328365173, -0.0017785892412241209, -0.00327028354363512, -0.04325218304430076, 0.04340376697623518, 3.597340640289376e-05, -0.0005403585856822508, 0.0002956520938279424, -0.00022769990750264098], [0.4154795483895605, 0.019843570584107708, -0.01574659023479138, 0.008317118431222143, -0.008723301405201752, -15.992677078508626, 16.503663226274018, -0.6600580395589473, 0.13986092022708346, -0.23516913533670955, 0.7225103749720736, -9.827337059999854, 3.9170781172948277, 9.017177359697362, -5.061681127078767, 3.0189990249009684, -10.872720629943064, 26.930850446045312, -21.212262927009288, -9.108832855558225, 5.24001569725003, -3.0593641098325475, 10.919392118399086, -4.656429022326572, 4.807130744160698, -0.197483770056898, 0.0546641837169651, -0.028871392916916285, 0.23592766838010845]])
    new_x1 = np.array([11.390625, 656.8408355712891])
    new_x2 = np.array([16.777216000000006, 1844.6744073709567])
    new_data = {'x1': new_x1, 'x2': new_x2}
    data_chunked = [{'x1': x1[:10], 'x2': x2[:10]}, {'x1': x1[10:], 'x2': x2[10:]}]
    builder = incr_dbuilder('te(cr(x1, df=5), cc(x2, df=6)) - 1', lambda: iter(data_chunked))
    dmatrix_nocons = build_design_matrices([builder], new_data)[0]
    assert np.allclose(dmatrix_nocons, dmatrix_R_nocons, rtol=1e-12, atol=0.0)
    builder = incr_dbuilder("te(cr(x1, df=5), cc(x2, df=6), constraints='center') - 1", lambda: iter(data_chunked))
    dmatrix_cons = build_design_matrices([builder], new_data)[0]
    assert np.allclose(dmatrix_cons, dmatrix_R_cons, rtol=1e-12, atol=0.0)