import pyomo.common.unittest as unittest
from pyomo.environ import (
from pyomo.core.expr.logical_expr import (
from pyomo.gdp import Disjunct, Disjunction
from pyomo.gdp.util import GDP_Error, check_model_algebraic
from pyomo.gdp.plugins.partition_disjuncts import (
from pyomo.core import Block, value
import pyomo.core.expr as EXPR
import pyomo.gdp.tests.common_tests as ct
import pyomo.gdp.tests.models as models
from pyomo.repn import generate_standard_repn
from pyomo.opt import check_available_solvers
def check_transformation_block(self, m, aux1lb, aux1ub, aux2lb, aux2ub):
    b = m.component('_pyomo_gdp_partition_disjuncts_reformulation')
    self.assertIsInstance(b, Block)
    self.assertEqual(len(b.component_map(Disjunction)), 1)
    self.assertEqual(len(b.component_map(Disjunct)), 2)
    self.assertEqual(len(b.component_map(Constraint)), 2)
    self.assertEqual(len(b.component_map(LogicalConstraint)), 1)
    disjunction = b.disjunction
    self.assertEqual(len(disjunction.disjuncts), 2)
    disj1 = disjunction.disjuncts[0]
    disj2 = disjunction.disjuncts[1]
    self.assertEqual(len(disj1.component_map(Constraint)), 1)
    self.assertEqual(len(disj2.component_map(Constraint)), 1)
    self.assertEqual(len(disj1.component_map(Var)), 3)
    self.assertEqual(len(disj2.component_map(Var)), 3)
    equivalence = b.component('indicator_var_equalities')
    self.assertIsInstance(equivalence, LogicalConstraint)
    self.assertEqual(len(equivalence), 2)
    for i, variables in enumerate([(m.disjunction.disjuncts[0].indicator_var, disj1.indicator_var), (m.disjunction.disjuncts[1].indicator_var, disj2.indicator_var)]):
        cons = equivalence[i]
        self.assertIsInstance(cons.body, EquivalenceExpression)
        self.assertEqual(cons.body.args, variables)
    aux_vars1 = disj1.component('disjunction_disjuncts[0].constraint[1]_aux_vars')
    self.assertEqual(len(aux_vars1), 2)
    self.assertEqual(aux_vars1[0].lb, aux1lb)
    self.assertEqual(aux_vars1[0].ub, aux1ub)
    self.assertEqual(aux_vars1[1].lb, aux1lb)
    self.assertEqual(aux_vars1[1].ub, aux1ub)
    aux_vars2 = disj2.component('disjunction_disjuncts[1].constraint[1]_aux_vars')
    self.assertEqual(len(aux_vars2), 2)
    self.assertEqual(aux_vars2[0].lb, aux2lb)
    self.assertEqual(aux_vars2[0].ub, aux2ub)
    self.assertEqual(aux_vars2[1].lb, aux2lb)
    self.assertEqual(aux_vars2[1].ub, aux2ub)
    c = disj1.component('disjunction_disjuncts[0].constraint[1]')
    self.assertEqual(len(c), 1)
    c1 = c[0]
    self.assertIsNone(c1.lower)
    self.assertEqual(c1.upper, 1)
    repn = generate_standard_repn(c1.body)
    self.assertTrue(repn.is_linear())
    self.assertEqual(len(repn.linear_vars), 2)
    self.assertEqual(repn.constant, 0)
    self.assertIs(repn.linear_vars[0], aux_vars1[0])
    self.assertIs(repn.linear_vars[1], aux_vars1[1])
    self.assertEqual(repn.linear_coefs[0], 1)
    self.assertEqual(repn.linear_coefs[1], 1)
    c = disj2.component('disjunction_disjuncts[1].constraint[1]')
    self.assertEqual(len(c), 1)
    c2 = c[0]
    self.assertIsNone(c2.lower)
    self.assertEqual(value(c2.upper), 1)
    repn = generate_standard_repn(c2.body)
    self.assertTrue(repn.is_linear())
    self.assertEqual(len(repn.linear_vars), 2)
    self.assertEqual(repn.constant, 0)
    self.assertIs(repn.linear_vars[0], aux_vars2[0])
    self.assertIs(repn.linear_vars[1], aux_vars2[1])
    self.assertEqual(repn.linear_coefs[0], 1)
    self.assertEqual(repn.linear_coefs[1], 1)
    c = b.component('disjunction_disjuncts[0].constraint[1]_split_constraints')
    self.assertEqual(len(c), 2)
    c1 = c[0]
    self.assertIsNone(c1.lower)
    self.assertEqual(c1.upper, 0)
    repn = generate_standard_repn(c1.body)
    self.assertEqual(repn.constant, 0)
    self.assertEqual(len(repn.linear_vars), 1)
    self.assertEqual(len(repn.nonlinear_vars), 2)
    self.assertEqual(repn.linear_coefs[0], -1)
    self.assertIs(repn.linear_vars[0], aux_vars1[0])
    self.assertIs(repn.nonlinear_vars[0], m.x[1])
    self.assertIs(repn.nonlinear_vars[1], m.x[2])
    self.assertIsInstance(repn.nonlinear_expr, EXPR.PowExpression)
    self.assertEqual(repn.nonlinear_expr.args[1], 0.25)
    self.assertIsInstance(repn.nonlinear_expr.args[0], EXPR.SumExpression)
    self.assertEqual(len(repn.nonlinear_expr.args[0].args), 2)
    self.assertIsInstance(repn.nonlinear_expr.args[0].args[0], EXPR.PowExpression)
    self.assertIsInstance(repn.nonlinear_expr.args[0].args[1], EXPR.PowExpression)
    self.assertIs(repn.nonlinear_expr.args[0].args[0].args[0], m.x[1])
    self.assertEqual(repn.nonlinear_expr.args[0].args[0].args[1], 4)
    self.assertIs(repn.nonlinear_expr.args[0].args[1].args[0], m.x[2])
    self.assertEqual(repn.nonlinear_expr.args[0].args[1].args[1], 4)
    c2 = c[1]
    self.assertIsNone(c2.lower)
    self.assertEqual(c2.upper, 0)
    repn = generate_standard_repn(c2.body)
    self.assertEqual(repn.constant, 0)
    self.assertEqual(len(repn.linear_vars), 1)
    self.assertEqual(len(repn.nonlinear_vars), 2)
    self.assertIs(repn.linear_vars[0], aux_vars1[1])
    self.assertIs(repn.nonlinear_vars[0], m.x[3])
    self.assertIs(repn.nonlinear_vars[1], m.x[4])
    self.assertIsInstance(repn.nonlinear_expr, EXPR.PowExpression)
    self.assertEqual(repn.nonlinear_expr.args[1], 0.25)
    self.assertIsInstance(repn.nonlinear_expr.args[0], EXPR.SumExpression)
    self.assertEqual(len(repn.nonlinear_expr.args[0].args), 2)
    self.assertIsInstance(repn.nonlinear_expr.args[0].args[0], EXPR.PowExpression)
    self.assertIsInstance(repn.nonlinear_expr.args[0].args[1], EXPR.PowExpression)
    self.assertIs(repn.nonlinear_expr.args[0].args[0].args[0], m.x[3])
    self.assertEqual(repn.nonlinear_expr.args[0].args[0].args[1], 4)
    self.assertIs(repn.nonlinear_expr.args[0].args[1].args[0], m.x[4])
    self.assertEqual(repn.nonlinear_expr.args[0].args[1].args[1], 4)
    c = b.component('disjunction_disjuncts[1].constraint[1]_split_constraints')
    self.assertEqual(len(c), 2)
    c1 = c[0]
    self.assertIsNone(c1.lower)
    self.assertEqual(c1.upper, 0)
    repn = generate_standard_repn(c1.body)
    self.assertEqual(repn.constant, 0)
    self.assertEqual(len(repn.linear_vars), 1)
    self.assertEqual(len(repn.nonlinear_vars), 2)
    self.assertEqual(repn.linear_coefs[0], -1)
    self.assertIs(repn.linear_vars[0], aux_vars2[0])
    self.assertIs(repn.nonlinear_vars[0], m.x[1])
    self.assertIs(repn.nonlinear_vars[1], m.x[2])
    self.assertIsInstance(repn.nonlinear_expr, EXPR.PowExpression)
    self.assertEqual(repn.nonlinear_expr.args[1], 0.25)
    self.assertIsInstance(repn.nonlinear_expr.args[0], EXPR.SumExpression)
    self.assertEqual(len(repn.nonlinear_expr.args[0].args), 2)
    self.assertIsInstance(repn.nonlinear_expr.args[0].args[0], EXPR.PowExpression)
    self.assertIsInstance(repn.nonlinear_expr.args[0].args[1], EXPR.PowExpression)
    sum_expr = repn.nonlinear_expr.args[0].args[0].args[0]
    self.assertIsInstance(sum_expr, EXPR.SumExpression)
    sum_repn = generate_standard_repn(sum_expr)
    self.assertEqual(sum_repn.constant, 3)
    self.assertTrue(sum_repn.is_linear())
    self.assertEqual(len(sum_repn.linear_vars), 1)
    self.assertEqual(sum_repn.linear_coefs[0], -1)
    self.assertIs(sum_repn.linear_vars[0], m.x[1])
    self.assertEqual(repn.nonlinear_expr.args[0].args[0].args[1], 4)
    self.assertIsInstance(repn.nonlinear_expr.args[0].args[1], EXPR.PowExpression)
    sum_expr = repn.nonlinear_expr.args[0].args[1].args[0]
    self.assertIsInstance(sum_expr, EXPR.SumExpression)
    sum_repn = generate_standard_repn(sum_expr)
    self.assertEqual(sum_repn.constant, 3)
    self.assertTrue(sum_repn.is_linear())
    self.assertEqual(len(sum_repn.linear_vars), 1)
    self.assertEqual(sum_repn.linear_coefs[0], -1)
    self.assertIs(sum_repn.linear_vars[0], m.x[2])
    self.assertEqual(repn.nonlinear_expr.args[0].args[1].args[1], 4)
    c2 = c[1]
    self.assertIsNone(c1.lower)
    self.assertEqual(c1.upper, 0)
    repn = generate_standard_repn(c2.body)
    self.assertEqual(repn.constant, 0)
    self.assertEqual(len(repn.linear_vars), 1)
    self.assertEqual(len(repn.nonlinear_vars), 2)
    self.assertEqual(repn.linear_coefs[0], -1)
    self.assertIs(repn.linear_vars[0], aux_vars2[1])
    self.assertIs(repn.nonlinear_vars[0], m.x[3])
    self.assertIs(repn.nonlinear_vars[1], m.x[4])
    self.assertIsInstance(repn.nonlinear_expr, EXPR.PowExpression)
    self.assertEqual(repn.nonlinear_expr.args[1], 0.25)
    self.assertIsInstance(repn.nonlinear_expr.args[0], EXPR.SumExpression)
    self.assertEqual(len(repn.nonlinear_expr.args[0].args), 2)
    self.assertIsInstance(repn.nonlinear_expr.args[0].args[0], EXPR.PowExpression)
    self.assertIsInstance(repn.nonlinear_expr.args[0].args[1], EXPR.PowExpression)
    sum_expr = repn.nonlinear_expr.args[0].args[0].args[0]
    self.assertIsInstance(sum_expr, EXPR.SumExpression)
    sum_repn = generate_standard_repn(sum_expr)
    self.assertEqual(sum_repn.constant, 3)
    self.assertTrue(sum_repn.is_linear())
    self.assertEqual(len(sum_repn.linear_vars), 1)
    self.assertEqual(sum_repn.linear_coefs[0], -1)
    self.assertIs(sum_repn.linear_vars[0], m.x[3])
    self.assertEqual(repn.nonlinear_expr.args[0].args[0].args[1], 4)
    self.assertIsInstance(repn.nonlinear_expr.args[0].args[1], EXPR.PowExpression)
    sum_expr = repn.nonlinear_expr.args[0].args[1].args[0]
    self.assertIsInstance(sum_expr, EXPR.SumExpression)
    sum_repn = generate_standard_repn(sum_expr)
    self.assertEqual(sum_repn.constant, 3)
    self.assertTrue(sum_repn.is_linear())
    self.assertEqual(len(sum_repn.linear_vars), 1)
    self.assertEqual(sum_repn.linear_coefs[0], -1)
    self.assertIs(sum_repn.linear_vars[0], m.x[4])
    self.assertEqual(repn.nonlinear_expr.args[0].args[1].args[1], 4)