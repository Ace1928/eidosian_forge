from io import StringIO
from breezy import osutils, trace
from .bzr.inventorytree import InventoryTreeChange
class _ChangeReporter:
    """Report changes between two trees"""

    def __init__(self, output=None, suppress_root_add=True, output_file=None, unversioned_filter=None, view_info=None, classify=True):
        """Constructor

        :param output: a function with the signature of trace.note, i.e.
            accepts a format and parameters.
        :param supress_root_add: If true, adding the root will be ignored
            (i.e. when a tree has just been initted)
        :param output_file: If supplied, a file-like object to write to.
            Only one of output and output_file may be supplied.
        :param unversioned_filter: A filter function to be called on
            unversioned files. This should return True to ignore a path.
            By default, no filtering takes place.
        :param view_info: A tuple of view_name,view_files if only
            items inside a view are to be reported on, or None for
            no view filtering.
        :param classify: Add special symbols to indicate file kind.
        """
        if output_file is not None:
            if output is not None:
                raise BzrError('Cannot specify both output and output_file')

            def output(fmt, *args):
                output_file.write(fmt % args + '\n')
        self.output = output
        if self.output is None:
            from . import trace
            self.output = trace.note
        self.suppress_root_add = suppress_root_add
        self.modified_map = {'kind changed': 'K', 'unchanged': ' ', 'created': 'N', 'modified': 'M', 'deleted': 'D', 'missing': '!'}
        self.versioned_map = {'added': '+', 'unchanged': ' ', 'removed': '-', 'unversioned': '?'}
        self.unversioned_filter = unversioned_filter
        if classify:
            self.kind_marker = osutils.kind_marker
        else:
            self.kind_marker = lambda kind: ''
        if view_info is None:
            self.view_name = None
            self.view_files = []
        else:
            self.view_name = view_info[0]
            self.view_files = view_info[1]
            self.output("Operating on whole tree but only reporting on '%s' view." % (self.view_name,))

    def report(self, paths, versioned, renamed, copied, modified, exe_change, kind):
        """Report one change to a file

        :param path: The old and new paths as generated by Tree.iter_changes.
        :param versioned: may be 'added', 'removed', 'unchanged', or
            'unversioned.
        :param renamed: may be True or False
        :param copied: may be True or False
        :param modified: may be 'created', 'deleted', 'kind changed',
            'modified' or 'unchanged'.
        :param exe_change: True if the execute bit has changed
        :param kind: A pair of file kinds, as generated by Tree.iter_changes.
            None indicates no file present.
        """
        if trace.is_quiet():
            return
        if paths[1] == '' and versioned == 'added' and self.suppress_root_add:
            return
        if self.view_files and (not osutils.is_inside_any(self.view_files, paths[1])):
            return
        if versioned == 'unversioned':
            if self.unversioned_filter is not None:
                if self.unversioned_filter(paths[1]):
                    return
            modified = 'unchanged'
        if versioned == 'unchanged' and (renamed or copied or modified == 'kind changed'):
            if renamed or copied:
                old_path, path = paths
            else:
                old_path, path = (paths[1], paths[1])
            if kind[0] is not None:
                old_path += self.kind_marker(kind[0])
            old_path += ' => '
        elif versioned == 'removed':
            old_path = ''
            path = paths[0]
        else:
            old_path = ''
            path = paths[1]
        if renamed:
            rename = 'R'
        elif copied:
            rename = 'C'
        else:
            rename = self.versioned_map[versioned]
        if modified == 'deleted':
            path += self.kind_marker(kind[0])
        elif kind[1] is not None:
            path += self.kind_marker(kind[1])
        if exe_change:
            exe = '*'
        else:
            exe = ' '
        self.output('%s%s%s %s%s', rename, self.modified_map[modified], exe, old_path, path)