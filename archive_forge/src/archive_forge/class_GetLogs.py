from __future__ import absolute_import
from __future__ import division
from __future__ import unicode_literals
import datetime
from googlecloudsdk.api_lib.functions.v1 import util as util_v1
from googlecloudsdk.api_lib.functions.v2 import client as client_v2
from googlecloudsdk.api_lib.functions.v2 import exceptions
from googlecloudsdk.api_lib.logging import common as logging_common
from googlecloudsdk.api_lib.logging import util as logging_util
from googlecloudsdk.calliope import arg_parsers
from googlecloudsdk.calliope import base
from googlecloudsdk.calliope import parser_extensions
from googlecloudsdk.command_lib.functions import flags
from googlecloudsdk.command_lib.functions import util
from googlecloudsdk.core import log
from googlecloudsdk.core import properties
from googlecloudsdk.core import resources
import six
@base.ReleaseTracks(base.ReleaseTrack.GA)
class GetLogs(base.ListCommand):
    """Display log entries produced by Google Cloud Functions."""

    @staticmethod
    def Args(parser):
        """Register flags for this command."""
        flags.AddRegionFlag(parser, help_text='Only show logs generated by functions in the region.')
        base.LIMIT_FLAG.RemoveFromParser(parser)
        parser.add_argument('name', nargs='?', help='Name of the function which logs are to be displayed. If no name is specified, logs from all functions are displayed.')
        parser.add_argument('--execution-id', help='Execution ID for which logs are to be displayed.')
        parser.add_argument('--start-time', required=False, type=arg_parsers.Datetime.Parse, help='Return only log entries in which timestamps are not earlier than the specified time. If *--start-time* is not specified, a default start time of 1 week ago is assumed. See $ gcloud topic datetimes for information on time formats.')
        parser.add_argument('--end-time', required=False, type=arg_parsers.Datetime.Parse, help='Return only log entries which timestamps are not later than the specified time. If *--end-time* is specified but *--start-time* is not, the command returns *--limit* latest log entries which appeared before --end-time. See *$ gcloud topic datetimes* for information on time formats.')
        parser.add_argument('--limit', required=False, type=arg_parsers.BoundedInt(1, 1000), default=20, help='Number of log entries to be fetched; must not be greater than 1000. Note that the most recent entries in the specified time range are returned, rather than the earliest.')
        flags.AddMinLogLevelFlag(parser)
        parser.display_info.AddCacheUpdater(None)
        flags.AddGen2Flag(parser)

    @util_v1.CatchHTTPErrorRaiseHTTPException
    def Run(self, args):
        """This is what gets called when the user runs this command.

    Args:
      args: an argparse namespace. All the arguments that were provided to this
        command invocation.

    Returns:
      A generator of objects representing log entries.
    """
        if not args.IsSpecified('format'):
            args.format = _DEFAULT_TABLE_FORMAT_V2 if flags.ShouldUseGen2() else _DEFAULT_TABLE_FORMAT
        if flags.ShouldUseGen2() and args.execution_id:
            raise exceptions.FunctionsError(_EXECUTION_ID_NOT_SUPPORTED)
        log_filter = _CreateLogFilter(args)
        entries = list(logging_common.FetchLogs(log_filter, order_by='DESC', limit=args.limit))
        if args.name and (not entries):
            client = client_v2.FunctionsClient(self.ReleaseTrack())
            function_ref = _GetFunctionRef(args.name)
            if not client.GetFunction(function_ref.RelativeName()):
                log.warning('There is no function named `{}` in region `{}`. Perhaps you meant to specify `--region` or update the `functions/region` configuration property?'.format(function_ref.functionsId, function_ref.locationsId))
        return _YieldLogEntries(entries)