import datetime as dt
import json
from unittest import mock
import uuid
from oslo_utils import timeutils
from heat.common import exception
from heat.common import template_format
from heat.common import timeutils as heat_timeutils
from heat.db import api as db_api
from heat.db import models
from heat.engine import api
from heat.engine.cfn import parameters as cfn_param
from heat.engine import event
from heat.engine import parent_rsrc
from heat.engine import stack as parser
from heat.engine import template
from heat.objects import event as event_object
from heat.rpc import api as rpc_api
from heat.tests import common
from heat.tests import utils
class FormatValidateParameterTest(common.HeatTestCase):
    base_template = '\n    {\n        "AWSTemplateFormatVersion" : "2010-09-09",\n        "Description" : "test",\n        "Parameters" : {\n            %s\n        }\n    }\n    '
    base_template_hot = '\n    {\n        "heat_template_version" : "2013-05-23",\n        "description" : "test",\n        "parameters" : {\n            %s\n        }\n    }\n    '
    scenarios = [('simple', dict(template=base_template, param_name='KeyName', param='\n                    "KeyName": {\n                        "Type": "String",\n                        "Description": "Name of SSH key pair"\n                    }\n                    ', expected={'Type': 'String', 'Description': 'Name of SSH key pair', 'NoEcho': 'false', 'Label': 'KeyName'})), ('default', dict(template=base_template, param_name='KeyName', param='\n                    "KeyName": {\n                        "Type": "String",\n                        "Description": "Name of SSH key pair",\n                        "Default": "dummy"\n                    }\n                    ', expected={'Type': 'String', 'Description': 'Name of SSH key pair', 'Default': 'dummy', 'NoEcho': 'false', 'Label': 'KeyName'})), ('min_length_constraint', dict(template=base_template, param_name='KeyName', param='\n                    "KeyName": {\n                        "Type": "String",\n                        "Description": "Name of SSH key pair",\n                        "MinLength": 4\n                    }\n                    ', expected={'Type': 'String', 'Description': 'Name of SSH key pair', 'MinLength': 4, 'NoEcho': 'false', 'Label': 'KeyName'})), ('max_length_constraint', dict(template=base_template, param_name='KeyName', param='\n                    "KeyName": {\n                        "Type": "String",\n                        "Description": "Name of SSH key pair",\n                        "MaxLength": 10\n                    }\n                    ', expected={'Type': 'String', 'Description': 'Name of SSH key pair', 'MaxLength': 10, 'NoEcho': 'false', 'Label': 'KeyName'})), ('min_max_length_constraint', dict(template=base_template, param_name='KeyName', param='\n                    "KeyName": {\n                        "Type": "String",\n                        "Description": "Name of SSH key pair",\n                        "MinLength": 4,\n                        "MaxLength": 10\n                    }\n                    ', expected={'Type': 'String', 'Description': 'Name of SSH key pair', 'MinLength': 4, 'MaxLength': 10, 'NoEcho': 'false', 'Label': 'KeyName'})), ('min_value_constraint', dict(template=base_template, param_name='MyNumber', param='\n                    "MyNumber": {\n                        "Type": "Number",\n                        "Description": "A number",\n                        "MinValue": 4\n                    }\n                    ', expected={'Type': 'Number', 'Description': 'A number', 'MinValue': 4, 'NoEcho': 'false', 'Label': 'MyNumber'})), ('max_value_constraint', dict(template=base_template, param_name='MyNumber', param='\n                    "MyNumber": {\n                        "Type": "Number",\n                        "Description": "A number",\n                        "MaxValue": 10\n                    }\n                    ', expected={'Type': 'Number', 'Description': 'A number', 'MaxValue': 10, 'NoEcho': 'false', 'Label': 'MyNumber'})), ('min_max_value_constraint', dict(template=base_template, param_name='MyNumber', param='\n                    "MyNumber": {\n                        "Type": "Number",\n                        "Description": "A number",\n                        "MinValue": 4,\n                        "MaxValue": 10\n                    }\n                    ', expected={'Type': 'Number', 'Description': 'A number', 'MinValue': 4, 'MaxValue': 10, 'NoEcho': 'false', 'Label': 'MyNumber'})), ('allowed_values_constraint', dict(template=base_template, param_name='KeyName', param='\n                    "KeyName": {\n                        "Type": "String",\n                        "Description": "Name of SSH key pair",\n                        "AllowedValues": [ "foo", "bar", "blub" ]\n                    }\n                    ', expected={'Type': 'String', 'Description': 'Name of SSH key pair', 'AllowedValues': ['foo', 'bar', 'blub'], 'NoEcho': 'false', 'Label': 'KeyName'})), ('allowed_pattern_constraint', dict(template=base_template, param_name='KeyName', param='\n                    "KeyName": {\n                        "Type": "String",\n                        "Description": "Name of SSH key pair",\n                        "AllowedPattern": "[a-zA-Z0-9]+"\n                    }\n                    ', expected={'Type': 'String', 'Description': 'Name of SSH key pair', 'AllowedPattern': '[a-zA-Z0-9]+', 'NoEcho': 'false', 'Label': 'KeyName'})), ('multiple_constraints', dict(template=base_template, param_name='KeyName', param='\n                    "KeyName": {\n                        "Type": "String",\n                        "Description": "Name of SSH key pair",\n                        "MinLength": 4,\n                        "MaxLength": 10,\n                        "AllowedValues": [\n                            "foo", "bar", "blub"\n                        ],\n                        "AllowedPattern": "[a-zA-Z0-9]+"\n                    }\n                    ', expected={'Type': 'String', 'Description': 'Name of SSH key pair', 'MinLength': 4, 'MaxLength': 10, 'AllowedValues': ['foo', 'bar', 'blub'], 'AllowedPattern': '[a-zA-Z0-9]+', 'NoEcho': 'false', 'Label': 'KeyName'})), ('simple_hot', dict(template=base_template_hot, param_name='KeyName', param='\n                    "KeyName": {\n                        "type": "string",\n                        "description": "Name of SSH key pair"\n                    }\n                    ', expected={'Type': 'String', 'Description': 'Name of SSH key pair', 'NoEcho': 'false', 'Label': 'KeyName'})), ('default_hot', dict(template=base_template_hot, param_name='KeyName', param='\n                    "KeyName": {\n                        "type": "string",\n                        "description": "Name of SSH key pair",\n                        "default": "dummy"\n                    }\n                    ', expected={'Type': 'String', 'Description': 'Name of SSH key pair', 'Default': 'dummy', 'NoEcho': 'false', 'Label': 'KeyName'})), ('min_length_constraint_hot', dict(template=base_template_hot, param_name='KeyName', param='\n                    "KeyName": {\n                        "type": "string",\n                        "description": "Name of SSH key pair",\n                        "constraints": [\n                            { "length": { "min": 4} }\n                        ]\n                    }\n                    ', expected={'Type': 'String', 'Description': 'Name of SSH key pair', 'MinLength': 4, 'NoEcho': 'false', 'Label': 'KeyName'})), ('max_length_constraint_hot', dict(template=base_template_hot, param_name='KeyName', param='\n                    "KeyName": {\n                        "type": "string",\n                        "description": "Name of SSH key pair",\n                        "constraints": [\n                            { "length": { "max": 10} }\n                        ]\n                    }\n                    ', expected={'Type': 'String', 'Description': 'Name of SSH key pair', 'MaxLength': 10, 'NoEcho': 'false', 'Label': 'KeyName'})), ('min_max_length_constraint_hot', dict(template=base_template_hot, param_name='KeyName', param='\n                    "KeyName": {\n                        "type": "string",\n                        "description": "Name of SSH key pair",\n                        "constraints": [\n                            { "length": { "min":4, "max": 10} }\n                        ]\n                    }\n                    ', expected={'Type': 'String', 'Description': 'Name of SSH key pair', 'MinLength': 4, 'MaxLength': 10, 'NoEcho': 'false', 'Label': 'KeyName'})), ('min_value_constraint_hot', dict(template=base_template_hot, param_name='MyNumber', param='\n                    "MyNumber": {\n                        "type": "number",\n                        "description": "A number",\n                        "constraints": [\n                            { "range": { "min": 4} }\n                        ]\n                    }\n                    ', expected={'Type': 'Number', 'Description': 'A number', 'MinValue': 4, 'NoEcho': 'false', 'Label': 'MyNumber'})), ('max_value_constraint_hot', dict(template=base_template_hot, param_name='MyNumber', param='\n                    "MyNumber": {\n                        "type": "number",\n                        "description": "A number",\n                        "constraints": [\n                            { "range": { "max": 10} }\n                        ]\n                    }\n                    ', expected={'Type': 'Number', 'Description': 'A number', 'MaxValue': 10, 'NoEcho': 'false', 'Label': 'MyNumber'})), ('min_max_value_constraint_hot', dict(template=base_template_hot, param_name='MyNumber', param='\n                    "MyNumber": {\n                        "type": "number",\n                        "description": "A number",\n                        "constraints": [\n                            { "range": { "min": 4, "max": 10} }\n                        ]\n                    }\n                    ', expected={'Type': 'Number', 'Description': 'A number', 'MinValue': 4, 'MaxValue': 10, 'NoEcho': 'false', 'Label': 'MyNumber'})), ('allowed_values_constraint_hot', dict(template=base_template_hot, param_name='KeyName', param='\n                    "KeyName": {\n                        "type": "string",\n                        "description": "Name of SSH key pair",\n                        "constraints": [\n                            { "allowed_values": [\n                                "foo", "bar", "blub"\n                              ]\n                            }\n                        ]\n                    }\n                    ', expected={'Type': 'String', 'Description': 'Name of SSH key pair', 'AllowedValues': ['foo', 'bar', 'blub'], 'NoEcho': 'false', 'Label': 'KeyName'})), ('allowed_pattern_constraint_hot', dict(template=base_template_hot, param_name='KeyName', param='\n                    "KeyName": {\n                        "type": "string",\n                        "description": "Name of SSH key pair",\n                        "constraints": [\n                            { "allowed_pattern": "[a-zA-Z0-9]+" }\n                        ]\n                    }\n                    ', expected={'Type': 'String', 'Description': 'Name of SSH key pair', 'AllowedPattern': '[a-zA-Z0-9]+', 'NoEcho': 'false', 'Label': 'KeyName'})), ('multiple_constraints_hot', dict(template=base_template_hot, param_name='KeyName', param='\n                    "KeyName": {\n                        "type": "string",\n                        "description": "Name of SSH key pair",\n                        "constraints": [\n                            { "length": { "min": 4, "max": 10} },\n                            { "allowed_values": [\n                                "foo", "bar", "blub"\n                              ]\n                            },\n                            { "allowed_pattern": "[a-zA-Z0-9]+" }\n                        ]\n                    }\n                    ', expected={'Type': 'String', 'Description': 'Name of SSH key pair', 'MinLength': 4, 'MaxLength': 10, 'AllowedValues': ['foo', 'bar', 'blub'], 'AllowedPattern': '[a-zA-Z0-9]+', 'NoEcho': 'false', 'Label': 'KeyName'})), ('constraint_description_hot', dict(template=base_template_hot, param_name='KeyName', param='\n                    "KeyName": {\n                        "type": "string",\n                        "description": "Name of SSH key pair",\n                        "constraints": [\n                            { "length": { "min": 4},\n                              "description": "Big enough" }\n                        ]\n                    }\n                    ', expected={'Type': 'String', 'Description': 'Name of SSH key pair', 'MinLength': 4, 'ConstraintDescription': 'Big enough', 'NoEcho': 'false', 'Label': 'KeyName'})), ('constraint_multiple_descriptions_hot', dict(template=base_template_hot, param_name='KeyName', param='\n                    "KeyName": {\n                        "type": "string",\n                        "description": "Name of SSH key pair",\n                        "constraints": [\n                            { "length": { "min": 4},\n                              "description": "Big enough." },\n                            { "allowed_pattern": "[a-zA-Z0-9]+",\n                              "description": "Only letters." }\n                        ]\n                    }\n                    ', expected={'Type': 'String', 'Description': 'Name of SSH key pair', 'MinLength': 4, 'AllowedPattern': '[a-zA-Z0-9]+', 'ConstraintDescription': 'Big enough. Only letters.', 'NoEcho': 'false', 'Label': 'KeyName'})), ('constraint_custom_hot', dict(template=base_template_hot, param_name='KeyName', param='\n                    "KeyName": {\n                        "type": "string",\n                        "description": "Public Network",\n                        "constraints": [\n                            { "custom_constraint": "neutron.network" }\n                        ]\n                    }\n                    ', expected={'Type': 'String', 'Description': 'Public Network', 'NoEcho': 'false', 'Label': 'KeyName', 'CustomConstraint': 'neutron.network'}))]

    def test_format_validate_parameter(self):
        """Test format of a parameter."""
        t = template_format.parse(self.template % self.param)
        tmpl = template.Template(t)
        tmpl_params = cfn_param.CfnParameters(None, tmpl)
        tmpl_params.validate(validate_value=False)
        param = tmpl_params.params[self.param_name]
        param_formated = api.format_validate_parameter(param)
        self.assertEqual(self.expected, param_formated)