import codecs
import os
import pipes
import re
import subprocess
import tempfile
from humanfriendly.terminal import (
from coloredlogs.converter.colors import (
def encode_whitespace(text, tabsize=4):
    """
    Encode whitespace so that web browsers properly render it.

    :param text: The plain text (a string).
    :param tabsize: Refer to :func:`str.expandtabs()` for details.
    :returns: The text converted to HTML (a string).

    The purpose of this function is to encode whitespace in such a way that web
    browsers render the same whitespace regardless of whether 'preformatted'
    styling is used (by wrapping the text in a ``<pre>...</pre>`` element).

    .. note:: While the string manipulation performed by this function is
              specifically intended not to corrupt the HTML generated by
              :func:`convert()` it definitely does have the potential to
              corrupt HTML from other sources. You have been warned :-).
    """
    text = text.replace('\r\n', '\n')
    text = text.replace('\n', '<br>\n')
    text = text.expandtabs(tabsize)
    text = re.sub(INDENT_PATTERN, encode_whitespace_cb, text)
    text = re.sub(TAG_INDENT_PATTERN, '\\1&nbsp;', text)
    text = re.sub(' {2,}', encode_whitespace_cb, text)
    return text