import datetime
import decimal
import re
import struct
from .base import _MSDateTime
from .base import _MSUnicode
from .base import _MSUnicodeText
from .base import BINARY
from .base import DATETIMEOFFSET
from .base import MSDialect
from .base import MSExecutionContext
from .base import VARBINARY
from .json import JSON as _MSJson
from .json import JSONIndexType as _MSJsonIndexType
from .json import JSONPathType as _MSJsonPathType
from ... import exc
from ... import types as sqltypes
from ... import util
from ...connectors.pyodbc import PyODBCConnector
from ...engine import cursor as _cursor
class MSExecutionContext_pyodbc(MSExecutionContext):
    _embedded_scope_identity = False

    def pre_exec(self):
        """where appropriate, issue "select scope_identity()" in the same
        statement.

        Background on why "scope_identity()" is preferable to "@@identity":
        https://msdn.microsoft.com/en-us/library/ms190315.aspx

        Background on why we attempt to embed "scope_identity()" into the same
        statement as the INSERT:
        https://code.google.com/p/pyodbc/wiki/FAQs#How_do_I_retrieve_autogenerated/identity_values?

        """
        super().pre_exec()
        if self._select_lastrowid and self.dialect.use_scope_identity and len(self.parameters[0]):
            self._embedded_scope_identity = True
            self.statement += '; select scope_identity()'

    def post_exec(self):
        if self._embedded_scope_identity:
            while True:
                try:
                    rows = self.cursor.fetchall()
                except self.dialect.dbapi.Error:
                    self.cursor.nextset()
                else:
                    if not rows:
                        self.cursor.nextset()
                        continue
                    row = rows[0]
                    break
            self._lastrowid = int(row[0])
            self.cursor_fetch_strategy = _cursor._NO_CURSOR_DML
        else:
            super().post_exec()