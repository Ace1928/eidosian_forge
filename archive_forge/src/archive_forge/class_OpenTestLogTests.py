from __future__ import annotations
import locale
import os
import sys
from io import StringIO
from typing import Generator
from zope.interface import implementer
from hamcrest import assert_that, equal_to
from twisted.internet.base import DelayedCall
from twisted.internet.interfaces import IProcessTransport
from twisted.python import filepath
from twisted.python.failure import Failure
from twisted.trial import util
from twisted.trial.unittest import SynchronousTestCase
from twisted.trial.util import (
class OpenTestLogTests(SynchronousTestCase):
    """
    Tests for C{openTestLog}.
    """

    def test_utf8(self) -> None:
        """
        The log file is opened in text mode and uses UTF-8 for encoding.
        """
        currentLocale = locale.getlocale()
        self.addCleanup(locale.setlocale, locale.LC_ALL, currentLocale)
        locale.setlocale(locale.LC_ALL, ('C', 'ascii'))
        text = 'Here comes the â˜‰'
        p = filepath.FilePath(self.mktemp())
        with openTestLog(p) as f:
            f.write(text)
        with open(p.path, 'rb') as f:
            written = f.read()
        assert_that(text.encode('utf-8'), equal_to(written))

    def test_append(self) -> None:
        """
        The log file is opened in append mode so if runner configuration specifies
        an existing log file its contents are not wiped out.
        """
        existingText = 'Hello, world.\n '
        newText = 'Goodbye, world.\n'
        expected = f'Hello, world.{os.linesep} Goodbye, world.{os.linesep}'
        p = filepath.FilePath(self.mktemp())
        with openTestLog(p) as f:
            f.write(existingText)
        with openTestLog(p) as f:
            f.write(newText)
        assert_that(p.getContent().decode('utf-8'), equal_to(expected))