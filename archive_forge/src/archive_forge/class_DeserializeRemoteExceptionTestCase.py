import sys
from oslo_serialization import jsonutils
import testscenarios
import oslo_messaging
from oslo_messaging._drivers import common as exceptions
from oslo_messaging.tests import utils as test_utils
class DeserializeRemoteExceptionTestCase(test_utils.BaseTestCase):
    _standard_allowed = [__name__]
    scenarios = [('bog_standard', dict(allowed=_standard_allowed, clsname='Exception', modname=EXCEPTIONS_MODULE, cls=Exception, args=['test'], kwargs={}, str='test\ntraceback\ntraceback\n', remote_name='Exception', remote_args=('test\ntraceback\ntraceback\n',), remote_kwargs={})), ('different_python_versions', dict(allowed=_standard_allowed, clsname='Exception', modname=OTHER_EXCEPTIONS_MODULE, cls=Exception, args=['test'], kwargs={}, str='test\ntraceback\ntraceback\n', remote_name='Exception', remote_args=('test\ntraceback\ntraceback\n',), remote_kwargs={})), ('nova_style', dict(allowed=_standard_allowed, clsname='NovaStyleException', modname=__name__, cls=NovaStyleException, args=[], kwargs={}, str='test\ntraceback\ntraceback\n', remote_name='NovaStyleException_Remote', remote_args=('I am Nova',), remote_kwargs={})), ('nova_style_with_msg', dict(allowed=_standard_allowed, clsname='NovaStyleException', modname=__name__, cls=NovaStyleException, args=['testing'], kwargs={}, str='test\ntraceback\ntraceback\n', remote_name='NovaStyleException_Remote', remote_args=('testing',), remote_kwargs={})), ('kwargs_style', dict(allowed=_standard_allowed, clsname='KwargsStyleException', modname=__name__, cls=KwargsStyleException, args=[], kwargs={'who': 'Oslo'}, str='test\ntraceback\ntraceback\n', remote_name='KwargsStyleException_Remote', remote_args=('I am Oslo',), remote_kwargs={})), ('not_allowed', dict(allowed=[], clsname='NovaStyleException', modname=__name__, cls=oslo_messaging.RemoteError, args=[], kwargs={}, str='Remote error: NovaStyleException test\n[%r].' % 'traceback\ntraceback\n', msg='Remote error: NovaStyleException test\n[%r].' % 'traceback\ntraceback\n', remote_name='RemoteError', remote_args=(), remote_kwargs={'exc_type': 'NovaStyleException', 'value': 'test', 'traceback': 'traceback\ntraceback\n'})), ('unknown_module', dict(allowed=['notexist'], clsname='Exception', modname='notexist', cls=oslo_messaging.RemoteError, args=[], kwargs={}, str='Remote error: Exception test\n[%r].' % 'traceback\ntraceback\n', msg='Remote error: Exception test\n[%r].' % 'traceback\ntraceback\n', remote_name='RemoteError', remote_args=(), remote_kwargs={'exc_type': 'Exception', 'value': 'test', 'traceback': 'traceback\ntraceback\n'})), ('unknown_exception', dict(allowed=[], clsname='FarcicalError', modname=EXCEPTIONS_MODULE, cls=oslo_messaging.RemoteError, args=[], kwargs={}, str='Remote error: FarcicalError test\n[%r].' % 'traceback\ntraceback\n', msg='Remote error: FarcicalError test\n[%r].' % 'traceback\ntraceback\n', remote_name='RemoteError', remote_args=(), remote_kwargs={'exc_type': 'FarcicalError', 'value': 'test', 'traceback': 'traceback\ntraceback\n'})), ('unknown_kwarg', dict(allowed=[], clsname='Exception', modname=EXCEPTIONS_MODULE, cls=oslo_messaging.RemoteError, args=[], kwargs={'foobar': 'blaa'}, str='Remote error: Exception test\n[%r].' % 'traceback\ntraceback\n', msg='Remote error: Exception test\n[%r].' % 'traceback\ntraceback\n', remote_name='RemoteError', remote_args=(), remote_kwargs={'exc_type': 'Exception', 'value': 'test', 'traceback': 'traceback\ntraceback\n'})), ('system_exit', dict(allowed=[], clsname='SystemExit', modname=EXCEPTIONS_MODULE, cls=oslo_messaging.RemoteError, args=[], kwargs={}, str='Remote error: SystemExit test\n[%r].' % 'traceback\ntraceback\n', msg='Remote error: SystemExit test\n[%r].' % 'traceback\ntraceback\n', remote_name='RemoteError', remote_args=(), remote_kwargs={'exc_type': 'SystemExit', 'value': 'test', 'traceback': 'traceback\ntraceback\n'}))]

    def test_deserialize_remote_exception(self):
        failure = {'class': self.clsname, 'module': self.modname, 'message': 'test', 'tb': ['traceback\ntraceback\n'], 'args': self.args, 'kwargs': self.kwargs}
        serialized = jsonutils.dumps(failure)
        ex = exceptions.deserialize_remote_exception(serialized, self.allowed)
        self.assertIsInstance(ex, self.cls)
        self.assertEqual(self.remote_name, ex.__class__.__name__)
        self.assertEqual(self.str, str(ex))
        if hasattr(self, 'msg'):
            self.assertEqual(self.msg, str(ex))
            self.assertEqual((self.msg,) + self.remote_args, ex.args)
        else:
            self.assertEqual(self.remote_args, ex.args)