import os
from pathlib import Path
from nipype.interfaces.base import File, InputMultiPath, TraitedSpec, traits, isdefined
from nipype.interfaces.cat12.base import NestedCell, Cell
from nipype.interfaces.spm import SPMCommand
from nipype.interfaces.spm.base import SPMCommandInputSpec
from nipype.utils.filemanip import split_filename
class ExtractAdditionalSurfaceParameters(SPMCommand):
    """
    Additional surface parameters can be extracted that can be used for statistical analysis, such as:

    * Central surfaces
    * Surface area
    * Surface GM volume
    * Gyrification Index
    * Sulcus depth
    * Toro's gyrification index
    * Shaer's local gyrification index
    * Laplacian gyrification indices
    * Addicional surfaces
    * Measure normalization
    * Lazy processing

    http://www.neuro.uni-jena.de/cat12/CAT12-Manual.pdf#page=53

    Examples
    --------
    >>> # Set the left surface files, both will be processed
    >>> lh_path_central = 'lh.central.structural.gii'
    >>> # Put here all surface files generated by CAT12 Segment, this is only required if the this approach is putted in
    >>> surf_files = ['lh.sphere.reg.structural.gii', 'rh.sphere.reg.structural.gii', 'lh.sphere.structural.gii', 'rh.sphere.structural.gii', 'rh.central.structural.gii', 'lh.pbt.structural', 'rh.pbt.structural']
    >>> extract_additional_measures = ExtractAdditionalSurfaceParameters(left_central_surfaces=lh_path_central, surface_files=surf_files)
    >>> extract_additional_measures.run() # doctest: +SKIP

    """
    input_spec = ExtractAdditionalSurfaceParametersInputSpec
    output_spec = ExtractAdditionalSurfaceParametersOutputSpec

    def __init__(self, **inputs):
        _local_version = SPMCommand().version
        if _local_version and '12.' in _local_version:
            self._jobtype = 'tools'
            self._jobname = 'cat.stools.surfextract'
        super().__init__(**inputs)

    def _list_outputs(self):
        outputs = self._outputs().get()
        names_outputs = [(self.inputs.gyrification, 'gyrification'), (self.inputs.gmv, 'gmv'), (self.inputs.area, 'area'), (self.inputs.depth, 'depth'), (self.inputs.fractal_dimension, 'fractaldimension')]
        for filename in self.inputs.left_central_surfaces:
            pth, base, ext = split_filename(filename)
            original_filename = base.split('.', 2)[-1]
            for extracted_parameter, parameter_name in names_outputs:
                if extracted_parameter:
                    for hemisphere in ['rh', 'lh']:
                        all_files_hemisphere = hemisphere + '_extracted_files'
                        name_hemisphere = hemisphere + '_' + parameter_name
                        if not isdefined(outputs[name_hemisphere]):
                            outputs[name_hemisphere] = []
                        if not isdefined(outputs[all_files_hemisphere]):
                            outputs[all_files_hemisphere] = []
                        generated_filename = '.'.join([hemisphere, parameter_name, original_filename])
                        outputs[name_hemisphere].append(os.path.join(pth, generated_filename))
                        outputs[all_files_hemisphere].append(os.path.join(pth, generated_filename))
        return outputs

    def _format_arg(self, opt, spec, val):
        if opt == 'left_central_surfaces':
            return Cell2Str(val)
        return super(ExtractAdditionalSurfaceParameters, self)._format_arg(opt, spec, val)