import pyomo.common.unittest as unittest
from pyomo.common.log import LoggingIntercept
from pyomo.common.dependencies import numpy, numpy_available
from pyomo.core.expr.compare import assertExpressionsEqual
from pyomo.core.expr.numeric_expr import LinearExpression, MonomialTermExpression
from pyomo.core.expr import Expr_if, inequality, LinearExpression, NPV_SumExpression
import pyomo.repn.linear as linear
from pyomo.repn.linear import LinearRepn, LinearRepnVisitor
from pyomo.repn.util import InvalidNumber
from pyomo.environ import (
def test_expr_if(self):
    m = ConcreteModel()
    m.x = Var()
    m.y = Var()
    e = Expr_if(m.y >= 5, m.x, m.x ** 2)
    f = Expr_if(m.y == 5, m.x, m.x ** 2)
    g = Expr_if(inequality(3, m.y, 5), m.x, m.x ** 2)
    m.y.fix(2)
    cfg = VisitorConfig()
    repn = LinearRepnVisitor(*cfg).walk_expression(e)
    self.assertEqual(cfg.subexpr, {})
    self.assertEqual(cfg.var_map, {id(m.x): m.x})
    self.assertEqual(cfg.var_order, {id(m.x): 0})
    self.assertEqual(repn.multiplier, 1)
    self.assertEqual(repn.constant, 0)
    self.assertEqual(repn.linear, {})
    assertExpressionsEqual(self, repn.nonlinear, m.x ** 2)
    cfg = VisitorConfig()
    repn = LinearRepnVisitor(*cfg).walk_expression(f)
    self.assertEqual(cfg.subexpr, {})
    self.assertEqual(cfg.var_map, {id(m.x): m.x})
    self.assertEqual(cfg.var_order, {id(m.x): 0})
    self.assertEqual(repn.multiplier, 1)
    self.assertEqual(repn.constant, 0)
    self.assertEqual(repn.linear, {})
    assertExpressionsEqual(self, repn.nonlinear, m.x ** 2)
    cfg = VisitorConfig()
    repn = LinearRepnVisitor(*cfg).walk_expression(g)
    self.assertEqual(cfg.subexpr, {})
    self.assertEqual(cfg.var_map, {id(m.x): m.x})
    self.assertEqual(cfg.var_order, {id(m.x): 0})
    self.assertEqual(repn.multiplier, 1)
    self.assertEqual(repn.constant, 0)
    self.assertEqual(repn.linear, {})
    assertExpressionsEqual(self, repn.nonlinear, m.x ** 2)
    m.y.fix(5)
    cfg = VisitorConfig()
    repn = LinearRepnVisitor(*cfg).walk_expression(e)
    self.assertEqual(cfg.subexpr, {})
    self.assertEqual(cfg.var_map, {id(m.x): m.x})
    self.assertEqual(cfg.var_order, {id(m.x): 0})
    self.assertEqual(repn.multiplier, 1)
    self.assertEqual(repn.constant, 0)
    self.assertEqual(repn.linear, {id(m.x): 1})
    self.assertEqual(repn.nonlinear, None)
    cfg = VisitorConfig()
    repn = LinearRepnVisitor(*cfg).walk_expression(f)
    self.assertEqual(cfg.subexpr, {})
    self.assertEqual(cfg.var_map, {id(m.x): m.x})
    self.assertEqual(cfg.var_order, {id(m.x): 0})
    self.assertEqual(repn.multiplier, 1)
    self.assertEqual(repn.constant, 0)
    self.assertEqual(repn.linear, {id(m.x): 1})
    self.assertEqual(repn.nonlinear, None)
    cfg = VisitorConfig()
    repn = LinearRepnVisitor(*cfg).walk_expression(g)
    self.assertEqual(cfg.subexpr, {})
    self.assertEqual(cfg.var_map, {id(m.x): m.x})
    self.assertEqual(cfg.var_order, {id(m.x): 0})
    self.assertEqual(repn.multiplier, 1)
    self.assertEqual(repn.constant, 0)
    self.assertEqual(repn.linear, {id(m.x): 1})
    self.assertEqual(repn.nonlinear, None)
    m.y.fix(2)
    m.x.fix(3)
    cfg = VisitorConfig()
    repn = LinearRepnVisitor(*cfg).walk_expression(e)
    self.assertEqual(cfg.subexpr, {})
    self.assertEqual(cfg.var_map, {})
    self.assertEqual(cfg.var_order, {})
    self.assertEqual(repn.multiplier, 1)
    self.assertEqual(repn.constant, 9)
    self.assertEqual(repn.linear, {})
    self.assertEqual(repn.nonlinear, None)
    cfg = VisitorConfig()
    repn = LinearRepnVisitor(*cfg).walk_expression(f)
    self.assertEqual(cfg.subexpr, {})
    self.assertEqual(cfg.var_map, {})
    self.assertEqual(cfg.var_order, {})
    self.assertEqual(repn.multiplier, 1)
    self.assertEqual(repn.constant, 9)
    self.assertEqual(repn.linear, {})
    self.assertEqual(repn.nonlinear, None)
    cfg = VisitorConfig()
    repn = LinearRepnVisitor(*cfg).walk_expression(g)
    self.assertEqual(cfg.subexpr, {})
    self.assertEqual(cfg.var_map, {})
    self.assertEqual(cfg.var_order, {})
    self.assertEqual(repn.multiplier, 1)
    self.assertEqual(repn.constant, 9)
    self.assertEqual(repn.linear, {})
    self.assertEqual(repn.nonlinear, None)
    m.y.fix(5)
    m.x.fix(6)
    cfg = VisitorConfig()
    repn = LinearRepnVisitor(*cfg).walk_expression(e)
    self.assertEqual(cfg.subexpr, {})
    self.assertEqual(cfg.var_map, {})
    self.assertEqual(cfg.var_order, {})
    self.assertEqual(repn.multiplier, 1)
    self.assertEqual(repn.constant, 6)
    self.assertEqual(repn.linear, {})
    self.assertEqual(repn.nonlinear, None)
    cfg = VisitorConfig()
    repn = LinearRepnVisitor(*cfg).walk_expression(f)
    self.assertEqual(cfg.subexpr, {})
    self.assertEqual(cfg.var_map, {})
    self.assertEqual(cfg.var_order, {})
    self.assertEqual(repn.multiplier, 1)
    self.assertEqual(repn.constant, 6)
    self.assertEqual(repn.linear, {})
    self.assertEqual(repn.nonlinear, None)
    cfg = VisitorConfig()
    repn = LinearRepnVisitor(*cfg).walk_expression(g)
    self.assertEqual(cfg.subexpr, {})
    self.assertEqual(cfg.var_map, {})
    self.assertEqual(cfg.var_order, {})
    self.assertEqual(repn.multiplier, 1)
    self.assertEqual(repn.constant, 6)
    self.assertEqual(repn.linear, {})
    self.assertEqual(repn.nonlinear, None)
    m.y.fix(None)
    m.x.unfix()
    cfg = VisitorConfig()
    repn = LinearRepnVisitor(*cfg).walk_expression(e)
    self.assertEqual(cfg.subexpr, {})
    self.assertEqual(cfg.var_map, {id(m.x): m.x})
    self.assertEqual(cfg.var_order, {id(m.x): 0})
    self.assertEqual(repn.multiplier, 1)
    self.assertEqual(repn.constant, 0)
    self.assertEqual(repn.linear, {})
    assertExpressionsEqual(self, repn.nonlinear, Expr_if(IF=InvalidNumber(False), THEN=m.x, ELSE=m.x ** 2))
    cfg = VisitorConfig()
    repn = LinearRepnVisitor(*cfg).walk_expression(f)
    self.assertEqual(cfg.subexpr, {})
    self.assertEqual(cfg.var_map, {id(m.x): m.x})
    self.assertEqual(cfg.var_order, {id(m.x): 0})
    self.assertEqual(repn.multiplier, 1)
    self.assertEqual(repn.constant, 0)
    self.assertEqual(repn.linear, {})
    assertExpressionsEqual(self, repn.nonlinear, Expr_if(IF=InvalidNumber(False), THEN=m.x, ELSE=m.x ** 2))
    cfg = VisitorConfig()
    repn = LinearRepnVisitor(*cfg).walk_expression(g)
    self.assertEqual(cfg.subexpr, {})
    self.assertEqual(cfg.var_map, {id(m.x): m.x})
    self.assertEqual(cfg.var_order, {id(m.x): 0})
    self.assertEqual(repn.multiplier, 1)
    self.assertEqual(repn.constant, 0)
    self.assertEqual(repn.linear, {})
    assertExpressionsEqual(self, repn.nonlinear, Expr_if(IF=InvalidNumber(False), THEN=m.x, ELSE=m.x ** 2))
    m.y.unfix()
    cfg = VisitorConfig()
    repn = LinearRepnVisitor(*cfg).walk_expression(e)
    self.assertEqual(cfg.subexpr, {})
    self.assertEqual(cfg.var_map, {id(m.y): m.y, id(m.x): m.x})
    self.assertEqual(cfg.var_order, {id(m.y): 0, id(m.x): 1})
    self.assertEqual(repn.multiplier, 1)
    self.assertEqual(repn.constant, 0)
    self.assertEqual(repn.linear, {})
    assertExpressionsEqual(self, repn.nonlinear, Expr_if(IF=m.y >= 5, THEN=m.x, ELSE=m.x ** 2))
    cfg = VisitorConfig()
    repn = LinearRepnVisitor(*cfg).walk_expression(f)
    self.assertEqual(cfg.subexpr, {})
    self.assertEqual(cfg.var_map, {id(m.y): m.y, id(m.x): m.x})
    self.assertEqual(cfg.var_order, {id(m.y): 0, id(m.x): 1})
    self.assertEqual(repn.multiplier, 1)
    self.assertEqual(repn.constant, 0)
    self.assertEqual(repn.linear, {})
    assertExpressionsEqual(self, repn.nonlinear, Expr_if(IF=m.y == 5, THEN=m.x, ELSE=m.x ** 2))
    cfg = VisitorConfig()
    repn = LinearRepnVisitor(*cfg).walk_expression(g)
    self.assertEqual(cfg.subexpr, {})
    self.assertEqual(cfg.var_map, {id(m.y): m.y, id(m.x): m.x})
    self.assertEqual(cfg.var_order, {id(m.y): 0, id(m.x): 1})
    self.assertEqual(repn.multiplier, 1)
    self.assertEqual(repn.constant, 0)
    self.assertEqual(repn.linear, {})
    assertExpressionsEqual(self, repn.nonlinear, Expr_if(IF=inequality(3, m.y, 5), THEN=m.x, ELSE=m.x ** 2))
    h = Expr_if(1 / m.y >= 1, m.x, m.x ** 2)
    cfg = VisitorConfig()
    repn = LinearRepnVisitor(*cfg).walk_expression(h)
    self.assertEqual(cfg.subexpr, {})
    self.assertEqual(cfg.var_map, {id(m.x): m.x, id(m.y): m.y})
    self.assertEqual(cfg.var_order, {id(m.y): 0, id(m.x): 1})
    self.assertEqual(repn.multiplier, 1)
    self.assertEqual(repn.constant, 0)
    self.assertEqual(repn.linear, {})
    assertExpressionsEqual(self, repn.nonlinear, Expr_if(IF=1 / m.y >= 1, THEN=m.x, ELSE=m.x ** 2))
    m.y.fix(0)
    cfg = VisitorConfig()
    repn = LinearRepnVisitor(*cfg).walk_expression(h)
    self.assertEqual(cfg.subexpr, {})
    self.assertEqual(cfg.var_map, {id(m.x): m.x})
    self.assertEqual(cfg.var_order, {id(m.x): 0})
    self.assertEqual(repn.multiplier, 1)
    self.assertEqual(repn.constant, 0)
    self.assertEqual(repn.linear, {})
    assertExpressionsEqual(self, repn.nonlinear, Expr_if(IF=InvalidNumber(False), THEN=m.x, ELSE=m.x ** 2))