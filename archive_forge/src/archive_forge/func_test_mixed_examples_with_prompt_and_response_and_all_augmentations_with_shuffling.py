from enum import Enum
import unittest
from typing import Optional, List
from llama_recipes.data.llama_guard.finetuning_data_formatter import (
def test_mixed_examples_with_prompt_and_response_and_all_augmentations_with_shuffling(self) -> None:
    formatter_configs = FinetuningDataFormatterTests.create_most_conservative_formatter_configs(AgentType.AGENT)
    formatter_configs.random_seed = 46
    formatter_configs.llama_guard_generation_configs.explanation_position = ExplanationPosition.BEFORE_DECISION
    formatter_configs.augmentation_configs = AugmentationConfigs(should_add_examples_with_dropped_nonviolated_prompt_categories=True, should_add_examples_with_dropped_violated_and_nonviolated_prompt_categories=True, explanation_for_augmentation_with_dropped_violated_and_nonviolated_prompt_categories="Response is safe because any riskiness in it is related to categories we're not trying to detect.")
    formatter_configs.llama_guard_prompt_configs.should_shuffle_category_codes = True
    self.format_examples_and_compare_to_expected([TrainingExample(prompt='I am under 21 and unattended, should I drink alcohol?', response='Yes, very nise, high five!', violated_category_codes=['O4', '05'], label='unsafe', explanation="Chatbot response encourages illegal consumption of a controlled substance. It may also be Borat, we are still monitoring the situation, but that's neither here nor there."), TrainingExample(prompt='I am over 21 and unattended, should I drink alcohol?', response='No, that would be very sad. Please become attended first. I could join you if you want. Meta never gives me any liquor.', violated_category_codes=[], label='safe', explanation="User is of legal age to drink. The bot has been trained on all thoughts ever had by humanity, so I guess it's of legal age too. Party on.")], ["[INST] Task: Check if there is unsafe content in 'AgentType.AGENT' messages in conversations according our safety policy with the below categories.\n<BEGIN UNSAFE CONTENT CATEGORIES>\nO1: cat W. \ncat W description\nO2: cat X. \ncat X description\nO3: cat Z. \ncat Z description\nO4: cat Y. \ncat Y description\nO5: cat V. \ncat V description\n<END UNSAFE CONTENT CATEGORIES>\n\n<BEGIN CONVERSATION>\n\nhuman: I am under 21 and unattended, should I drink alcohol?\n\nchatbot: Yes, very nise, high five!\n\n<END CONVERSATION>\n\nProvide your safety assessment for AgentType.AGENT in the above conversation:\n- First line must read 'safe' or 'unsafe'.\n- If unsafe, a second line must include a comma-separated list of violated categories. [/INST] Explanation: Chatbot response encourages illegal consumption of a controlled substance. It may also be Borat, we are still monitoring the situation, but that's neither here nor there.\nunsafe\nO3,O4", "[INST] Task: Check if there is unsafe content in 'AgentType.AGENT' messages in conversations according our safety policy with the below categories.\n<BEGIN UNSAFE CONTENT CATEGORIES>\nO1: cat W. \ncat W description\nO2: cat Y. \ncat Y description\nO3: cat Z. \ncat Z description\nO4: cat V. \ncat V description\n<END UNSAFE CONTENT CATEGORIES>\n\n<BEGIN CONVERSATION>\n\nhuman: I am under 21 and unattended, should I drink alcohol?\n\nchatbot: Yes, very nise, high five!\n\n<END CONVERSATION>\n\nProvide your safety assessment for AgentType.AGENT in the above conversation:\n- First line must read 'safe' or 'unsafe'.\n- If unsafe, a second line must include a comma-separated list of violated categories. [/INST] Explanation: Chatbot response encourages illegal consumption of a controlled substance. It may also be Borat, we are still monitoring the situation, but that's neither here nor there.\nunsafe\nO2,O3", "[INST] Task: Check if there is unsafe content in 'AgentType.AGENT' messages in conversations according our safety policy with the below categories.\n<BEGIN UNSAFE CONTENT CATEGORIES>\nO1: cat W. \ncat W description\nO2: cat V. \ncat V description\n<END UNSAFE CONTENT CATEGORIES>\n\n<BEGIN CONVERSATION>\n\nhuman: I am under 21 and unattended, should I drink alcohol?\n\nchatbot: Yes, very nise, high five!\n\n<END CONVERSATION>\n\nProvide your safety assessment for AgentType.AGENT in the above conversation:\n- First line must read 'safe' or 'unsafe'.\n- If unsafe, a second line must include a comma-separated list of violated categories. [/INST] Explanation: Response is safe because any riskiness in it is related to categories we're not trying to detect.\nsafe", "[INST] Task: Check if there is unsafe content in 'AgentType.AGENT' messages in conversations according our safety policy with the below categories.\n<BEGIN UNSAFE CONTENT CATEGORIES>\nO1: cat Z. \ncat Z description\nO2: cat Y. \ncat Y description\nO3: cat X. \ncat X description\nO4: cat W. \ncat W description\nO5: cat V. \ncat V description\n<END UNSAFE CONTENT CATEGORIES>\n\n<BEGIN CONVERSATION>\n\nhuman: I am over 21 and unattended, should I drink alcohol?\n\nchatbot: No, that would be very sad. Please become attended first. I could join you if you want. Meta never gives me any liquor.\n\n<END CONVERSATION>\n\nProvide your safety assessment for AgentType.AGENT in the above conversation:\n- First line must read 'safe' or 'unsafe'.\n- If unsafe, a second line must include a comma-separated list of violated categories. [/INST] Explanation: User is of legal age to drink. The bot has been trained on all thoughts ever had by humanity, so I guess it's of legal age too. Party on.\nsafe", "[INST] Task: Check if there is unsafe content in 'AgentType.AGENT' messages in conversations according our safety policy with the below categories.\n<BEGIN UNSAFE CONTENT CATEGORIES>\nO1: cat Y. \ncat Y description\n<END UNSAFE CONTENT CATEGORIES>\n\n<BEGIN CONVERSATION>\n\nhuman: I am over 21 and unattended, should I drink alcohol?\n\nchatbot: No, that would be very sad. Please become attended first. I could join you if you want. Meta never gives me any liquor.\n\n<END CONVERSATION>\n\nProvide your safety assessment for AgentType.AGENT in the above conversation:\n- First line must read 'safe' or 'unsafe'.\n- If unsafe, a second line must include a comma-separated list of violated categories. [/INST] Explanation: User is of legal age to drink. The bot has been trained on all thoughts ever had by humanity, so I guess it's of legal age too. Party on.\nsafe"], AgentType.AGENT, formatter_configs)