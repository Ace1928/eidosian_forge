from __future__ import annotations
import collections
import fnmatch
import os
import re
import warnings
from collections import defaultdict
from typing import TYPE_CHECKING, Any
import numpy as np
from monty.io import zopen
from monty.json import MSONable
from pymatgen.core.structure import Structure
from pymatgen.electronic_structure.bandstructure import LobsterBandStructureSymmLine
from pymatgen.electronic_structure.core import Orbital, Spin
from pymatgen.electronic_structure.dos import Dos, LobsterCompleteDos
from pymatgen.io.vasp.inputs import Kpoints
from pymatgen.io.vasp.outputs import Vasprun, VolumetricData
from pymatgen.util.due import Doi, due
class NciCobiList:
    """
    Class to read NcICOBILIST (multi-center ICOBI) files generated by LOBSTER.

    Attributes:
        is_spin_polarized (bool): Boolean to indicate if the calculation is spin polarized.
        NciCobiList (dict): Dict containing the listfile data of the form:
        {bond: "number_of_atoms": number of atoms involved in the multi-center interaction,
                "ncicobi": {Spin.up: Nc-ICOBI(Ef) spin up, Spin.down: ...}},
                "interaction_type": type of the multi-center interaction
    """

    def __init__(self, filename: str | None='NcICOBILIST.lobster'):
        """
        Args:
            filename: Name of the NcICOBILIST file.
        """
        with zopen(filename, mode='rt') as file:
            data = file.read().split('\n')[1:-1]
        if len(data) == 0:
            raise OSError('NcICOBILIST file contains no data.')
        self.is_spin_polarized = 'spin' in data[len(data) // 2]
        self.orbital_wise = False
        for entry in data:
            if len(data) > 2 and 's]' in str(entry.split()[3:]):
                self.orbital_wise = True
                warnings.warn('This is an orbitalwise NcICOBILIST.lobster file. Currently, the orbitalwise information is not read!')
                break
        if self.orbital_wise:
            data_without_orbitals = []
            for line in data:
                if '_' not in str(line.split()[3:]) and 's]' not in str(line.split()[3:]):
                    data_without_orbitals += [line]
        else:
            data_without_orbitals = data
        if 'spin' in data_without_orbitals[len(data_without_orbitals) // 2]:
            n_bonds = len(data_without_orbitals) // 2
            if n_bonds == 0:
                raise OSError('NcICOBILIST file contains no data.')
        else:
            n_bonds = len(data_without_orbitals)
        self.list_labels = []
        self.list_n_atoms = []
        self.list_ncicobi = []
        self.list_interaction_type = []
        self.list_num = []
        for bond in range(n_bonds):
            line = data_without_orbitals[bond].split()
            ncicobi = {}
            label = f'{line[0]}'
            n_atoms = str(line[1])
            ncicobi[Spin.up] = float(line[2])
            interaction_type = str(line[3:]).replace("'", '').replace(' ', '')
            num = 1
            if self.is_spin_polarized:
                ncicobi[Spin.down] = float(data_without_orbitals[bond + n_bonds + 1].split()[2])
            self.list_labels += [label]
            self.list_n_atoms += [n_atoms]
            self.list_ncicobi += [ncicobi]
            self.list_interaction_type += [interaction_type]
            self.list_num += [num]

    @property
    def ncicobi_list(self) -> dict[Any, dict[str, Any]]:
        """
        Returns: ncicobilist.
        """
        ncicobi_list = {}
        for idx in range(len(self.list_labels)):
            ncicobi_list[str(idx + 1)] = {'number_of_atoms': int(self.list_n_atoms[idx]), 'ncicobi': self.list_ncicobi[idx], 'interaction_type': self.list_interaction_type[idx]}
        return ncicobi_list