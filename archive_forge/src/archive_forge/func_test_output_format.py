import re
import os
import numpy as np
import pytest
import cirq
from cirq.circuits.qasm_output import QasmTwoQubitGate, QasmUGate
from cirq.testing import consistent_qasm as cq
def test_output_format():

    def filter_unpredictable_numbers(text):
        return re.sub('u3\\(.+\\)', 'u3(<not-repeatable>)', text)
    qubits = tuple(_make_qubits(5))
    operations = _all_operations(*qubits)
    output = cirq.QasmOutput(operations, qubits, header='Generated from Cirq!', precision=5)
    assert filter_unpredictable_numbers(str(output)) == filter_unpredictable_numbers('// Generated from Cirq!\n\nOPENQASM 2.0;\ninclude "qelib1.inc";\n\n\n// Qubits: [q0, q1, q2, q3, q4]\nqreg q[5];\ncreg m_xX[1];\ncreg m_x_a[1];\ncreg m0[1];  // Measurement: x?\ncreg m_X[1];\ncreg m__x[1];\ncreg m_multi[3];\n\n\nid q[0];\nz q[0];\nrz(pi*0.625) q[0];\nrz(0) q[0];\ny q[0];\nry(pi*0.375) q[0];\nry(0) q[0];\nx q[0];\nrx(pi*0.875) q[0];\nrx(0) q[0];\nh q[0];\nid q[0];\nsx q[0];\nsxdg q[0];\ns q[0];\nsdg q[0];\nt q[0];\ntdg q[0];\nrx(pi*1.0) q[0];\nrx(pi*0.5) q[0];\nrx(pi*0.25) q[0];\nry(pi*1.0) q[0];\nry(pi*0.5) q[0];\nry(pi*0.25) q[0];\nrz(pi*1.0) q[0];\nrz(pi*0.5) q[0];\nrz(pi*0.25) q[0];\nu3(pi*1.5,pi*1.0,pi*0.25) q[0];\ncz q[0],q[1];\n\n// Gate: CZ**0.25\nu3(pi*0.5,pi*1.0,pi*0.75) q[0];\nu3(pi*0.5,pi*1.0,pi*0.25) q[1];\nsx q[0];\ncx q[0],q[1];\nrx(pi*0.375) q[0];\nry(pi*0.5) q[1];\ncx q[1],q[0];\nsxdg q[1];\ns q[1];\ncx q[0],q[1];\nu3(pi*0.5,pi*0.375,0) q[0];\nu3(pi*0.5,pi*0.875,0) q[1];\n\ncx q[0],q[1];\n\n// Gate: CNOT**0.5\nry(pi*-0.5) q[1];\nu3(pi*0.5,0,pi*0.25) q[0];\nu3(pi*0.5,0,pi*0.75) q[1];\nsx q[0];\ncx q[0],q[1];\nrx(pi*0.25) q[0];\nry(pi*0.5) q[1];\ncx q[1],q[0];\nsxdg q[1];\ns q[1];\ncx q[0],q[1];\nu3(pi*0.5,pi*1.0,pi*1.0) q[0];\nu3(pi*0.5,pi*0.5,pi*1.0) q[1];\nry(pi*0.5) q[1];\n\ncy q[0],q[1];\nch q[0],q[1];\nswap q[0],q[1];\n\n// Gate: SWAP**0.75\ncx q[0],q[1];\nry(pi*-0.5) q[0];\nu3(pi*0.5,0,pi*0.45919) q[1];\nu3(pi*0.5,0,pi*1.95919) q[0];\nsx q[1];\ncx q[1],q[0];\nrx(pi*0.125) q[1];\nry(pi*0.5) q[0];\ncx q[0],q[1];\nsxdg q[0];\ns q[0];\ncx q[1],q[0];\nu3(pi*0.5,pi*0.91581,pi*1.0) q[1];\nu3(pi*0.5,pi*1.41581,pi*1.0) q[0];\nry(pi*0.5) q[0];\ncx q[0],q[1];\n\n// Gate: CCZ\nh q[2];\nccx q[0],q[1],q[2];\nh q[2];\n\nccx q[0],q[1],q[2];\n\n// Gate: CCZ**0.5\nrz(pi*0.125) q[0];\nrz(pi*0.125) q[1];\nrz(pi*0.125) q[2];\ncx q[0],q[1];\ncx q[1],q[2];\nrz(pi*-0.125) q[1];\nrz(pi*0.125) q[2];\ncx q[0],q[1];\ncx q[1],q[2];\nrz(pi*-0.125) q[2];\ncx q[0],q[1];\ncx q[1],q[2];\nrz(pi*-0.125) q[2];\ncx q[0],q[1];\ncx q[1],q[2];\n\n// Gate: TOFFOLI**0.5\nh q[2];\nrz(pi*0.125) q[0];\nrz(pi*0.125) q[1];\nrz(pi*0.125) q[2];\ncx q[0],q[1];\ncx q[1],q[2];\nrz(pi*-0.125) q[1];\nrz(pi*0.125) q[2];\ncx q[0],q[1];\ncx q[1],q[2];\nrz(pi*-0.125) q[2];\ncx q[0],q[1];\ncx q[1],q[2];\nrz(pi*-0.125) q[2];\ncx q[0],q[1];\ncx q[1],q[2];\nh q[2];\n\ncswap q[0],q[1],q[2];\nid q[0];\n\n// Gate: I(3)\nid q[0];\nid q[1];\nid q[2];\n\n// Gate: ISWAP\ncx q[2],q[0];\nh q[2];\ncx q[0],q[2];\ns q[2];\ncx q[0],q[2];\nsdg q[2];\nh q[2];\ncx q[2],q[0];\n\nu3(pi*-0.25, pi*0.611, pi*-0.611) q[1];\nu2(pi*-0.167, pi*0.167) q[1];\nu2(pi*1.277, pi*-1.277) q[1];\nmeasure q[0] -> m_xX[0];\nmeasure q[2] -> m_x_a[0];\nmeasure q[1] -> m0[0];\nmeasure q[3] -> m_X[0];\nmeasure q[4] -> m__x[0];\nmeasure q[2] -> m_x_a[0];\n\n// Gate: cirq.MeasurementGate(3, cirq.MeasurementKey(name=\'multi\'), (False, True))\nmeasure q[1] -> m_multi[0];\nx q[2];  // Invert the following measurement\nmeasure q[2] -> m_multi[1];\nx q[2];  // Undo the inversion\nmeasure q[3] -> m_multi[2];\n\n// Example operation\n\n// Operation: ExampleCompositeOperation()\nx q[0];\n')