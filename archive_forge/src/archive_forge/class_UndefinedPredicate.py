from contextlib import contextmanager
import inspect
from sympy.core.symbol import Str
from sympy.core.sympify import _sympify
from sympy.logic.boolalg import Boolean, false, true
from sympy.multipledispatch.dispatcher import Dispatcher, str_signature
from sympy.utilities.exceptions import sympy_deprecation_warning
from sympy.utilities.iterables import is_sequence
from sympy.utilities.source import get_class
class UndefinedPredicate(Predicate):
    """
    Predicate without handler.

    Explanation
    ===========

    This predicate is generated by using ``Predicate`` directly for
    construction. It does not have a handler, and evaluating this with
    arguments is done by SAT solver.

    Examples
    ========

    >>> from sympy import Predicate, Q
    >>> Q.P = Predicate('P')
    >>> Q.P.func
    <class 'sympy.assumptions.assume.UndefinedPredicate'>
    >>> Q.P.name
    Str('P')

    """
    handler = None

    def __new__(cls, name, handlers=None):
        if not isinstance(name, Str):
            name = Str(name)
        obj = super(Boolean, cls).__new__(cls, name)
        obj.handlers = handlers or []
        return obj

    @property
    def name(self):
        return self.args[0]

    def _hashable_content(self):
        return (self.name,)

    def __getnewargs__(self):
        return (self.name,)

    def __call__(self, expr):
        return AppliedPredicate(self, expr)

    def add_handler(self, handler):
        sympy_deprecation_warning('\n            The AskHandler system is deprecated. Predicate.add_handler()\n            should be replaced with the multipledispatch handler of Predicate.\n            ', deprecated_since_version='1.8', active_deprecations_target='deprecated-askhandler')
        self.handlers.append(handler)

    def remove_handler(self, handler):
        sympy_deprecation_warning('\n            The AskHandler system is deprecated. Predicate.remove_handler()\n            should be replaced with the multipledispatch handler of Predicate.\n            ', deprecated_since_version='1.8', active_deprecations_target='deprecated-askhandler')
        self.handlers.remove(handler)

    def eval(self, args, assumptions=True):
        sympy_deprecation_warning('\n            The AskHandler system is deprecated. Evaluating UndefinedPredicate\n            objects should be replaced with the multipledispatch handler of\n            Predicate.\n            ', deprecated_since_version='1.8', active_deprecations_target='deprecated-askhandler', stacklevel=5)
        expr, = args
        res, _res = (None, None)
        mro = inspect.getmro(type(expr))
        for handler in self.handlers:
            cls = get_class(handler)
            for subclass in mro:
                eval_ = getattr(cls, subclass.__name__, None)
                if eval_ is None:
                    continue
                res = eval_(expr, assumptions)
                if res is None:
                    continue
                if _res is None:
                    _res = res
                elif _res != res:
                    raise ValueError('incompatible resolutors')
                break
        return res