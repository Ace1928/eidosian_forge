from typing import Optional, List
import pytest
import cirq
from cirq.transformers.transformer_primitives import MAPPED_CIRCUIT_OP_TAG
def test_map_operations_deep_subcircuits():
    q = cirq.LineQubit.range(5)
    c_orig = cirq.Circuit(cirq.CX(q[0], q[1]), cirq.CX(q[3], q[2]), cirq.CX(q[3], q[4]))
    c_orig_with_circuit_ops = cirq.Circuit(cirq.CircuitOperation(cirq.FrozenCircuit([cirq.CircuitOperation(cirq.FrozenCircuit(op)).repeat(2).with_tags('internal') for op in c_orig.all_operations()])).repeat(6).with_tags('external'))

    def map_func(op: cirq.Operation, _: int) -> cirq.OP_TREE:
        yield ([cirq.Z.on_each(*op.qubits), cirq.CX(*op.qubits), cirq.Z.on_each(*op.qubits)] if op.gate == cirq.CX else op)
    cirq.testing.assert_has_diagram(c_orig_with_circuit_ops, "\n      [       [ 0: ───@─── ]                                                               ]\n      [ 0: ───[       │    ]────────────────────────────────────────────────────────────── ]\n      [       [ 1: ───X─── ](loops=2)['internal']                                          ]\n      [       │                                                                            ]\n      [ 1: ───#2────────────────────────────────────────────────────────────────────────── ]\n      [                                                                                    ]\n      [       [ 2: ───X─── ]                                                               ]\n0: ───[ 2: ───[       │    ]────────────────────────────────────────────────────────────── ]────────────────────────\n      [       [ 3: ───@─── ](loops=2)['internal']                                          ]\n      [       │                                                                            ]\n      [       │                                     [ 3: ───@─── ]                         ]\n      [ 3: ───#2────────────────────────────────────[       │    ]──────────────────────── ]\n      [                                             [ 4: ───X─── ](loops=2)['internal']    ]\n      [                                             │                                      ]\n      [ 4: ─────────────────────────────────────────#2──────────────────────────────────── ](loops=6)['external']\n      │\n1: ───#2────────────────────────────────────────────────────────────────────────────────────────────────────────────\n      │\n2: ───#3────────────────────────────────────────────────────────────────────────────────────────────────────────────\n      │\n3: ───#4────────────────────────────────────────────────────────────────────────────────────────────────────────────\n      │\n4: ───#5────────────────────────────────────────────────────────────────────────────────────────────────────────────\n")
    c_mapped = cirq.map_operations(c_orig_with_circuit_ops, map_func, deep=True)
    for unroller in [cirq.unroll_circuit_op, cirq.unroll_circuit_op_greedy_earliest, cirq.unroll_circuit_op_greedy_frontier]:
        cirq.testing.assert_has_diagram(unroller(c_mapped, deep=True), "\n      [       [ 0: ───Z───@───Z─── ]                                                                       ]\n      [ 0: ───[           │        ]────────────────────────────────────────────────────────────────────── ]\n      [       [ 1: ───Z───X───Z─── ](loops=2)['internal']                                                  ]\n      [       │                                                                                            ]\n      [ 1: ───#2────────────────────────────────────────────────────────────────────────────────────────── ]\n      [                                                                                                    ]\n      [       [ 2: ───Z───X───Z─── ]                                                                       ]\n0: ───[ 2: ───[           │        ]────────────────────────────────────────────────────────────────────── ]────────────────────────\n      [       [ 3: ───Z───@───Z─── ](loops=2)['internal']                                                  ]\n      [       │                                                                                            ]\n      [       │                                             [ 3: ───Z───@───Z─── ]                         ]\n      [ 3: ───#2────────────────────────────────────────────[           │        ]──────────────────────── ]\n      [                                                     [ 4: ───Z───X───Z─── ](loops=2)['internal']    ]\n      [                                                     │                                              ]\n      [ 4: ─────────────────────────────────────────────────#2──────────────────────────────────────────── ](loops=6)['external']\n      │\n1: ───#2────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────\n      │\n2: ───#3────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────\n      │\n3: ───#4────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────\n      │\n4: ───#5────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────\n")