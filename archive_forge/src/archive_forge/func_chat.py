import importlib.util
import json
import os
import time
from dataclasses import dataclass
from typing import Dict
import requests
from huggingface_hub import HfFolder, hf_hub_download, list_spaces
from ..models.auto import AutoTokenizer
from ..utils import is_offline_mode, is_openai_available, is_torch_available, logging
from .base import TASK_MAPPING, TOOL_CONFIG_FILE, Tool, load_tool, supports_remote
from .prompts import CHAT_MESSAGE_PROMPT, download_prompt
from .python_interpreter import evaluate
def chat(self, task, *, return_code=False, remote=False, **kwargs):
    """
        Sends a new request to the agent in a chat. Will use the previous ones in its history.

        Args:
            task (`str`): The task to perform
            return_code (`bool`, *optional*, defaults to `False`):
                Whether to just return code and not evaluate it.
            remote (`bool`, *optional*, defaults to `False`):
                Whether or not to use remote tools (inference endpoints) instead of local ones.
            kwargs (additional keyword arguments, *optional*):
                Any keyword argument to send to the agent when evaluating the code.

        Example:

        ```py
        from transformers import HfAgent

        agent = HfAgent("https://api-inference.huggingface.co/models/bigcode/starcoder")
        agent.chat("Draw me a picture of rivers and lakes")

        agent.chat("Transform the picture so that there is a rock in there")
        ```
        """
    prompt = self.format_prompt(task, chat_mode=True)
    result = self.generate_one(prompt, stop=['Human:', '====='])
    self.chat_history = prompt + result.strip() + '\n'
    explanation, code = clean_code_for_chat(result)
    self.log(f'==Explanation from the agent==\n{explanation}')
    if code is not None:
        self.log(f'\n\n==Code generated by the agent==\n{code}')
        if not return_code:
            self.log('\n\n==Result==')
            self.cached_tools = resolve_tools(code, self.toolbox, remote=remote, cached_tools=self.cached_tools)
            self.chat_state.update(kwargs)
            return evaluate(code, self.cached_tools, self.chat_state, chat_mode=True)
        else:
            tool_code = get_tool_creation_code(code, self.toolbox, remote=remote)
            return f'{tool_code}\n{code}'