import gymnasium as gym
import logging
import numpy as np
import re
from typing import (
import tree  # pip install dm_tree
import ray.cloudpickle as pickle
from ray.rllib.models.preprocessors import ATARI_OBS_SHAPE
from ray.rllib.policy.policy import PolicySpec
from ray.rllib.policy.sample_batch import SampleBatch
from ray.rllib.utils.deprecation import Deprecated
from ray.rllib.utils.framework import try_import_tf
from ray.rllib.utils.typing import (
from ray.util import log_once
from ray.util.annotations import PublicAPI
@PublicAPI(stability='alpha')
def parse_policy_specs_from_checkpoint(path: str) -> Tuple[PartialAlgorithmConfigDict, Dict[str, PolicySpec], Dict[str, PolicyState]]:
    """Read and parse policy specifications from a checkpoint file.

    Args:
        path: Path to a policy checkpoint.

    Returns:
        A tuple of: base policy config, dictionary of policy specs, and
        dictionary of policy states.
    """
    with open(path, 'rb') as f:
        checkpoint_dict = pickle.load(f)
    w = pickle.loads(checkpoint_dict['worker'])
    policy_config = w['policy_config']
    assert policy_config.get('enable_connectors', False), 'load_policies_from_checkpoint only works for checkpoints generated by stacks with connectors enabled.'
    policy_states = w.get('policy_states', w['state'])
    serialized_policy_specs = w['policy_specs']
    policy_specs = {id: PolicySpec.deserialize(spec) for id, spec in serialized_policy_specs.items()}
    return (policy_config, policy_specs, policy_states)