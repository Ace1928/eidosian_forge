from __future__ import absolute_import, division, print_function
import re
def merge_interfaces(interfaces):
    """ to reduce commands generated by an edgeswitch module
        we take interfaces one by one and we try to merge them with neighbors if everyone has same commands to run
    """
    merged = {}
    for i, interface in interfaces.items():
        if interface.merged:
            continue
        interface.merged = True
        match = re.match('(\\d+)\\/(\\d+)', i)
        group = int(match.group(1))
        start = int(match.group(2))
        end = start
        while True:
            try:
                start = start - 1
                key = '{0}/{1}'.format(group, start)
                neighbor = interfaces[key]
                if not neighbor.merged and interface.has_same_commands(neighbor):
                    neighbor.merged = True
                else:
                    break
            except KeyError:
                break
        start = start + 1
        while True:
            try:
                end = end + 1
                key = '{0}/{1}'.format(group, end)
                neighbor = interfaces[key]
                if not neighbor.merged and interface.has_same_commands(neighbor):
                    neighbor.merged = True
                else:
                    break
            except KeyError:
                break
        end = end - 1
        if end == start:
            key = '{0}/{1}'.format(group, start)
        else:
            key = '{0}/{1}-{2}/{3}'.format(group, start, group, end)
        merged[key] = interface
    return merged