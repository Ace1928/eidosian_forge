import datetime
import difflib
import functools
import inspect
import json
import os
import re
import tempfile
import threading
import unittest
from typing import Any, Callable, Dict, List, Optional, Tuple, Union
import torch
import torch._dynamo
import torch.utils._pytree as pytree
from torch._dynamo.utils import clone_input
from torch._subclasses.schema_check_mode import SchemaCheckMode
from torch._utils_internal import get_file_path_2
from torch.overrides import TorchFunctionMode
from torch.testing._internal.optests import (
def maybe_raise_errors_on_exit(self) -> None:
    for qualname in self.seen_ops_to_errors.keys():
        option = self.failures_dict.get_status(qualname, self.test_name)
        if len(self.seen_ops_to_errors[qualname]) == 0:
            if should_update_failures_dict():
                self.failures_dict.set_status(qualname, self.test_name, 'xsuccess', comment='')
            elif option == 'xfail':
                raise OpCheckError(f'generate_opcheck_tests: Unexpected success for operator {qualname} on test {self.test_name}. This may mean that you have fixed this test failure. Please rerun the test with PYTORCH_OPCHECK_ACCEPT=1 to automatically update the test runner or manually remove the expected failure in the failure dict at {self.failures_dict_path}For more details, see {GDOC}')
            continue
    failed_ops = []
    for qualname in self.seen_ops_to_errors.keys():
        option = self.failures_dict.get_status(qualname, self.test_name)
        if option != 'xsuccess':
            continue
        if len(self.seen_ops_to_errors[qualname]) == 0:
            continue
        failed_ops.append(qualname)
    if not failed_ops:
        return
    if should_update_failures_dict():
        for op in failed_ops:
            self.failures_dict.set_status(op, self.test_name, 'xfail')
        return
    ex, op, args, kwargs = self.seen_ops_to_errors[failed_ops[0]][0]
    repro_command = generate_repro(self.test_util_name, op, args, kwargs, save_data=should_print_better_repro())
    raise OpCheckError(f'Test generated by `generate_opcheck_tests`, {self.test_name}, failed on operators {failed_ops}. This usually means that the operators are not implemented correctly and may lead to silently incorrect behavior. Set PYTORCH_OPCHECK_PRINT_BETTER_REPRO=1 for a standalone repro, or please see {GDOC} for more recommendations. To reproduce this problem locally, try to run the following:\n{repro_command}') from ex