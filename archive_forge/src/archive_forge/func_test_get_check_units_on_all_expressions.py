import math
import pickle
from pyomo.common.errors import PyomoException
import pyomo.common.unittest as unittest
from pyomo.environ import (
from pyomo.common.log import LoggingIntercept
from pyomo.util.check_units import assert_units_consistent, check_units_equivalent
from pyomo.core.expr import inequality
from pyomo.core.expr.numvalue import NumericConstant
import pyomo.core.expr as EXPR
from pyomo.core.base.units_container import (
from io import StringIO
def test_get_check_units_on_all_expressions(self):
    uc = units
    kg = uc.kg
    m = uc.m
    model = ConcreteModel()
    model.x = Var()
    model.y = Var()
    model.z = Var()
    model.p = Param(initialize=42.0, mutable=True)
    model.xkg = Var(units=kg)
    model.ym = Var(units=m)
    self._get_check_units_ok(3.0 * kg == 1.0 * kg, uc, 'kg', EXPR.EqualityExpression)
    self._get_check_units_fail(3.0 * kg == 2.0 * m, uc, EXPR.EqualityExpression)
    self._get_check_units_ok(3.0 * kg <= 1.0 * kg, uc, 'kg', EXPR.InequalityExpression)
    self._get_check_units_fail(3.0 * kg <= 2.0 * m, uc, EXPR.InequalityExpression)
    self._get_check_units_ok(3.0 * kg >= 1.0 * kg, uc, 'kg', EXPR.InequalityExpression)
    self._get_check_units_fail(3.0 * kg >= 2.0 * m, uc, EXPR.InequalityExpression)
    self._get_check_units_ok(inequality(3.0 * kg, 4.0 * kg, 5.0 * kg), uc, 'kg', EXPR.RangedExpression)
    self._get_check_units_fail(inequality(3.0 * m, 4.0 * kg, 5.0 * kg), uc, EXPR.RangedExpression)
    self._get_check_units_fail(inequality(3.0 * kg, 4.0 * m, 5.0 * kg), uc, EXPR.RangedExpression)
    self._get_check_units_fail(inequality(3.0 * kg, 4.0 * kg, 5.0 * m), uc, EXPR.RangedExpression)
    self._get_check_units_ok(3.0 * model.x * kg + 1.0 * model.y * kg + 3.65 * model.z * kg, uc, 'kg', EXPR.LinearExpression)
    self._get_check_units_fail(3.0 * model.x * kg + 1.0 * model.y * m + 3.65 * model.z * kg, uc, EXPR.LinearExpression)
    self._get_check_units_ok(3.0 * kg + 1.0 * kg + 2.0 * kg, uc, 'kg', EXPR.NPV_SumExpression)
    self._get_check_units_fail(3.0 * kg + 1.0 * kg + 2.0 * m, uc, EXPR.NPV_SumExpression)
    self._get_check_units_ok(model.x * kg * model.y * m, uc, 'kg*m', EXPR.ProductExpression)
    self._get_check_units_ok(3.0 * kg * 1.0 * m, uc, 'kg*m', EXPR.NPV_ProductExpression)
    self._get_check_units_ok(3.0 * kg * m, uc, 'kg*m', EXPR.NPV_ProductExpression)
    self._get_check_units_ok(model.x * kg, uc, 'kg', EXPR.MonomialTermExpression)
    self._get_check_units_ok(1.0 / (model.x * kg), uc, '1/kg', EXPR.DivisionExpression)
    self._get_check_units_ok(2.0 / kg, uc, '1/kg', EXPR.NPV_DivisionExpression)
    self._get_check_units_ok(model.x * kg / 1.0, uc, 'kg', EXPR.MonomialTermExpression)
    self._get_check_units_ok(kg / 2.0, uc, 'kg', EXPR.NPV_DivisionExpression)
    self._get_check_units_ok(model.y * m / (model.x * kg), uc, 'm/kg', EXPR.DivisionExpression)
    self._get_check_units_ok(m / kg, uc, 'm/kg', EXPR.NPV_DivisionExpression)
    self._get_check_units_ok(kg ** 2, uc, 'kg**2', EXPR.NPV_PowExpression)
    self._get_check_units_ok(model.p ** model.p, uc, 'dimensionless', EXPR.NPV_PowExpression)
    self._get_check_units_ok(kg ** model.p, uc, 'kg**42', EXPR.NPV_PowExpression)
    self._get_check_units_ok((model.x * kg ** 2) ** 3, uc, 'kg**6', EXPR.PowExpression)
    self._get_check_units_fail(kg ** model.x, uc, EXPR.PowExpression, UnitsError)
    self._get_check_units_fail(model.x ** kg, uc, EXPR.PowExpression, UnitsError)
    self._get_check_units_ok(kg ** 2, uc, 'kg**2', EXPR.NPV_PowExpression)
    self._get_check_units_fail(3.0 ** kg, uc, EXPR.NPV_PowExpression, UnitsError)
    self._get_check_units_ok(-(kg * model.x * model.y), uc, 'kg', EXPR.NegationExpression)
    self._get_check_units_ok(-kg, uc, 'kg', EXPR.NPV_NegationExpression)
    self._get_check_units_ok(abs(kg * model.x), uc, 'kg', EXPR.AbsExpression)
    self._get_check_units_ok(abs(kg), uc, 'kg', EXPR.NPV_AbsExpression)
    self._get_check_units_ok(log(3.0 * model.x), uc, 'dimensionless', EXPR.UnaryFunctionExpression)
    self._get_check_units_fail(log(3.0 * kg * model.x), uc, EXPR.UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(log(3.0 * model.p), uc, 'dimensionless', EXPR.NPV_UnaryFunctionExpression)
    self._get_check_units_fail(log(3.0 * kg), uc, EXPR.NPV_UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(log10(3.0 * model.x), uc, 'dimensionless', EXPR.UnaryFunctionExpression)
    self._get_check_units_fail(log10(3.0 * kg * model.x), uc, EXPR.UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(log10(3.0 * model.p), uc, 'dimensionless', EXPR.NPV_UnaryFunctionExpression)
    self._get_check_units_fail(log10(3.0 * kg), uc, EXPR.NPV_UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(sin(3.0 * model.x), uc, 'dimensionless', EXPR.UnaryFunctionExpression)
    self._get_check_units_ok(sin(3.0 * model.x * uc.radians), uc, 'dimensionless', EXPR.UnaryFunctionExpression)
    self._get_check_units_fail(sin(3.0 * kg * model.x), uc, EXPR.UnaryFunctionExpression, UnitsError)
    self._get_check_units_fail(sin(3.0 * kg * model.x * uc.kg), uc, EXPR.UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(sin(3.0 * model.p * uc.radians), uc, 'dimensionless', EXPR.NPV_UnaryFunctionExpression)
    self._get_check_units_fail(sin(3.0 * kg), uc, EXPR.NPV_UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(cos(3.0 * model.x * uc.radians), uc, 'dimensionless', EXPR.UnaryFunctionExpression)
    self._get_check_units_fail(cos(3.0 * kg * model.x), uc, EXPR.UnaryFunctionExpression, UnitsError)
    self._get_check_units_fail(cos(3.0 * kg * model.x * uc.kg), uc, EXPR.UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(cos(3.0 * model.p * uc.radians), uc, 'dimensionless', EXPR.NPV_UnaryFunctionExpression)
    self._get_check_units_fail(cos(3.0 * kg), uc, EXPR.NPV_UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(tan(3.0 * model.x * uc.radians), uc, 'dimensionless', EXPR.UnaryFunctionExpression)
    self._get_check_units_fail(tan(3.0 * kg * model.x), uc, EXPR.UnaryFunctionExpression, UnitsError)
    self._get_check_units_fail(tan(3.0 * kg * model.x * uc.kg), uc, EXPR.UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(tan(3.0 * model.p * uc.radians), uc, 'dimensionless', EXPR.NPV_UnaryFunctionExpression)
    self._get_check_units_fail(tan(3.0 * kg), uc, EXPR.NPV_UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(sinh(3.0 * model.x * uc.radians), uc, 'dimensionless', EXPR.UnaryFunctionExpression)
    self._get_check_units_fail(sinh(3.0 * kg * model.x), uc, EXPR.UnaryFunctionExpression, UnitsError)
    self._get_check_units_fail(sinh(3.0 * kg * model.x * uc.kg), uc, EXPR.UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(sinh(3.0 * model.p * uc.radians), uc, 'dimensionless', EXPR.NPV_UnaryFunctionExpression)
    self._get_check_units_fail(sinh(3.0 * kg), uc, EXPR.NPV_UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(cosh(3.0 * model.x * uc.radians), uc, 'dimensionless', EXPR.UnaryFunctionExpression)
    self._get_check_units_fail(cosh(3.0 * kg * model.x), uc, EXPR.UnaryFunctionExpression, UnitsError)
    self._get_check_units_fail(cosh(3.0 * kg * model.x * uc.kg), uc, EXPR.UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(cosh(3.0 * model.p * uc.radians), uc, 'dimensionless', EXPR.NPV_UnaryFunctionExpression)
    self._get_check_units_fail(cosh(3.0 * kg), uc, EXPR.NPV_UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(tanh(3.0 * model.x * uc.radians), uc, 'dimensionless', EXPR.UnaryFunctionExpression)
    self._get_check_units_fail(tanh(3.0 * kg * model.x), uc, EXPR.UnaryFunctionExpression, UnitsError)
    self._get_check_units_fail(tanh(3.0 * kg * model.x * uc.kg), uc, EXPR.UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(tanh(3.0 * model.p * uc.radians), uc, 'dimensionless', EXPR.NPV_UnaryFunctionExpression)
    self._get_check_units_fail(tanh(3.0 * kg), uc, EXPR.NPV_UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(asin(3.0 * model.x), uc, 'rad', EXPR.UnaryFunctionExpression)
    self._get_check_units_fail(asin(3.0 * kg * model.x), uc, EXPR.UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(asin(3.0 * model.p), uc, 'rad', EXPR.NPV_UnaryFunctionExpression)
    self._get_check_units_fail(asin(3.0 * model.p * kg), uc, EXPR.NPV_UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(acos(3.0 * model.x), uc, 'rad', EXPR.UnaryFunctionExpression)
    self._get_check_units_fail(acos(3.0 * kg * model.x), uc, EXPR.UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(acos(3.0 * model.p), uc, 'rad', EXPR.NPV_UnaryFunctionExpression)
    self._get_check_units_fail(acos(3.0 * model.p * kg), uc, EXPR.NPV_UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(atan(3.0 * model.x), uc, 'rad', EXPR.UnaryFunctionExpression)
    self._get_check_units_fail(atan(3.0 * kg * model.x), uc, EXPR.UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(atan(3.0 * model.p), uc, 'rad', EXPR.NPV_UnaryFunctionExpression)
    self._get_check_units_fail(atan(3.0 * model.p * kg), uc, EXPR.NPV_UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(exp(3.0 * model.x), uc, 'dimensionless', EXPR.UnaryFunctionExpression)
    self._get_check_units_fail(exp(3.0 * kg * model.x), uc, EXPR.UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(exp(3.0 * model.p), uc, 'dimensionless', EXPR.NPV_UnaryFunctionExpression)
    self._get_check_units_fail(exp(3.0 * kg), uc, EXPR.NPV_UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(sqrt(3.0 * model.x), uc, 'dimensionless', EXPR.UnaryFunctionExpression)
    self._get_check_units_ok(sqrt(3.0 * model.x * kg ** 2), uc, 'kg', EXPR.UnaryFunctionExpression)
    self._get_check_units_ok(sqrt(3.0 * model.x * kg), uc, 'kg**0.5', EXPR.UnaryFunctionExpression)
    self._get_check_units_ok(sqrt(3.0 * model.p), uc, 'dimensionless', EXPR.NPV_UnaryFunctionExpression)
    self._get_check_units_ok(sqrt(3.0 * model.p * kg ** 2), uc, 'kg', EXPR.NPV_UnaryFunctionExpression)
    self._get_check_units_ok(sqrt(3.0 * model.p * kg), uc, 'kg**0.5', EXPR.NPV_UnaryFunctionExpression)
    self._get_check_units_ok(asinh(3.0 * model.x), uc, 'rad', EXPR.UnaryFunctionExpression)
    self._get_check_units_fail(asinh(3.0 * kg * model.x), uc, EXPR.UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(asinh(3.0 * model.p), uc, 'rad', EXPR.NPV_UnaryFunctionExpression)
    self._get_check_units_fail(asinh(3.0 * model.p * kg), uc, EXPR.NPV_UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(acosh(3.0 * model.x), uc, 'rad', EXPR.UnaryFunctionExpression)
    self._get_check_units_fail(acosh(3.0 * kg * model.x), uc, EXPR.UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(acosh(3.0 * model.p), uc, 'rad', EXPR.NPV_UnaryFunctionExpression)
    self._get_check_units_fail(acosh(3.0 * model.p * kg), uc, EXPR.NPV_UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(atanh(3.0 * model.x), uc, 'rad', EXPR.UnaryFunctionExpression)
    self._get_check_units_fail(atanh(3.0 * kg * model.x), uc, EXPR.UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(atanh(3.0 * model.p), uc, 'rad', EXPR.NPV_UnaryFunctionExpression)
    self._get_check_units_fail(atanh(3.0 * model.p * kg), uc, EXPR.NPV_UnaryFunctionExpression, UnitsError)
    self._get_check_units_ok(ceil(kg * model.x), uc, 'kg', EXPR.UnaryFunctionExpression)
    self._get_check_units_ok(ceil(kg), uc, 'kg', EXPR.NPV_UnaryFunctionExpression)
    self._get_check_units_ok(floor(kg * model.x), uc, 'kg', EXPR.UnaryFunctionExpression)
    self._get_check_units_ok(floor(kg), uc, 'kg', EXPR.NPV_UnaryFunctionExpression)
    self._get_check_units_ok(EXPR.Expr_if(IF=model.x * kg + kg >= 2.0 * kg, THEN=model.x * kg, ELSE=model.y * kg), uc, 'kg', EXPR.Expr_ifExpression)
    self._get_check_units_ok(EXPR.Expr_if(IF=model.x >= 2.0, THEN=model.x * kg, ELSE=model.y * kg), uc, 'kg', EXPR.Expr_ifExpression)
    self._get_check_units_ok(EXPR.Expr_if(IF=model.x * kg + kg >= 2.0 * kg, THEN=model.x, ELSE=model.x), uc, 'dimensionless', EXPR.Expr_ifExpression)
    self._get_check_units_fail(EXPR.Expr_if(IF=model.x >= 2.0, THEN=model.x * m, ELSE=model.y * kg), uc, EXPR.Expr_ifExpression)
    self._get_check_units_fail(EXPR.Expr_if(IF=model.x >= 2.0, THEN=model.p * m, ELSE=model.p * kg), uc, EXPR.Expr_ifExpression)
    self._get_check_units_fail(EXPR.Expr_if(IF=model.x >= 2.0, THEN=m, ELSE=kg), uc, EXPR.Expr_ifExpression)
    model.S = Set()
    i = EXPR.IndexTemplate(model.S)
    j = EXPR.IndexTemplate(model.S)
    self._get_check_units_ok(i, uc, 'dimensionless', EXPR.IndexTemplate)
    model.mat = Var(model.S, model.S)
    self._get_check_units_ok(model.mat[i, j + 1], uc, 'dimensionless', EXPR.Numeric_GetItemExpression)
    model.ef = ExternalFunction(python_callback_function)
    self._get_check_units_ok(model.ef(model.x, model.y), uc, 'dimensionless', EXPR.ExternalFunctionExpression)
    self._get_check_units_ok(model.ef(1.0, 2.0), uc, 'dimensionless', EXPR.NPV_ExternalFunctionExpression)
    self._get_check_units_fail(model.ef(model.x * kg, model.y), uc, EXPR.ExternalFunctionExpression, UnitsError)
    self._get_check_units_fail(model.ef(2.0 * kg, 1.0), uc, EXPR.NPV_ExternalFunctionExpression, UnitsError)
    model.ef2 = ExternalFunction(python_callback_function, units=uc.kg)
    self._get_check_units_ok(model.ef2(model.x, model.y), uc, 'kg', EXPR.ExternalFunctionExpression)
    self._get_check_units_ok(model.ef2(1.0, 2.0), uc, 'kg', EXPR.NPV_ExternalFunctionExpression)
    self._get_check_units_fail(model.ef2(model.x * kg, model.y), uc, EXPR.ExternalFunctionExpression, UnitsError)
    self._get_check_units_fail(model.ef2(2.0 * kg, 1.0), uc, EXPR.NPV_ExternalFunctionExpression, UnitsError)
    model.ef3 = ExternalFunction(python_callback_function, units=uc.kg, arg_units=[uc.kg, uc.m])
    self._get_check_units_fail(model.ef3(model.x, model.y), uc, EXPR.ExternalFunctionExpression)
    self._get_check_units_fail(model.ef3(1.0, 2.0), uc, EXPR.NPV_ExternalFunctionExpression)
    self._get_check_units_fail(model.ef3(model.x * kg, model.y), uc, EXPR.ExternalFunctionExpression, UnitsError)
    self._get_check_units_fail(model.ef3(2.0 * kg, 1.0), uc, EXPR.NPV_ExternalFunctionExpression, UnitsError)
    self._get_check_units_ok(model.ef3(2.0 * kg, 1.0 * uc.m), uc, 'kg', EXPR.NPV_ExternalFunctionExpression)
    self._get_check_units_ok(model.ef3(model.x * kg, model.y * m), uc, 'kg', EXPR.ExternalFunctionExpression)
    self._get_check_units_ok(model.ef3(model.xkg, model.ym), uc, 'kg', EXPR.ExternalFunctionExpression)
    self._get_check_units_fail(model.ef3(model.ym, model.xkg), uc, EXPR.ExternalFunctionExpression, InconsistentUnitsError)