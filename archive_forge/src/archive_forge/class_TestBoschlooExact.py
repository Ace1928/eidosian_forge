from itertools import product
import numpy as np
import random
import functools
import pytest
from numpy.testing import (assert_, assert_equal, assert_allclose,
from pytest import raises as assert_raises
import scipy.stats as stats
from scipy.stats import distributions
from scipy.stats._hypotests import (epps_singleton_2samp, cramervonmises,
from scipy.stats._mannwhitneyu import mannwhitneyu, _mwu_state
from .common_tests import check_named_results
from scipy._lib._testutils import _TestPythranFunc
class TestBoschlooExact:
    """Some tests to show that boschloo_exact() works correctly."""
    ATOL = 1e-07

    @pytest.mark.parametrize('input_sample,expected', [([[2, 7], [8, 2]], (0.01852173, 0.009886142)), ([[5, 1], [10, 10]], (0.9782609, 0.9450994)), ([[5, 16], [20, 25]], (0.08913823, 0.05827348)), ([[10, 5], [10, 1]], (0.1652174, 0.08565611)), ([[5, 0], [1, 4]], (1, 1)), ([[0, 1], [3, 2]], (0.5, 0.34375)), ([[2, 7], [8, 2]], (0.01852173, 0.009886142)), ([[7, 12], [8, 3]], (0.06406797, 0.03410916)), ([[10, 24], [25, 37]], (0.2009359, 0.1512882))])
    def test_less(self, input_sample, expected):
        """The expected values have been generated by R, using a resolution
        for the nuisance parameter of 1e-8 :
        ```R
        library(Exact)
        options(digits=10)
        data <- matrix(c(43, 10, 40, 39), 2, 2, byrow=TRUE)
        a = exact.test(data, method="Boschloo", alternative="less",
                       tsmethod="central", np.interval=TRUE, beta=1e-8)
        ```
        """
        res = boschloo_exact(input_sample, alternative='less')
        statistic, pvalue = (res.statistic, res.pvalue)
        assert_allclose([statistic, pvalue], expected, atol=self.ATOL)

    @pytest.mark.parametrize('input_sample,expected', [([[43, 40], [10, 39]], (0.0002875544, 0.0001615562)), ([[2, 7], [8, 2]], (0.9990149, 0.9918327)), ([[5, 1], [10, 10]], (0.1652174, 0.09008534)), ([[5, 15], [20, 20]], (0.9849087, 0.9706997)), ([[5, 16], [20, 25]], (0.972349, 0.9524124)), ([[5, 0], [1, 4]], (0.02380952, 0.006865367)), ([[0, 1], [3, 2]], (1, 1)), ([[0, 2], [6, 4]], (1, 1)), ([[2, 7], [8, 2]], (0.9990149, 0.9918327)), ([[7, 12], [8, 3]], (0.9895302, 0.9771215)), ([[10, 24], [25, 37]], (0.9012936, 0.8633275))])
    def test_greater(self, input_sample, expected):
        """The expected values have been generated by R, using a resolution
        for the nuisance parameter of 1e-8 :
        ```R
        library(Exact)
        options(digits=10)
        data <- matrix(c(43, 10, 40, 39), 2, 2, byrow=TRUE)
        a = exact.test(data, method="Boschloo", alternative="greater",
                       tsmethod="central", np.interval=TRUE, beta=1e-8)
        ```
        """
        res = boschloo_exact(input_sample, alternative='greater')
        statistic, pvalue = (res.statistic, res.pvalue)
        assert_allclose([statistic, pvalue], expected, atol=self.ATOL)

    @pytest.mark.parametrize('input_sample,expected', [([[43, 40], [10, 39]], (0.0002875544, 0.0003231115)), ([[2, 7], [8, 2]], (0.01852173, 0.01977228)), ([[5, 1], [10, 10]], (0.1652174, 0.1801707)), ([[5, 16], [20, 25]], (0.08913823, 0.116547)), ([[5, 0], [1, 4]], (0.02380952, 0.01373073)), ([[0, 1], [3, 2]], (0.5, 0.6875)), ([[2, 7], [8, 2]], (0.01852173, 0.01977228)), ([[7, 12], [8, 3]], (0.06406797, 0.06821831))])
    def test_two_sided(self, input_sample, expected):
        """The expected values have been generated by R, using a resolution
        for the nuisance parameter of 1e-8 :
        ```R
        library(Exact)
        options(digits=10)
        data <- matrix(c(43, 10, 40, 39), 2, 2, byrow=TRUE)
        a = exact.test(data, method="Boschloo", alternative="two.sided",
                       tsmethod="central", np.interval=TRUE, beta=1e-8)
        ```
        """
        res = boschloo_exact(input_sample, alternative='two-sided', n=64)
        statistic, pvalue = (res.statistic, res.pvalue)
        assert_allclose([statistic, pvalue], expected, atol=self.ATOL)

    def test_raises(self):
        error_msg = 'Number of points `n` must be strictly positive, found 0'
        with assert_raises(ValueError, match=error_msg):
            boschloo_exact([[1, 2], [3, 4]], n=0)
        error_msg = 'The input `table` must be of shape \\(2, 2\\).'
        with assert_raises(ValueError, match=error_msg):
            boschloo_exact(np.arange(6).reshape(2, 3))
        error_msg = 'All values in `table` must be nonnegative.'
        with assert_raises(ValueError, match=error_msg):
            boschloo_exact([[-1, 2], [3, 4]])
        error_msg = "`alternative` should be one of \\('two-sided', 'less', 'greater'\\), found .*"
        with assert_raises(ValueError, match=error_msg):
            boschloo_exact([[1, 2], [3, 4]], 'not-correct')

    @pytest.mark.parametrize('input_sample,expected', [([[0, 5], [0, 10]], (np.nan, np.nan)), ([[5, 0], [10, 0]], (np.nan, np.nan))])
    def test_row_or_col_zero(self, input_sample, expected):
        res = boschloo_exact(input_sample)
        statistic, pvalue = (res.statistic, res.pvalue)
        assert_equal(pvalue, expected[0])
        assert_equal(statistic, expected[1])

    def test_two_sided_gt_1(self):
        tbl = [[1, 1], [13, 12]]
        pl = boschloo_exact(tbl, alternative='less').pvalue
        pg = boschloo_exact(tbl, alternative='greater').pvalue
        assert 2 * min(pl, pg) > 1
        pt = boschloo_exact(tbl, alternative='two-sided').pvalue
        assert pt == 1.0

    @pytest.mark.parametrize('alternative', ('less', 'greater'))
    def test_against_fisher_exact(self, alternative):
        tbl = [[2, 7], [8, 2]]
        boschloo_stat = boschloo_exact(tbl, alternative=alternative).statistic
        fisher_p = stats.fisher_exact(tbl, alternative=alternative)[1]
        assert_allclose(boschloo_stat, fisher_p)