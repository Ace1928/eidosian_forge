from unittest import TestCase
from unittest.mock import MagicMock
import pytest
from nltk.parse import corenlp
from nltk.tree import Tree
class TestTaggerAPI(TestCase):

    def test_pos_tagger(self):
        corenlp_tagger = corenlp.CoreNLPParser(tagtype='pos')
        api_return_value = {'sentences': [{'basicDependencies': [{'dep': 'ROOT', 'dependent': 1, 'dependentGloss': 'What', 'governor': 0, 'governorGloss': 'ROOT'}, {'dep': 'cop', 'dependent': 2, 'dependentGloss': 'is', 'governor': 1, 'governorGloss': 'What'}, {'dep': 'det', 'dependent': 3, 'dependentGloss': 'the', 'governor': 4, 'governorGloss': 'airspeed'}, {'dep': 'nsubj', 'dependent': 4, 'dependentGloss': 'airspeed', 'governor': 1, 'governorGloss': 'What'}, {'dep': 'case', 'dependent': 5, 'dependentGloss': 'of', 'governor': 8, 'governorGloss': 'swallow'}, {'dep': 'det', 'dependent': 6, 'dependentGloss': 'an', 'governor': 8, 'governorGloss': 'swallow'}, {'dep': 'compound', 'dependent': 7, 'dependentGloss': 'unladen', 'governor': 8, 'governorGloss': 'swallow'}, {'dep': 'nmod', 'dependent': 8, 'dependentGloss': 'swallow', 'governor': 4, 'governorGloss': 'airspeed'}, {'dep': 'punct', 'dependent': 9, 'dependentGloss': '?', 'governor': 1, 'governorGloss': 'What'}], 'enhancedDependencies': [{'dep': 'ROOT', 'dependent': 1, 'dependentGloss': 'What', 'governor': 0, 'governorGloss': 'ROOT'}, {'dep': 'cop', 'dependent': 2, 'dependentGloss': 'is', 'governor': 1, 'governorGloss': 'What'}, {'dep': 'det', 'dependent': 3, 'dependentGloss': 'the', 'governor': 4, 'governorGloss': 'airspeed'}, {'dep': 'nsubj', 'dependent': 4, 'dependentGloss': 'airspeed', 'governor': 1, 'governorGloss': 'What'}, {'dep': 'case', 'dependent': 5, 'dependentGloss': 'of', 'governor': 8, 'governorGloss': 'swallow'}, {'dep': 'det', 'dependent': 6, 'dependentGloss': 'an', 'governor': 8, 'governorGloss': 'swallow'}, {'dep': 'compound', 'dependent': 7, 'dependentGloss': 'unladen', 'governor': 8, 'governorGloss': 'swallow'}, {'dep': 'nmod:of', 'dependent': 8, 'dependentGloss': 'swallow', 'governor': 4, 'governorGloss': 'airspeed'}, {'dep': 'punct', 'dependent': 9, 'dependentGloss': '?', 'governor': 1, 'governorGloss': 'What'}], 'enhancedPlusPlusDependencies': [{'dep': 'ROOT', 'dependent': 1, 'dependentGloss': 'What', 'governor': 0, 'governorGloss': 'ROOT'}, {'dep': 'cop', 'dependent': 2, 'dependentGloss': 'is', 'governor': 1, 'governorGloss': 'What'}, {'dep': 'det', 'dependent': 3, 'dependentGloss': 'the', 'governor': 4, 'governorGloss': 'airspeed'}, {'dep': 'nsubj', 'dependent': 4, 'dependentGloss': 'airspeed', 'governor': 1, 'governorGloss': 'What'}, {'dep': 'case', 'dependent': 5, 'dependentGloss': 'of', 'governor': 8, 'governorGloss': 'swallow'}, {'dep': 'det', 'dependent': 6, 'dependentGloss': 'an', 'governor': 8, 'governorGloss': 'swallow'}, {'dep': 'compound', 'dependent': 7, 'dependentGloss': 'unladen', 'governor': 8, 'governorGloss': 'swallow'}, {'dep': 'nmod:of', 'dependent': 8, 'dependentGloss': 'swallow', 'governor': 4, 'governorGloss': 'airspeed'}, {'dep': 'punct', 'dependent': 9, 'dependentGloss': '?', 'governor': 1, 'governorGloss': 'What'}], 'index': 0, 'parse': '(ROOT\n  (SBARQ\n    (WHNP (WP What))\n    (SQ (VBZ is)\n      (NP\n        (NP (DT the) (NN airspeed))\n        (PP (IN of)\n          (NP (DT an) (NN unladen) (NN swallow)))))\n    (. ?)))', 'tokens': [{'after': ' ', 'before': '', 'characterOffsetBegin': 0, 'characterOffsetEnd': 4, 'index': 1, 'lemma': 'what', 'originalText': 'What', 'pos': 'WP', 'word': 'What'}, {'after': ' ', 'before': ' ', 'characterOffsetBegin': 5, 'characterOffsetEnd': 7, 'index': 2, 'lemma': 'be', 'originalText': 'is', 'pos': 'VBZ', 'word': 'is'}, {'after': ' ', 'before': ' ', 'characterOffsetBegin': 8, 'characterOffsetEnd': 11, 'index': 3, 'lemma': 'the', 'originalText': 'the', 'pos': 'DT', 'word': 'the'}, {'after': ' ', 'before': ' ', 'characterOffsetBegin': 12, 'characterOffsetEnd': 20, 'index': 4, 'lemma': 'airspeed', 'originalText': 'airspeed', 'pos': 'NN', 'word': 'airspeed'}, {'after': ' ', 'before': ' ', 'characterOffsetBegin': 21, 'characterOffsetEnd': 23, 'index': 5, 'lemma': 'of', 'originalText': 'of', 'pos': 'IN', 'word': 'of'}, {'after': ' ', 'before': ' ', 'characterOffsetBegin': 24, 'characterOffsetEnd': 26, 'index': 6, 'lemma': 'a', 'originalText': 'an', 'pos': 'DT', 'word': 'an'}, {'after': ' ', 'before': ' ', 'characterOffsetBegin': 27, 'characterOffsetEnd': 34, 'index': 7, 'lemma': 'unladen', 'originalText': 'unladen', 'pos': 'JJ', 'word': 'unladen'}, {'after': ' ', 'before': ' ', 'characterOffsetBegin': 35, 'characterOffsetEnd': 42, 'index': 8, 'lemma': 'swallow', 'originalText': 'swallow', 'pos': 'VB', 'word': 'swallow'}, {'after': '', 'before': ' ', 'characterOffsetBegin': 43, 'characterOffsetEnd': 44, 'index': 9, 'lemma': '?', 'originalText': '?', 'pos': '.', 'word': '?'}]}]}
        corenlp_tagger.api_call = MagicMock(return_value=api_return_value)
        input_tokens = 'What is the airspeed of an unladen swallow ?'.split()
        expected_output = [('What', 'WP'), ('is', 'VBZ'), ('the', 'DT'), ('airspeed', 'NN'), ('of', 'IN'), ('an', 'DT'), ('unladen', 'JJ'), ('swallow', 'VB'), ('?', '.')]
        tagged_output = corenlp_tagger.tag(input_tokens)
        corenlp_tagger.api_call.assert_called_once_with('What is the airspeed of an unladen swallow ?', properties={'ssplit.isOneSentence': 'true', 'annotators': 'tokenize,ssplit,pos'})
        self.assertEqual(expected_output, tagged_output)

    def test_ner_tagger(self):
        corenlp_tagger = corenlp.CoreNLPParser(tagtype='ner')
        api_return_value = {'sentences': [{'index': 0, 'tokens': [{'after': ' ', 'before': '', 'characterOffsetBegin': 0, 'characterOffsetEnd': 4, 'index': 1, 'lemma': 'Rami', 'ner': 'PERSON', 'originalText': 'Rami', 'pos': 'NNP', 'word': 'Rami'}, {'after': ' ', 'before': ' ', 'characterOffsetBegin': 5, 'characterOffsetEnd': 8, 'index': 2, 'lemma': 'Eid', 'ner': 'PERSON', 'originalText': 'Eid', 'pos': 'NNP', 'word': 'Eid'}, {'after': ' ', 'before': ' ', 'characterOffsetBegin': 9, 'characterOffsetEnd': 11, 'index': 3, 'lemma': 'be', 'ner': 'O', 'originalText': 'is', 'pos': 'VBZ', 'word': 'is'}, {'after': ' ', 'before': ' ', 'characterOffsetBegin': 12, 'characterOffsetEnd': 20, 'index': 4, 'lemma': 'study', 'ner': 'O', 'originalText': 'studying', 'pos': 'VBG', 'word': 'studying'}, {'after': ' ', 'before': ' ', 'characterOffsetBegin': 21, 'characterOffsetEnd': 23, 'index': 5, 'lemma': 'at', 'ner': 'O', 'originalText': 'at', 'pos': 'IN', 'word': 'at'}, {'after': ' ', 'before': ' ', 'characterOffsetBegin': 24, 'characterOffsetEnd': 29, 'index': 6, 'lemma': 'Stony', 'ner': 'ORGANIZATION', 'originalText': 'Stony', 'pos': 'NNP', 'word': 'Stony'}, {'after': ' ', 'before': ' ', 'characterOffsetBegin': 30, 'characterOffsetEnd': 35, 'index': 7, 'lemma': 'Brook', 'ner': 'ORGANIZATION', 'originalText': 'Brook', 'pos': 'NNP', 'word': 'Brook'}, {'after': ' ', 'before': ' ', 'characterOffsetBegin': 36, 'characterOffsetEnd': 46, 'index': 8, 'lemma': 'University', 'ner': 'ORGANIZATION', 'originalText': 'University', 'pos': 'NNP', 'word': 'University'}, {'after': ' ', 'before': ' ', 'characterOffsetBegin': 47, 'characterOffsetEnd': 49, 'index': 9, 'lemma': 'in', 'ner': 'O', 'originalText': 'in', 'pos': 'IN', 'word': 'in'}, {'after': '', 'before': ' ', 'characterOffsetBegin': 50, 'characterOffsetEnd': 52, 'index': 10, 'lemma': 'NY', 'ner': 'O', 'originalText': 'NY', 'pos': 'NNP', 'word': 'NY'}]}]}
        corenlp_tagger.api_call = MagicMock(return_value=api_return_value)
        input_tokens = 'Rami Eid is studying at Stony Brook University in NY'.split()
        expected_output = [('Rami', 'PERSON'), ('Eid', 'PERSON'), ('is', 'O'), ('studying', 'O'), ('at', 'O'), ('Stony', 'ORGANIZATION'), ('Brook', 'ORGANIZATION'), ('University', 'ORGANIZATION'), ('in', 'O'), ('NY', 'O')]
        tagged_output = corenlp_tagger.tag(input_tokens)
        corenlp_tagger.api_call.assert_called_once_with('Rami Eid is studying at Stony Brook University in NY', properties={'ssplit.isOneSentence': 'true', 'annotators': 'tokenize,ssplit,ner'})
        self.assertEqual(expected_output, tagged_output)

    def test_unexpected_tagtype(self):
        with self.assertRaises(ValueError):
            corenlp_tagger = corenlp.CoreNLPParser(tagtype='test')