from __future__ import absolute_import
from __future__ import division
from __future__ import unicode_literals
import collections
from apitools.base.py import exceptions as apitools_exceptions
from googlecloudsdk.api_lib.firebase.test import util
from googlecloudsdk.calliope import exceptions
from googlecloudsdk.core import log
class ToolResultsSummaryFetcher(object):
    """Creates Test Results summary using data from the ToolResults API."""

    def __init__(self, project, client, messages, tool_results_ids, test_matrix_id):
        """Constructs a ToolResultsSummaryFetcher.

    Args:
      project: string containing the GCE project id.
      client: ToolResults API client lib generated by apitools.
      messages: ToolResults API message classes generated by apitools.
      tool_results_ids: a ToolResultsIds object holding history & execution IDs.
      test_matrix_id: test matrix ID from Testing API.
    """
        self._project = project
        self._client = client
        self._messages = messages
        self._history_id = tool_results_ids.history_id
        self._execution_id = tool_results_ids.execution_id
        self._test_matrix_id = test_matrix_id
        self._outcome_names = {messages.Outcome.SummaryValueValuesEnum.success: _SUCCESS, messages.Outcome.SummaryValueValuesEnum.failure: _FAILURE, messages.Outcome.SummaryValueValuesEnum.flaky: _FLAKY, messages.Outcome.SummaryValueValuesEnum.skipped: _SKIPPED, messages.Outcome.SummaryValueValuesEnum.inconclusive: _INCONCLUSIVE}

    def FetchMatrixRollupOutcome(self):
        """Gets a test execution's rolled-up outcome from the ToolResults service.

    Returns:
      The rolled-up test execution outcome (type: toolresults_v1beta3.Outcome).

    Raises:
      HttpException if the ToolResults service reports a back-end error.
    """
        request = self._messages.ToolresultsProjectsHistoriesExecutionsGetRequest(projectId=self._project, historyId=self._history_id, executionId=self._execution_id)
        try:
            response = self._client.projects_histories_executions.Get(request)
            return response.outcome
        except apitools_exceptions.HttpError as error:
            msg = 'Http error fetching test roll-up outcome: ' + util.GetError(error)
            raise exceptions.HttpException(msg)

    def CreateMatrixOutcomeSummaryUsingSteps(self):
        """Fetches test results and creates a test outcome summary.

    Lists all the steps in an execution and creates a high-level outcome summary
    for each step (pass/fail/inconclusive). Each step represents a test run on
    a single device (e.g. running the tests on a Nexus 5 in portrait mode using
    the en locale and API level 18).

    Returns:
      A list of TestOutcome objects.

    Raises:
      HttpException if the ToolResults service reports a back-end error.
    """
        outcomes = []
        steps = self._ListAllSteps()
        if not steps:
            log.warning('No test results found, something went wrong. Try re-running the tests.')
            return outcomes
        for step in steps:
            dimension_value = step.dimensionValue
            axis_value = self._GetAxisValue(dimension_value)
            if not step.outcome:
                log.warning('Step for [{0}] had no outcome value.'.format(axis_value))
            else:
                details = self._GetStepOutcomeDetails(step)
                self._LogWarnings(details, axis_value)
                outcome_summary = step.outcome.summary
                outcome_str = self._GetOutcomeSummaryDisplayName(outcome_summary)
                outcomes.append(TestOutcome(outcome=outcome_str, axis_value=axis_value, test_details=details))
        return sorted(outcomes, key=_TestOutcomeSortKey)

    def CreateMatrixOutcomeSummaryUsingEnvironments(self):
        """Fetches test results and creates a test outcome summary.

    Lists all the environments in an execution and creates a high-level outcome
    summary for each environment (pass/flaky/fail/skipped/inconclusive). Each
    environment represents a combination of one or more test executions with the
    same device configuration (e.g. running the tests on a Nexus 5 in portrait
    mode using the en locale and API level 18).

    Returns:
      A list of TestOutcome objects.

    Raises:
      HttpException if the ToolResults service reports a back-end error.
    """
        outcomes = []
        environments = self._ListAllEnvironments()
        if not environments:
            log.warning('Environment has no results, something went wrong. Displaying step outcomes instead.')
            return self.CreateMatrixOutcomeSummaryUsingSteps()
        for environment in environments:
            dimension_value = environment.dimensionValue
            axis_value = self._GetAxisValue(dimension_value)
            if not environment.environmentResult.outcome:
                log.warning('Environment for [{0}] had no outcome value. Displaying step outcomes instead.'.format(axis_value))
                return self.CreateMatrixOutcomeSummaryUsingSteps()
            details = self._GetEnvironmentOutcomeDetails(environment)
            self._LogWarnings(details, axis_value)
            outcome_summary = environment.environmentResult.outcome.summary
            outcome_str = self._GetOutcomeSummaryDisplayName(outcome_summary)
            outcomes.append(TestOutcome(outcome=outcome_str, axis_value=axis_value, test_details=details))
        return sorted(outcomes, key=_TestOutcomeSortKey)

    def _LogWarnings(self, details, axis_value):
        """Log warnings if there was native crash or infrustructure failure."""
        if _NATIVE_CRASH in details:
            log.warning(_NATIVE_CRASH_DETAILED_FORMAT.format(axis_value))
        if _INFRASTRUCTURE_FAILURE in details:
            log.warning(_INFRASTRUCTURE_FAILURE_DETAILED_FORMAT.format(axis_value, self._test_matrix_id))

    def _GetAxisValue(self, dimensionvalue):
        axes = {}
        for dimension in dimensionvalue:
            axes[dimension.key] = dimension.value
        return '{m}-{v}-{l}-{o}'.format(m=axes.get('Model', '?'), v=axes.get('Version', '?'), l=axes.get('Locale', '?'), o=axes.get('Orientation', '?'))

    def _ListAllSteps(self):
        """Lists all steps for a test execution using the ToolResults service.

    Returns:
      The full list of steps for a test execution.
    """
        response = self._ListSteps(None)
        steps = []
        steps.extend(response.steps)
        while response.nextPageToken:
            response = self._ListSteps(response.nextPageToken)
            steps.extend(response.steps)
        return steps

    def _ListSteps(self, page_token):
        """Lists one page of steps using the ToolResults service.

    Args:
      page_token: A page token to attach to the List request. If it's None, then
        it returns at most the first 200 steps.

    Returns:
      A ListStepsResponse containing a single page's steps.

    Raises:
      HttpException if the ToolResults service reports a back-end error.
    """
        request = self._messages.ToolresultsProjectsHistoriesExecutionsStepsListRequest(projectId=self._project, historyId=self._history_id, executionId=self._execution_id, pageSize=100, pageToken=page_token)
        try:
            return self._client.projects_histories_executions_steps.List(request)
        except apitools_exceptions.HttpError as error:
            msg = 'Http error while listing test results of steps: ' + util.GetError(error)
            raise exceptions.HttpException(msg)

    def _ListAllEnvironments(self):
        """Lists all environments of a test execution using the ToolResults service.

    Returns:
      A ListEnvironmentsResponse containing all environments within execution.
    """
        response = self._ListEnvironments(None)
        environments = []
        environments.extend(response.environments)
        while response.nextPageToken:
            response = self._ListEnvironments(response.nextPageToken)
            environments.extend(response.environments)
        return environments

    def _ListEnvironments(self, page_token):
        """Lists one page of environments using the ToolResults service.

    Args:
      page_token: A page token to attach to the List request. If it's None, then
        it returns a maximum of 200 Environments.

    Returns:
      A ListEnvironmentsResponse containing a single page's environments.

    Raises:
      HttpException if the ToolResults service reports a back-end error.
    """
        request = self._messages.ToolresultsProjectsHistoriesExecutionsEnvironmentsListRequest(projectId=self._project, historyId=self._history_id, executionId=self._execution_id, pageSize=100, pageToken=page_token)
        try:
            return self._client.projects_histories_executions_environments.List(request)
        except apitools_exceptions.HttpError as error:
            msg = 'Http error while listing test results: ' + util.GetError(error)
            raise exceptions.HttpException(msg)

    def _GetOutcomeSummaryDisplayName(self, outcome):
        """Transforms the outcome enum to a human readable outcome.

    Args:
      outcome: An Outcome.SummaryValueValuesEnum value.

    Returns:
      A string containing a human readable outcome.
    """
        try:
            return self._outcome_names[outcome]
        except ValueError:
            return 'Unknown'

    def _GetStepOutcomeDetails(self, step):
        """Turn test outcome counts and details into something human readable."""
        outcome = step.outcome
        summary_enum = self._messages.Outcome.SummaryValueValuesEnum
        test_suite_overviews = step.testExecutionStep.testSuiteOverviews
        if outcome.summary == summary_enum.success:
            details = _GetSuccessCountDetails(test_suite_overviews)
            if outcome.successDetail and outcome.successDetail.otherNativeCrash:
                return '{d} ({c})'.format(d=details, c=_NATIVE_CRASH)
            else:
                return details
        elif outcome.summary == summary_enum.failure:
            if outcome.failureDetail:
                return _GetFailureDetail(outcome, test_suite_overviews)
            if not step.testExecutionStep:
                return 'Unknown failure'
            return _GetFailureOrFlakyCountDetails(test_suite_overviews)
        elif outcome.summary == summary_enum.inconclusive:
            return _GetInconclusiveDetail(outcome)
        elif outcome.summary == summary_enum.skipped:
            return _GetSkippedDetail(outcome)
        else:
            return 'Unknown outcome'

    def _GetEnvironmentOutcomeDetails(self, environment):
        """Turn test outcome counts and details into something human readable."""
        outcome = environment.environmentResult.outcome
        summary_enum = self._messages.Outcome.SummaryValueValuesEnum
        test_suite_overviews = environment.environmentResult.testSuiteOverviews
        if outcome.summary == summary_enum.success:
            details = _GetSuccessCountDetails(test_suite_overviews)
            if outcome.successDetail and outcome.successDetail.otherNativeCrash:
                return '{d} ({c})'.format(d=details, c=_NATIVE_CRASH)
            else:
                return details
        elif outcome.summary == summary_enum.failure or outcome.summary == summary_enum.flaky:
            if outcome.failureDetail:
                return _GetFailureDetail(outcome, test_suite_overviews)
            return _GetFailureOrFlakyCountDetails(test_suite_overviews)
        elif outcome.summary == summary_enum.inconclusive:
            return _GetInconclusiveDetail(outcome)
        elif outcome.summary == summary_enum.skipped:
            return _GetSkippedDetail(outcome)
        else:
            return 'Unknown outcome'