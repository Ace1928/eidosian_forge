import argparse
import errno
import functools
import io
import logging
import os
import shutil
import sys
import tempfile
import unittest
from unittest import mock
import fixtures
from oslotest import base
import testscenarios
from oslo_config import cfg
from oslo_config import types
class CliOptsTestCase(BaseTestCase):
    """Test CLI Options.

    Each test scenario takes a name for the scenarios, as well as a dict:
    opt_class - class of the type of option that should be tested
    default - a default value for the option
    cli_args - a list containing a representation of an input command line
    value - the result value that is expected to be found
    deps - a tuple of deprecated name/group
    """
    IPv4Opt = functools.partial(cfg.IPOpt, version=4)
    IPv6Opt = functools.partial(cfg.IPOpt, version=6)
    multi_int = functools.partial(cfg.MultiOpt, item_type=types.Integer())
    multi_float = functools.partial(cfg.MultiOpt, item_type=types.Float())
    multi_string = functools.partial(cfg.MultiOpt, item_type=types.String())
    scenarios = [('str_default', dict(opt_class=cfg.StrOpt, default=None, cli_args=[], value=None, deps=(None, None))), ('str_arg', dict(opt_class=cfg.StrOpt, default=None, cli_args=['--foo', 'bar'], value='bar', deps=(None, None))), ('str_arg_deprecated_name', dict(opt_class=cfg.StrOpt, default=None, cli_args=['--oldfoo', 'bar'], value='bar', deps=('oldfoo', None))), ('str_arg_deprecated_group', dict(opt_class=cfg.StrOpt, default=None, cli_args=['--old-foo', 'bar'], value='bar', deps=(None, 'old'))), ('str_arg_deprecated_group_default', dict(opt_class=cfg.StrOpt, default=None, cli_args=['--foo', 'bar'], value='bar', deps=(None, 'DEFAULT'))), ('str_arg_deprecated_group_and_name', dict(opt_class=cfg.StrOpt, default=None, cli_args=['--old-oof', 'bar'], value='bar', deps=('oof', 'old'))), ('bool_default', dict(opt_class=cfg.BoolOpt, default=False, cli_args=[], value=False, deps=(None, None))), ('bool_arg', dict(opt_class=cfg.BoolOpt, default=None, cli_args=['--foo'], value=True, deps=(None, None))), ('bool_arg_deprecated_name', dict(opt_class=cfg.BoolOpt, default=None, cli_args=['--oldfoo'], value=True, deps=('oldfoo', None))), ('bool_arg_deprecated_group', dict(opt_class=cfg.BoolOpt, default=None, cli_args=['--old-foo'], value=True, deps=(None, 'old'))), ('bool_arg_deprecated_group_default', dict(opt_class=cfg.BoolOpt, default=None, cli_args=['--foo'], value=True, deps=(None, 'DEFAULT'))), ('bool_arg_deprecated_group_and_name', dict(opt_class=cfg.BoolOpt, default=None, cli_args=['--old-oof'], value=True, deps=('oof', 'old'))), ('bool_arg_inverse', dict(opt_class=cfg.BoolOpt, default=None, cli_args=['--foo', '--nofoo'], value=False, deps=(None, None))), ('bool_arg_inverse_deprecated_name', dict(opt_class=cfg.BoolOpt, default=None, cli_args=['--oldfoo', '--nooldfoo'], value=False, deps=('oldfoo', None))), ('bool_arg_inverse_deprecated_group', dict(opt_class=cfg.BoolOpt, default=None, cli_args=['--old-foo', '--old-nofoo'], value=False, deps=(None, 'old'))), ('bool_arg_inverse_deprecated_group_default', dict(opt_class=cfg.BoolOpt, default=None, cli_args=['--foo', '--nofoo'], value=False, deps=(None, 'DEFAULT'))), ('bool_arg_inverse_deprecated_group_and_name', dict(opt_class=cfg.BoolOpt, default=None, cli_args=['--old-oof', '--old-nooof'], value=False, deps=('oof', 'old'))), ('int_default', dict(opt_class=cfg.IntOpt, default=10, cli_args=[], value=10, deps=(None, None))), ('int_arg', dict(opt_class=cfg.IntOpt, default=None, cli_args=['--foo=20'], value=20, deps=(None, None))), ('int_arg_deprecated_name', dict(opt_class=cfg.IntOpt, default=None, cli_args=['--oldfoo=20'], value=20, deps=('oldfoo', None))), ('int_arg_deprecated_group', dict(opt_class=cfg.IntOpt, default=None, cli_args=['--old-foo=20'], value=20, deps=(None, 'old'))), ('int_arg_deprecated_group_default', dict(opt_class=cfg.IntOpt, default=None, cli_args=['--foo=20'], value=20, deps=(None, 'DEFAULT'))), ('int_arg_deprecated_group_and_name', dict(opt_class=cfg.IntOpt, default=None, cli_args=['--old-oof=20'], value=20, deps=('oof', 'old'))), ('float_default', dict(opt_class=cfg.FloatOpt, default=1.0, cli_args=[], value=1.0, deps=(None, None))), ('float_arg', dict(opt_class=cfg.FloatOpt, default=None, cli_args=['--foo', '2.0'], value=2.0, deps=(None, None))), ('float_arg_deprecated_name', dict(opt_class=cfg.FloatOpt, default=None, cli_args=['--oldfoo', '2.0'], value=2.0, deps=('oldfoo', None))), ('float_arg_deprecated_group', dict(opt_class=cfg.FloatOpt, default=None, cli_args=['--old-foo', '2.0'], value=2.0, deps=(None, 'old'))), ('float_arg_deprecated_group_default', dict(opt_class=cfg.FloatOpt, default=None, cli_args=['--foo', '2.0'], value=2.0, deps=(None, 'DEFAULT'))), ('float_arg_deprecated_group_and_name', dict(opt_class=cfg.FloatOpt, default=None, cli_args=['--old-oof', '2.0'], value=2.0, deps=('oof', 'old'))), ('float_default_as_integer', dict(opt_class=cfg.FloatOpt, default=2, cli_args=['--old-oof', '2.0'], value=2.0, deps=('oof', 'old'))), ('ipv4addr_arg', dict(opt_class=IPv4Opt, default=None, cli_args=['--foo', '192.168.0.1'], value='192.168.0.1', deps=(None, None))), ('ipaddr_arg_implicitv4', dict(opt_class=cfg.IPOpt, default=None, cli_args=['--foo', '192.168.0.1'], value='192.168.0.1', deps=(None, None))), ('ipaddr_arg_implicitv6', dict(opt_class=cfg.IPOpt, default=None, cli_args=['--foo', 'abcd:ef::1'], value='abcd:ef::1', deps=(None, None))), ('ipv6addr_arg', dict(opt_class=IPv6Opt, default=None, cli_args=['--foo', 'abcd:ef::1'], value='abcd:ef::1', deps=(None, None))), ('list_default', dict(opt_class=cfg.ListOpt, default=['bar'], cli_args=[], value=['bar'], deps=(None, None))), ('list_arg', dict(opt_class=cfg.ListOpt, default=None, cli_args=['--foo', 'blaa,bar'], value=['blaa', 'bar'], deps=(None, None))), ('list_arg_with_spaces', dict(opt_class=cfg.ListOpt, default=None, cli_args=['--foo', 'blaa ,bar'], value=['blaa', 'bar'], deps=(None, None))), ('list_arg_deprecated_name', dict(opt_class=cfg.ListOpt, default=None, cli_args=['--oldfoo', 'blaa,bar'], value=['blaa', 'bar'], deps=('oldfoo', None))), ('list_arg_deprecated_group', dict(opt_class=cfg.ListOpt, default=None, cli_args=['--old-foo', 'blaa,bar'], value=['blaa', 'bar'], deps=(None, 'old'))), ('list_arg_deprecated_group_default', dict(opt_class=cfg.ListOpt, default=None, cli_args=['--foo', 'blaa,bar'], value=['blaa', 'bar'], deps=(None, 'DEFAULT'))), ('list_arg_deprecated_group_and_name', dict(opt_class=cfg.ListOpt, default=None, cli_args=['--old-oof', 'blaa,bar'], value=['blaa', 'bar'], deps=('oof', 'old'))), ('dict_default', dict(opt_class=cfg.DictOpt, default={'foo': 'bar'}, cli_args=[], value={'foo': 'bar'}, deps=(None, None))), ('dict_arg', dict(opt_class=cfg.DictOpt, default=None, cli_args=['--foo', 'key1:blaa,key2:bar'], value={'key1': 'blaa', 'key2': 'bar'}, deps=(None, None))), ('dict_arg_multiple_keys_last_wins', dict(opt_class=cfg.DictOpt, default=None, cli_args=['--foo', 'key1:blaa', '--foo', 'key2:bar'], value={'key2': 'bar'}, deps=(None, None))), ('dict_arg_with_spaces', dict(opt_class=cfg.DictOpt, default=None, cli_args=['--foo', 'key1:blaa   ,key2:bar'], value={'key1': 'blaa', 'key2': 'bar'}, deps=(None, None))), ('dict_arg_deprecated_name', dict(opt_class=cfg.DictOpt, default=None, cli_args=['--oldfoo', 'key1:blaa', '--oldfoo', 'key2:bar'], value={'key2': 'bar'}, deps=('oldfoo', None))), ('dict_arg_deprecated_group', dict(opt_class=cfg.DictOpt, default=None, cli_args=['--old-foo', 'key1:blaa,key2:bar'], value={'key1': 'blaa', 'key2': 'bar'}, deps=(None, 'old'))), ('dict_arg_deprecated_group2', dict(opt_class=cfg.DictOpt, default=None, cli_args=['--old-foo', 'key1:blaa', '--old-foo', 'key2:bar'], value={'key2': 'bar'}, deps=(None, 'old'))), ('dict_arg_deprecated_group_default', dict(opt_class=cfg.DictOpt, default=None, cli_args=['--foo', 'key1:blaa', '--foo', 'key2:bar'], value={'key2': 'bar'}, deps=(None, 'DEFAULT'))), ('dict_arg_deprecated_group_and_name', dict(opt_class=cfg.DictOpt, default=None, cli_args=['--old-oof', 'key1:blaa,key2:bar'], value={'key1': 'blaa', 'key2': 'bar'}, deps=('oof', 'old'))), ('dict_arg_deprecated_group_and_name2', dict(opt_class=cfg.DictOpt, default=None, cli_args=['--old-oof', 'key1:blaa', '--old-oof', 'key2:bar'], value={'key2': 'bar'}, deps=('oof', 'old'))), ('port_default', dict(opt_class=cfg.PortOpt, default=80, cli_args=[], value=80, deps=(None, None))), ('port_arg', dict(opt_class=cfg.PortOpt, default=None, cli_args=['--foo=80'], value=80, deps=(None, None))), ('port_arg_deprecated_name', dict(opt_class=cfg.PortOpt, default=None, cli_args=['--oldfoo=80'], value=80, deps=('oldfoo', None))), ('port_arg_deprecated_group', dict(opt_class=cfg.PortOpt, default=None, cli_args=['--old-foo=80'], value=80, deps=(None, 'old'))), ('port_arg_deprecated_group_default', dict(opt_class=cfg.PortOpt, default=None, cli_args=['--foo=80'], value=80, deps=(None, 'DEFAULT'))), ('port_arg_deprecated_group_and_name', dict(opt_class=cfg.PortOpt, default=None, cli_args=['--old-oof=80'], value=80, deps=('oof', 'old'))), ('uri_default', dict(opt_class=cfg.URIOpt, default='http://example.com', cli_args=[], value='http://example.com', deps=(None, None))), ('uri_arg', dict(opt_class=cfg.URIOpt, default=None, cli_args=['--foo', 'http://example.com'], value='http://example.com', deps=(None, None))), ('multistr_default', dict(opt_class=cfg.MultiStrOpt, default=['bar'], cli_args=[], value=['bar'], deps=(None, None))), ('multistr_arg', dict(opt_class=cfg.MultiStrOpt, default=None, cli_args=['--foo', 'blaa', '--foo', 'bar'], value=['blaa', 'bar'], deps=(None, None))), ('multistr_arg_deprecated_name', dict(opt_class=cfg.MultiStrOpt, default=None, cli_args=['--oldfoo', 'blaa', '--oldfoo', 'bar'], value=['blaa', 'bar'], deps=('oldfoo', None))), ('multistr_arg_deprecated_group', dict(opt_class=cfg.MultiStrOpt, default=None, cli_args=['--old-foo', 'blaa', '--old-foo', 'bar'], value=['blaa', 'bar'], deps=(None, 'old'))), ('multistr_arg_deprecated_group_default', dict(opt_class=cfg.MultiStrOpt, default=None, cli_args=['--foo', 'blaa', '--foo', 'bar'], value=['blaa', 'bar'], deps=(None, 'DEFAULT'))), ('multistr_arg_deprecated_group_and_name', dict(opt_class=cfg.MultiStrOpt, default=None, cli_args=['--old-oof', 'blaa', '--old-oof', 'bar'], value=['blaa', 'bar'], deps=('oof', 'old'))), ('multiopt_arg_int', dict(opt_class=multi_int, default=None, cli_args=['--foo', '1', '--foo', '2'], value=[1, 2], deps=(None, None))), ('multiopt_float_int', dict(opt_class=multi_float, default=None, cli_args=['--foo', '1.2', '--foo', '2.3'], value=[1.2, 2.3], deps=(None, None))), ('multiopt_string', dict(opt_class=multi_string, default=None, cli_args=['--foo', 'bar', '--foo', 'baz'], value=['bar', 'baz'], deps=(None, None)))]

    def test_cli(self):
        self.conf.register_cli_opt(self.opt_class('foo', default=self.default, deprecated_name=self.deps[0], deprecated_group=self.deps[1]))
        self.conf(self.cli_args)
        self.assertTrue(hasattr(self.conf, 'foo'))
        self.assertEqual(self.value, self.conf.foo)