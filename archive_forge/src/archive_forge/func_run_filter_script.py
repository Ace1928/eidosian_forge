import sys
from optparse import OptionParser
from testtools import CopyStreamResult, StreamResult, StreamResultRouter
from subunit import (ByteStreamToStreamResult, DiscardStream, ProtocolTestCase,
from subunit.test_results import CatFiles
def run_filter_script(result_factory, description, post_run_hook=None, protocol_version=1, passthrough_subunit=True):
    """Main function for simple subunit filter scripts.

    Many subunit filter scripts take a stream of subunit input and use a
    TestResult to handle the events generated by that stream.  This function
    wraps a lot of the boiler-plate around that by making a script with
    options for handling passthrough information and stream forwarding, and
    that will exit with a successful return code (i.e. 0) if the input stream
    represents a successful test run.

    :param result_factory: A callable that takes an output stream and returns
        a test result that outputs to that stream.
    :param description: A description of the filter script.
    :param protocol_version: What protocol version to consume/emit.
    :param passthrough_subunit: If True, passthrough should be as subunit.
    """
    parser = make_options(description)
    options, args = parser.parse_args()
    result = filter_by_result(result_factory, options.output_to, not options.no_passthrough, options.forward, protocol_version=protocol_version, passthrough_subunit=passthrough_subunit, input_stream=find_stream(sys.stdin, args))
    if post_run_hook:
        post_run_hook(result)
    if not hasattr(result, 'wasSuccessful'):
        result = result.decorated
    if result.wasSuccessful():
        sys.exit(0)
    else:
        sys.exit(1)