import copy
import datetime
from openstack import exceptions
from openstack.tests import fakes
from openstack.tests.unit import base
from openstack import utils
def test_auto_ip_pool_no_reuse(self):
    self.register_uris([dict(method='GET', uri='https://network.example.com/v2.0/networks/ext-net', status_code=404), dict(method='GET', uri='https://network.example.com/v2.0/networks?name=ext-net', json={'networks': [{'status': 'ACTIVE', 'subnets': ['df3e17fa-a4b2-47ae-9015-bc93eb076ba2', '6b0c3dc9-b0b8-4d87-976a-7f2ebf13e7ec', 'fc541f48-fc7f-48c0-a063-18de6ee7bdd7'], 'availability_zone_hints': [], 'availability_zones': ['nova'], 'name': 'ext-net', 'admin_state_up': True, 'tenant_id': 'a564613210ee43708b8a7fc6274ebd63', 'tags': [], 'ipv6_address_scope': '9f03124f-89af-483a-b6fd-10f08079db4d', 'mtu': 0, 'is_default': False, 'router:external': True, 'ipv4_address_scope': None, 'shared': False, 'id': '0232c17f-2096-49bc-b205-d3dcd9a30ebf', 'description': None}]}), dict(method='GET', uri='https://network.example.com/v2.0/ports?device_id=f80e3ad0-e13e-41d4-8e9c-be79bccdb8f7', json={'ports': [{'status': 'ACTIVE', 'created_at': '2017-02-06T20:59:45', 'description': '', 'allowed_address_pairs': [], 'admin_state_up': True, 'network_id': '2c9adcb5-c123-4c5a-a2ba-1ad4c4e1481f', 'dns_name': None, 'extra_dhcp_opts': [], 'mac_address': 'fa:16:3e:e8:7f:03', 'updated_at': '2017-02-06T20:59:49', 'name': '', 'device_owner': 'compute:None', 'tenant_id': '65222a4d09ea4c68934fa1028c77f394', 'binding:vnic_type': 'normal', 'fixed_ips': [{'subnet_id': 'f0ad1df5-53ee-473f-b86b-3604ea5591e9', 'ip_address': '10.4.0.16'}], 'id': 'a767944e-057a-47d1-a669-824a21b8fb7b', 'security_groups': ['9fb5ba44-5c46-4357-8e60-8b55526cab54'], 'device_id': 'f80e3ad0-e13e-41d4-8e9c-be79bccdb8f7'}]}), dict(method='POST', uri='https://network.example.com/v2.0/floatingips', json={'floatingip': {'router_id': '9de9c787-8f89-4a53-8468-a5533d6d7fd1', 'status': 'DOWN', 'description': '', 'dns_domain': '', 'floating_network_id': '0232c17f-2096-49bc-b205-d3dcd9a30ebf', 'fixed_ip_address': '10.4.0.16', 'floating_ip_address': '89.40.216.153', 'port_id': 'a767944e-057a-47d1-a669-824a21b8fb7b', 'id': 'e69179dc-a904-4c9a-a4c9-891e2ecb984c', 'dns_name': '', 'tenant_id': '65222a4d09ea4c68934fa1028c77f394'}}, validate=dict(json={'floatingip': {'floating_network_id': '0232c17f-2096-49bc-b205-d3dcd9a30ebf', 'fixed_ip_address': '10.4.0.16', 'port_id': 'a767944e-057a-47d1-a669-824a21b8fb7b'}})), self.get_nova_discovery_mock_dict(), dict(method='GET', uri='{endpoint}/servers/detail'.format(endpoint=fakes.COMPUTE_ENDPOINT), json={'servers': [{'status': 'ACTIVE', 'updated': '2017-02-06T20:59:49Z', 'addresses': {'private': [{'OS-EXT-IPS-MAC:mac_addr': 'fa:16:3e:e8:7f:03', 'version': 4, 'addr': '10.4.0.16', 'OS-EXT-IPS:type': 'fixed'}, {'OS-EXT-IPS-MAC:mac_addr': 'fa:16:3e:e8:7f:03', 'version': 4, 'addr': '89.40.216.153', 'OS-EXT-IPS:type': 'floating'}]}, 'key_name': None, 'image': {'id': '95e4c449-8abf-486e-97d9-dc3f82417d2d'}, 'OS-EXT-STS:task_state': None, 'OS-EXT-STS:vm_state': 'active', 'OS-SRV-USG:launched_at': '2017-02-06T20:59:48.000000', 'flavor': {'id': '2186bd79-a05e-4953-9dde-ddefb63c88d4'}, 'id': 'f80e3ad0-e13e-41d4-8e9c-be79bccdb8f7', 'security_groups': [{'name': 'default'}], 'OS-SRV-USG:terminated_at': None, 'OS-EXT-AZ:availability_zone': 'nova', 'user_id': 'c17534835f8f42bf98fc367e0bf35e09', 'name': 'testmt', 'created': '2017-02-06T20:59:44Z', 'tenant_id': '65222a4d09ea4c68934fa1028c77f394', 'OS-DCF:diskConfig': 'MANUAL', 'os-extended-volumes:volumes_attached': [], 'accessIPv4': '', 'accessIPv6': '', 'progress': 0, 'OS-EXT-STS:power_state': 1, 'config_drive': '', 'metadata': {}}]}), dict(method='GET', uri='https://network.example.com/v2.0/networks', json={'networks': [{'status': 'ACTIVE', 'subnets': ['df3e17fa-a4b2-47ae-9015-bc93eb076ba2', '6b0c3dc9-b0b8-4d87-976a-7f2ebf13e7ec', 'fc541f48-fc7f-48c0-a063-18de6ee7bdd7'], 'availability_zone_hints': [], 'availability_zones': ['nova'], 'name': 'ext-net', 'admin_state_up': True, 'tenant_id': 'a564613210ee43708b8a7fc6274ebd63', 'tags': [], 'ipv6_address_scope': '9f03124f-89af-483a-b6fd-10f08079db4d', 'mtu': 0, 'is_default': False, 'router:external': True, 'ipv4_address_scope': None, 'shared': False, 'id': '0232c17f-2096-49bc-b205-d3dcd9a30ebf', 'description': None}, {'status': 'ACTIVE', 'subnets': ['f0ad1df5-53ee-473f-b86b-3604ea5591e9'], 'availability_zone_hints': [], 'availability_zones': ['nova'], 'name': 'private', 'admin_state_up': True, 'tenant_id': '65222a4d09ea4c68934fa1028c77f394', 'created_at': '2016-10-22T13:46:26', 'tags': [], 'updated_at': '2016-10-22T13:46:26', 'ipv6_address_scope': None, 'router:external': False, 'ipv4_address_scope': None, 'shared': False, 'mtu': 1450, 'id': '2c9adcb5-c123-4c5a-a2ba-1ad4c4e1481f', 'description': ''}]}), dict(method='GET', uri='https://network.example.com/v2.0/subnets', json={'subnets': [{'description': '', 'enable_dhcp': True, 'network_id': '2c9adcb5-c123-4c5a-a2ba-1ad4c4e1481f', 'tenant_id': '65222a4d09ea4c68934fa1028c77f394', 'created_at': '2016-10-22T13:46:26', 'dns_nameservers': ['89.36.90.101', '89.36.90.102'], 'updated_at': '2016-10-22T13:46:26', 'gateway_ip': '10.4.0.1', 'ipv6_ra_mode': None, 'allocation_pools': [{'start': '10.4.0.2', 'end': '10.4.0.200'}], 'host_routes': [], 'ip_version': 4, 'ipv6_address_mode': None, 'cidr': '10.4.0.0/24', 'id': 'f0ad1df5-53ee-473f-b86b-3604ea5591e9', 'subnetpool_id': None, 'name': 'private-subnet-ipv4'}]})])
    self.cloud.add_ips_to_server(utils.Munch(id='f80e3ad0-e13e-41d4-8e9c-be79bccdb8f7', addresses={'private': [{'OS-EXT-IPS-MAC:mac_addr': 'fa:16:3e:e8:7f:03', 'version': 4, 'addr': '10.4.0.16', 'OS-EXT-IPS:type': 'fixed'}]}), ip_pool='ext-net', reuse=False)
    self.assert_calls()