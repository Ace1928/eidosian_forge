import warnings
import pyomo.common.unittest as unittest
from pyomo.contrib.pynumero.dependencies import (
def test_matvect_with_empty_rows(self):
    rank = comm.Get_rank()
    rank_ownership = np.array([[0, -1, -1, 0], [-1, 1, -1, 1], [-1, -1, 2, 2], [0, 1, 2, -1]])
    m = MPIBlockMatrix(4, 4, rank_ownership, comm)
    sub_m = np.array([[1, 0], [0, 1]])
    sub_m = coo_matrix(sub_m)
    m.set_block(rank, rank, sub_m.copy())
    m.set_block(rank, 3, sub_m.copy())
    m.set_row_size(3, 2)
    rank_ownership = np.array([0, 1, 2, -1])
    v = MPIBlockVector(4, rank_ownership, comm)
    sub_v = np.ones(2)
    v.set_block(rank, sub_v.copy())
    v.set_block(3, sub_v.copy())
    res = m.dot(v)
    self.assertIsInstance(res, MPIBlockVector)
    self.assertTrue(np.allclose(res.get_block(rank), sub_v * 2))
    self.assertTrue(np.allclose(res.get_block(3), np.zeros(2)))
    self.assertTrue(np.allclose(res.rank_ownership, np.array([0, 1, 2, -1])))
    self.assertFalse(res.has_none)
    rank_ownership = np.array([[0, -1, -1, 0], [-1, 1, -1, 1], [-1, -1, 2, 2], [0, -1, -1, -1]])
    m = MPIBlockMatrix(4, 4, rank_ownership, comm)
    sub_m = np.array([[1, 0], [0, 1]])
    sub_m = coo_matrix(sub_m)
    m.set_block(rank, rank, sub_m.copy())
    m.set_block(rank, 3, sub_m.copy())
    m.set_row_size(3, 2)
    res = m.dot(v)
    self.assertIsInstance(res, MPIBlockVector)
    self.assertTrue(np.allclose(res.get_block(rank), sub_v * 2))
    if rank == 0:
        self.assertTrue(np.allclose(res.get_block(3), np.zeros(2)))
    self.assertTrue(np.allclose(res.rank_ownership, np.array([0, 1, 2, 0])))
    self.assertFalse(res.has_none)
    rank_ownership = np.array([[0, -1, -1, 0], [-1, 1, -1, 1], [-1, -1, 2, 2], [-1, -1, -1, 0]])
    m = MPIBlockMatrix(4, 4, rank_ownership, comm)
    sub_m = np.array([[1, 0], [0, 1]])
    sub_m = coo_matrix(sub_m)
    m.set_block(rank, rank, sub_m.copy())
    m.set_block(rank, 3, sub_m.copy())
    m.set_row_size(3, 2)
    res = m.dot(v)
    self.assertIsInstance(res, MPIBlockVector)
    self.assertTrue(np.allclose(res.get_block(rank), sub_v * 2))
    if rank == 0:
        self.assertTrue(np.allclose(res.get_block(3), np.zeros(2)))
    self.assertTrue(np.allclose(res.rank_ownership, np.array([0, 1, 2, 0])))
    self.assertFalse(res.has_none)