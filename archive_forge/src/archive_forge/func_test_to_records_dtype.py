from collections import abc
import email
from email.parser import Parser
import numpy as np
import pytest
from pandas import (
import pandas._testing as tm
@pytest.mark.parametrize('kwargs,expected', [({}, np.rec.array([(0, 1, 0.2, 'a'), (1, 2, 1.5, 'bc')], dtype=[('index', f'{tm.ENDIAN}i8'), ('A', f'{tm.ENDIAN}i8'), ('B', f'{tm.ENDIAN}f8'), ('C', 'O')])), ({'index': True}, np.rec.array([(0, 1, 0.2, 'a'), (1, 2, 1.5, 'bc')], dtype=[('index', f'{tm.ENDIAN}i8'), ('A', f'{tm.ENDIAN}i8'), ('B', f'{tm.ENDIAN}f8'), ('C', 'O')])), ({'column_dtypes': f'{tm.ENDIAN}U4'}, np.rec.array([('0', '1', '0.2', 'a'), ('1', '2', '1.5', 'bc')], dtype=[('index', f'{tm.ENDIAN}i8'), ('A', f'{tm.ENDIAN}U4'), ('B', f'{tm.ENDIAN}U4'), ('C', f'{tm.ENDIAN}U4')])), ({'index_dtypes': f'{tm.ENDIAN}U1'}, np.rec.array([('0', 1, 0.2, 'a'), ('1', 2, 1.5, 'bc')], dtype=[('index', f'{tm.ENDIAN}U1'), ('A', f'{tm.ENDIAN}i8'), ('B', f'{tm.ENDIAN}f8'), ('C', 'O')])), ({'column_dtypes': str}, np.rec.array([('0', '1', '0.2', 'a'), ('1', '2', '1.5', 'bc')], dtype=[('index', f'{tm.ENDIAN}i8'), ('A', f'{tm.ENDIAN}U'), ('B', f'{tm.ENDIAN}U'), ('C', f'{tm.ENDIAN}U')])), ({'column_dtypes': np.dtype(np.str_)}, np.rec.array([('0', '1', '0.2', 'a'), ('1', '2', '1.5', 'bc')], dtype=[('index', f'{tm.ENDIAN}i8'), ('A', f'{tm.ENDIAN}U'), ('B', f'{tm.ENDIAN}U'), ('C', f'{tm.ENDIAN}U')])), ({'column_dtypes': {'A': np.int8, 'B': np.float32, 'C': f'{tm.ENDIAN}U2'}}, np.rec.array([('0', '1', '0.2', 'a'), ('1', '2', '1.5', 'bc')], dtype=[('index', f'{tm.ENDIAN}i8'), ('A', 'i1'), ('B', f'{tm.ENDIAN}f4'), ('C', f'{tm.ENDIAN}U2')])), ({'index_dtypes': {0: 'int16'}}, np.rec.array([(0, 1, 0.2, 'a'), (1, 2, 1.5, 'bc')], dtype=[('index', 'i2'), ('A', f'{tm.ENDIAN}i8'), ('B', f'{tm.ENDIAN}f8'), ('C', 'O')])), ({'index': False, 'index_dtypes': f'{tm.ENDIAN}U2'}, np.rec.array([(1, 0.2, 'a'), (2, 1.5, 'bc')], dtype=[('A', f'{tm.ENDIAN}i8'), ('B', f'{tm.ENDIAN}f8'), ('C', 'O')])), ({'index_dtypes': {0: 'int16', 'not-there': 'float32'}}, np.rec.array([(0, 1, 0.2, 'a'), (1, 2, 1.5, 'bc')], dtype=[('index', 'i2'), ('A', f'{tm.ENDIAN}i8'), ('B', f'{tm.ENDIAN}f8'), ('C', 'O')])), ({'column_dtypes': {'A': np.int8, 'B': np.float32}}, np.rec.array([('0', '1', '0.2', 'a'), ('1', '2', '1.5', 'bc')], dtype=[('index', f'{tm.ENDIAN}i8'), ('A', 'i1'), ('B', f'{tm.ENDIAN}f4'), ('C', 'O')])), ({'column_dtypes': {'A': np.dtype('int8'), 'B': np.dtype('float32')}}, np.rec.array([('0', '1', '0.2', 'a'), ('1', '2', '1.5', 'bc')], dtype=[('index', f'{tm.ENDIAN}i8'), ('A', 'i1'), ('B', f'{tm.ENDIAN}f4'), ('C', 'O')])), ({'column_dtypes': {'A': np.int8, 'B': np.float32}, 'index_dtypes': f'{tm.ENDIAN}U2'}, np.rec.array([('0', '1', '0.2', 'a'), ('1', '2', '1.5', 'bc')], dtype=[('index', f'{tm.ENDIAN}U2'), ('A', 'i1'), ('B', f'{tm.ENDIAN}f4'), ('C', 'O')])), ({'index': False, 'column_dtypes': []}, (ValueError, 'Invalid dtype \\[\\] specified for column A')), ({'index': False, 'column_dtypes': {'A': 'int32', 'B': 5}}, (ValueError, 'Invalid dtype 5 specified for column B')), ({'index': False, 'column_dtypes': {'A': 'int32', 'B': CategoricalDtype(['a', 'b'])}}, (ValueError, 'Invalid dtype category specified for column B')), ({'index': False, 'column_dtypes': {'A': 'int32', 'B': 'foo'}}, (TypeError, 'data type ["\']foo["\'] not understood'))])
def test_to_records_dtype(self, kwargs, expected):
    df = DataFrame({'A': [1, 2], 'B': [0.2, 1.5], 'C': ['a', 'bc']})
    if not isinstance(expected, np.rec.recarray):
        with pytest.raises(expected[0], match=expected[1]):
            df.to_records(**kwargs)
    else:
        result = df.to_records(**kwargs)
        tm.assert_almost_equal(result, expected)