import warnings
from scipy._lib import _pep440
import numpy as np
from numpy.testing import (assert_array_almost_equal,
import pytest
from pytest import raises as assert_raises
from numpy import array, spacing, sin, pi, sort, sqrt
from scipy.signal import (argrelextrema, BadCoefficients, bessel, besselap, bilinear,
from scipy.signal._filter_design import (_cplxreal, _cplxpair, _norm_factor,
class TestCheby1:

    def test_degenerate(self):
        b, a = cheby1(0, 10 * np.log10(2), 1, analog=True)
        assert_array_almost_equal(b, [1 / np.sqrt(2)])
        assert_array_equal(a, [1])
        b, a = cheby1(1, 10 * np.log10(2), 1, analog=True)
        assert_array_almost_equal(b, [1])
        assert_array_almost_equal(a, [1, 1])
        z, p, k = cheby1(1, 0.1, 0.3, output='zpk')
        assert_array_equal(z, [-1])
        assert_allclose(p, [-0.5390126972799615], rtol=1e-14)
        assert_allclose(k, 0.7695063486399808, rtol=1e-14)

    def test_basic(self):
        for N in range(25):
            wn = 0.01
            z, p, k = cheby1(N, 1, wn, 'low', analog=True, output='zpk')
            assert_array_almost_equal([], z)
            assert_(len(p) == N)
            assert_(all(np.real(p) <= 0))
        for N in range(25):
            wn = 0.01
            z, p, k = cheby1(N, 1, wn, 'high', analog=False, output='zpk')
            assert_array_equal(np.ones(N), z)
            assert_(all(np.abs(p) <= 1))
        b, a = cheby1(8, 0.5, 0.048)
        assert_array_almost_equal(b, [2.150733144728282e-11, 1.720586515782626e-10, 6.02205280523919e-10, 1.204410561047838e-09, 1.505513201309798e-09, 1.204410561047838e-09, 6.02205280523919e-10, 1.720586515782626e-10, 2.150733144728282e-11], decimal=14)
        assert_array_almost_equal(a, [1.0, -7.782402035027959, 26.54354569747454, -51.82182531666387, 63.34127355102684, -49.63358186631157, 24.34862182949389, -6.836925348604676, 0.841293494444914], decimal=14)
        b, a = cheby1(4, 1, [0.4, 0.7], btype='band')
        assert_array_almost_equal(b, [0.0084, 0, -0.0335, 0, 0.0502, 0, -0.0335, 0, 0.0084], decimal=4)
        assert_array_almost_equal(a, [1.0, 1.1191, 2.862, 2.2986, 3.4137, 1.8653, 1.8982, 0.5676, 0.4103], decimal=4)
        b2, a2 = cheby1(5, 3, 1, analog=True)
        assert_array_almost_equal(b2, [0.0626], decimal=4)
        assert_array_almost_equal(a2, [1, 0.5745, 1.415, 0.5489, 0.408, 0.0626], decimal=4)
        b, a = cheby1(8, 0.5, 0.1)
        assert_array_almost_equal(b, 1e-06 * np.array([0.00703924326028, 0.05631394608227, 0.19709881128793, 0.39419762257586, 0.49274702821983, 0.39419762257586, 0.19709881128793, 0.05631394608227, 0.00703924326028]), decimal=13)
        assert_array_almost_equal(a, [1.0, -7.44912258934158, 24.46749067762108, -46.27560200466141, 55.11160187999928, -42.31640010161038, 20.45543300484147, -5.69110270561444, 0.69770374759022], decimal=13)
        b, a = cheby1(8, 0.5, 0.25)
        assert_array_almost_equal(b, 0.001 * np.array([0.00895261138923, 0.07162089111382, 0.25067311889837, 0.50134623779673, 0.62668279724591, 0.50134623779673, 0.25067311889837, 0.07162089111382, 0.00895261138923]), decimal=13)
        assert_array_almost_equal(a, [1.0, -5.97529229188545, 16.58122329202101, -27.71423273542923, 30.39509758355313, -22.34729670426879, 10.7450980043491, -3.08924633697497, 0.40707685889802], decimal=13)

    def test_highpass(self):
        z, p, k = cheby1(24, 0.7, 0.2, 'high', output='zpk')
        z2 = np.ones(24)
        p2 = [-0.6136558509657073 + 0.2700091504942893j, -0.6136558509657073 - 0.2700091504942893j, -0.3303348340927516 + 0.6659400861114254j, -0.3303348340927516 - 0.6659400861114254j, 0.008779713780557169 + 0.822310844748304j, 0.008779713780557169 - 0.822310844748304j, 0.2742361123006911 + 0.8356666951611864j, 0.2742361123006911 - 0.8356666951611864j, 0.4562984557158206 + 0.7954276912303594j, 0.4562984557158206 - 0.7954276912303594j, 0.5777335494123628 + 0.7435821817961783j, 0.5777335494123628 - 0.7435821817961783j, 0.6593260977749194 + 0.6955390907990932j, 0.6593260977749194 - 0.6955390907990932j, 0.7149590948466562 + 0.6559437858502012j, 0.7149590948466562 - 0.6559437858502012j, 0.7532432388188739 + 0.625615804229206j, 0.7532432388188739 - 0.625615804229206j, 0.7794365244268271 + 0.6042099234813333j, 0.7794365244268271 - 0.6042099234813333j, 0.7967253874772997 + 0.5911966597313203j, 0.7967253874772997 - 0.5911966597313203j, 0.806975641729387 + 0.5862214589217275j, 0.806975641729387 - 0.5862214589217275j]
        k2 = 0.0006190427617192018
        assert_array_equal(z, z2)
        assert_allclose(sorted(p, key=np.imag), sorted(p2, key=np.imag), rtol=1e-10)
        assert_allclose(k, k2, rtol=1e-10)
        z, p, k = cheby1(23, 0.8, 0.3, 'high', output='zpk')
        z2 = np.ones(23)
        p2 = [-0.767640053201101, -0.6754621070166477 + 0.3970502605619561j, -0.6754621070166477 - 0.3970502605619561j, -0.4528880018446727 + 0.6844061483786332j, -0.4528880018446727 - 0.6844061483786332j, -0.1986009130216447 + 0.8382285942941594j, -0.1986009130216447 - 0.8382285942941594j, 0.02504673931532608 + 0.895813763579408j, 0.02504673931532608 - 0.895813763579408j, 0.2001089429976469 + 0.901067829079148j, 0.2001089429976469 - 0.901067829079148j, 0.3302410157191755 + 0.8835444665962544j, 0.3302410157191755 - 0.8835444665962544j, 0.4246662537333661 + 0.8594054226449009j, 0.4246662537333661 - 0.8594054226449009j, 0.4919620928120296 + 0.8366772762965786j, 0.4919620928120296 - 0.8366772762965786j, 0.5385746917494749 + 0.819161618079672j, 0.5385746917494749 - 0.819161618079672j, 0.5855636993537203 + 0.8060680937701062j, 0.5855636993537203 - 0.8060680937701062j, 0.5688812849391721 + 0.8086497795114683j, 0.5688812849391721 - 0.8086497795114683j]
        k2 = 1.941697029206324e-05
        assert_array_equal(z, z2)
        assert_allclose(sorted(p, key=np.imag), sorted(p2, key=np.imag), rtol=1e-10)
        assert_allclose(k, k2, rtol=1e-10)
        z, p, k = cheby1(10, 1, 1000, 'high', analog=True, output='zpk')
        z2 = np.zeros(10)
        p2 = [-3144.743169501551 + 3511.680029092744j, -3144.743169501551 - 3511.680029092744j, -563.3065604514602 + 2023.615191183945j, -563.3065604514602 - 2023.615191183945j, -194.6412183352025 + 1372.309454274755j, -194.6412183352025 - 1372.309454274755j, -79.87162953085479 + 1105.207708045358j, -79.87162953085479 - 1105.207708045358j, -22.50315039031946 + 1001.723931471477j, -22.50315039031946 - 1001.723931471477j]
        k2 = 0.8912509381337453
        assert_array_equal(z, z2)
        assert_allclose(sorted(p, key=np.imag), sorted(p2, key=np.imag), rtol=1e-13)
        assert_allclose(k, k2, rtol=1e-15)

    def test_bandpass(self):
        z, p, k = cheby1(8, 1, [0.3, 0.4], 'bp', output='zpk')
        z2 = [1, 1, 1, 1, 1, 1, 1, 1, -1, -1, -1, -1, -1, -1, -1, -1]
        p2 = [0.3077784854851463 + 0.9453307017592942j, 0.3077784854851463 - 0.9453307017592942j, 0.3280567400654425 + 0.9272377218689016j, 0.3280567400654425 - 0.9272377218689016j, 0.3677912763284301 + 0.9038008865279966j, 0.3677912763284301 - 0.9038008865279966j, 0.4194425632520948 + 0.8769407159656157j, 0.4194425632520948 - 0.8769407159656157j, 0.4740921994669189 + 0.8496508528630974j, 0.4740921994669189 - 0.8496508528630974j, 0.5234866481897429 + 0.8259608422808477j, 0.5234866481897429 - 0.8259608422808477j, 0.5844717632289875 + 0.805290136350021j, 0.5844717632289875 - 0.805290136350021j, 0.561518906333607 + 0.8100667803850766j, 0.561518906333607 - 0.8100667803850766j]
        k2 = 5.007028718074307e-09
        assert_array_equal(z, z2)
        assert_allclose(sorted(p, key=np.imag), sorted(p2, key=np.imag), rtol=1e-13)
        assert_allclose(k, k2, rtol=1e-13)

    def test_bandstop(self):
        z, p, k = cheby1(7, 1, [0.5, 0.6], 'stop', output='zpk')
        z2 = [-0.1583844403245361 + 0.987377521044045j, -0.1583844403245361 - 0.987377521044045j, -0.1583844403245361 + 0.987377521044045j, -0.1583844403245361 - 0.987377521044045j, -0.1583844403245361 + 0.987377521044045j, -0.1583844403245361 - 0.987377521044045j, -0.1583844403245361 + 0.987377521044045j, -0.1583844403245361 - 0.987377521044045j, -0.1583844403245361 + 0.987377521044045j, -0.1583844403245361 - 0.987377521044045j, -0.1583844403245361 + 0.987377521044045j, -0.1583844403245361 - 0.987377521044045j, -0.1583844403245361 + 0.987377521044045j, -0.1583844403245361 - 0.987377521044045j]
        p2 = [-0.08942974551472813 + 0.3482480481185926j, -0.08942974551472813 - 0.3482480481185926j, 0.1293775154041798 + 0.8753499858081858j, 0.1293775154041798 - 0.8753499858081858j, 0.03399741945062013 + 0.9690316022705607j, 0.03399741945062013 - 0.9690316022705607j, 0.0004167225522796539 + 0.9927338161087488j, 0.0004167225522796539 - 0.9927338161087488j, -0.391296654955096 + 0.8046122859255742j, -0.391296654955096 - 0.8046122859255742j, -0.3307805547127368 + 0.9133455018206508j, -0.3307805547127368 - 0.9133455018206508j, -0.3072658345097743 + 0.9443589759799366j, -0.3072658345097743 - 0.9443589759799366j]
        k2 = 0.3619438310405028
        assert_allclose(sorted(z, key=np.imag), sorted(z2, key=np.imag), rtol=1e-13)
        assert_allclose(sorted(p, key=np.imag), sorted(p2, key=np.imag), rtol=1e-13)
        assert_allclose(k, k2, rtol=0, atol=5e-16)

    def test_ba_output(self):
        b, a = cheby1(5, 0.9, [210, 310], 'stop', analog=True)
        b2 = [1.000000000000006, 0, 325500.000000002, 0, 42380100000.00026, 0, 2758944510000017.0, 0, 8.980364380050052e+19, 0, 1.169243442282517e+24]
        a2 = [1.0, 463.0555945694342, 403926.6454794788, 133806098.8610237, 58443335512.94591, 13573463716376.38, 3804661141892782.0, 5.67071585034008e+17, 1.114411200988328e+20, 8.316815934908471e+21, 1.169243442282517e+24]
        assert_allclose(b, b2, rtol=1e-14)
        assert_allclose(a, a2, rtol=1e-14)

    def test_fs_param(self):
        for fs in (900, 900.1, 1234.567):
            for N in (0, 1, 2, 3, 10):
                for fc in (100, 100.1, 432.12345):
                    for btype in ('lp', 'hp'):
                        ba1 = cheby1(N, 1, fc, btype, fs=fs)
                        ba2 = cheby1(N, 1, fc / (fs / 2), btype)
                        assert_allclose(ba1, ba2)
                for fc in ((100, 200), (100.1, 200.2), (321.123, 432.123)):
                    for btype in ('bp', 'bs'):
                        ba1 = cheby1(N, 1, fc, btype, fs=fs)
                        for seq in (list, tuple, array):
                            fcnorm = seq([f / (fs / 2) for f in fc])
                            ba2 = cheby1(N, 1, fcnorm, btype)
                            assert_allclose(ba1, ba2)