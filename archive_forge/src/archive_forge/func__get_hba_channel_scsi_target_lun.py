from __future__ import annotations
import glob
import os
from typing import Iterable
from oslo_concurrency import processutils as putils
from oslo_log import log as logging
from os_brick.initiator import linuxscsi
def _get_hba_channel_scsi_target_lun(self, hba, conn_props):
    """Get HBA channels, SCSI targets, LUNs to FC targets for given HBA.

        Given an HBA and the connection properties we look for the HBA channels
        and SCSI targets for each of the FC targets that this HBA has been
        granted permission to connect.

        For drivers that don't return an initiator to target map we try to find
        the info for all the target ports.

        For drivers that return an initiator_target_map we use the
        initiator_target_lun_map entry that was generated by the FC connector
        based on the contents of the connection information data to know which
        target ports to look for.

        We scan for targets in the following two paths:
        * /sys/class/fc_transport/target<host>*
        * /sys/class/fc_remote_ports/rport-<host>*

        We search for targets in the fc_transport path first and if not
        found, we search in the fc_remote_ports path

        :returns: 2-Tuple with the first entry being a list of [c, t, l]
        entries where the target port was found, and the second entry of the
        tuple being a set of luns for ports that were not found.
        """
    targets = conn_props['targets']
    if conn_props.get('initiator_target_map') is not None:
        targets = conn_props['initiator_target_lun_map'].get(hba['port_name'], targets)
    host_device = hba['host_device']
    if host_device and len(host_device) > 4:
        host_device = host_device[4:]
    path = '/sys/class/fc_transport/target%s:' % host_device
    rpath = '/sys/class/fc_remote_ports/rport-%s:' % host_device
    ctls = []
    luns_not_found = set()
    for wwpn, lun in targets:
        try:
            ctl = self._get_target_fc_transport_path(path, wwpn, lun) or self._get_target_fc_remote_ports_path(rpath, wwpn, lun)
            if ctl:
                ctls.append(ctl)
        except Exception as exc:
            LOG.debug('Could not get HBA channel and SCSI target ID, path: %(path)s*, reason: %(reason)s', {'path': path, 'reason': exc})
            luns_not_found.add(lun)
    return (ctls, luns_not_found)