import json
import logging
import threading
import os
import platform
import sys
import time
import uuid
from dataclasses import asdict, dataclass
from enum import Enum, auto
from pathlib import Path
from typing import Dict, List, Optional, Set
import requests
import yaml
import ray
import ray._private.ray_constants as ray_constants
import ray._private.usage.usage_constants as usage_constant
from ray.experimental.internal_kv import _internal_kv_initialized, _internal_kv_put
from ray.core.generated import usage_pb2, gcs_pb2
def generate_report_data(cluster_config_to_report: ClusterConfigToReport, total_success: int, total_failed: int, seq_number: int, gcs_address: str) -> UsageStatsToReport:
    """Generate the report data.

    Params:
        cluster_config_to_report: The cluster (autoscaler)
            config generated by `get_cluster_config_to_report`.
        total_success: The total number of successful report
            for the lifetime of the cluster.
        total_failed: The total number of failed report
            for the lifetime of the cluster.
        seq_number: The sequence number that's incremented whenever
            a new report is sent.
        gcs_address: the address of gcs to get data to report.

    Returns:
        UsageStats
    """
    gcs_client = ray._raylet.GcsClient(address=gcs_address, nums_reconnect_retry=20)
    cluster_metadata = get_cluster_metadata(gcs_client)
    cluster_status_to_report = get_cluster_status_to_report(gcs_client)
    data = UsageStatsToReport(ray_version=cluster_metadata['ray_version'], python_version=cluster_metadata['python_version'], schema_version=cluster_metadata['schema_version'], source=cluster_metadata['source'], session_id=cluster_metadata['session_id'], git_commit=cluster_metadata['git_commit'], os=cluster_metadata['os'], collect_timestamp_ms=int(time.time() * 1000), session_start_timestamp_ms=cluster_metadata['session_start_timestamp_ms'], cloud_provider=cluster_config_to_report.cloud_provider, min_workers=cluster_config_to_report.min_workers, max_workers=cluster_config_to_report.max_workers, head_node_instance_type=cluster_config_to_report.head_node_instance_type, worker_node_instance_types=cluster_config_to_report.worker_node_instance_types, total_num_cpus=cluster_status_to_report.total_num_cpus, total_num_gpus=cluster_status_to_report.total_num_gpus, total_memory_gb=cluster_status_to_report.total_memory_gb, total_object_store_memory_gb=cluster_status_to_report.total_object_store_memory_gb, library_usages=get_library_usages_to_report(gcs_client), total_success=total_success, total_failed=total_failed, seq_number=seq_number, extra_usage_tags=get_extra_usage_tags_to_report(gcs_client), total_num_nodes=get_total_num_nodes_to_report(gcs_client), total_num_running_jobs=get_total_num_running_jobs_to_report(gcs_client), libc_version=cluster_metadata.get('libc_version'), hardware_usages=get_hardware_usages_to_report(gcs_client))
    return data