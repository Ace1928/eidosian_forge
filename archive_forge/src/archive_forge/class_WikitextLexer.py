import re
from pygments.lexers.html import XmlLexer
from pygments.lexers.javascript import JavascriptLexer
from pygments.lexers.css import CssLexer
from pygments.lexers.lilypond import LilyPondLexer
from pygments.lexers.data import JsonLexer
from pygments.lexer import RegexLexer, DelegatingLexer, include, bygroups, \
from pygments.token import Text, Comment, Operator, Keyword, Name, String, \
from pygments.util import get_bool_opt, ClassNotFound
class WikitextLexer(RegexLexer):
    """
    For MediaWiki Wikitext.

    Parsing Wikitext is tricky, and results vary between different MediaWiki
    installations, so we only highlight common syntaxes (built-in or from
    popular extensions), and also assume templates produce no unbalanced
    syntaxes.

    .. versionadded:: 2.15
    """
    name = 'Wikitext'
    url = 'https://www.mediawiki.org/wiki/Wikitext'
    aliases = ['wikitext', 'mediawiki']
    filenames = []
    mimetypes = ['text/x-wiki']
    flags = re.MULTILINE

    def nowiki_tag_rules(tag_name):
        return [('(?i)(</)({})(\\s*)(>)'.format(tag_name), bygroups(Punctuation, Name.Tag, Whitespace, Punctuation), '#pop'), include('entity'), include('text')]

    def plaintext_tag_rules(tag_name):
        return [('(?si)(.*?)(</)({})(\\s*)(>)'.format(tag_name), bygroups(Text, Punctuation, Name.Tag, Whitespace, Punctuation), '#pop')]

    def delegate_tag_rules(tag_name, lexer):
        return [('(?i)(</)({})(\\s*)(>)'.format(tag_name), bygroups(Punctuation, Name.Tag, Whitespace, Punctuation), '#pop'), ('(?si).+?(?=</{}\\s*>)'.format(tag_name), using(lexer))]

    def text_rules(token):
        return [('\\w+', token), ('[^\\S\\n]+', token), ('(?s).', token)]

    def handle_syntaxhighlight(self, match, ctx):
        from pygments.lexers import get_lexer_by_name
        attr_content = match.group()
        start = 0
        index = 0
        while True:
            index = attr_content.find('>', start)
            if attr_content[index - 2:index] != '--':
                break
            start = index + 1
        if index == -1:
            yield from self.get_tokens_unprocessed(attr_content, stack=['root', 'attr'])
            return
        attr = attr_content[:index]
        yield from self.get_tokens_unprocessed(attr, stack=['root', 'attr'])
        yield (match.start(3) + index, Punctuation, '>')
        lexer = None
        content = attr_content[index + 1:]
        lang_match = re.findall('\\blang=("|\\\'|)(\\w+)(\\1)', attr)
        if len(lang_match) >= 1:
            lang = lang_match[-1][1]
            try:
                lexer = get_lexer_by_name(lang)
            except ClassNotFound:
                pass
        if lexer is None:
            yield (match.start() + index + 1, Text, content)
        else:
            yield from lexer.get_tokens_unprocessed(content)

    def handle_score(self, match, ctx):
        attr_content = match.group()
        start = 0
        index = 0
        while True:
            index = attr_content.find('>', start)
            if attr_content[index - 2:index] != '--':
                break
            start = index + 1
        if index == -1:
            yield from self.get_tokens_unprocessed(attr_content, stack=['root', 'attr'])
            return
        attr = attr_content[:index]
        content = attr_content[index + 1:]
        yield from self.get_tokens_unprocessed(attr, stack=['root', 'attr'])
        yield (match.start(3) + index, Punctuation, '>')
        lang_match = re.findall('\\blang=("|\\\'|)(\\w+)(\\1)', attr)
        lang = lang_match[-1][1] if len(lang_match) >= 1 else 'lilypond'
        if lang == 'lilypond':
            yield from LilyPondLexer().get_tokens_unprocessed(content)
        else:
            yield (match.start() + index + 1, Text, content)
    title_char = ' %!"$&\\\'()*,\\-./0-9:;=?@A-Z\\\\\\^_`~+\\u0080-\\uFFFF'
    nbsp_char = '(?:\\t|&nbsp;|&\\#0*160;|&\\#[Xx]0*[Aa]0;|[ \\xA0\\u1680\\u2000-\\u200A\\u202F\\u205F\\u3000])'
    link_address = '(?:[0-9.]+|\\[[0-9a-f:.]+\\]|[^\\x00-\\x20"<>\\[\\]\\x7F\\xA0\\u1680\\u2000-\\u200A\\u202F\\u205F\\u3000\\uFFFD])'
    link_char_class = '[^\\x00-\\x20"<>\\[\\]\\x7F\\xA0\\u1680\\u2000-\\u200A\\u202F\\u205F\\u3000\\uFFFD]'
    double_slashes_i = {'__FORCETOC__', '__NOCONTENTCONVERT__', '__NOCC__', '__NOEDITSECTION__', '__NOGALLERY__', '__NOTITLECONVERT__', '__NOTC__', '__NOTOC__', '__TOC__'}
    double_slashes = {'__EXPECTUNUSEDCATEGORY__', '__HIDDENCAT__', '__INDEX__', '__NEWSECTIONLINK__', '__NOINDEX__', '__NONEWSECTIONLINK__', '__STATICREDIRECT__', '__NOGLOBAL__', '__DISAMBIG__', '__EXPECTED_UNCONNECTED_PAGE__'}
    protocols = {'bitcoin:', 'ftp://', 'ftps://', 'geo:', 'git://', 'gopher://', 'http://', 'https://', 'irc://', 'ircs://', 'magnet:', 'mailto:', 'mms://', 'news:', 'nntp://', 'redis://', 'sftp://', 'sip:', 'sips:', 'sms:', 'ssh://', 'svn://', 'tel:', 'telnet://', 'urn:', 'worldwind://', 'xmpp:', '//'}
    non_relative_protocols = protocols - {'//'}
    html_tags = {'abbr', 'b', 'bdi', 'bdo', 'big', 'blockquote', 'br', 'caption', 'center', 'cite', 'code', 'data', 'dd', 'del', 'dfn', 'div', 'dl', 'dt', 'em', 'font', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'hr', 'i', 'ins', 'kbd', 'li', 'link', 'mark', 'meta', 'ol', 'p', 'q', 'rb', 'rp', 'rt', 'rtc', 'ruby', 's', 'samp', 'small', 'span', 'strike', 'strong', 'sub', 'sup', 'table', 'td', 'th', 'time', 'tr', 'tt', 'u', 'ul', 'var', 'wbr'}
    parser_tags = {'graph', 'charinsert', 'rss', 'chem', 'categorytree', 'nowiki', 'inputbox', 'math', 'hiero', 'score', 'pre', 'ref', 'translate', 'imagemap', 'templatestyles', 'languages', 'noinclude', 'mapframe', 'section', 'poem', 'syntaxhighlight', 'includeonly', 'tvar', 'onlyinclude', 'templatedata', 'langconvert', 'timeline', 'dynamicpagelist', 'gallery', 'maplink', 'ce', 'references'}
    variant_langs = {'zh', 'zh-hans', 'zh-hant', 'zh-cn', 'zh-hk', 'zh-mo', 'zh-my', 'zh-sg', 'zh-tw', 'uz', 'uz-latn', 'uz-cyrl', 'tly', 'tly-cyrl', 'tg', 'tg-latn', 'sr', 'sr-ec', 'sr-el', 'shi', 'shi-tfng', 'shi-latn', 'sh-latn', 'sh-cyrl', 'ku', 'ku-arab', 'ku-latn', 'kk', 'kk-cyrl', 'kk-latn', 'kk-arab', 'kk-kz', 'kk-tr', 'kk-cn', 'iu', 'ike-cans', 'ike-latn', 'gan', 'gan-hans', 'gan-hant', 'en', 'en-x-piglatin', 'crh', 'crh-cyrl', 'crh-latn', 'ban', 'ban-bali', 'ban-x-dharma', 'ban-x-palmleaf', 'ban-x-pku'}
    magic_vars_i = {'ARTICLEPATH', 'INT', 'PAGEID', 'SCRIPTPATH', 'SERVER', 'SERVERNAME', 'STYLEPATH'}
    magic_vars = {'!', '=', 'BASEPAGENAME', 'BASEPAGENAMEE', 'CASCADINGSOURCES', 'CONTENTLANGUAGE', 'CONTENTLANG', 'CURRENTDAY', 'CURRENTDAY2', 'CURRENTDAYNAME', 'CURRENTDOW', 'CURRENTHOUR', 'CURRENTMONTH', 'CURRENTMONTH2', 'CURRENTMONTH1', 'CURRENTMONTHABBREV', 'CURRENTMONTHNAME', 'CURRENTMONTHNAMEGEN', 'CURRENTTIME', 'CURRENTTIMESTAMP', 'CURRENTVERSION', 'CURRENTWEEK', 'CURRENTYEAR', 'DIRECTIONMARK', 'DIRMARK', 'FULLPAGENAME', 'FULLPAGENAMEE', 'LOCALDAY', 'LOCALDAY2', 'LOCALDAYNAME', 'LOCALDOW', 'LOCALHOUR', 'LOCALMONTH', 'LOCALMONTH2', 'LOCALMONTH1', 'LOCALMONTHABBREV', 'LOCALMONTHNAME', 'LOCALMONTHNAMEGEN', 'LOCALTIME', 'LOCALTIMESTAMP', 'LOCALWEEK', 'LOCALYEAR', 'NAMESPACE', 'NAMESPACEE', 'NAMESPACENUMBER', 'NUMBEROFACTIVEUSERS', 'NUMBEROFADMINS', 'NUMBEROFARTICLES', 'NUMBEROFEDITS', 'NUMBEROFFILES', 'NUMBEROFPAGES', 'NUMBEROFUSERS', 'PAGELANGUAGE', 'PAGENAME', 'PAGENAMEE', 'REVISIONDAY', 'REVISIONDAY2', 'REVISIONID', 'REVISIONMONTH', 'REVISIONMONTH1', 'REVISIONSIZE', 'REVISIONTIMESTAMP', 'REVISIONUSER', 'REVISIONYEAR', 'ROOTPAGENAME', 'ROOTPAGENAMEE', 'SITENAME', 'SUBJECTPAGENAME', 'ARTICLEPAGENAME', 'SUBJECTPAGENAMEE', 'ARTICLEPAGENAMEE', 'SUBJECTSPACE', 'ARTICLESPACE', 'SUBJECTSPACEE', 'ARTICLESPACEE', 'SUBPAGENAME', 'SUBPAGENAMEE', 'TALKPAGENAME', 'TALKPAGENAMEE', 'TALKSPACE', 'TALKSPACEE'}
    parser_functions_i = {'ANCHORENCODE', 'BIDI', 'CANONICALURL', 'CANONICALURLE', 'FILEPATH', 'FORMATNUM', 'FULLURL', 'FULLURLE', 'GENDER', 'GRAMMAR', 'INT', '\\#LANGUAGE', 'LC', 'LCFIRST', 'LOCALURL', 'LOCALURLE', 'NS', 'NSE', 'PADLEFT', 'PADRIGHT', 'PAGEID', 'PLURAL', 'UC', 'UCFIRST', 'URLENCODE'}
    parser_functions = {'BASEPAGENAME', 'BASEPAGENAMEE', 'CASCADINGSOURCES', 'DEFAULTSORT', 'DEFAULTSORTKEY', 'DEFAULTCATEGORYSORT', 'FULLPAGENAME', 'FULLPAGENAMEE', 'NAMESPACE', 'NAMESPACEE', 'NAMESPACENUMBER', 'NUMBERINGROUP', 'NUMINGROUP', 'NUMBEROFACTIVEUSERS', 'NUMBEROFADMINS', 'NUMBEROFARTICLES', 'NUMBEROFEDITS', 'NUMBEROFFILES', 'NUMBEROFPAGES', 'NUMBEROFUSERS', 'PAGENAME', 'PAGENAMEE', 'PAGESINCATEGORY', 'PAGESINCAT', 'PAGESIZE', 'PROTECTIONEXPIRY', 'PROTECTIONLEVEL', 'REVISIONDAY', 'REVISIONDAY2', 'REVISIONID', 'REVISIONMONTH', 'REVISIONMONTH1', 'REVISIONTIMESTAMP', 'REVISIONUSER', 'REVISIONYEAR', 'ROOTPAGENAME', 'ROOTPAGENAMEE', 'SUBJECTPAGENAME', 'ARTICLEPAGENAME', 'SUBJECTPAGENAMEE', 'ARTICLEPAGENAMEE', 'SUBJECTSPACE', 'ARTICLESPACE', 'SUBJECTSPACEE', 'ARTICLESPACEE', 'SUBPAGENAME', 'SUBPAGENAMEE', 'TALKPAGENAME', 'TALKPAGENAMEE', 'TALKSPACE', 'TALKSPACEE', 'INT', 'DISPLAYTITLE', 'PAGESINNAMESPACE', 'PAGESINNS'}
    tokens = {'root': [('(?xi)\n                (\\A\\s*?)(\\#REDIRECT:?) # may contain a colon\n                (\\s+)(\\[\\[) (?=[^\\]\\n]* \\]\\]$)\n            ', bygroups(Whitespace, Keyword, Whitespace, Punctuation), 'redirect-inner'), ('^(={2,6})(.+?)(\\1)(\\s*$\\n)', bygroups(Generic.Subheading, Generic.Subheading, Generic.Subheading, Whitespace)), ('^(=.+?=)(\\s*$\\n)', bygroups(Generic.Heading, Whitespace)), (words(double_slashes_i, prefix='(?i)'), Name.Function.Magic), (words(double_slashes), Name.Function.Magic), ('(?i)\\b(?:{}){}{}*'.format('|'.join(protocols), link_address, link_char_class), Name.Label), ('\\b(?:RFC|PMID){}+[0-9]+\\b'.format(nbsp_char), Name.Function.Magic), ('(?x)\n                \\bISBN {nbsp_char}\n                (?: 97[89] {nbsp_dash}? )?\n                (?: [0-9] {nbsp_dash}? ){{9}} # escape format()\n                [0-9Xx]\\b\n            '.format(nbsp_char=nbsp_char, nbsp_dash=f'(?:-|{nbsp_char})'), Name.Function.Magic), include('list'), include('inline'), include('text')], 'redirect-inner': [('(\\]\\])(\\s*?\\n)', bygroups(Punctuation, Whitespace), '#pop'), ('(\\#)([^#]*?)', bygroups(Punctuation, Name.Label)), ('(?i)[{}]+'.format(title_char), Name.Tag)], 'list': [('^;', Keyword, 'dt'), ('^[#:*]+', Keyword), ('^-{4,}', Keyword)], 'inline': [('~{3,5}', Keyword), include('entity'), ("('')(''')(?!')", bygroups(Generic.Emph, Generic.EmphStrong), 'inline-italic-bold'), ("'''(?!')", Generic.Strong, 'inline-bold'), ("''(?!')", Generic.Emph, 'inline-italic'), include('replaceable'), ('(?xi)\n                (\\[\\[)\n                    (File|Image) (:)\n                    ((?: [%s] | \\{{2,3}[^{}]*?\\}{2,3} | <!--[\\s\\S]*?--> )*)\n                    (?: (\\#) ([%s]*?) )?\n                ' % (title_char, f'{title_char}#'), bygroups(Punctuation, Name.Namespace, Punctuation, using(this, state=['wikilink-name']), Punctuation, Name.Label), 'medialink-inner'), ('(?xi)\n                (\\[\\[)(?!%s) # Should not contain URLs\n                    (?: ([%s]*) (:))?\n                    ((?: [%s] | \\{{2,3}[^{}]*?\\}{2,3} | <!--[\\s\\S]*?--> )*?)\n                    (?: (\\#) ([%s]*?) )?\n                (\\]\\])\n                ' % ('|'.join(protocols), title_char.replace('/', ''), title_char, f'{title_char}#'), bygroups(Punctuation, Name.Namespace, Punctuation, using(this, state=['wikilink-name']), Punctuation, Name.Label, Punctuation)), ('(?xi)\n                (\\[\\[)(?!%s)\n                    (?: ([%s]*) (:))?\n                    ((?: [%s] | \\{{2,3}[^{}]*?\\}{2,3} | <!--[\\s\\S]*?--> )*?)\n                    (?: (\\#) ([%s]*?) )?\n                    (\\|)\n                ' % ('|'.join(protocols), title_char.replace('/', ''), title_char, f'{title_char}#'), bygroups(Punctuation, Name.Namespace, Punctuation, using(this, state=['wikilink-name']), Punctuation, Name.Label, Punctuation), 'wikilink-inner'), ('(?xi)\n                (\\[)\n                    ((?:{}) {} {}*)\n                    (\\s*)\n                '.format('|'.join(protocols), link_address, link_char_class), bygroups(Punctuation, Name.Label, Whitespace), 'extlink-inner'), ('^(:*)(\\s*?)(\\{\\|)([^\\n]*)$', bygroups(Keyword, Whitespace, Punctuation, using(this, state=['root', 'attr'])), 'table'), ('(?i)(<)({})\\b'.format('|'.join(html_tags)), bygroups(Punctuation, Name.Tag), 'tag-inner-ordinary'), ('(?i)(</)({})\\b(\\s*)(>)'.format('|'.join(html_tags)), bygroups(Punctuation, Name.Tag, Whitespace, Punctuation)), ('(?i)(<)(nowiki)\\b', bygroups(Punctuation, Name.Tag), ('tag-nowiki', 'tag-inner')), ('(?i)(<)(pre)\\b', bygroups(Punctuation, Name.Tag), ('tag-pre', 'tag-inner')), ('(?i)(<)(categorytree)\\b', bygroups(Punctuation, Name.Tag), ('tag-categorytree', 'tag-inner')), ('(?i)(<)(hiero)\\b', bygroups(Punctuation, Name.Tag), ('tag-hiero', 'tag-inner')), ('(?i)(<)(math)\\b', bygroups(Punctuation, Name.Tag), ('tag-math', 'tag-inner')), ('(?i)(<)(chem)\\b', bygroups(Punctuation, Name.Tag), ('tag-chem', 'tag-inner')), ('(?i)(<)(ce)\\b', bygroups(Punctuation, Name.Tag), ('tag-ce', 'tag-inner')), ('(?i)(<)(charinsert)\\b', bygroups(Punctuation, Name.Tag), ('tag-charinsert', 'tag-inner')), ('(?i)(<)(templatedata)\\b', bygroups(Punctuation, Name.Tag), ('tag-templatedata', 'tag-inner')), ('(?i)(<)(gallery)\\b', bygroups(Punctuation, Name.Tag), ('tag-gallery', 'tag-inner')), ('(?i)(<)(gallery)\\b', bygroups(Punctuation, Name.Tag), ('tag-graph', 'tag-inner')), ('(?i)(<)(dynamicpagelist)\\b', bygroups(Punctuation, Name.Tag), ('tag-dynamicpagelist', 'tag-inner')), ('(?i)(<)(inputbox)\\b', bygroups(Punctuation, Name.Tag), ('tag-inputbox', 'tag-inner')), ('(?i)(<)(rss)\\b', bygroups(Punctuation, Name.Tag), ('tag-rss', 'tag-inner')), ('(?i)(<)(imagemap)\\b', bygroups(Punctuation, Name.Tag), ('tag-imagemap', 'tag-inner')), ('(?i)(</)(syntaxhighlight)\\b(\\s*)(>)', bygroups(Punctuation, Name.Tag, Whitespace, Punctuation)), ('(?si)(<)(syntaxhighlight)\\b([^>]*?(?<!/)>.*?)(?=</\\2\\s*>)', bygroups(Punctuation, Name.Tag, handle_syntaxhighlight)), ('(?i)(<)(syntaxhighlight)\\b(\\s*?)((?:[^>]|-->)*?)(/\\s*?(?<!--)>)', bygroups(Punctuation, Name.Tag, Whitespace, using(this, state=['root', 'attr']), Punctuation)), ('(?i)(</)(source)\\b(\\s*)(>)', bygroups(Punctuation, Name.Tag, Whitespace, Punctuation)), ('(?si)(<)(source)\\b([^>]*?(?<!/)>.*?)(?=</\\2\\s*>)', bygroups(Punctuation, Name.Tag, handle_syntaxhighlight)), ('(?i)(<)(source)\\b(\\s*?)((?:[^>]|-->)*?)(/\\s*?(?<!--)>)', bygroups(Punctuation, Name.Tag, Whitespace, using(this, state=['root', 'attr']), Punctuation)), ('(?i)(</)(score)\\b(\\s*)(>)', bygroups(Punctuation, Name.Tag, Whitespace, Punctuation)), ('(?si)(<)(score)\\b([^>]*?(?<!/)>.*?)(?=</\\2\\s*>)', bygroups(Punctuation, Name.Tag, handle_score)), ('(?i)(<)(score)\\b(\\s*?)((?:[^>]|-->)*?)(/\\s*?(?<!--)>)', bygroups(Punctuation, Name.Tag, Whitespace, using(this, state=['root', 'attr']), Punctuation)), ('(?i)(<)({})\\b'.format('|'.join(parser_tags)), bygroups(Punctuation, Name.Tag), 'tag-inner-ordinary'), ('(?i)(</)({})\\b(\\s*)(>)'.format('|'.join(parser_tags)), bygroups(Punctuation, Name.Tag, Whitespace, Punctuation)), ('(?xi)\n                (-\\{{) # Escape format()\n                    (?: ([^|]) (\\|))?\n                    (?: (\\s* (?:{variants}) \\s*) (=>))?\n                    (\\s* (?:{variants}) \\s*) (:)\n                '.format(variants='|'.join(variant_langs)), bygroups(Punctuation, Keyword, Punctuation, Name.Label, Operator, Name.Label, Punctuation), 'lc-inner'), ('-\\{(?!\\{)', Punctuation, 'lc-raw')], 'wikilink-name': [include('replaceable'), ('[^{<]+', Name.Tag), ('(?s).', Name.Tag)], 'wikilink-inner': [('(?=\\[\\[)', Punctuation, '#pop'), ('\\]\\]', Punctuation, '#pop'), include('inline'), include('text')], 'medialink-inner': [('\\]\\]', Punctuation, '#pop'), ('(\\|)([^\\n=|]*)(=)', bygroups(Punctuation, Name.Attribute, Operator)), ('\\|', Punctuation), include('inline'), include('text')], 'quote-common': [('(?=\\]\\]|\\{\\{|\\}\\})', Punctuation, '#pop'), ('\\n', Text, '#pop')], 'inline-italic': [include('quote-common'), ("('')(''')(?!')", bygroups(Generic.Emph, Generic.Strong), ('#pop', 'inline-bold')), ("'''(?!')", Generic.EmphStrong, ('#pop', 'inline-italic-bold')), ("''(?!')", Generic.Emph, '#pop'), include('inline'), include('text-italic')], 'inline-bold': [include('quote-common'), ("(''')('')(?!')", bygroups(Generic.Strong, Generic.Emph), ('#pop', 'inline-italic')), ("'''(?!')", Generic.Strong, '#pop'), ("''(?!')", Generic.EmphStrong, ('#pop', 'inline-bold-italic')), include('inline'), include('text-bold')], 'inline-bold-italic': [include('quote-common'), ("('')(''')(?!')", bygroups(Generic.EmphStrong, Generic.Strong), '#pop'), ("'''(?!')", Generic.EmphStrong, ('#pop', 'inline-italic')), ("''(?!')", Generic.EmphStrong, ('#pop', 'inline-bold')), include('inline'), include('text-bold-italic')], 'inline-italic-bold': [include('quote-common'), ("(''')('')(?!')", bygroups(Generic.EmphStrong, Generic.Emph), '#pop'), ("'''(?!')", Generic.EmphStrong, ('#pop', 'inline-italic')), ("''(?!')", Generic.EmphStrong, ('#pop', 'inline-bold')), include('inline'), include('text-bold-italic')], 'lc-inner': [('(?xi)\n                (;)\n                (?: (\\s* (?:{variants}) \\s*) (=>))?\n                (\\s* (?:{variants}) \\s*) (:)\n                '.format(variants='|'.join(variant_langs)), bygroups(Punctuation, Name.Label, Operator, Name.Label, Punctuation)), (';?\\s*?\\}-', Punctuation, '#pop'), include('inline'), include('text')], 'lc-raw': [('\\}-', Punctuation, '#pop'), include('inline'), include('text')], 'replaceable': [('<!--[\\s\\S]*?(?:-->|\\Z)', Comment.Multiline), ('(?x)\n                (\\{{3})\n                    ([^|]*?)\n                    (?=\\}{3}|\\|)\n                ', bygroups(Punctuation, Name.Variable), 'parameter-inner'), ('(?i)(\\{\\{)(\\s*)(%s)(\\s*)(\\}\\})' % '|'.join(magic_vars_i), bygroups(Punctuation, Whitespace, Name.Function, Whitespace, Punctuation)), ('(\\{\\{)(\\s*)(%s)(\\s*)(\\}\\})' % '|'.join(magic_vars), bygroups(Punctuation, Whitespace, Name.Function, Whitespace, Punctuation)), ('\\{\\{', Punctuation, 'template-begin-space'), ('(?i)(<)(tvar)\\b(\\|)([^>]*?)(>)', bygroups(Punctuation, Name.Tag, Punctuation, String, Punctuation)), ('</>', Punctuation, '#pop'), ('(?i)(<)(tvar)\\b', bygroups(Punctuation, Name.Tag), 'tag-inner-ordinary'), ('(?i)(</)(tvar)\\b(\\s*)(>)', bygroups(Punctuation, Name.Tag, Whitespace, Punctuation))], 'parameter-inner': [('\\}{3}', Punctuation, '#pop'), ('\\|', Punctuation), include('inline'), include('text')], 'template-begin-space': [('<!--[\\s\\S]*?(?:-->|\\Z)', Comment.Multiline), ('\\s+', Whitespace), ('(?i)(\\#[%s]*?|%s)(:)' % (title_char, '|'.join(parser_functions_i)), bygroups(Name.Function, Punctuation), ('#pop', 'template-inner')), ('(%s)(:)' % '|'.join(parser_functions), bygroups(Name.Function, Punctuation), ('#pop', 'template-inner')), ('(?i)([%s]*?)(:)' % title_char, bygroups(Name.Namespace, Punctuation), ('#pop', 'template-name')), default(('#pop', 'template-name'))], 'template-name': [('(\\s*?)(\\|)', bygroups(Text, Punctuation), ('#pop', 'template-inner')), ('\\}\\}', Punctuation, '#pop'), ('\\n', Text, '#pop'), include('replaceable'), *text_rules(Name.Tag)], 'template-inner': [('\\}\\}', Punctuation, '#pop'), ('\\|', Punctuation), ('(?x)\n                    (?<=\\|)\n                    ( (?: (?! \\{\\{ | \\}\\} )[^=\\|<])*? ) # Exclude templates and tags\n                    (=)\n                ', bygroups(Name.Label, Operator)), include('inline'), include('text')], 'table': [('^([ \\t\\n\\r\\0\\x0B]*?)(\\|\\})', bygroups(Whitespace, Punctuation), '#pop'), ('^([ \\t\\n\\r\\0\\x0B]*?)(\\|-+)(.*)$', bygroups(Whitespace, Punctuation, using(this, state=['root', 'attr']))), ('(?x)\n                ^([ \\t\\n\\r\\0\\x0B]*?)(\\|\\+)\n                # Exclude links, template and tags\n                (?: ( (?: (?! \\[\\[ | \\{\\{ )[^|\\n<] )*? )(\\|) )?\n                (.*?)$\n                ', bygroups(Whitespace, Punctuation, using(this, state=['root', 'attr']), Punctuation, Generic.Heading)), ('(?x)\n                ( ^(?:[ \\t\\n\\r\\0\\x0B]*?)\\| | \\|\\| )\n                (?: ( (?: (?! \\[\\[ | \\{\\{ )[^|\\n<] )*? )(\\|)(?!\\|) )?\n                ', bygroups(Punctuation, using(this, state=['root', 'attr']), Punctuation)), ('(?x)\n                ( ^(?:[ \\t\\n\\r\\0\\x0B]*?)!  )\n                (?: ( (?: (?! \\[\\[ | \\{\\{ )[^|\\n<] )*? )(\\|)(?!\\|) )?\n                ', bygroups(Punctuation, using(this, state=['root', 'attr']), Punctuation), 'table-header'), include('list'), include('inline'), include('text')], 'table-header': [('\\n', Text, '#pop'), ('(?x)\n                (!!|\\|\\|)\n                (?:\n                    ( (?: (?! \\[\\[ | \\{\\{ )[^|\\n<] )*? )\n                    (\\|)(?!\\|)\n                )?\n                ', bygroups(Punctuation, using(this, state=['root', 'attr']), Punctuation)), *text_rules(Generic.Subheading)], 'entity': [('&\\S*?;', Name.Entity)], 'dt': [('\\n', Text, '#pop'), include('inline'), (':', Keyword, '#pop'), include('text')], 'extlink-inner': [('\\]', Punctuation, '#pop'), include('inline'), include('text')], 'nowiki-ish': [include('entity'), include('text')], 'attr': [include('replaceable'), ('\\s+', Whitespace), ('(=)(\\s*)(")', bygroups(Operator, Whitespace, String.Double), 'attr-val-2'), ("(=)(\\s*)(')", bygroups(Operator, Whitespace, String.Single), 'attr-val-1'), ('(=)(\\s*)', bygroups(Operator, Whitespace), 'attr-val-0'), ('[\\w:-]+', Name.Attribute)], 'attr-val-0': [('\\s', Whitespace, '#pop'), include('replaceable'), *text_rules(String)], 'attr-val-1': [("'", String.Single, '#pop'), include('replaceable'), *text_rules(String.Single)], 'attr-val-2': [('"', String.Double, '#pop'), include('replaceable'), *text_rules(String.Double)], 'tag-inner-ordinary': [('/?\\s*>', Punctuation, '#pop'), include('tag-attr')], 'tag-inner': [('/\\s*>', Punctuation, '#pop:2'), ('\\s*>', Punctuation, '#pop'), include('tag-attr')], 'tag-attr': [include('replaceable'), ('\\s+', Whitespace), ('(=)(\\s*)(")', bygroups(Operator, Whitespace, String.Double), 'tag-attr-val-2'), ("(=)(\\s*)(')", bygroups(Operator, Whitespace, String.Single), 'tag-attr-val-1'), ('(=)(\\s*)', bygroups(Operator, Whitespace), 'tag-attr-val-0'), ('[\\w:-]+', Name.Attribute)], 'tag-attr-val-0': [('\\s', Whitespace, '#pop'), ('/?>', Punctuation, '#pop:2'), include('replaceable'), *text_rules(String)], 'tag-attr-val-1': [("'", String.Single, '#pop'), ('/?>', Punctuation, '#pop:2'), include('replaceable'), *text_rules(String.Single)], 'tag-attr-val-2': [('"', String.Double, '#pop'), ('/?>', Punctuation, '#pop:2'), include('replaceable'), *text_rules(String.Double)], 'tag-nowiki': nowiki_tag_rules('nowiki'), 'tag-pre': nowiki_tag_rules('pre'), 'tag-categorytree': plaintext_tag_rules('categorytree'), 'tag-dynamicpagelist': plaintext_tag_rules('dynamicpagelist'), 'tag-hiero': plaintext_tag_rules('hiero'), 'tag-inputbox': plaintext_tag_rules('inputbox'), 'tag-imagemap': plaintext_tag_rules('imagemap'), 'tag-charinsert': plaintext_tag_rules('charinsert'), 'tag-timeline': plaintext_tag_rules('timeline'), 'tag-gallery': plaintext_tag_rules('gallery'), 'tag-graph': plaintext_tag_rules('graph'), 'tag-rss': plaintext_tag_rules('rss'), 'tag-math': delegate_tag_rules('math', TexLexer), 'tag-chem': delegate_tag_rules('chem', TexLexer), 'tag-ce': delegate_tag_rules('ce', TexLexer), 'tag-templatedata': delegate_tag_rules('templatedata', JsonLexer), 'text-italic': text_rules(Generic.Emph), 'text-bold': text_rules(Generic.Strong), 'text-bold-italic': text_rules(Generic.EmphStrong), 'text': text_rules(Text)}