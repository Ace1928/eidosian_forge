import os
import pathlib
import pytest
import pyarrow as pa
import pyarrow.compute as pc
from pyarrow.lib import tobytes
from pyarrow.lib import ArrowInvalid, ArrowNotImplementedError
def test_hash_aggregate_udf_basic(varargs_agg_func_fixture):
    test_table = pa.Table.from_pydict({'t': [1, 1, 1, 1, 2, 2, 2, 2], 'k': [1, 0, 0, 1, 0, 1, 0, 1], 'v1': [1, 2, 3, 4, 5, 6, 7, 8], 'v2': [1.0, 1.0, 1.0, 1.0, 2.0, 3.0, 4.0, 5.0]})

    def table_provider(names, _):
        return test_table
    substrait_query = b'\n{\n  "extensionUris": [\n    {\n      "extensionUriAnchor": 1,\n      "uri": "urn:arrow:substrait_simple_extension_function"\n    },\n  ],\n  "extensions": [\n    {\n      "extensionFunction": {\n        "extensionUriReference": 1,\n        "functionAnchor": 1,\n        "name": "sum_mean"\n      }\n    }\n  ],\n  "relations": [\n    {\n      "root": {\n        "input": {\n          "extensionSingle": {\n            "common": {\n              "emit": {\n                "outputMapping": [\n                  0,\n                  1,\n                  2\n                ]\n              }\n            },\n            "input": {\n              "read": {\n                "baseSchema": {\n                  "names": [\n                    "t",\n                    "k",\n                    "v1",\n                    "v2",\n                  ],\n                  "struct": {\n                    "types": [\n                      {\n                        "i64": {\n                          "nullability": "NULLABILITY_REQUIRED"\n                        }\n                      },\n                      {\n                        "i64": {\n                          "nullability": "NULLABILITY_REQUIRED"\n                        }\n                      },\n                      {\n                        "i64": {\n                          "nullability": "NULLABILITY_NULLABLE"\n                        }\n                      },\n                      {\n                        "fp64": {\n                          "nullability": "NULLABILITY_NULLABLE"\n                        }\n                      }\n                    ],\n                    "nullability": "NULLABILITY_REQUIRED"\n                  }\n                },\n                "namedTable": {\n                  "names": ["t1"]\n                }\n              }\n            },\n            "detail": {\n              "@type": "/arrow.substrait_ext.SegmentedAggregateRel",\n              "groupingKeys": [\n                {\n                  "directReference": {\n                    "structField": {\n                      "field": 1\n                    }\n                  },\n                  "rootReference": {}\n                }\n              ],\n              "segmentKeys": [\n                {\n                  "directReference": {\n                    "structField": {}\n                  },\n                  "rootReference": {}\n                }\n              ],\n              "measures": [\n                {\n                  "measure": {\n                    "functionReference": 1,\n                    "phase": "AGGREGATION_PHASE_INITIAL_TO_RESULT",\n                    "outputType": {\n                      "fp64": {\n                        "nullability": "NULLABILITY_NULLABLE"\n                      }\n                    },\n                    "arguments": [\n                      {\n                        "value": {\n                          "selection": {\n                            "directReference": {\n                              "structField": {\n                                "field": 2\n                              }\n                            },\n                            "rootReference": {}\n                          }\n                        }\n                      },\n                      {\n                        "value": {\n                          "selection": {\n                            "directReference": {\n                              "structField": {\n                                "field": 3\n                              }\n                            },\n                            "rootReference": {}\n                          }\n                        }\n                      }\n                    ]\n                  }\n                }\n              ]\n            }\n          }\n        },\n        "names": [\n          "t",\n          "k",\n          "v_avg"\n        ]\n      }\n    }\n  ],\n}\n'
    buf = pa._substrait._parse_json_plan(substrait_query)
    reader = pa.substrait.run_query(buf, table_provider=table_provider, use_threads=False)
    res_tb = reader.read_all()
    expected_tb = pa.Table.from_pydict({'t': [1, 1, 2, 2], 'k': [1, 0, 0, 1], 'v_avg': [3.5, 3.5, 9.0, 11.0]})
    assert res_tb == expected_tb