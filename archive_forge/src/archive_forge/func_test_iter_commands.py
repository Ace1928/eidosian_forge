import io
import time
import unittest
from fastimport import (
from :2
def test_iter_commands(self):
    s = io.BytesIO(_sample_import_text)
    p = parser.ImportParser(s)
    result = []
    for cmd in p.iter_commands():
        result.append(cmd)
        if cmd.name == b'commit':
            for fc in cmd.iter_files():
                result.append(fc)
    self.assertEqual(len(result), 17)
    cmd1 = result.pop(0)
    self.assertEqual(b'progress', cmd1.name)
    self.assertEqual(b'completed', cmd1.message)
    cmd2 = result.pop(0)
    self.assertEqual(b'blob', cmd2.name)
    self.assertEqual(b'1', cmd2.mark)
    self.assertEqual(b':1', cmd2.id)
    self.assertEqual(b'aaaa', cmd2.data)
    self.assertEqual(4, cmd2.lineno)
    cmd3 = result.pop(0)
    self.assertEqual(b'blob', cmd3.name)
    self.assertEqual(b'@7', cmd3.id)
    self.assertEqual(None, cmd3.mark)
    self.assertEqual(b'bbbbb', cmd3.data)
    self.assertEqual(7, cmd3.lineno)
    cmd4 = result.pop(0)
    self.assertEqual(b'commit', cmd4.name)
    self.assertEqual(b'2', cmd4.mark)
    self.assertEqual(b':2', cmd4.id)
    self.assertEqual(b'initial import', cmd4.message)
    self.assertEqual((b'bugs bunny', b'bugs@bunny.org', self.fake_time, 0), cmd4.committer)
    self.assertEqual(b'bugs bunny', cmd4.committer.name)
    self.assertEqual(b'bugs@bunny.org', cmd4.committer.email)
    self.assertEqual(self.fake_time, cmd4.committer.timestamp)
    self.assertEqual(0, cmd4.committer.timezone)
    self.assertEqual(None, cmd4.author)
    self.assertEqual(11, cmd4.lineno)
    self.assertEqual(b'refs/heads/master', cmd4.ref)
    self.assertEqual(None, cmd4.from_)
    self.assertEqual([], cmd4.merges)
    file_cmd1 = result.pop(0)
    self.assertEqual(b'filemodify', file_cmd1.name)
    self.assertEqual(b'README', file_cmd1.path)
    self.assertEqual(33188, file_cmd1.mode)
    self.assertEqual(b'Welcome from bugs\n', file_cmd1.data)
    cmd5 = result.pop(0)
    self.assertEqual(b'commit', cmd5.name)
    self.assertEqual(None, cmd5.mark)
    self.assertEqual(b'@19', cmd5.id)
    self.assertEqual(b'second commit', cmd5.message)
    self.assertEqual((b'', b'bugs@bunny.org', self.fake_time, 0), cmd5.committer)
    self.assertEqual(None, cmd5.author)
    self.assertEqual(19, cmd5.lineno)
    self.assertEqual(b'refs/heads/master', cmd5.ref)
    self.assertEqual(b':2', cmd5.from_)
    self.assertEqual([], cmd5.merges)
    file_cmd2 = result.pop(0)
    self.assertEqual(b'filemodify', file_cmd2.name)
    self.assertEqual(b'README', file_cmd2.path)
    self.assertEqual(33188, file_cmd2.mode)
    self.assertEqual(b'Welcome from bugs, etc.', file_cmd2.data)
    cmd6 = result.pop(0)
    self.assertEqual(cmd6.name, b'checkpoint')
    cmd7 = result.pop(0)
    self.assertEqual(b'progress', cmd7.name)
    self.assertEqual(b'completed', cmd7.message)
    cmd = result.pop(0)
    self.assertEqual(b'commit', cmd.name)
    self.assertEqual(b'3', cmd.mark)
    self.assertEqual(None, cmd.from_)
    cmd = result.pop(0)
    self.assertEqual(b'commit', cmd.name)
    self.assertEqual(b'4', cmd.mark)
    self.assertEqual(b'Commit with heredoc-style message\n', cmd.message)
    cmd = result.pop(0)
    self.assertEqual(b'commit', cmd.name)
    self.assertEqual(b'5', cmd.mark)
    self.assertEqual(b'submodule test\n', cmd.message)
    file_cmd1 = result.pop(0)
    self.assertEqual(b'filemodify', file_cmd1.name)
    self.assertEqual(b'tree-id', file_cmd1.path)
    self.assertEqual(57344, file_cmd1.mode)
    self.assertEqual(b'rev-id', file_cmd1.dataref)
    cmd = result.pop(0)
    self.assertEqual(b'feature', cmd.name)
    self.assertEqual(b'whatever', cmd.feature_name)
    self.assertEqual(None, cmd.value)
    cmd = result.pop(0)
    self.assertEqual(b'feature', cmd.name)
    self.assertEqual(b'foo', cmd.feature_name)
    self.assertEqual(b'bar', cmd.value)
    cmd = result.pop(0)
    self.assertEqual(b'commit', cmd.name)
    self.assertEqual(b'6', cmd.mark)
    self.assertEqual(b'test of properties', cmd.message)
    self.assertEqual({b'p1': None, b'p2': b'hohum', b'p3': b'alpha\nbeta\ngamma', b'p4': b'whatever'}, cmd.properties)
    cmd = result.pop(0)
    self.assertEqual(b'commit', cmd.name)
    self.assertEqual(b'7', cmd.mark)
    self.assertEqual(b'multi-author test', cmd.message)
    self.assertEqual(b'', cmd.committer[0])
    self.assertEqual(b'bugs@bunny.org', cmd.committer[1])
    self.assertEqual(b'Fluffy', cmd.author[0])
    self.assertEqual(b'fluffy@bunny.org', cmd.author[1])
    self.assertEqual(b'Daffy', cmd.more_authors[0][0])
    self.assertEqual(b'daffy@duck.org', cmd.more_authors[0][1])
    self.assertEqual(b'Donald', cmd.more_authors[1][0])
    self.assertEqual(b'donald@duck.org', cmd.more_authors[1][1])