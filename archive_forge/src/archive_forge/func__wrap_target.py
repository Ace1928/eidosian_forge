import atexit
import inspect
import os
import pprint
import re
import subprocess
import textwrap
def _wrap_target(self, output_dir, dispatch_src, target, nochange=False):
    assert isinstance(target, (str, tuple))
    if isinstance(target, str):
        ext_name = target_name = target
    else:
        ext_name = '.'.join(target)
        target_name = '__'.join(target)
    wrap_path = os.path.join(output_dir, os.path.basename(dispatch_src))
    wrap_path = '{0}.{2}{1}'.format(*os.path.splitext(wrap_path), ext_name.lower())
    if nochange and os.path.exists(wrap_path):
        return wrap_path
    self.dist_log('wrap dispatch-able target -> ', wrap_path)
    features = self.feature_sorted(self.feature_implies_c(target))
    target_join = '#define %sCPU_TARGET_' % self.conf_c_prefix_
    target_defs = [target_join + f for f in features]
    target_defs = '\n'.join(target_defs)
    with open(wrap_path, 'w') as fd:
        fd.write(textwrap.dedent('            /**\n             * AUTOGENERATED DON\'T EDIT\n             * Please make changes to the code generator              (distutils/ccompiler_opt.py)\n             */\n            #define {pfx}CPU_TARGET_MODE\n            #define {pfx}CPU_TARGET_CURRENT {target_name}\n            {target_defs}\n            #include "{path}"\n            ').format(pfx=self.conf_c_prefix_, target_name=target_name, path=os.path.abspath(dispatch_src), target_defs=target_defs))
    return wrap_path