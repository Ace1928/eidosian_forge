from typing import Sequence, Callable
import functools
from functools import partial
import warnings
import numpy as np
import pennylane as qml
from pennylane.circuit_graph import LayerData
from pennylane.queuing import WrappedObj
from pennylane.transforms import transform
def _get_first_term_tapes(layer_i, layer_j, allow_nonunitary, aux_wire):
    """Obtain the tapes for the first term of all tensor entries
    belonging to an off-diagonal block.

    Args:
        layer_i (list): The first layer of parametrized ops, of the format of
            the layers generated by ``iterate_parametrized_layers``
        layer_j (list): The second layer of parametrized ops
        allow_nonunitary (bool): Whether non-unitary operations are allowed
            in the circuit; passed to ``_get_gen_op``
        aux_wire (object or pennylane.wires.Wires): Auxiliary wire on which to
            control the controlled-generator operations

    Returns:
        list[pennylane.tape.QuantumTape]: Transformed tapes that compute the
            first term of the metric tensor for the off-diagonal block belonging
            to the input layers
        list[tuple[int]]: 2-tuple indices assigning the tapes to metric tensor
            entries
    """
    tapes = []
    ids = []
    ops_between_cgens = [op1 for op1 in layer_j.pre_ops if not any((op1 is op2 for op2 in layer_i.pre_ops))]
    for diffed_op_i, par_idx_i in zip(layer_i.ops, layer_i.param_inds):
        gen_op_i = _get_gen_op(WrappedObj(diffed_op_i), allow_nonunitary, aux_wire)
        for diffed_op_j, par_idx_j in zip(layer_j.ops, layer_j.param_inds):
            gen_op_j = _get_gen_op(WrappedObj(diffed_op_j), allow_nonunitary, aux_wire)
            with qml.queuing.AnnotatedQueue() as q:
                qml.Hadamard(wires=aux_wire)
                for op in layer_i.pre_ops:
                    qml.apply(op)
                qml.apply(gen_op_i)
                for op in ops_between_cgens:
                    qml.apply(op)
                qml.apply(gen_op_j)
                qml.expval(qml.X(aux_wire))
            tapes.append(qml.tape.QuantumScript.from_queue(q))
            ids.append((par_idx_i, par_idx_j))
    return (tapes, ids)