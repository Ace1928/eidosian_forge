from __future__ import annotations
import abc
import copy
import json
import logging
import os
from collections import namedtuple
from collections.abc import Mapping, MutableMapping, Sequence
from enum import Enum, unique
from typing import TYPE_CHECKING
import numpy as np
from monty.collections import AttrDict
from monty.json import MSONable
from pymatgen.core.structure import Structure
from pymatgen.io.abinit import abiobjects as aobj
from pymatgen.io.abinit.pseudos import Pseudo, PseudoTable
from pymatgen.io.abinit.variable import InputVariable
from pymatgen.symmetry.bandstructure import HighSymmKpath
def calc_shiftk(structure, symprec: float=0.01, angle_tolerance=5):
    """
    Find the values of shiftk and nshiftk appropriated for the sampling of the Brillouin zone.

    When the primitive vectors of the lattice do NOT form a FCC or a BCC lattice,
    the usual (shifted) Monkhorst-Pack grids are formed by using nshiftk=1 and shiftk 0.5 0.5 0.5 .
    This is often the preferred k point sampling. For a non-shifted Monkhorst-Pack grid,
    use `nshiftk=1` and `shiftk 0.0 0.0 0.0`, but there is little reason to do that.

    When the primitive vectors of the lattice form a FCC lattice, with rprim:

            0.0 0.5 0.5
            0.5 0.0 0.5
            0.5 0.5 0.0

    the (very efficient) usual Monkhorst-Pack sampling will be generated by using nshiftk= 4 and shiftk:

        0.5 0.5 0.5
        0.5 0.0 0.0
        0.0 0.5 0.0
        0.0 0.0 0.5

    When the primitive vectors of the lattice form a BCC lattice, with rprim:

           -0.5  0.5  0.5
            0.5 -0.5  0.5
            0.5  0.5 -0.5

    the usual Monkhorst-Pack sampling will be generated by using nshiftk= 2 and shiftk:

            0.25  0.25  0.25
           -0.25 -0.25 -0.25

    However, the simple sampling nshiftk=1 and shiftk 0.5 0.5 0.5 is excellent.

    For hexagonal lattices with hexagonal axes, e.g. rprim:

            1.0  0.0       0.0
           -0.5  sqrt(3)/2 0.0
            0.0  0.0       1.0

    one can use nshiftk= 1 and shiftk 0.0 0.0 0.5
    In rhombohedral axes, e.g. using angdeg 3*60., this corresponds to shiftk 0.5 0.5 0.5,
    to keep the shift along the symmetry axis.

    Returns:
        Suggested value of shiftk.
    """
    from pymatgen.symmetry.analyzer import SpacegroupAnalyzer
    sym = SpacegroupAnalyzer(structure, symprec=symprec, angle_tolerance=angle_tolerance)
    lattice_type, spg_symbol = (sym.get_lattice_type(), sym.get_space_group_symbol())
    is_primitive = len(sym.find_primitive()) == len(structure)
    shiftk = None
    if is_primitive:
        if lattice_type == 'cubic':
            if 'F' in spg_symbol:
                shiftk = [0.5, 0.5, 0.5, 0.5, 0.0, 0.0, 0.0, 0.5, 0.0, 0.0, 0.0, 0.5]
            elif 'I' in spg_symbol:
                shiftk = [0.25, 0.25, 0.25, -0.25, -0.25, -0.25]
        elif lattice_type == 'hexagonal':
            for i, angle in enumerate(structure.lattice.angles, start=1):
                if abs(angle - 120) < 1.0:
                    j = i % 3
                    k = (i + 1) % 3
                    hex_ax = next((ax for ax in range(3) if ax not in [j, k]))
                    break
            else:
                raise ValueError('Cannot find hexagonal axis')
            shiftk = [0.0, 0.0, 0.0]
            shiftk[hex_ax] = 0.5
        elif lattice_type == 'tetragonal' and 'I' in spg_symbol:
            shiftk = [0.25, 0.25, 0.25, -0.25, -0.25, -0.25]
    if shiftk is None:
        shiftk = [0.5, 0.5, 0.5]
    return np.reshape(shiftk, (-1, 3))