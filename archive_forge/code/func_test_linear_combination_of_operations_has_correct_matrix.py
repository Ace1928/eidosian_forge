import collections
from typing import Union
import numpy as np
import pytest
import sympy
import sympy.parsing.sympy_parser as sympy_parser
import cirq
import cirq.testing
@pytest.mark.parametrize('terms, expected_matrix', (({}, np.array([0])), ({cirq.I(q0): 2, cirq.X(q0): 3, cirq.Y(q0): 4, cirq.Z(q0): 5j}, np.array([[2 + 5j, 3 - 4j], [3 + 4j, 2 - 5j]])), ({cirq.X(q0): 2, cirq.Y(q1): 3}, np.array([[0, -3j, 2, 0], [3j, 0, 0, 2], [2, 0, 0, -3j], [0, 2, 3j, 0]])), ({cirq.XX(q0, q1): 0.5, cirq.YY(q0, q1): -0.5}, np.rot90(np.diag([1, 0, 0, 1]))), ({cirq.CCZ(q0, q1, q2): 3j}, np.diag([3j, 3j, 3j, 3j, 3j, 3j, 3j, -3j])), ({cirq.I(q0): 0.1, cirq.CNOT(q1, q2): 1}, np.array([[1.1, _, _, _, _, _, _, _], [_, 1.1, _, _, _, _, _, _], [_, _, 0.1, 1, _, _, _, _], [_, _, 1, 0.1, _, _, _, _], [_, _, _, _, 1.1, _, _, _], [_, _, _, _, _, 1.1, _, _], [_, _, _, _, _, _, 0.1, 1], [_, _, _, _, _, _, 1, 0.1]])), ({cirq.I(q1): 0.1, cirq.CNOT(q0, q2): 1}, np.array([[1.1, _, _, _, _, _, _, _], [_, 1.1, _, _, _, _, _, _], [_, _, 1.1, _, _, _, _, _], [_, _, _, 1.1, _, _, _, _], [_, _, _, _, 0.1, 1, _, _], [_, _, _, _, 1, 0.1, _, _], [_, _, _, _, _, _, 0.1, 1], [_, _, _, _, _, _, 1, 0.1]])), ({cirq.I(q2): 0.1, cirq.CNOT(q0, q1): 1}, np.array([[1.1, _, _, _, _, _, _, _], [_, 1.1, _, _, _, _, _, _], [_, _, 1.1, _, _, _, _, _], [_, _, _, 1.1, _, _, _, _], [_, _, _, _, 0.1, _, 1, _], [_, _, _, _, _, 0.1, _, 1], [_, _, _, _, 1, _, 0.1, _], [_, _, _, _, _, 1, _, 0.1]])), ({cirq.I(q0): 0.1, cirq.ControlledGate(cirq.Y).on(q1, q2): 1}, np.array([[1.1, _, _, _, _, _, _, _], [_, 1.1, _, _, _, _, _, _], [_, _, 0.1, -1j, _, _, _, _], [_, _, 1j, 0.1, _, _, _, _], [_, _, _, _, 1.1, _, _, _], [_, _, _, _, _, 1.1, _, _], [_, _, _, _, _, _, 0.1, -1j], [_, _, _, _, _, _, 1j, 0.1]])), ({cirq.I(q1): 0.1, cirq.ControlledGate(cirq.Y).on(q0, q2): 1}, np.array([[1.1, _, _, _, _, _, _, _], [_, 1.1, _, _, _, _, _, _], [_, _, 1.1, _, _, _, _, _], [_, _, _, 1.1, _, _, _, _], [_, _, _, _, 0.1, -1j, _, _], [_, _, _, _, 1j, 0.1, _, _], [_, _, _, _, _, _, 0.1, -1j], [_, _, _, _, _, _, 1j, 0.1]])), ({cirq.I(q2): 0.1, cirq.ControlledGate(cirq.Y).on(q0, q1): 1}, np.array([[1.1, _, _, _, _, _, _, _], [_, 1.1, _, _, _, _, _, _], [_, _, 1.1, _, _, _, _, _], [_, _, _, 1.1, _, _, _, _], [_, _, _, _, 0.1, _, -1j, _], [_, _, _, _, _, 0.1, _, -1j], [_, _, _, _, 1j, _, 0.1, _], [_, _, _, _, _, 1j, _, 0.1]])), ({cirq.I(q0): 0.1, cirq.FREDKIN(q1, q2, q3): 1}, np.array([[1.1, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _], [_, 1.1, _, _, _, _, _, _, _, _, _, _, _, _, _, _], [_, _, 1.1, _, _, _, _, _, _, _, _, _, _, _, _, _], [_, _, _, 1.1, _, _, _, _, _, _, _, _, _, _, _, _], [_, _, _, _, 1.1, _, _, _, _, _, _, _, _, _, _, _], [_, _, _, _, _, 0.1, 1, _, _, _, _, _, _, _, _, _], [_, _, _, _, _, 1, 0.1, _, _, _, _, _, _, _, _, _], [_, _, _, _, _, _, _, 1.1, _, _, _, _, _, _, _, _], [_, _, _, _, _, _, _, _, 1.1, _, _, _, _, _, _, _], [_, _, _, _, _, _, _, _, _, 1.1, _, _, _, _, _, _], [_, _, _, _, _, _, _, _, _, _, 1.1, _, _, _, _, _], [_, _, _, _, _, _, _, _, _, _, _, 1.1, _, _, _, _], [_, _, _, _, _, _, _, _, _, _, _, _, 1.1, _, _, _], [_, _, _, _, _, _, _, _, _, _, _, _, _, 0.1, 1, _], [_, _, _, _, _, _, _, _, _, _, _, _, _, 1, 0.1, _], [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 1.1]])), ({cirq.I(q1): 0.1, cirq.FREDKIN(q0, q2, q3): 1}, np.array([[1.1, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _], [_, 1.1, _, _, _, _, _, _, _, _, _, _, _, _, _, _], [_, _, 1.1, _, _, _, _, _, _, _, _, _, _, _, _, _], [_, _, _, 1.1, _, _, _, _, _, _, _, _, _, _, _, _], [_, _, _, _, 1.1, _, _, _, _, _, _, _, _, _, _, _], [_, _, _, _, _, 1.1, _, _, _, _, _, _, _, _, _, _], [_, _, _, _, _, _, 1.1, _, _, _, _, _, _, _, _, _], [_, _, _, _, _, _, _, 1.1, _, _, _, _, _, _, _, _], [_, _, _, _, _, _, _, _, 1.1, _, _, _, _, _, _, _], [_, _, _, _, _, _, _, _, _, 0.1, 1, _, _, _, _, _], [_, _, _, _, _, _, _, _, _, 1, 0.1, _, _, _, _, _], [_, _, _, _, _, _, _, _, _, _, _, 1.1, _, _, _, _], [_, _, _, _, _, _, _, _, _, _, _, _, 1.1, _, _, _], [_, _, _, _, _, _, _, _, _, _, _, _, _, 0.1, 1, _], [_, _, _, _, _, _, _, _, _, _, _, _, _, 1, 0.1, _], [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 1.1]])), ({cirq.I(q2): 0.1, cirq.FREDKIN(q0, q1, q3): 1}, np.array([[1.1, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _], [_, 1.1, _, _, _, _, _, _, _, _, _, _, _, _, _, _], [_, _, 1.1, _, _, _, _, _, _, _, _, _, _, _, _, _], [_, _, _, 1.1, _, _, _, _, _, _, _, _, _, _, _, _], [_, _, _, _, 1.1, _, _, _, _, _, _, _, _, _, _, _], [_, _, _, _, _, 1.1, _, _, _, _, _, _, _, _, _, _], [_, _, _, _, _, _, 1.1, _, _, _, _, _, _, _, _, _], [_, _, _, _, _, _, _, 1.1, _, _, _, _, _, _, _, _], [_, _, _, _, _, _, _, _, 1.1, _, _, _, _, _, _, _], [_, _, _, _, _, _, _, _, _, 0.1, _, _, 1, _, _, _], [_, _, _, _, _, _, _, _, _, _, 1.1, _, _, _, _, _], [_, _, _, _, _, _, _, _, _, _, _, 0.1, _, _, 1, _], [_, _, _, _, _, _, _, _, _, 1, _, _, 0.1, _, _, _], [_, _, _, _, _, _, _, _, _, _, _, _, 0, 1.1, _, _], [_, _, _, _, _, _, _, _, _, _, _, 1, _, _, 0.1, _], [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 1.1]])), ({cirq.I(q3): 2j, cirq.FREDKIN(q0, q1, q2): 1j}, np.array([[3j, _, _, _, _, _, _, _, _, _, _, _, _, _, _, _], [_, 3j, _, _, _, _, _, _, _, _, _, _, _, _, _, _], [_, _, 3j, _, _, _, _, _, _, _, _, _, _, _, _, _], [_, _, _, 3j, _, _, _, _, _, _, _, _, _, _, _, _], [_, _, _, _, 3j, _, _, _, _, _, _, _, _, _, _, _], [_, _, _, _, _, 3j, _, _, _, _, _, _, _, _, _, _], [_, _, _, _, _, _, 3j, _, _, _, _, _, _, _, _, _], [_, _, _, _, _, _, _, 3j, _, _, _, _, _, _, _, _], [_, _, _, _, _, _, _, _, 3j, _, _, _, _, _, _, _], [_, _, _, _, _, _, _, _, _, 3j, _, _, _, _, _, _], [_, _, _, _, _, _, _, _, _, _, 2j, _, 1j, _, _, _], [_, _, _, _, _, _, _, _, _, _, _, 2j, _, 1j, _, _], [_, _, _, _, _, _, _, _, _, _, 1j, _, 2j, _, _, _], [_, _, _, _, _, _, _, _, _, _, _, 1j, _, 2j, _, _], [_, _, _, _, _, _, _, _, _, _, _, _, _, _, 3j, _], [_, _, _, _, _, _, _, _, _, _, _, _, _, _, _, 3j]]))))
def test_linear_combination_of_operations_has_correct_matrix(terms, expected_matrix):
    combination = cirq.LinearCombinationOfOperations(terms)
    assert np.allclose(combination.matrix(), expected_matrix)