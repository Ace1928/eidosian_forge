from __future__ import annotations
import os
import time
from xml.etree.ElementTree import (
from xml.dom import (
from ...io import (
from ...util_common import (
from ...util import (
from ...data import (
from ...provisioning import (
from .combine import (
from . import (
def _generate_powershell_xml(coverage_file: str) -> Element:
    """Generate a PowerShell coverage report XML element from the specified coverage file and return it."""
    coverage_info = read_json_file(coverage_file)
    content_root = data_context().content.root
    is_ansible = data_context().content.is_ansible
    packages: dict[str, dict[str, dict[str, int]]] = {}
    for path, results in coverage_info.items():
        filename = os.path.splitext(os.path.basename(path))[0]
        if filename.startswith('Ansible.ModuleUtils'):
            package = 'ansible.module_utils'
        elif is_ansible:
            package = 'ansible.modules'
        else:
            rel_path = path[len(content_root) + 1:]
            plugin_type = 'modules' if rel_path.startswith('plugins/modules') else 'module_utils'
            package = 'ansible_collections.%splugins.%s' % (data_context().content.collection.prefix, plugin_type)
        if package not in packages:
            packages[package] = {}
        packages[package][path] = results
    elem_coverage = Element('coverage')
    elem_coverage.append(Comment(' Generated by ansible-test from the Ansible project: https://www.ansible.com/ '))
    elem_coverage.append(Comment(' Based on https://raw.githubusercontent.com/cobertura/web/master/htdocs/xml/coverage-04.dtd '))
    elem_sources = SubElement(elem_coverage, 'sources')
    elem_source = SubElement(elem_sources, 'source')
    elem_source.text = data_context().content.root
    elem_packages = SubElement(elem_coverage, 'packages')
    total_lines_hit = 0
    total_line_count = 0
    for package_name, package_data in packages.items():
        lines_hit, line_count = _add_cobertura_package(elem_packages, package_name, package_data)
        total_lines_hit += lines_hit
        total_line_count += line_count
    elem_coverage.attrib.update({'branch-rate': '0', 'branches-covered': '0', 'branches-valid': '0', 'complexity': '0', 'line-rate': str(round(total_lines_hit / total_line_count, 4)) if total_line_count else '0', 'lines-covered': str(total_line_count), 'lines-valid': str(total_lines_hit), 'timestamp': str(int(time.time())), 'version': get_ansible_version()})
    return elem_coverage