import re
from numpy import zeros, isscalar
from ase.atoms import Atoms
from ase.units import _auf, _amu, _auv
from ase.data import chemical_symbols
from ase.calculators.singlepoint import SinglePointCalculator
def write_dlp4(fd, atoms, levcfg=0, title='CONFIG generated by ASE'):
    """Write a DL_POLY_4 config file.

    Typically used indirectly through write('filename', atoms, format='dlp4').

    Can be unforgiven with custom chemical element names.
    Please complain to alin@elena.space in case of bugs"""
    fd.write('{0:72s}\n'.format(title))
    natoms = len(atoms)
    npbc = sum(atoms.pbc)
    if npbc == 0:
        imcon = 0
    elif npbc == 3:
        imcon = 3
    elif tuple(atoms.pbc) == (True, True, False):
        imcon = 6
    else:
        raise ValueError('Unsupported pbc: {}.  Supported pbc are 000, 110, and 000.'.format(atoms.pbc))
    fd.write('{0:10d}{1:10d}{2:10d}\n'.format(levcfg, imcon, natoms))
    if imcon > 0:
        cell = atoms.get_cell()
        for j in range(3):
            fd.write('{0:20.10f}{1:20.10f}{2:20.10f}\n'.format(cell[j, 0], cell[j, 1], cell[j, 2]))
    vels = []
    forces = []
    if levcfg > 0:
        vels = atoms.get_velocities() / dlp_v_ase
    if levcfg > 1:
        forces = atoms.get_forces() / dlp_f_ase
    labels = atoms.arrays.get(DLP4_LABELS_KEY)
    for i, a in enumerate(atoms):
        sym = a.symbol
        if labels is not None:
            sym += labels[i]
        fd.write('{0:8s}{1:10d}\n{2:20.10f}{3:20.10f}{4:20.10f}\n'.format(sym, a.index + 1, a.x, a.y, a.z))
        if levcfg > 0:
            if vels is None:
                fd.write('{0:20.10f}{1:20.10f}{2:20.10f}\n'.format(0.0, 0.0, 0.0))
            else:
                fd.write('{0:20.10f}{1:20.10f}{2:20.10f}\n'.format(vels[a.index, 0], vels[a.index, 1], vels[a.index, 2]))
        if levcfg > 1:
            if forces is None:
                fd.write('{0:20.10f}{1:20.10f}{2:20.10f}\n'.format(0.0, 0.0, 0.0))
            else:
                fd.write('{0:20.10f}{1:20.10f}{2:20.10f}\n'.format(forces[a.index, 0], forces[a.index, 1], forces[a.index, 2]))