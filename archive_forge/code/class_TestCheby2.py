import warnings
from scipy._lib import _pep440
import numpy as np
from numpy.testing import (assert_array_almost_equal,
import pytest
from pytest import raises as assert_raises
from numpy import array, spacing, sin, pi, sort, sqrt
from scipy.signal import (argrelextrema, BadCoefficients, bessel, besselap, bilinear,
from scipy.signal._filter_design import (_cplxreal, _cplxpair, _norm_factor,
class TestCheby2:

    def test_degenerate(self):
        b, a = cheby2(0, 123.456, 1, analog=True)
        assert_array_equal(b, [1])
        assert_array_equal(a, [1])
        b, a = cheby2(1, 10 * np.log10(2), 1, analog=True)
        assert_array_almost_equal(b, [1])
        assert_array_almost_equal(a, [1, 1])
        z, p, k = cheby2(1, 50, 0.3, output='zpk')
        assert_array_equal(z, [-1])
        assert_allclose(p, [0.9967826460175649], rtol=1e-14)
        assert_allclose(k, 0.001608676991217512, rtol=1e-14)

    def test_basic(self):
        for N in range(25):
            wn = 0.01
            z, p, k = cheby2(N, 40, wn, 'low', analog=True, output='zpk')
            assert_(len(p) == N)
            assert_(all(np.real(p) <= 0))
        for N in range(25):
            wn = 0.01
            z, p, k = cheby2(N, 40, wn, 'high', analog=False, output='zpk')
            assert_(all(np.abs(p) <= 1))
        B, A = cheby2(18, 100, 0.5)
        assert_array_almost_equal(B, [0.00167583914216, 0.01249479541868, 0.05282702120282, 0.15939804265706, 0.37690207631117, 0.73227013789108, 1.20191856962356, 1.69522872823393, 2.07598674519837, 2.21972389625291, 2.07598674519838, 1.69522872823395, 1.20191856962359, 0.7322701378911, 0.37690207631118, 0.15939804265707, 0.05282702120282, 0.01249479541868, 0.00167583914216], decimal=13)
        assert_array_almost_equal(A, [1.0, -0.27631970006174, 3.1975121425406, -0.15685969461355, 4.13926117356269, 0.60689917820044, 2.9508277063654, 0.89016501910416, 1.32135245849798, 0.51502467236824, 0.3890664386666, 0.15367372690642, 0.07255803834919, 0.02422454070134, 0.00756108751837, 0.00179848550988, 0.00033713574499, 4.258794833e-05, 2.81030149e-06], decimal=13)

    def test_highpass(self):
        z, p, k = cheby2(26, 60, 0.3, 'high', output='zpk')
        z2 = [0.9981088955489852 + 0.06147058341984388j, 0.9981088955489852 - 0.06147058341984388j, 0.9832702870387426 + 0.1821525257215483j, 0.9832702870387426 - 0.1821525257215483j, 0.9550760158089112 + 0.2963609353922882j, 0.9550760158089112 - 0.2963609353922882j, 0.9162054748821922 + 0.4007087817803773j, 0.9162054748821922 - 0.4007087817803773j, 0.8700619897368064 + 0.4929423232136168j, 0.8700619897368064 - 0.4929423232136168j, 0.5889791753434985 + 0.8081482110427953j, 0.5889791753434985 - 0.8081482110427953j, 0.5984900456570295 + 0.8011302423760501j, 0.5984900456570295 - 0.8011302423760501j, 0.6172880888914629 + 0.7867371958365343j, 0.6172880888914629 - 0.7867371958365343j, 0.644889997103818 + 0.7642754030030161j, 0.644889997103818 - 0.7642754030030161j, 0.6804845629637927 + 0.7327624168637228j, 0.6804845629637927 - 0.7327624168637228j, 0.820261910710866 + 0.5719881098737678j, 0.820261910710866 - 0.5719881098737678j, 0.7228410452536148 + 0.6910143437705678j, 0.7228410452536148 - 0.6910143437705678j, 0.7702121399578629 + 0.6377877856007792j, 0.7702121399578629 - 0.6377877856007792j]
        p2 = [0.736554619828645 + 0.04842085129329526j, 0.736554619828645 - 0.04842085129329526j, 0.7292038510962885 + 0.1442201672097581j, 0.7292038510962885 - 0.1442201672097581j, 0.7151293788040354 + 0.2369925800458584j, 0.7151293788040354 - 0.2369925800458584j, 0.6955051820787286 + 0.325034136385691j, 0.6955051820787286 - 0.325034136385691j, 0.671912295604522 + 0.4070475750638047j, 0.671912295604522 - 0.4070475750638047j, 0.64617221306113 + 0.482196591668927j, 0.64617221306113 - 0.482196591668927j, 0.5528045062872224 + 0.8162920513838372j, 0.5528045062872224 - 0.8162920513838372j, 0.5464847782492791 + 0.7869899955967304j, 0.5464847782492791 - 0.7869899955967304j, 0.5488033111260949 + 0.7520442354055579j, 0.5488033111260949 - 0.7520442354055579j, 0.6201874719022955 + 0.5500894392527353j, 0.6201874719022955 - 0.5500894392527353j, 0.5586478152536709 + 0.7112676877332921j, 0.5586478152536709 - 0.7112676877332921j, 0.5958145844148228 + 0.6107074340842115j, 0.5958145844148228 - 0.6107074340842115j, 0.5747812938519067 + 0.6643001536914696j, 0.5747812938519067 - 0.6643001536914696j]
        k2 = 0.09932997786497189
        assert_allclose(sorted(z, key=np.angle), sorted(z2, key=np.angle), rtol=1e-13)
        assert_allclose(sorted(p, key=np.angle), sorted(p2, key=np.angle), rtol=1e-12)
        assert_allclose(k, k2, rtol=1e-11)
        z, p, k = cheby2(25, 80, 0.5, 'high', output='zpk')
        z2 = [0.9690690376586687 + 0.2467897896011971j, 0.9690690376586687 - 0.2467897896011971j, 0.9999999999999492, 0.8835111277191199 + 0.4684101698261429j, 0.8835111277191199 - 0.4684101698261429j, 0.7613142857900539 + 0.6483830335935022j, 0.7613142857900539 - 0.6483830335935022j, 0.6232625173626231 + 0.7820126817709752j, 0.6232625173626231 - 0.7820126817709752j, 0.4864456563413621 + 0.8737108351316745j, 0.4864456563413621 - 0.8737108351316745j, 0.3618368136816749 + 0.9322414495530347j, 0.3618368136816749 - 0.9322414495530347j, 0.2549486883466794 + 0.9669545833752675j, 0.2549486883466794 - 0.9669545833752675j, 0.1676175432109457 + 0.9858520980390212j, 0.1676175432109457 - 0.9858520980390212j, 0.001975218468277521 + 0.9999980492540941j, 0.001975218468277521 - 0.9999980492540941j, 0.01786959496651858 + 0.9998403260399917j, 0.01786959496651858 - 0.9998403260399917j, 0.09967933660557139 + 0.9950196127985684j, 0.09967933660557139 - 0.9950196127985684j, 0.05013970951219547 + 0.998742213751889j, 0.05013970951219547 - 0.998742213751889j]
        p2 = [0.4218866331906864, 0.4120110200127552 + 0.1361290593621978j, 0.4120110200127552 - 0.1361290593621978j, 0.383589011363253 + 0.2664910809911026j, 0.383589011363253 - 0.2664910809911026j, 0.3399195570456499 + 0.3863983538639875j, 0.3399195570456499 - 0.3863983538639875j, 0.2855977834508353 + 0.4929444399540688j, 0.2855977834508353 - 0.4929444399540688j, 0.2255765441339322 + 0.5851631870205766j, 0.2255765441339322 - 0.5851631870205766j, 0.1644087535815792 + 0.6637356937277153j, 0.1644087535815792 - 0.6637356937277153j, -0.07293633845273095 + 0.9739218252516307j, -0.07293633845273095 - 0.9739218252516307j, 0.1058259206358626 + 0.7304739464862978j, 0.1058259206358626 - 0.7304739464862978j, -0.05703971947785402 + 0.9291057542169088j, -0.05703971947785402 - 0.9291057542169088j, 0.05263875132656864 + 0.7877974334424453j, 0.05263875132656864 - 0.7877974334424453j, -0.03007943405982616 + 0.8846331716180016j, -0.03007943405982616 - 0.8846331716180016j, 0.006857277464483946 + 0.8383275456264492j, 0.006857277464483946 - 0.8383275456264492j]
        k2 = 0.006507068761705037
        assert_allclose(sorted(z, key=np.angle), sorted(z2, key=np.angle), rtol=1e-13)
        assert_allclose(sorted(p, key=np.angle), sorted(p2, key=np.angle), rtol=1e-12)
        assert_allclose(k, k2, rtol=1e-11)

    def test_bandpass(self):
        z, p, k = cheby2(9, 40, [0.07, 0.2], 'pass', output='zpk')
        z2 = [-0.9999999999999999, 0.3676588029658514 + 0.9299607543341383j, 0.3676588029658514 - 0.9299607543341383j, 0.7009689684982283 + 0.7131917730894889j, 0.7009689684982283 - 0.7131917730894889j, 0.7815697973765858 + 0.6238178033919218j, 0.7815697973765858 - 0.6238178033919218j, 0.8063793628819866 + 0.59139861609412j, 0.8063793628819866 - 0.59139861609412j, 1.000000000000001, 0.9944493019920448 + 0.1052168511576739j, 0.9944493019920448 - 0.1052168511576739j, 0.9854674703367308 + 0.1698642543566085j, 0.9854674703367308 - 0.1698642543566085j, 0.9762751735919308 + 0.2165335665157851j, 0.9762751735919308 - 0.2165335665157851j, 0.9792277171575134 + 0.2027636011479496j, 0.9792277171575134 - 0.2027636011479496j]
        p2 = [0.8143803410489621 + 0.5411056063397541j, 0.8143803410489621 - 0.5411056063397541j, 0.7650769827887418 + 0.5195412242095543j, 0.7650769827887418 - 0.5195412242095543j, 0.6096241204063443 + 0.3568440484659796j, 0.6096241204063443 - 0.3568440484659796j, 0.6918192770246239 + 0.4770463577106911j, 0.6918192770246239 - 0.4770463577106911j, 0.6986241085779207 + 0.114651222618006j, 0.6986241085779207 - 0.114651222618006j, 0.8654645923909734 + 0.1604208797063147j, 0.8654645923909734 - 0.1604208797063147j, 0.9164831670444591 + 0.1969181049384918j, 0.9164831670444591 - 0.1969181049384918j, 0.963042577759455 + 0.2317513360702271j, 0.963042577759455 - 0.2317513360702271j, 0.943810470372553 + 0.219350990026986j, 0.943810470372553 - 0.219350990026986j]
        k2 = 0.009345352824659604
        assert_allclose(sorted(z, key=np.angle), sorted(z2, key=np.angle), rtol=1e-13)
        assert_allclose(sorted(p, key=np.angle), sorted(p2, key=np.angle), rtol=1e-13)
        assert_allclose(k, k2, rtol=1e-11)

    def test_bandstop(self):
        z, p, k = cheby2(6, 55, [0.1, 0.9], 'stop', output='zpk')
        z2 = [0.6230544895101009 + 0.7821784343111114j, 0.6230544895101009 - 0.7821784343111114j, 0.9086608545660115 + 0.4175349702471991j, 0.9086608545660115 - 0.4175349702471991j, 0.9478129721465802 + 0.3188268649763867j, 0.9478129721465802 - 0.3188268649763867j, -0.6230544895100982 + 0.7821784343111109j, -0.6230544895100982 - 0.7821784343111109j, -0.9086608545660116 + 0.4175349702472088j, -0.9086608545660116 - 0.4175349702472088j, -0.9478129721465784 + 0.3188268649763897j, -0.9478129721465784 - 0.3188268649763897j]
        p2 = [-0.9464094036167638 + 0.1720048695084344j, -0.9464094036167638 - 0.1720048695084344j, -0.8715844103386737 + 0.1370665039509297j, -0.8715844103386737 - 0.1370665039509297j, -0.8078751204586425 + 0.05729329866682983j, -0.8078751204586425 - 0.05729329866682983j, 0.9464094036167665 + 0.1720048695084332j, 0.9464094036167665 - 0.1720048695084332j, 0.8078751204586447 + 0.05729329866683007j, 0.8078751204586447 - 0.05729329866683007j, 0.8715844103386721 + 0.1370665039509331j, 0.8715844103386721 - 0.1370665039509331j]
        k2 = 0.002917823332763358
        assert_allclose(sorted(z, key=np.angle), sorted(z2, key=np.angle), rtol=1e-13)
        assert_allclose(sorted(p, key=np.angle), sorted(p2, key=np.angle), rtol=1e-13)
        assert_allclose(k, k2, rtol=1e-11)

    def test_ba_output(self):
        b, a = cheby2(5, 20, [2010, 2100], 'stop', True)
        b2 = [1.0, 0, 21115125.0, 0, 178296643378125.0, 0, 7.525901316990656e+20, 0, 1.587960565565748e+27, 0, 1.339913493808585e+33]
        a2 = [1.0, 184.9550755473371, 21132229.18998538, 3125114149.732283, 178513345715560.9, 1.979158697776348e+16, 7.53504832265383e+20, 5.567966191263037e+22, 1.589246884221346e+27, 5.871210648525566e+28, 1.33991349380859e+33]
        assert_allclose(b, b2, rtol=1e-14)
        assert_allclose(a, a2, rtol=1e-14)

    def test_fs_param(self):
        for fs in (900, 900.1, 1234.567):
            for N in (0, 1, 2, 3, 10):
                for fc in (100, 100.1, 432.12345):
                    for btype in ('lp', 'hp'):
                        ba1 = cheby2(N, 20, fc, btype, fs=fs)
                        ba2 = cheby2(N, 20, fc / (fs / 2), btype)
                        assert_allclose(ba1, ba2)
                for fc in ((100, 200), (100.1, 200.2), (321.123, 432.123)):
                    for btype in ('bp', 'bs'):
                        ba1 = cheby2(N, 20, fc, btype, fs=fs)
                        for seq in (list, tuple, array):
                            fcnorm = seq([f / (fs / 2) for f in fc])
                            ba2 = cheby2(N, 20, fcnorm, btype)
                            assert_allclose(ba1, ba2)