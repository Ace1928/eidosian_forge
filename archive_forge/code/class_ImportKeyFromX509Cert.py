import unittest
import re
from Cryptodome.PublicKey import DSA
from Cryptodome.SelfTest.st_common import *
from Cryptodome.Util.py3compat import *
from binascii import unhexlify
class ImportKeyFromX509Cert(unittest.TestCase):

    def test_x509v1(self):
        x509_v1_cert = '\n-----BEGIN CERTIFICATE-----\nMIIDUjCCArsCAQIwDQYJKoZIhvcNAQEFBQAwfjENMAsGA1UEChMEQWNtZTELMAkG\nA1UECxMCUkQxHDAaBgkqhkiG9w0BCQEWDXNwYW1AYWNtZS5vcmcxEzARBgNVBAcT\nCk1ldHJvcG9saXMxETAPBgNVBAgTCE5ldyBZb3JrMQswCQYDVQQGEwJVUzENMAsG\nA1UEAxMEdGVzdDAeFw0xNDA3MTEyMDM4NDNaFw0xNzA0MDYyMDM4NDNaME0xCzAJ\nBgNVBAYTAlVTMREwDwYDVQQIEwhOZXcgWW9yazENMAsGA1UEChMEQWNtZTELMAkG\nA1UECxMCUkQxDzANBgNVBAMTBnBvbGFuZDCCAbYwggErBgcqhkjOOAQBMIIBHgKB\ngQDOrN4Ox4+t3T6wKeHfhzArhcrNEFMQ4Ss+4PIKyimDy9Bn64WPkL1B/9dvYIga\n23GLu6tVJmXo6EdJnVOHEMhr99EeOwuDWWeP7Awq7RSlKEejokr4BEzMTW/tExSD\ncO6/GI7xzh0eTH+VTTPDfyrJMYCkh0rJAfCP+5xrmPNetwIVALtXYOV1yoRrzJ2Q\nM5uEjidH6GiZAoGAfUqA1SAm5g5U68SILMVX9l5rq0OpB0waBMpJQ31/R/yXNDqo\nc3gGWZTOJFU4IzwNpGhrGNADUByz/lc1SAOAdEJIr0JVrhbGewQjB4pWqoLGbBKz\nRoavTNDc/zD7SYa12evWDHADwvlXoeQg+lWop1zS8OqaDC7aLGKpWN3/m8kDgYQA\nAoGAKoirPAfcp1rbbl4y2FFAIktfW8f4+T7d2iKSg73aiVfujhNOt1Zz1lfC0NI2\neonLWO3tAM4XGKf1TLjb5UXngGn40okPsaA81YE6ZIKm20ywjlOY3QkAEdMaLVY3\n9PJvM8RGB9m7pLKxyHfGMfF40MVN4222zKeGp7xhM0CNiCUwDQYJKoZIhvcNAQEF\nBQADgYEAfbNZfpYa2KlALEM1FZnwvQDvJHntHz8LdeJ4WM7CXDlKi67wY2HKM30w\ns2xej75imkVOFd1kF2d0A8sjfriXLVIt1Hwq9ANZomhu4Edx0xpH8tqdh/bDtnM2\nTmduZNY9OWkb07h0CtWD6Zt8fhRllVsSSrlWd/2or7FXNC5weFQ=\n-----END CERTIFICATE-----\n        '.strip()
        y_str = '\n2a:88:ab:3c:07:dc:a7:5a:db:6e:5e:32:d8:51:40:\n22:4b:5f:5b:c7:f8:f9:3e:dd:da:22:92:83:bd:da:\n89:57:ee:8e:13:4e:b7:56:73:d6:57:c2:d0:d2:36:\n7a:89:cb:58:ed:ed:00:ce:17:18:a7:f5:4c:b8:db:\ne5:45:e7:80:69:f8:d2:89:0f:b1:a0:3c:d5:81:3a:\n64:82:a6:db:4c:b0:8e:53:98:dd:09:00:11:d3:1a:\n2d:56:37:f4:f2:6f:33:c4:46:07:d9:bb:a4:b2:b1:\nc8:77:c6:31:f1:78:d0:c5:4d:e3:6d:b6:cc:a7:86:\na7:bc:61:33:40:8d:88:25\n        '
        p_str = '\n00:ce:ac:de:0e:c7:8f:ad:dd:3e:b0:29:e1:df:87:\n30:2b:85:ca:cd:10:53:10:e1:2b:3e:e0:f2:0a:ca:\n29:83:cb:d0:67:eb:85:8f:90:bd:41:ff:d7:6f:60:\n88:1a:db:71:8b:bb:ab:55:26:65:e8:e8:47:49:9d:\n53:87:10:c8:6b:f7:d1:1e:3b:0b:83:59:67:8f:ec:\n0c:2a:ed:14:a5:28:47:a3:a2:4a:f8:04:4c:cc:4d:\n6f:ed:13:14:83:70:ee:bf:18:8e:f1:ce:1d:1e:4c:\n7f:95:4d:33:c3:7f:2a:c9:31:80:a4:87:4a:c9:01:\nf0:8f:fb:9c:6b:98:f3:5e:b7\n        '
        q_str = '\n00:bb:57:60:e5:75:ca:84:6b:cc:9d:90:33:9b:84:\n8e:27:47:e8:68:99\n        '
        g_str = '\n7d:4a:80:d5:20:26:e6:0e:54:eb:c4:88:2c:c5:57:\nf6:5e:6b:ab:43:a9:07:4c:1a:04:ca:49:43:7d:7f:\n47:fc:97:34:3a:a8:73:78:06:59:94:ce:24:55:38:\n23:3c:0d:a4:68:6b:18:d0:03:50:1c:b3:fe:57:35:\n48:03:80:74:42:48:af:42:55:ae:16:c6:7b:04:23:\n07:8a:56:aa:82:c6:6c:12:b3:46:86:af:4c:d0:dc:\nff:30:fb:49:86:b5:d9:eb:d6:0c:70:03:c2:f9:57:\na1:e4:20:fa:55:a8:a7:5c:d2:f0:ea:9a:0c:2e:da:\n2c:62:a9:58:dd:ff:9b:c9\n        '
        key = DSA.importKey(x509_v1_cert)
        for comp_name in ('y', 'p', 'q', 'g'):
            comp_str = locals()[comp_name + '_str']
            comp = int(re.sub('[^0-9a-f]', '', comp_str), 16)
            self.assertEqual(getattr(key, comp_name), comp)
        self.assertFalse(key.has_private())

    def test_x509v3(self):
        x509_v3_cert = '\n-----BEGIN CERTIFICATE-----\nMIIFhjCCA26gAwIBAgIBAzANBgkqhkiG9w0BAQsFADBhMQswCQYDVQQGEwJVUzEL\nMAkGA1UECAwCTUQxEjAQBgNVBAcMCUJhbHRpbW9yZTEQMA4GA1UEAwwHVGVzdCBD\nQTEfMB0GCSqGSIb3DQEJARYQdGVzdEBleGFtcGxlLmNvbTAeFw0xNDA3MTMyMDUz\nMjBaFw0xNzA0MDgyMDUzMjBaMEAxCzAJBgNVBAYTAlVTMQswCQYDVQQIDAJNRDES\nMBAGA1UEBwwJQmFsdGltb3JlMRAwDgYDVQQDDAdhdXN0cmlhMIIBtjCCASsGByqG\nSM44BAEwggEeAoGBALfd8gyEpVPA0ZI69Kp3nyJcu5N0ZZ3K1K9hleQLNqKEcZOh\n7a/C2J1TPdmHTLJ0rAwBZ1nWxnARSgRphziGDFspKCYQwYcSMz8KoFgvXbXpuchy\noFACiQ2LqZnc5MakuLQtLcQciSYGYj3zmZdYMoa904F1aDWr+DxQI6DVC3/bAhUA\nhqXMCJ6fQK3G2O9S3/CC/yVZXCsCgYBRXROl3R2khX7l10LQjDEgo3B1IzjXU/jP\nMcMBl6XO+nBJXxr/scbq8Ajiv7LTnGpSjgryHtvfj887kfvo8QbSS3kp3vq5uSqI\nui7E7r3jguWaLj616AG1HWOctXJUjqsiabZwsp2h09gHTzmHEXBOmiARu8xFxKAH\nxsuo7onAbwOBhAACgYBylWjWSnKHE8mHx1A5m/0GQx6xnhWIe3+MJAnEhRGxA2J4\nSCsfWU0OwglIQToh1z5uUU9oDi9cYgNPBevOFRnDhc2yaJY6VAYnI+D+6J5IU6Yd\n0iaG/iSc4sV4bFr0axcPpse3SN0XaQxiKeSFBfFnoMqL+dd9Gb3QPZSllBcVD6OB\n1TCB0jAdBgNVHQ4EFgQUx5wN0Puotv388M9Tp/fsPbZpzAUwHwYDVR0jBBgwFoAU\na0hkif3RMaraiWtsOOZZlLu9wJwwCQYDVR0TBAIwADALBgNVHQ8EBAMCBeAwSgYD\nVR0RBEMwQYILZXhhbXBsZS5jb22CD3d3dy5leGFtcGxlLmNvbYIQbWFpbC5leGFt\ncGxlLmNvbYIPZnRwLmV4YW1wbGUuY29tMCwGCWCGSAGG+EIBDQQfFh1PcGVuU1NM\nIEdlbmVyYXRlZCBDZXJ0aWZpY2F0ZTANBgkqhkiG9w0BAQsFAAOCAgEAyWf1TiJI\naNEIA9o/PG8/JiGASTS2/HBVTJbkq03k6NkJVk/GxC1DPziTUJ+CdWlHWcAi1EOW\nAch3QxNDRrVfCOfCMDgElIO1094/reJgdFYG00LRi8QkRJuxANV7YS4tLudhyHJC\nkR2lhdMNmEuzWK+s2y+5cLrdm7qdvdENQCcV67uvGPx4sc+EaE7x13SczKjWBtbo\nQCs6JTOW+EkPRl4Zo27K4OIZ43/J+GxvwU9QUVH3wPVdbbLNw+QeTFBYMTEcxyc4\nkv50HPBFaithziXBFyvdIs19FjkFzu0Uz/e0zb1+vMzQlJMD94HVOrMnIj5Sb2cL\nKKdYXS4uhxFJmdV091Xur5JkYYwEzuaGav7J3zOzYutrIGTgDluLCvA+VQkRcTsy\njZ065SkY/v+38QHp+cmm8WRluupJTs8wYzVp6Fu0iFaaK7ztFmaZmHpiPIfDFjva\naCIgzzT5NweJd/b71A2SyzHXJ14zBXsr1PMylMp2TpHIidhuuNuQL6I0HaollB4M\nZ3FsVBMhVDw4Z76qnFPr8mZE2tar33hSlJI/3pS/bBiukuBk8U7VB0X8OqaUnP3C\n7b2Z4G8GtqDVcKGMzkvMjT4n9rKd/Le+qHSsQOGO9W/0LB7UDAZSwUsfAPnoBgdS\n5t9tIomLCOstByXi+gGZue1TcdCa3Ph4kO0=\n-----END CERTIFICATE-----\n        '.strip()
        y_str = '\n72:95:68:d6:4a:72:87:13:c9:87:c7:50:39:9b:fd:\n06:43:1e:b1:9e:15:88:7b:7f:8c:24:09:c4:85:11:\nb1:03:62:78:48:2b:1f:59:4d:0e:c2:09:48:41:3a:\n21:d7:3e:6e:51:4f:68:0e:2f:5c:62:03:4f:05:eb:\nce:15:19:c3:85:cd:b2:68:96:3a:54:06:27:23:e0:\nfe:e8:9e:48:53:a6:1d:d2:26:86:fe:24:9c:e2:c5:\n78:6c:5a:f4:6b:17:0f:a6:c7:b7:48:dd:17:69:0c:\n62:29:e4:85:05:f1:67:a0:ca:8b:f9:d7:7d:19:bd:\nd0:3d:94:a5:94:17:15:0f\n        '
        p_str = '\n00:b7:dd:f2:0c:84:a5:53:c0:d1:92:3a:f4:aa:77:\n9f:22:5c:bb:93:74:65:9d:ca:d4:af:61:95:e4:0b:\n36:a2:84:71:93:a1:ed:af:c2:d8:9d:53:3d:d9:87:\n4c:b2:74:ac:0c:01:67:59:d6:c6:70:11:4a:04:69:\n87:38:86:0c:5b:29:28:26:10:c1:87:12:33:3f:0a:\na0:58:2f:5d:b5:e9:b9:c8:72:a0:50:02:89:0d:8b:\na9:99:dc:e4:c6:a4:b8:b4:2d:2d:c4:1c:89:26:06:\n62:3d:f3:99:97:58:32:86:bd:d3:81:75:68:35:ab:\nf8:3c:50:23:a0:d5:0b:7f:db\n        '
        q_str = '\n00:86:a5:cc:08:9e:9f:40:ad:c6:d8:ef:52:df:f0:\n82:ff:25:59:5c:2b\n        '
        g_str = '\n51:5d:13:a5:dd:1d:a4:85:7e:e5:d7:42:d0:8c:31:\n20:a3:70:75:23:38:d7:53:f8:cf:31:c3:01:97:a5:\nce:fa:70:49:5f:1a:ff:b1:c6:ea:f0:08:e2:bf:b2:\nd3:9c:6a:52:8e:0a:f2:1e:db:df:8f:cf:3b:91:fb:\ne8:f1:06:d2:4b:79:29:de:fa:b9:b9:2a:88:ba:2e:\nc4:ee:bd:e3:82:e5:9a:2e:3e:b5:e8:01:b5:1d:63:\n9c:b5:72:54:8e:ab:22:69:b6:70:b2:9d:a1:d3:d8:\n07:4f:39:87:11:70:4e:9a:20:11:bb:cc:45:c4:a0:\n07:c6:cb:a8:ee:89:c0:6f\n        '
        key = DSA.importKey(x509_v3_cert)
        for comp_name in ('y', 'p', 'q', 'g'):
            comp_str = locals()[comp_name + '_str']
            comp = int(re.sub('[^0-9a-f]', '', comp_str), 16)
            self.assertEqual(getattr(key, comp_name), comp)
        self.assertFalse(key.has_private())