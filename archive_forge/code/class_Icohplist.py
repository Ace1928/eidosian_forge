from __future__ import annotations
import collections
import fnmatch
import os
import re
import warnings
from collections import defaultdict
from typing import TYPE_CHECKING, Any
import numpy as np
from monty.io import zopen
from monty.json import MSONable
from pymatgen.core.structure import Structure
from pymatgen.electronic_structure.bandstructure import LobsterBandStructureSymmLine
from pymatgen.electronic_structure.core import Orbital, Spin
from pymatgen.electronic_structure.dos import Dos, LobsterCompleteDos
from pymatgen.io.vasp.inputs import Kpoints
from pymatgen.io.vasp.outputs import Vasprun, VolumetricData
from pymatgen.util.due import Doi, due
class Icohplist(MSONable):
    """
    Class to read ICOHPLIST/ICOOPLIST files generated by LOBSTER.

    Attributes:
        are_coops (bool): Indicates whether the object is consisting of COOPs.
        is_spin_polarized (bool): Boolean to indicate if the calculation is spin polarized.
        Icohplist (dict[str, Dict[str, Union[float, int, Dict[Spin, float]]]]): Dict containing the
            listfile data of the form: {
                bond: "length": bond length,
                "number_of_bonds": number of bonds
                "icohp": {Spin.up: ICOHP(Ef) spin up, Spin.down: ...}
            }
        IcohpCollection (IcohpCollection): IcohpCollection Object.
    """

    def __init__(self, are_coops: bool=False, are_cobis: bool=False, filename: str | None=None, is_spin_polarized: bool=False, orbitalwise: bool=False, icohpcollection=None):
        """
        Args:
            are_coops: Determines if the file is a list of ICOOPs.
              Defaults to False for ICOHPs.
            are_cobis: Determines if the file is a list of ICOBIs.
              Defaults to False for ICOHPs.
            filename: Name of the ICOHPLIST file. If it is None, the default
              file name will be chosen, depending on the value of are_coops
            is_spin_polarized: Boolean to indicate if the calculation is spin polarized
            icohpcollection: IcohpCollection Object

        """
        from pymatgen.electronic_structure.cohp import IcohpCollection
        self._filename = filename
        self.is_spin_polarized = is_spin_polarized
        self.orbitalwise = orbitalwise
        self._icohpcollection = icohpcollection
        if are_coops and are_cobis:
            raise ValueError('You cannot have info about COOPs and COBIs in the same file.')
        self.are_coops = are_coops
        self.are_cobis = are_cobis
        if filename is None:
            if are_coops:
                filename = 'ICOOPLIST.lobster'
            elif are_cobis:
                filename = 'ICOBILIST.lobster'
            else:
                filename = 'ICOHPLIST.lobster'
        if self._icohpcollection is None:
            with zopen(filename, mode='rt') as file:
                data = file.read().split('\n')[1:-1]
            if len(data) == 0:
                raise OSError('ICOHPLIST file contains no data.')
            if len(data[0].split()) == 8:
                version = '3.1.1'
            elif len(data[0].split()) == 6:
                version = '2.2.1'
                warnings.warn('Please consider using the new Lobster version. See www.cohp.de.')
            else:
                raise ValueError
            self.is_spin_polarized = 'distance' in data[len(data) // 2]
            self.orbitalwise = len(data) > 2 and '_' in data[1].split()[1]
            data_orbitals: list[str] = []
            if self.orbitalwise:
                data_without_orbitals = []
                data_orbitals = []
                for line in data:
                    if '_' not in line.split()[1]:
                        data_without_orbitals += [line]
                    else:
                        data_orbitals += [line]
            else:
                data_without_orbitals = data
            if 'distance' in data_without_orbitals[len(data_without_orbitals) // 2]:
                n_bonds = len(data_without_orbitals) // 2
                if n_bonds == 0:
                    raise OSError('ICOHPLIST file contains no data.')
            else:
                n_bonds = len(data_without_orbitals)
            labels, atoms1, atoms2, lens, translations, nums, icohps = ([], [], [], [], [], [], [])
            label = ''
            atom1 = ''
            atom2 = ''
            length = None
            num = None
            translation = []
            for bond in range(n_bonds):
                line = data_without_orbitals[bond].split()
                icohp = {}
                if version == '2.2.1':
                    label = f'{line[0]}'
                    atom1 = str(line[1])
                    atom2 = str(line[2])
                    length = float(line[3])
                    icohp[Spin.up] = float(line[4])
                    num = int(line[5])
                    translation = [0, 0, 0]
                    if self.is_spin_polarized:
                        icohp[Spin.down] = float(data_without_orbitals[bond + n_bonds + 1].split()[4])
                elif version == '3.1.1':
                    label = f'{line[0]}'
                    atom1 = str(line[1])
                    atom2 = str(line[2])
                    length = float(line[3])
                    translation = [int(line[4]), int(line[5]), int(line[6])]
                    icohp[Spin.up] = float(line[7])
                    num = 1
                    if self.is_spin_polarized:
                        icohp[Spin.down] = float(data_without_orbitals[bond + n_bonds + 1].split()[7])
                labels += [label]
                atoms1 += [atom1]
                atoms2 += [atom2]
                lens += [length]
                translations += [translation]
                nums += [num]
                icohps += [icohp]
            list_orb_icohp: list[dict] | None = None
            if self.orbitalwise:
                list_orb_icohp = []
                n_orbs = len(data_orbitals) // 2 if self.is_spin_polarized else len(data_orbitals)
                for i_data_orb in range(n_orbs):
                    data_orb = data_orbitals[i_data_orb]
                    icohp = {}
                    line = data_orb.split()
                    label = f'{line[0]}'
                    orbs = re.findall('_(.*?)(?=\\s)', data_orb)
                    orb_label, orbitals = get_orb_from_str(orbs)
                    icohp[Spin.up] = float(line[7])
                    if self.is_spin_polarized:
                        icohp[Spin.down] = float(data_orbitals[n_orbs + i_data_orb].split()[7])
                    if len(list_orb_icohp) < int(label):
                        list_orb_icohp += [{orb_label: {'icohp': icohp, 'orbitals': orbitals}}]
                    else:
                        list_orb_icohp[int(label) - 1][orb_label] = {'icohp': icohp, 'orbitals': orbitals}
            self._icohpcollection = IcohpCollection(are_coops=are_coops, are_cobis=are_cobis, list_labels=labels, list_atom1=atoms1, list_atom2=atoms2, list_length=lens, list_translation=translations, list_num=nums, list_icohp=icohps, is_spin_polarized=self.is_spin_polarized, list_orb_icohp=list_orb_icohp)

    @property
    def icohplist(self) -> dict[Any, dict[str, Any]]:
        """Returns: icohplist compatible with older version of this class."""
        icohp_dict = {}
        for key, value in self._icohpcollection._icohplist.items():
            icohp_dict[key] = {'length': value._length, 'number_of_bonds': value._num, 'icohp': value._icohp, 'translation': value._translation, 'orbitals': value._orbitals}
        return icohp_dict

    @property
    def icohpcollection(self):
        """Returns: IcohpCollection object."""
        return self._icohpcollection