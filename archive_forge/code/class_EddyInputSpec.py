import os
import numpy as np
import nibabel as nb
import warnings
from ...utils.filemanip import split_filename, fname_presuffix
from ..base import traits, TraitedSpec, InputMultiPath, File, isdefined
from .base import FSLCommand, FSLCommandInputSpec, Info
class EddyInputSpec(FSLCommandInputSpec):
    in_file = File(exists=True, mandatory=True, argstr='--imain=%s', desc='File containing all the images to estimate distortions for')
    in_mask = File(exists=True, mandatory=True, argstr='--mask=%s', desc='Mask to indicate brain')
    in_index = File(exists=True, mandatory=True, argstr='--index=%s', desc='File containing indices for all volumes in --imain into --acqp and --topup')
    in_acqp = File(exists=True, mandatory=True, argstr='--acqp=%s', desc='File containing acquisition parameters')
    in_bvec = File(exists=True, mandatory=True, argstr='--bvecs=%s', desc='File containing the b-vectors for all volumes in --imain')
    in_bval = File(exists=True, mandatory=True, argstr='--bvals=%s', desc='File containing the b-values for all volumes in --imain')
    out_base = traits.Str(default_value='eddy_corrected', usedefault=True, argstr='--out=%s', desc='Basename for output image')
    session = File(exists=True, argstr='--session=%s', desc='File containing session indices for all volumes in --imain')
    in_topup_fieldcoef = File(exists=True, argstr='--topup=%s', requires=['in_topup_movpar'], desc='Topup results file containing the field coefficients')
    in_topup_movpar = File(exists=True, requires=['in_topup_fieldcoef'], desc='Topup results file containing the movement parameters (movpar.txt)')
    field = File(exists=True, argstr='--field=%s', desc='Non-topup derived fieldmap scaled in Hz')
    field_mat = File(exists=True, argstr='--field_mat=%s', desc='Matrix specifying the relative positions of the fieldmap, --field, and the first volume of the input file, --imain')
    flm = traits.Enum('quadratic', 'linear', 'cubic', usedefault=True, argstr='--flm=%s', desc='First level EC model')
    slm = traits.Enum('none', 'linear', 'quadratic', usedefault=True, argstr='--slm=%s', desc='Second level EC model')
    fep = traits.Bool(False, argstr='--fep', desc='Fill empty planes in x- or y-directions')
    initrand = traits.Bool(False, argstr='--initrand', desc='Resets rand for when selecting voxels', min_ver='5.0.10')
    interp = traits.Enum('spline', 'trilinear', usedefault=True, argstr='--interp=%s', desc='Interpolation model for estimation step')
    nvoxhp = traits.Int(default_value=1000, usedefault=True, argstr='--nvoxhp=%s', desc='# of voxels used to estimate the hyperparameters')
    fudge_factor = traits.Float(default_value=10.0, usedefault=True, argstr='--ff=%s', desc='Fudge factor for hyperparameter error variance')
    dont_sep_offs_move = traits.Bool(False, argstr='--dont_sep_offs_move', desc='Do NOT attempt to separate field offset from subject movement')
    dont_peas = traits.Bool(False, argstr='--dont_peas', desc='Do NOT perform a post-eddy alignment of shells')
    fwhm = traits.Float(desc='FWHM for conditioning filter when estimating the parameters', argstr='--fwhm=%s')
    niter = traits.Int(5, usedefault=True, argstr='--niter=%s', desc='Number of iterations')
    method = traits.Enum('jac', 'lsr', usedefault=True, argstr='--resamp=%s', desc='Final resampling method (jacobian/least squares)')
    repol = traits.Bool(False, argstr='--repol', desc='Detect and replace outlier slices')
    outlier_nstd = traits.Int(argstr='--ol_nstd', desc='Number of std off to qualify as outlier', requires=['repol'], min_ver='5.0.10')
    outlier_nvox = traits.Int(argstr='--ol_nvox', desc='Min # of voxels in a slice for inclusion in outlier detection', requires=['repol'], min_ver='5.0.10')
    outlier_type = traits.Enum('sw', 'gw', 'both', argstr='--ol_type', desc='Type of outliers, slicewise (sw), groupwise (gw) or both (both)', requires=['repol'], min_ver='5.0.10')
    outlier_pos = traits.Bool(False, argstr='--ol_pos', desc='Consider both positive and negative outliers if set', requires=['repol'], min_ver='5.0.10')
    outlier_sqr = traits.Bool(False, argstr='--ol_sqr', desc='Consider outliers among sums-of-squared differences if set', requires=['repol'], min_ver='5.0.10')
    multiband_factor = traits.Int(argstr='--mb=%s', desc='Multi-band factor', min_ver='5.0.10')
    multiband_offset = traits.Enum(0, 1, -1, argstr='--mb_offs=%d', desc='Multi-band offset (-1 if bottom slice removed, 1 if top slice removed', requires=['multiband_factor'], min_ver='5.0.10')
    mporder = traits.Int(argstr='--mporder=%s', desc='Order of slice-to-vol movement model', requires=['use_cuda'], min_ver='5.0.11')
    slice2vol_niter = traits.Int(argstr='--s2v_niter=%d', desc='Number of iterations for slice-to-vol', requires=['mporder'], min_ver='5.0.11')
    slice2vol_lambda = traits.Int(argstr='--s2v_lambda=%d', desc='Regularisation weight for slice-to-vol movement (reasonable range 1-10)', requires=['mporder'], min_ver='5.0.11')
    slice2vol_interp = traits.Enum('trilinear', 'spline', argstr='--s2v_interp=%s', desc='Slice-to-vol interpolation model for estimation step', requires=['mporder'], min_ver='5.0.11')
    slice_order = traits.File(exists=True, argstr='--slspec=%s', desc='Name of text file completely specifying slice/group acquisition', requires=['mporder'], xor=['json'], min_ver='5.0.11')
    json = traits.File(exists=True, argstr='--json=%s', desc='Name of .json text file with information about slice timing', requires=['mporder'], xor=['slice_order'], min_ver='6.0.1')
    estimate_move_by_susceptibility = traits.Bool(False, argstr='--estimate_move_by_susceptibility', desc='Estimate how susceptibility field changes with subject movement', min_ver='6.0.1')
    mbs_niter = traits.Int(argstr='--mbs_niter=%s', desc='Number of iterations for MBS estimation', requires=['estimate_move_by_susceptibility'], min_ver='6.0.1')
    mbs_lambda = traits.Int(argstr='--mbs_lambda=%s', desc='Weighting of regularisation for MBS estimation', requires=['estimate_move_by_susceptibility'], min_ver='6.0.1')
    mbs_ksp = traits.Int(argstr='--mbs_ksp=%smm', desc='Knot-spacing for MBS field estimation', requires=['estimate_move_by_susceptibility'], min_ver='6.0.1')
    num_threads = traits.Int(1, usedefault=True, nohash=True, desc='Number of openmp threads to use')
    is_shelled = traits.Bool(False, argstr='--data_is_shelled', desc='Override internal check to ensure that date are acquired on a set of b-value shells')
    use_cuda = traits.Bool(False, desc='Run eddy using cuda gpu')
    cnr_maps = traits.Bool(False, desc='Output CNR-Maps', argstr='--cnr_maps', min_ver='5.0.10')
    residuals = traits.Bool(False, desc='Output Residuals', argstr='--residuals', min_ver='5.0.10')