import itertools
import math
import sys
import unittest
from contextlib import redirect_stdout
from functools import wraps
from io import StringIO
from os import getenv
from textwrap import dedent
from typing import Sequence, Tuple
import numpy as np
import parameterized
import version_utils
from numpy.testing import assert_allclose
import onnx.reference.custom_element_types as custom
from onnx import (
from onnx.backend.test.case.node.roialign import get_roi_align_input_values
from onnx.checker import check_model
from onnx.defs import onnx_opset_version
from onnx.helper import (
from onnx.numpy_helper import float8e4m3_to_float32, float8e5m2_to_float32, from_array
from onnx.reference import ReferenceEvaluator
from onnx.reference.op_run import OpRun, OpRunExpand
from onnx.reference.ops import load_op
from onnx.reference.ops._op_common_indices import _get_indices, _is_out
from onnx.reference.ops._op_list import Cast_19, Celu
from onnx.reference.ops.aionnx_preview_training._op_list import Adam
from onnx.reference.ops.op_celu import _vcelu1
from onnx.reference.ops.op_col2im import (
from onnx.reference.ops.op_conv import Conv, _conv_implementation
from onnx.reference.ops_optimized import Conv as ConvOptimized
from onnx.reference.ops_optimized.op_conv_optimized import _conv_implementation_im2col
def test_dynamic_quantize_linear(self):
    feeds = {'X': np.array([[-0.0780749545, -0.380597055, 0.133831516, -0.0820474699, 0.0756645501, 0.0565112457, 0.256818235, 0.0942316353, 0.188027292, 0.144878656, 0.134825557, -0.20457691, 0.168852255, 0.062325336, 0.430482924, -0.0550433956, 0.0910681635, 0.155332625, -0.0453630984, 0.399910688, -0.128678545, 0.0377916731, 0.12987271, -0.112420328, -0.0297306702, 0.220508516, -0.00588933006, 0.481076002, -0.118835129, -0.0445004404, -0.0753675848, 0.14111267, 0.197793499, -0.771476865, 0.0864694864, 0.0173293594, 0.128247693, 0.075814411, -0.27143538, 0.175212905, -0.247283235, -0.0302810557, 0.0845039487, 0.602229357, -0.104913145, -0.246705681, 0.29207328, -0.0388464853, 0.426557302, -0.371325493, -0.311283618, 0.0785303488, 0.318069518, -0.151467413, -0.102828763, 0.092913188, 0.255233884, 0.500160515, -0.149993747, 0.429408073, -0.191787735, 0.0316187665, -0.0184284449, -0.162873864, -0.273632705, 0.284725696, -0.287029266, -0.0715534389, 0.224836454, -0.170527741, -0.265601039, -0.00268008932, 0.144260898, 0.0780707747, 0.0273875445, -0.118391573, -0.064497225, -0.00522445887, -0.296754301, 0.105800219, 0.262558222, 0.0362841524, 0.00944730639, 0.175837606, 0.269956529, 0.302758247, -0.113724738, 0.298936248, 0.0854668319, -0.6745556, 0.438643873, 0.0127896462, 0.0920789093, 0.193946883, 0.197548166, 0.282558739, -0.24887912, -0.393428057, 0.0645540953, -0.00966283306], [-0.242438495, -0.358334243, 0.122619808, -0.121529415, -0.0523974374, -0.0674922541, 0.109727375, -0.00356835872, 0.151029706, 0.118043356, 0.0816475376, -0.236466587, 0.0944180191, 0.0561679937, 0.367988586, 0.129441261, 0.115772486, 0.0530351102, -0.104345076, 0.129062623, -0.217205048, 0.025808949, 0.218848974, -0.0836039707, 0.00543577969, 0.078707628, 0.119966723, 0.281631678, -0.0358020402, -0.0965647772, 0.0317915753, 0.249396205, 0.22360079, -0.382718384, 0.116506606, -0.0319400802, 0.160812005, 0.098173596, -0.199046463, 0.0881427377, -0.165171087, -0.110251531, 0.115387037, 0.31931293, -0.114400804, -0.202447772, 0.233669549, 0.0920853689, 0.391551465, -0.358036369, -0.235071778, -0.0500670634, 0.165313914, -0.160922945, -0.195520848, 0.182456985, 0.380704433, 0.419890225, -0.0298131555, 0.366110623, -0.281170905, -0.12394245, 0.0958625227, -0.0590450205, -0.156236291, 0.211865619, -0.175286919, -0.0836539492, 0.129381597, -0.16611588, -0.166922957, 0.165688396, 0.0841224194, 0.167839468, -0.0403967649, -0.0834071711, -0.0565301552, 0.16707401, -0.319734544, 0.0771123618, 0.0557036921, 0.12070933, -0.0663790107, 0.136002287, 0.342324018, 0.342968374, -0.142380476, 0.289662749, 0.0182179566, -0.496056974, 0.264364302, 0.073891893, 0.111150607, -0.0595749579, 0.118562862, 0.0690007359, -0.208283514, -0.170682222, 0.0782715827, 0.135489792], [-0.0635757595, -0.320629895, 0.0938569903, -0.115190029, 0.010364607, -0.0431734361, 0.231717676, 0.0401005745, 0.118915148, 0.210071519, -0.0299234912, -0.293135524, -0.23958829, 0.0671441257, 0.315238893, -0.0508778207, 0.11614728, -0.0672954097, -0.163787514, 0.160288364, -0.230847582, -0.222037435, 0.0450191796, -0.109636143, -0.0600997508, 0.214693844, -0.00851289369, 0.388416052, -0.118085533, -0.0857385695, -0.0118666515, 0.329741478, 0.203779504, -0.169492334, 0.194324687, 0.0416374728, 0.0683876276, -0.0185160581, -0.0373600274, 0.0714804307, -0.301446438, 0.0174035393, 0.335123807, 0.417102218, -0.158562332, -0.0254483074, 0.199573949, 0.0795029774, 0.482958555, -0.458213627, -0.26722917, 0.127542794, 0.0447799414, -0.168686539, -0.0892183557, 0.0979782715, 0.0277656261, 0.296871901, 0.0629860088, 0.177246213, -0.315523535, -0.174582571, 0.0125724282, -0.0454988703, -0.129154682, 0.213568255, -0.140891463, -0.266211092, 0.262144595, -0.142889306, -0.0667349845, 0.0163380653, -0.0192995071, 0.114811368, 0.143584609, -0.0265347548, 0.0932592154, 0.223325342, -0.187100068, 0.057119742, 0.271253467, 0.102890521, -0.00304941833, 0.110537663, 0.275728375, 0.211693868, -0.180009842, 0.0299300496, 0.177923322, -0.453491032, 0.194149211, 0.247100577, -0.00995091349, 0.199301094, 0.20656465, -0.0199648179, -0.18962945, 0.016168993, 0.104817756, 0.206400946], [-0.038625136, -0.307115853, 0.0374236181, -0.171237886, -0.0277359486, -0.0408068746, 0.0691853091, 0.00265322998, 0.123958819, 0.220951259, 0.0836500078, -0.31441319, 0.134745941, -0.0825274512, 0.336270213, -0.0249634441, -0.0106189884, 0.0718819201, -0.173392966, 0.298084319, -0.125626653, -0.0217043106, 0.287982523, -0.00341932476, -0.0689984411, -0.00714176893, 0.044954244, 0.516424477, -0.102622584, 0.0202640779, 0.0230106711, 0.193037808, 0.203393996, -0.434632808, 0.0574068353, 0.0966466218, -0.0719890296, 0.0423505977, -0.160067812, 0.0388947129, -0.332329512, 0.191072702, 0.0379437394, 0.43383947, -0.12923196, -0.146881789, 0.247269243, 0.0286379829, 0.292926908, -0.297341049, -0.340239167, 0.152589783, 0.0881168991, 0.0140633471, -0.0883188471, 0.24836731, 0.341982782, 0.318781316, -0.115148552, 0.25432542, -0.182771236, 0.053388983, 0.0212034155, -0.0978844613, -0.161611915, 0.354084134, -0.125332132, -0.20798941, 0.0235610008, -0.135993093, -0.197377697, -0.0121356212, 0.00786775351, 0.471337497, 0.00949376822, 0.0425345525, 0.11416205, 0.0627847165, -0.231957644, -0.0833211765, 0.202719584, -0.0464919358, 0.0757966787, 0.101521172, 0.316580981, 0.149488643, -0.120770879, 0.256563038, 0.166572407, -0.611343801, 0.209183827, 0.0666101649, 0.177328646, 0.177777156, 0.203266457, 0.137545317, -0.138004154, -0.257656008, 0.18392086, 0.0287696868], [0.000514136627, -0.288997203, -0.0334554128, -0.0680408552, -0.0461972654, 0.175428241, 0.186710209, -0.151355267, 0.128381401, 0.287129283, 0.0052215457, -0.353413224, -0.0387947261, 0.0581918843, 0.317016482, -0.251671404, 0.0701867491, -0.0492945537, -0.273323953, 0.127938241, -0.411552131, -0.0223789401, 0.195418939, -0.325946212, 0.0460528135, 0.18688409, 0.0698191971, 0.295638293, -0.180322871, -0.0298620313, 0.211789399, 0.31514591, 0.311763227, -0.578147054, 0.0643244758, -0.0314367823, 0.186190963, 0.171108633, -0.0629745722, 0.0748428777, -0.458003521, -0.3014718, 0.217973694, 0.573273778, -0.101379365, -0.246951967, 0.158989042, -0.179126799, 0.524153829, -0.46485284, -0.294867605, 0.183558539, 0.250552952, -0.0856962949, -0.25755471, 0.230709136, 0.353280157, 0.320184112, 0.0299184099, 0.309098989, -0.202217728, -0.0929201543, -0.0120569356, -0.137087986, -0.21652469, 0.139787242, -0.12790215, -0.264347821, 0.0929943919, -0.157217175, -0.386638314, 0.0790465698, 0.040721193, -0.0307695866, 0.127393469, -0.118648581, -0.0721216127, -0.0371141285, -0.337082207, -0.0623112544, 0.352166295, 0.151260465, 0.050342761, 0.190433189, 0.521304548, 0.385341585, -0.12645705, 0.154961571, 0.0529025272, -0.506486952, 0.228533953, 0.178438187, -0.041476503, 0.201903239, -0.0389365852, 0.0884043872, -0.155351788, -0.0906582028, 0.0995599255, -0.047998976]], dtype=np.float32)}
    expected = [np.array([[129, 72, 168, 128, 157, 153, 191, 160, 178, 170, 168, 105, 174, 155, 223, 133, 160, 172, 135, 217, 119, 150, 167, 122, 137, 184, 142, 232, 121, 135, 129, 169, 180, 0, 159, 146, 167, 157, 93, 176, 97, 137, 159, 255, 124, 97, 197, 136, 222, 74, 85, 158, 202, 115, 124, 160, 190, 236, 115, 223, 107, 149, 140, 113, 92, 196, 90, 130, 185, 111, 94, 143, 170, 157, 148, 121, 131, 142, 88, 163, 192, 150, 145, 176, 193, 199, 122, 198, 159, 18, 224, 145, 160, 179, 180, 195, 97, 70, 155, 141], [98, 76, 166, 120, 133, 130, 163, 142, 171, 165, 158, 99, 161, 153, 211, 167, 164, 153, 124, 167, 103, 148, 184, 127, 144, 158, 165, 195, 136, 125, 149, 189, 185, 72, 165, 137, 173, 161, 106, 159, 112, 123, 164, 202, 122, 105, 186, 160, 216, 77, 99, 134, 174, 113, 107, 177, 214, 221, 137, 211, 91, 120, 161, 132, 114, 182, 110, 127, 167, 112, 112, 174, 159, 174, 136, 128, 133, 174, 84, 157, 153, 165, 131, 168, 207, 207, 117, 197, 146, 51, 192, 157, 164, 132, 165, 156, 104, 111, 158, 168], [131, 83, 160, 122, 145, 135, 186, 150, 165, 182, 137, 89, 99, 155, 202, 134, 165, 131, 113, 173, 100, 102, 151, 123, 132, 183, 141, 215, 121, 127, 141, 204, 181, 112, 179, 151, 156, 140, 136, 156, 87, 146, 205, 220, 114, 138, 180, 158, 233, 58, 93, 167, 151, 112, 126, 161, 148, 198, 155, 176, 84, 111, 145, 135, 119, 183, 117, 94, 192, 116, 131, 146, 139, 164, 170, 138, 160, 184, 108, 154, 193, 162, 142, 164, 194, 182, 110, 149, 176, 59, 179, 189, 141, 180, 181, 139, 108, 146, 162, 181], [136, 86, 150, 111, 138, 135, 156, 143, 166, 184, 159, 85, 168, 128, 205, 138, 141, 156, 111, 198, 120, 139, 196, 142, 130, 142, 151, 239, 124, 147, 147, 179, 181, 62, 154, 161, 130, 151, 113, 150, 81, 178, 150, 224, 119, 116, 189, 148, 197, 88, 80, 171, 159, 146, 127, 189, 206, 202, 122, 190, 109, 153, 147, 125, 113, 209, 120, 104, 147, 118, 106, 141, 144, 230, 145, 151, 164, 155, 100, 128, 181, 134, 157, 162, 202, 171, 121, 191, 174, 30, 182, 155, 176, 176, 181, 169, 117, 95, 177, 148], [143, 89, 137, 130, 134, 176, 178, 115, 167, 196, 144, 77, 136, 154, 202, 96, 156, 134, 92, 167, 67, 139, 179, 82, 152, 178, 156, 198, 110, 137, 182, 202, 201, 36, 155, 137, 178, 175, 131, 157, 58, 87, 183, 249, 124, 97, 173, 110, 240, 57, 88, 177, 190, 127, 95, 186, 209, 202, 149, 200, 105, 126, 141, 118, 103, 169, 119, 94, 160, 114, 71, 158, 151, 137, 167, 121, 130, 136, 80, 131, 208, 171, 152, 178, 240, 215, 120, 172, 153, 49, 185, 176, 135, 180, 136, 159, 114, 126, 161, 134]], dtype=np.uint8), np.array(0.005387083161622286, dtype=np.float32), np.array(143, dtype=np.uint8)]
    X = make_tensor_value_info('X', TensorProto.FLOAT, None)
    Y = make_tensor_value_info('Y', TensorProto.UINT8, None)
    Scale = make_tensor_value_info('scale', TensorProto.FLOAT, None)
    Zp = make_tensor_value_info('zp', TensorProto.UINT8, None)
    nodes = [make_node('DynamicQuantizeLinear', ['X'], ['Y', 'scale', 'zp'])]
    model = make_model(make_graph(nodes, 'g', [X], [Y, Scale, Zp]), opset_imports=[make_opsetid('', onnx_opset_version() - 1)])
    ref = ReferenceEvaluator(model)
    got = ref.run(None, feeds)
    self.assertEqual(len(got), 3)
    for i in range(2, -1, -1):
        assert_allclose(expected[i], got[i])