import os
from glob import glob
import numpy as np
from ... import logging
from ...utils.filemanip import ensure_list, simplify_list, split_filename
from ..base import (
from .base import SPMCommand, SPMCommandInputSpec, scans_for_fnames, ImageFileSPM
class EstimateContrast(SPMCommand):
    """Use spm_contrasts to estimate contrasts of interest

    Examples
    --------
    >>> import nipype.interfaces.spm as spm
    >>> est = spm.EstimateContrast()
    >>> est.inputs.spm_mat_file = 'SPM.mat'
    >>> cont1 = ('Task>Baseline','T', ['Task-Odd','Task-Even'],[0.5,0.5])
    >>> cont2 = ('Task-Odd>Task-Even','T', ['Task-Odd','Task-Even'],[1,-1])
    >>> contrasts = [cont1,cont2]
    >>> est.inputs.contrasts = contrasts
    >>> est.run() # doctest: +SKIP

    """
    input_spec = EstimateContrastInputSpec
    output_spec = EstimateContrastOutputSpec
    _jobtype = 'stats'
    _jobname = 'con'

    def _make_matlab_command(self, _):
        """Validate spm options and generate job structure."""
        contrasts = []
        cname = []
        for i, cont in enumerate(self.inputs.contrasts):
            cname.insert(i, cont[0])
            contrasts.insert(i, Bunch(name=cont[0], stat=cont[1], conditions=cont[2], weights=None, sessions=None))
            if len(cont) >= 4:
                contrasts[i].weights = cont[3]
            if len(cont) >= 5:
                contrasts[i].sessions = cont[4]
        script = ["%% generated by nipype.interfaces.spm\nspm_defaults;\njobs{1}.stats{1}.con.spmmat  = {'%s'};\nload(jobs{1}.stats{1}.con.spmmat{:});\nSPM.swd = '%s';\nsave(jobs{1}.stats{1}.con.spmmat{:},'SPM');\nnames = SPM.xX.name;" % (self.inputs.spm_mat_file, os.getcwd())]
        if isdefined(self.inputs.group_contrast) and self.inputs.group_contrast:
            script += ['condnames=names;']
        else:
            if self.inputs.use_derivs:
                script += ["pat = 'Sn\\([0-9]*\\) (.*)';"]
            else:
                script += ["pat = 'Sn\\([0-9]*\\) (.*)\\*bf\\(1\\)|Sn\\([0-9]*\\) .*\\*bf\\([2-9]\\)|Sn\\([0-9]*\\) (.*)';"]
            script += ["t = regexp(names,pat,'tokens');"]
            script += ["pat1 = 'Sn\\(([0-9].*)\\)\\s.*';"]
            script += ["t1 = regexp(names,pat1,'tokens');"]
            script += ["for i0=1:numel(t)\n  condnames{i0}='';\n  condsess(i0)=0;\n  if ~isempty(t{i0}{1})\n    condnames{i0} = t{i0}{1}{1};\n    condsess(i0)=str2num(t1{i0}{1}{1});\n  end;\nend;"]
        for i, contrast in enumerate(contrasts):
            if contrast.stat == 'T':
                script += ["consess{%d}.tcon.name   = '%s';" % (i + 1, contrast.name)]
                script += ['consess{%d}.tcon.convec = zeros(1,numel(names));' % (i + 1)]
                for c0, cond in enumerate(contrast.conditions):
                    script += ["idx = strmatch('%s',condnames,'exact');" % cond]
                    script += ["if isempty(idx)\n  throw(MException('CondName:Chk', sprintf('Condition %%s not found in design','%s')));\nend;" % cond]
                    if contrast.sessions:
                        for sno, sw in enumerate(contrast.sessions):
                            script += ['sidx = find(condsess(idx)==%d);' % (sno + 1)]
                            script += ['consess{%d}.tcon.convec(idx(sidx)) = %f;' % (i + 1, sw * contrast.weights[c0])]
                    else:
                        script += ['consess{%d}.tcon.convec(idx) = %f;' % (i + 1, contrast.weights[c0])]
        for i, contrast in enumerate(contrasts):
            if contrast.stat == 'F':
                script += ["consess{%d}.fcon.name   =  '%s';" % (i + 1, contrast.name)]
                for cl0, fcont in enumerate(contrast.conditions):
                    tidx = cname.index(fcont[0])
                    script += ['consess{%d}.fcon.convec{%d} = consess{%d}.tcon.convec;' % (i + 1, cl0 + 1, tidx + 1)]
        script += ['jobs{1}.stats{1}.con.consess = consess;']
        script += ["if strcmp(spm('ver'),'SPM8')\n  spm_jobman('initcfg');\n  jobs=spm_jobman('spm5tospm8',{jobs});\nend;"]
        script += ["spm_jobman('run',jobs);"]
        return '\n'.join(script)

    def _list_outputs(self):
        import scipy.io as sio
        outputs = self._outputs().get()
        pth, _ = os.path.split(self.inputs.spm_mat_file)
        spm = sio.loadmat(self.inputs.spm_mat_file, struct_as_record=False)
        con_images = []
        spmT_images = []
        for con in spm['SPM'][0, 0].xCon[0]:
            con_images.append(str(os.path.join(pth, con.Vcon[0, 0].fname[0])))
            spmT_images.append(str(os.path.join(pth, con.Vspm[0, 0].fname[0])))
        if con_images:
            outputs['con_images'] = con_images
            outputs['spmT_images'] = spmT_images
        spm12 = '12' in self.version.split('.')[0]
        if spm12:
            ess = glob(os.path.join(pth, 'ess*.nii'))
        else:
            ess = glob(os.path.join(pth, 'ess*.img'))
        if len(ess) > 0:
            outputs['ess_images'] = sorted(ess)
        if spm12:
            spmf = glob(os.path.join(pth, 'spmF*.nii'))
        else:
            spmf = glob(os.path.join(pth, 'spmF*.img'))
        if len(spmf) > 0:
            outputs['spmF_images'] = sorted(spmf)
        outputs['spm_mat_file'] = self.inputs.spm_mat_file
        return outputs