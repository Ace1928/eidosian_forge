import asyncio
import datetime
import os
from unittest import mock
import duet
import pytest
from google.api_core import exceptions
from google.protobuf import any_pb2
from google.protobuf.field_mask_pb2 import FieldMask
from google.protobuf.timestamp_pb2 import Timestamp
from cirq_google.engine.engine_client import EngineClient, EngineException
import cirq_google.engine.stream_manager as engine_stream_manager
from cirq_google.cloud import quantum
@pytest.mark.parametrize('run_job_kwargs, expected_submit_args', [({'project_id': 'proj', 'program_id': 'prog', 'code': any_pb2.Any(), 'job_id': 'job0', 'processor_id': 'processor0', 'run_context': any_pb2.Any(), 'program_description': 'A program', 'program_labels': {'hello': 'world'}, 'priority': 10, 'job_description': 'A job', 'job_labels': {'hello': 'world'}}, ['projects/proj', quantum.QuantumProgram(name='projects/proj/programs/prog', code=any_pb2.Any(), description='A program', labels={'hello': 'world'}), quantum.QuantumJob(name='projects/proj/programs/prog/jobs/job0', run_context=any_pb2.Any(), scheduling_config=quantum.SchedulingConfig(priority=10, processor_selector=quantum.SchedulingConfig.ProcessorSelector(processor='projects/proj/processors/processor0', device_config_key=quantum.DeviceConfigKey())), description='A job', labels={'hello': 'world'})]), ({'project_id': 'proj', 'program_id': 'prog', 'code': any_pb2.Any(), 'job_id': 'job0', 'processor_id': 'processor0', 'run_context': any_pb2.Any(), 'program_description': 'A program', 'priority': 10, 'job_description': 'A job', 'job_labels': {'hello': 'world'}}, ['projects/proj', quantum.QuantumProgram(name='projects/proj/programs/prog', code=any_pb2.Any(), description='A program'), quantum.QuantumJob(name='projects/proj/programs/prog/jobs/job0', run_context=any_pb2.Any(), scheduling_config=quantum.SchedulingConfig(priority=10, processor_selector=quantum.SchedulingConfig.ProcessorSelector(processor='projects/proj/processors/processor0', device_config_key=quantum.DeviceConfigKey())), description='A job', labels={'hello': 'world'})]), ({'project_id': 'proj', 'program_id': 'prog', 'code': any_pb2.Any(), 'job_id': 'job0', 'processor_id': 'processor0', 'run_context': any_pb2.Any(), 'priority': 10, 'job_description': 'A job', 'job_labels': {'hello': 'world'}}, ['projects/proj', quantum.QuantumProgram(name='projects/proj/programs/prog', code=any_pb2.Any()), quantum.QuantumJob(name='projects/proj/programs/prog/jobs/job0', run_context=any_pb2.Any(), scheduling_config=quantum.SchedulingConfig(priority=10, processor_selector=quantum.SchedulingConfig.ProcessorSelector(processor='projects/proj/processors/processor0', device_config_key=quantum.DeviceConfigKey())), description='A job', labels={'hello': 'world'})]), ({'project_id': 'proj', 'program_id': 'prog', 'code': any_pb2.Any(), 'job_id': 'job0', 'processor_id': 'processor0', 'run_context': any_pb2.Any(), 'program_description': 'A program', 'program_labels': {'hello': 'world'}, 'priority': 10, 'job_description': 'A job'}, ['projects/proj', quantum.QuantumProgram(name='projects/proj/programs/prog', code=any_pb2.Any(), description='A program', labels={'hello': 'world'}), quantum.QuantumJob(name='projects/proj/programs/prog/jobs/job0', run_context=any_pb2.Any(), scheduling_config=quantum.SchedulingConfig(priority=10, processor_selector=quantum.SchedulingConfig.ProcessorSelector(processor='projects/proj/processors/processor0', device_config_key=quantum.DeviceConfigKey())), description='A job')]), ({'project_id': 'proj', 'program_id': 'prog', 'code': any_pb2.Any(), 'job_id': 'job0', 'processor_id': 'processor0', 'run_context': any_pb2.Any(), 'program_description': 'A program', 'program_labels': {'hello': 'world'}, 'priority': 10}, ['projects/proj', quantum.QuantumProgram(name='projects/proj/programs/prog', code=any_pb2.Any(), description='A program', labels={'hello': 'world'}), quantum.QuantumJob(name='projects/proj/programs/prog/jobs/job0', run_context=any_pb2.Any(), scheduling_config=quantum.SchedulingConfig(priority=10, processor_selector=quantum.SchedulingConfig.ProcessorSelector(processor='projects/proj/processors/processor0', device_config_key=quantum.DeviceConfigKey())))]), ({'project_id': 'proj', 'program_id': 'prog', 'code': any_pb2.Any(), 'job_id': 'job0', 'processor_id': 'processor0', 'run_context': any_pb2.Any(), 'program_description': 'A program', 'program_labels': {'hello': 'world'}}, ['projects/proj', quantum.QuantumProgram(name='projects/proj/programs/prog', code=any_pb2.Any(), description='A program', labels={'hello': 'world'}), quantum.QuantumJob(name='projects/proj/programs/prog/jobs/job0', run_context=any_pb2.Any(), scheduling_config=quantum.SchedulingConfig(processor_selector=quantum.SchedulingConfig.ProcessorSelector(processor='projects/proj/processors/processor0', device_config_key=quantum.DeviceConfigKey())))])])
@mock.patch.object(quantum, 'QuantumEngineServiceAsyncClient', autospec=True)
@mock.patch.object(engine_stream_manager, 'StreamManager', autospec=True)
def test_run_job_over_stream(manager_constructor, client_constructor, run_job_kwargs, expected_submit_args):
    _setup_client_mock(client_constructor)
    stream_manager = _setup_stream_manager_mock(manager_constructor)
    result = quantum.QuantumResult(parent='projects/proj/programs/prog/jobs/job0')
    expected_future = duet.AwaitableFuture()
    expected_future.try_set_result(result)
    stream_manager.submit.return_value = expected_future
    client = EngineClient()
    actual_future = client.run_job_over_stream(**run_job_kwargs)
    assert actual_future == expected_future
    stream_manager.submit.assert_called_with(*expected_submit_args)