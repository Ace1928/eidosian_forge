from warnings import warn
import os
import pickle
import sys
import numpy
from rdkit import DataStructs
from rdkit.Dbase import DbModule
from rdkit.Dbase.DbConnection import DbConnect
from rdkit.ML import CompositeRun
from rdkit.ML.Data import DataUtils, SplitData
def MakePredPlot(details, indices, data, goodVotes, badVotes, nRes, idCol=0, verbose=0):
    """

  **Arguments**

    - details:  a CompositeRun.RunDetails object

    - indices: a sequence of integer indices into _data_

    - data: the data set in question.  We assume that the ids for
      the data points are in the _idCol_ column

    - goodVotes/badVotes: predictions where the model was correct/incorrect.
      These are sequences of 4-tuples:
        (answer,prediction,confidence,index into _indices_)

  """
    if not hasattr(details, 'predPlot') or not details.predPlot:
        return
    if verbose:
        message('\n-> Constructing Prediction (Hanneke) Plot')
    outF = open(details.predPlot, 'w+')
    gnuF = open('%s.gnu' % details.predPlot, 'w+')
    ptIds = [data[x][idCol] for x in indices]
    origConn = DbConnect(details.dbName, details.tableName, user=details.dbUser, password=details.dbPassword)
    colNames = origConn.GetColumnNames()
    idName = colNames[idCol]
    if not hasattr(details, 'predActTable') or not details.predActTable or details.predActTable == details.tableName:
        actConn = origConn
    else:
        actConn = DbConnect(details.dbName, details.predActTable, user=details.dbUser, password=details.dbPassword)
    if verbose:
        message('\t-> Pulling Activity Data')
    if type(ptIds[0]) not in [type(''), type(u'')]:
        ptIds = [str(x) for x in ptIds]
    whereL = [DbModule.placeHolder] * len(ptIds)
    if hasattr(details, 'predActCol') and details.predActCol:
        actColName = details.predActCol
    else:
        actColName = actConn.GetColumnNames()[-1]
    whereTxt = '%s in (%s)' % (idName, ','.join(whereL))
    rawD = actConn.GetData(fields='%s,%s' % (idName, actColName), where=whereTxt, extras=ptIds)
    if verbose:
        message('\t-> Creating Plot')
    acts = [None] * len(ptIds)
    for entry in rawD:
        ID, act = entry
        idx = ptIds.index(ID)
        acts[idx] = act
    outF.write('#ID Pred Conf %s\n' % actColName)
    for ans, pred, conf, idx in goodVotes:
        act = acts[idx]
        if act != 'None':
            act = float(act)
        else:
            act = 0
        outF.write('%s %d %.4f %f\n' % (ptIds[idx], pred, conf, act))
    for ans, pred, conf, idx in badVotes:
        act = acts[idx]
        if act != 'None':
            act = float(act)
        else:
            act = 0
        outF.write('%s %d %.4f %f\n' % (ptIds[idx], pred, conf, act))
    outF.close()
    if not hasattr(details, 'predLogScale') or not details.predLogScale:
        actLabel = actColName
    else:
        actLabel = 'log(%s)' % actColName
    actLabel = actLabel.replace('_', ' ')
    gnuHdr = '# Generated by ScreenComposite.py version: %s\n  set size square 0.7\n  set yrange [:1]\n  set data styl points\n  set ylab \'confidence\'\n  set xlab \'%s\'\n  set grid\n  set nokey\n  set term postscript enh color solid "Helvetica" 16\n  set term X\n  ' % (__VERSION_STRING, actLabel)
    gnuF.write(gnuHdr)
    plots = []
    for i in range(nRes):
        if not hasattr(details, 'predLogScale') or not details.predLogScale:
            plots.append("'%s' us 4:($2==%d?$3:0/0)" % (details.predPlot, i))
        else:
            plots.append("'%s' us (log10($4)):($2==%d?$3:0/0)" % (details.predPlot, i))
    gnuF.write('plot %s\n' % ','.join(plots))
    gnuTail = '\n  # EOF\n  '
    gnuF.write(gnuTail)
    gnuF.close()
    if hasattr(details, 'predShow') and details.predShow:
        try:
            try:
                from Gnuplot import Gnuplot
            except ImportError:
                raise ImportError('Functionality requires the Gnuplot module')
            p = Gnuplot()
            p('cd "%s"' % os.getcwd())
            p('load "%s.gnu"' % details.predPlot)
            input('press return to continue...\n')
        except Exception:
            import traceback
            traceback.print_exc()