import os
from itertools import islice
from Bio.Align import MultipleSeqAlignment
from Bio.Seq import Seq
from Bio.SeqRecord import SeqRecord
from .Interfaces import SequentialAlignmentWriter
class MafWriter(SequentialAlignmentWriter):
    """Accepts a MultipleSeqAlignment object, writes a MAF file."""

    def write_header(self):
        """Write the MAF header."""
        self.handle.write('##maf version=1 scoring=none\n')
        self.handle.write('# generated by Biopython\n\n')

    def _write_record(self, record):
        """Write a single SeqRecord object to an 's' line in a MAF block (PRIVATE)."""
        if record.annotations.get('strand') == 1:
            strand = '+'
        elif record.annotations.get('strand') == -1:
            strand = '-'
        else:
            strand = '+'
        fields = ['s', '%-40s' % record.id.replace(' ', '_'), '%15s' % record.annotations.get('start', 0), '%5s' % record.annotations.get('size', len(str(record.seq).replace('-', ''))), strand, '%15s' % record.annotations.get('srcSize', 0), str(record.seq)]
        self.handle.write(f'{' '.join(fields)}\n')

    def write_alignment(self, alignment):
        """Write a complete alignment to a MAF block.

        Writes every SeqRecord in a MultipleSeqAlignment object to its own
        MAF block (beginning with an 'a' line, containing 's' lines).
        """
        if not isinstance(alignment, MultipleSeqAlignment):
            raise TypeError('Expected an alignment object')
        if len({len(x) for x in alignment}) > 1:
            raise ValueError('Sequences must all be the same length')
        try:
            anno = ' '.join([f'{x}={y}' for x, y in alignment._annotations.items() if x in ('score', 'pass')])
        except AttributeError:
            anno = 'score=0.00'
        self.handle.write(f'a {anno}\n')
        recs_out = 0
        for record in alignment:
            self._write_record(record)
            recs_out += 1
        self.handle.write('\n')
        return recs_out