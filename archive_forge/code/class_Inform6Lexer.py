import re
from pygments.lexer import RegexLexer, include, bygroups, using, \
from pygments.token import Text, Comment, Operator, Keyword, Name, String, \
class Inform6Lexer(RegexLexer):
    """
    For `Inform 6 <http://inform-fiction.org/>`_ source code.

    .. versionadded:: 2.0
    """
    name = 'Inform 6'
    aliases = ['inform6', 'i6']
    filenames = ['*.inf']
    flags = re.MULTILINE | re.DOTALL | re.UNICODE
    _name = '[a-zA-Z_]\\w*'
    _dash = u'\\-‐-—'
    _dquote = u'"“”'
    _squote = u"'‘’"
    _newline = u'\\n\x85\u2028\u2029'
    tokens = {'root': [('\\A(!%%[^%s]*[%s])+' % (_newline, _newline), Comment.Preproc, 'directive'), default('directive')], '_whitespace': [('\\s+', Text), ('![^%s]*' % _newline, Comment.Single)], 'default': [include('_whitespace'), ('\\[', Punctuation, 'many-values'), (':|(?=;)', Punctuation, '#pop'), ('<', Punctuation), default(('expression', '_expression'))], '_expression': [include('_whitespace'), ('(?=sp\\b)', Text, '#pop'), ('(?=[%s%s$0-9#a-zA-Z_])' % (_dquote, _squote), Text, ('#pop', 'value')), ('\\+\\+|[%s]{1,2}(?!>)|~~?' % _dash, Operator), ('(?=[()\\[%s,?@{:;])' % _dash, Text, '#pop')], 'expression': [include('_whitespace'), ('\\(', Punctuation, ('expression', '_expression')), ('\\)', Punctuation, '#pop'), ('\\[', Punctuation, ('#pop', 'statements', 'locals')), ('>(?=(\\s+|(![^%s]*))*[>;])' % _newline, Punctuation), ('\\+\\+|[%s]{2}(?!>)' % _dash, Operator), (',', Punctuation, '_expression'), ('&&?|\\|\\|?|[=~><]?=|[%s]{1,2}>?|\\.\\.?[&#]?|::|[<>+*/%%]' % _dash, Operator, '_expression'), ('(has|hasnt|in|notin|ofclass|or|provides)\\b', Operator.Word, '_expression'), ('sp\\b', Name), ('\\?~?', Name.Label, 'label?'), ('[@{]', Error), default('#pop')], '_assembly-expression': [('\\(', Punctuation, ('#push', '_expression')), ('[\\[\\]]', Punctuation), ('[%s]>' % _dash, Punctuation, '_expression'), ('sp\\b', Keyword.Pseudo), (';', Punctuation, '#pop:3'), include('expression')], '_for-expression': [('\\)', Punctuation, '#pop:2'), (':', Punctuation, '#pop'), include('expression')], '_keyword-expression': [('(from|near|to)\\b', Keyword, '_expression'), include('expression')], '_list-expression': [(',', Punctuation, '#pop'), include('expression')], '_object-expression': [('has\\b', Keyword.Declaration, '#pop'), include('_list-expression')], 'value': [include('_whitespace'), ('[%s][^@][%s]' % (_squote, _squote), String.Char, '#pop'), ('([%s])(@\\{[0-9a-fA-F]{1,4}\\})([%s])' % (_squote, _squote), bygroups(String.Char, String.Escape, String.Char), '#pop'), ('([%s])(@.{2})([%s])' % (_squote, _squote), bygroups(String.Char, String.Escape, String.Char), '#pop'), ('[%s]' % _squote, String.Single, ('#pop', 'dictionary-word')), ('[%s]' % _dquote, String.Double, ('#pop', 'string')), ('\\$[+%s][0-9]*\\.?[0-9]*([eE][+%s]?[0-9]+)?' % (_dash, _dash), Number.Float, '#pop'), ('\\$[0-9a-fA-F]+', Number.Hex, '#pop'), ('\\$\\$[01]+', Number.Bin, '#pop'), ('[0-9]+', Number.Integer, '#pop'), ('(##|#a\\$)(%s)' % _name, bygroups(Operator, Name), '#pop'), ('(#g\\$)(%s)' % _name, bygroups(Operator, Name.Variable.Global), '#pop'), ('#[nw]\\$', Operator, ('#pop', 'obsolete-dictionary-word')), ('(#r\\$)(%s)' % _name, bygroups(Operator, Name.Function), '#pop'), ('#', Name.Builtin, ('#pop', 'system-constant')), (words(('child', 'children', 'elder', 'eldest', 'glk', 'indirect', 'metaclass', 'parent', 'random', 'sibling', 'younger', 'youngest'), suffix='\\b'), Name.Builtin, '#pop'), ('(?i)(Class|Object|Routine|String)\\b', Name.Builtin, '#pop'), (words(('Box__Routine', 'CA__Pr', 'CDefArt', 'CInDefArt', 'Cl__Ms', 'Copy__Primitive', 'CP__Tab', 'DA__Pr', 'DB__Pr', 'DefArt', 'Dynam__String', 'EnglishNumber', 'Glk__Wrap', 'IA__Pr', 'IB__Pr', 'InDefArt', 'Main__', 'Meta__class', 'OB__Move', 'OB__Remove', 'OC__Cl', 'OP__Pr', 'Print__Addr', 'Print__PName', 'PrintShortName', 'RA__Pr', 'RA__Sc', 'RL__Pr', 'R_Process', 'RT__ChG', 'RT__ChGt', 'RT__ChLDB', 'RT__ChLDW', 'RT__ChPR', 'RT__ChPrintA', 'RT__ChPrintC', 'RT__ChPrintO', 'RT__ChPrintS', 'RT__ChPS', 'RT__ChR', 'RT__ChSTB', 'RT__ChSTW', 'RT__ChT', 'RT__Err', 'RT__TrPS', 'RV__Pr', 'Symb__Tab', 'Unsigned__Compare', 'WV__Pr', 'Z__Region'), prefix='(?i)', suffix='\\b'), Name.Builtin, '#pop'), (words(('call', 'copy', 'create', 'DEBUG', 'destroy', 'DICT_CHAR_SIZE', 'DICT_ENTRY_BYTES', 'DICT_IS_UNICODE', 'DICT_WORD_SIZE', 'false', 'FLOAT_INFINITY', 'FLOAT_NAN', 'FLOAT_NINFINITY', 'GOBJFIELD_CHAIN', 'GOBJFIELD_CHILD', 'GOBJFIELD_NAME', 'GOBJFIELD_PARENT', 'GOBJFIELD_PROPTAB', 'GOBJFIELD_SIBLING', 'GOBJ_EXT_START', 'GOBJ_TOTAL_LENGTH', 'Grammar__Version', 'INDIV_PROP_START', 'INFIX', 'infix__watching', 'MODULE_MODE', 'name', 'nothing', 'NUM_ATTR_BYTES', 'print', 'print_to_array', 'recreate', 'remaining', 'self', 'sender', 'STRICT_MODE', 'sw__var', 'sys__glob0', 'sys__glob1', 'sys__glob2', 'sys_statusline_flag', 'TARGET_GLULX', 'TARGET_ZCODE', 'temp__global2', 'temp__global3', 'temp__global4', 'temp_global', 'true', 'USE_MODULES', 'WORDSIZE'), prefix='(?i)', suffix='\\b'), Name.Builtin, '#pop'), (_name, Name, '#pop')], 'dictionary-word': [('[~^]+', String.Escape), ('[^~^\\\\@({%s]+' % _squote, String.Single), ('[({]', String.Single), ('@\\{[0-9a-fA-F]{,4}\\}', String.Escape), ('@.{2}', String.Escape), ('[%s]' % _squote, String.Single, '#pop')], 'string': [('[~^]+', String.Escape), ('[^~^\\\\@({%s]+' % _dquote, String.Double), ('[({]', String.Double), ('\\\\', String.Escape), ('@(\\\\\\s*[%s]\\s*)*@((\\\\\\s*[%s]\\s*)*[0-9])*' % (_newline, _newline), String.Escape), ('@(\\\\\\s*[%s]\\s*)*\\{((\\\\\\s*[%s]\\s*)*[0-9a-fA-F]){,4}(\\\\\\s*[%s]\\s*)*\\}' % (_newline, _newline, _newline), String.Escape), ('@(\\\\\\s*[%s]\\s*)*.(\\\\\\s*[%s]\\s*)*.' % (_newline, _newline), String.Escape), ('[%s]' % _dquote, String.Double, '#pop')], 'plain-string': [('[^~^\\\\({\\[\\]%s]+' % _dquote, String.Double), ('[~^({\\[\\]]', String.Double), ('\\\\', String.Escape), ('[%s]' % _dquote, String.Double, '#pop')], '_constant': [include('_whitespace'), (_name, Name.Constant, '#pop'), include('value')], '_global': [include('_whitespace'), (_name, Name.Variable.Global, '#pop'), include('value')], 'label?': [include('_whitespace'), (_name, Name.Label, '#pop'), default('#pop')], 'variable?': [include('_whitespace'), (_name, Name.Variable, '#pop'), default('#pop')], 'obsolete-dictionary-word': [('\\S\\w*', String.Other, '#pop')], 'system-constant': [include('_whitespace'), (_name, Name.Builtin, '#pop')], 'directive': [include('_whitespace'), ('#', Punctuation), (';', Punctuation, '#pop'), ('\\[', Punctuation, ('default', 'statements', 'locals', 'routine-name?')), (words(('abbreviate', 'endif', 'dictionary', 'ifdef', 'iffalse', 'ifndef', 'ifnot', 'iftrue', 'ifv3', 'ifv5', 'release', 'serial', 'switches', 'system_file', 'version'), prefix='(?i)', suffix='\\b'), Keyword, 'default'), ('(?i)(array|global)\\b', Keyword, ('default', 'directive-keyword?', '_global')), ('(?i)attribute\\b', Keyword, ('default', 'alias?', '_constant')), ('(?i)class\\b', Keyword, ('object-body', 'duplicates', 'class-name')), ('(?i)(constant|default)\\b', Keyword, ('default', 'expression', '_constant')), ('(?i)(end\\b)(.*)', bygroups(Keyword, Text)), ('(?i)(extend|verb)\\b', Keyword, 'grammar'), ('(?i)fake_action\\b', Keyword, ('default', '_constant')), ('(?i)import\\b', Keyword, 'manifest'), ('(?i)(include|link)\\b', Keyword, ('default', 'before-plain-string')), ('(?i)(lowstring|undef)\\b', Keyword, ('default', '_constant')), ('(?i)message\\b', Keyword, ('default', 'diagnostic')), ('(?i)(nearby|object)\\b', Keyword, ('object-body', '_object-head')), ('(?i)property\\b', Keyword, ('default', 'alias?', '_constant', 'property-keyword*')), ('(?i)replace\\b', Keyword, ('default', 'routine-name?', 'routine-name?')), ('(?i)statusline\\b', Keyword, ('default', 'directive-keyword?')), ('(?i)stub\\b', Keyword, ('default', 'routine-name?')), ('(?i)trace\\b', Keyword, ('default', 'trace-keyword?', 'trace-keyword?')), ('(?i)zcharacter\\b', Keyword, ('default', 'directive-keyword?', 'directive-keyword?')), (_name, Name.Class, ('object-body', '_object-head'))], 'routine-name?': [include('_whitespace'), (_name, Name.Function, '#pop'), default('#pop')], 'locals': [include('_whitespace'), (';', Punctuation, '#pop'), ('\\*', Punctuation), ('"', String.Double, 'plain-string'), (_name, Name.Variable)], 'many-values': [include('_whitespace'), (';', Punctuation), ('\\]', Punctuation, '#pop'), (':', Error), default(('expression', '_expression'))], 'alias?': [include('_whitespace'), ('alias\\b', Keyword, ('#pop', '_constant')), default('#pop')], 'class-name': [include('_whitespace'), ('(?=[,;]|(class|has|private|with)\\b)', Text, '#pop'), (_name, Name.Class, '#pop')], 'duplicates': [include('_whitespace'), ('\\(', Punctuation, ('#pop', 'expression', '_expression')), default('#pop')], '_object-head': [('[%s]>' % _dash, Punctuation), ('(class|has|private|with)\\b', Keyword.Declaration, '#pop'), include('_global')], 'object-body': [include('_whitespace'), (';', Punctuation, '#pop:2'), (',', Punctuation), ('class\\b', Keyword.Declaration, 'class-segment'), ('(has|private|with)\\b', Keyword.Declaration), (':', Error), default(('_object-expression', '_expression'))], 'class-segment': [include('_whitespace'), ('(?=[,;]|(class|has|private|with)\\b)', Text, '#pop'), (_name, Name.Class), default('value')], 'grammar': [include('_whitespace'), ('=', Punctuation, ('#pop', 'default')), ('\\*', Punctuation, ('#pop', 'grammar-line')), default('_directive-keyword')], 'grammar-line': [include('_whitespace'), (';', Punctuation, '#pop'), ('[/*]', Punctuation), ('[%s]>' % _dash, Punctuation, 'value'), ('(noun|scope)\\b', Keyword, '=routine'), default('_directive-keyword')], '=routine': [include('_whitespace'), ('=', Punctuation, 'routine-name?'), default('#pop')], 'manifest': [include('_whitespace'), (';', Punctuation, '#pop'), (',', Punctuation), ('(?i)global\\b', Keyword, '_global'), default('_global')], 'diagnostic': [include('_whitespace'), ('[%s]' % _dquote, String.Double, ('#pop', 'message-string')), default(('#pop', 'before-plain-string', 'directive-keyword?'))], 'before-plain-string': [include('_whitespace'), ('[%s]' % _dquote, String.Double, ('#pop', 'plain-string'))], 'message-string': [('[~^]+', String.Escape), include('plain-string')], '_directive-keyword!': [include('_whitespace'), (words(('additive', 'alias', 'buffer', 'class', 'creature', 'data', 'error', 'fatalerror', 'first', 'has', 'held', 'initial', 'initstr', 'last', 'long', 'meta', 'multi', 'multiexcept', 'multiheld', 'multiinside', 'noun', 'number', 'only', 'private', 'replace', 'reverse', 'scope', 'score', 'special', 'string', 'table', 'terminating', 'time', 'topic', 'warning', 'with'), suffix='\\b'), Keyword, '#pop'), ('[%s]{1,2}>|[+=]' % _dash, Punctuation, '#pop')], '_directive-keyword': [include('_directive-keyword!'), include('value')], 'directive-keyword?': [include('_directive-keyword!'), default('#pop')], 'property-keyword*': [include('_whitespace'), ('(additive|long)\\b', Keyword), default('#pop')], 'trace-keyword?': [include('_whitespace'), (words(('assembly', 'dictionary', 'expressions', 'lines', 'linker', 'objects', 'off', 'on', 'symbols', 'tokens', 'verbs'), suffix='\\b'), Keyword, '#pop'), default('#pop')], 'statements': [include('_whitespace'), ('\\]', Punctuation, '#pop'), ('[;{}]', Punctuation), (words(('box', 'break', 'continue', 'default', 'give', 'inversion', 'new_line', 'quit', 'read', 'remove', 'return', 'rfalse', 'rtrue', 'spaces', 'string', 'until'), suffix='\\b'), Keyword, 'default'), ('(do|else)\\b', Keyword), ('(font|style)\\b', Keyword, ('default', 'miscellaneous-keyword?')), ('for\\b', Keyword, ('for', '(?')), ('(if|switch|while)', Keyword, ('expression', '_expression', '(?')), ('(jump|save|restore)\\b', Keyword, ('default', 'label?')), ('objectloop\\b', Keyword, ('_keyword-expression', 'variable?', '(?')), ('print(_ret)?\\b|(?=[%s])' % _dquote, Keyword, 'print-list'), ('\\.', Name.Label, 'label?'), ('@', Keyword, 'opcode'), ('#(?![agrnw]\\$|#)', Punctuation, 'directive'), ('<', Punctuation, 'default'), ('move\\b', Keyword, ('default', '_keyword-expression', '_expression')), default(('default', '_keyword-expression', '_expression'))], 'miscellaneous-keyword?': [include('_whitespace'), ('(bold|fixed|from|near|off|on|reverse|roman|to|underline)\\b', Keyword, '#pop'), ('(a|A|an|address|char|name|number|object|property|string|the|The)\\b(?=(\\s+|(![^%s]*))*\\))' % _newline, Keyword.Pseudo, '#pop'), ('%s(?=(\\s+|(![^%s]*))*\\))' % (_name, _newline), Name.Function, '#pop'), default('#pop')], '(?': [include('_whitespace'), ('\\(', Punctuation, '#pop'), default('#pop')], 'for': [include('_whitespace'), (';', Punctuation, ('_for-expression', '_expression')), default(('_for-expression', '_expression'))], 'print-list': [include('_whitespace'), (';', Punctuation, '#pop'), (':', Error), default(('_list-expression', '_expression', '_list-expression', 'form'))], 'form': [include('_whitespace'), ('\\(', Punctuation, ('#pop', 'miscellaneous-keyword?')), default('#pop')], 'opcode': [include('_whitespace'), ('[%s]' % _dquote, String.Double, ('operands', 'plain-string')), (_name, Keyword, 'operands')], 'operands': [(':', Error), default(('_assembly-expression', '_expression'))]}

    def get_tokens_unprocessed(self, text):
        objectloop_queue = []
        objectloop_token_count = -1
        previous_token = None
        for index, token, value in RegexLexer.get_tokens_unprocessed(self, text):
            if previous_token is Name.Variable and value == 'in':
                objectloop_queue = [[index, token, value]]
                objectloop_token_count = 2
            elif objectloop_token_count > 0:
                if token not in Comment and token not in Text:
                    objectloop_token_count -= 1
                objectloop_queue.append((index, token, value))
            else:
                if objectloop_token_count == 0:
                    if objectloop_queue[-1][2] == ')':
                        objectloop_queue[0][1] = Keyword
                    while objectloop_queue:
                        yield objectloop_queue.pop(0)
                    objectloop_token_count = -1
                yield (index, token, value)
            if token not in Comment and token not in Text:
                previous_token = token
        while objectloop_queue:
            yield objectloop_queue.pop(0)