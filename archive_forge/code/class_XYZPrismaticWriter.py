import numpy as np
from ase.atoms import Atoms, symbols2numbers
from ase.utils import reader
from .utils import verify_cell_for_export, verify_dictionary
class XYZPrismaticWriter:
    """ See the docstring of the `write_prismatic` function.
    """

    def __init__(self, atoms, debye_waller_factors=None, comments=None):
        verify_cell_for_export(atoms.get_cell())
        self.atoms = atoms.copy()
        self.atom_types = set(atoms.symbols)
        self.comments = comments
        self.occupancies = self._get_occupancies()
        debye_waller_factors = self._get_debye_waller_factors(debye_waller_factors)
        self.RMS = np.sqrt(debye_waller_factors / (8 * np.pi ** 2))

    def _get_occupancies(self):
        if 'occupancies' in self.atoms.arrays:
            occupancies = self.atoms.get_array('occupancies', copy=False)
        else:
            occupancies = np.ones_like(self.atoms.numbers)
        return occupancies

    def _get_debye_waller_factors(self, DW):
        if np.isscalar(DW):
            if len(self.atom_types) > 1:
                raise ValueError('This cell contains more then one type of atoms and the Debye-Waller factor needs to be provided for each atom using a dictionary.')
            DW = np.ones_like(self.atoms.numbers) * DW
        elif isinstance(DW, dict):
            verify_dictionary(self.atoms, DW, 'DW')
            DW = {symbols2numbers(k)[0]: v for k, v in DW.items()}
            DW = np.vectorize(DW.get)(self.atoms.numbers)
        else:
            for name in ['DW', 'debye_waller_factors']:
                if name in self.atoms.arrays:
                    DW = self.atoms.get_array(name)
        if DW is None:
            raise ValueError('Missing Debye-Waller factors. It can be provided as a dictionary with symbols as key or can be set for each atom by using the `set_array("debye_waller_factors", values)` of the `Atoms` object.')
        return DW

    def _get_file_header(self):
        if self.comments is None:
            s = '{0} atoms with chemical formula: {1}.'.format(len(self.atoms), self.atoms.get_chemical_formula())
        else:
            s = self.comments
        s = s.strip()
        s += ' generated by the ase library.\n'
        s += '{} {} {}'.format(*self.atoms.cell.cellpar()[:3])
        return s

    def write_to_file(self, f):
        data_array = np.vstack((self.atoms.numbers, self.atoms.positions.T, self.occupancies, self.RMS)).T
        np.savetxt(fname=f, X=data_array, fmt='%.6g', header=self._get_file_header(), newline='\n', footer='-1', comments='')