import io
import operator
import tempfile
from unittest import mock
import uuid
from openstack.cloud import meta
from openstack import connection
from openstack import exceptions
from openstack.image.v1 import image as image_v1
from openstack.image.v2 import image
from openstack.tests import fakes
from openstack.tests.unit import base
def test_create_image_task(self):
    self.cloud.image_api_use_tasks = True
    endpoint = self.cloud.object_store.get_endpoint()
    task_id = str(uuid.uuid4())
    args = dict(id=task_id, status='success', type='import', result={'image_id': self.image_id})
    image_no_checksums = self.fake_image_dict.copy()
    del image_no_checksums['owner_specified.openstack.md5']
    del image_no_checksums['owner_specified.openstack.sha256']
    del image_no_checksums['owner_specified.openstack.object']
    self.register_uris([dict(method='GET', uri=self.get_mock_url('image', append=['images', self.image_name], base_url_append='v2'), status_code=404), dict(method='GET', uri=self.get_mock_url('image', append=['images'], base_url_append='v2', qs_elements=['name=' + self.image_name]), validate=dict(), json={'images': []}), dict(method='GET', uri=self.get_mock_url('image', append=['images'], base_url_append='v2', qs_elements=['os_hidden=True']), json={'images': []}), dict(method='HEAD', uri='{endpoint}/{container}'.format(endpoint=endpoint, container=self.container_name), status_code=404), dict(method='PUT', uri='{endpoint}/{container}'.format(endpoint=endpoint, container=self.container_name), status_code=201, headers={'Date': 'Fri, 16 Dec 2016 18:21:20 GMT', 'Content-Length': '0', 'Content-Type': 'text/html; charset=UTF-8'}), dict(method='HEAD', uri='{endpoint}/{container}'.format(endpoint=endpoint, container=self.container_name), headers={'Content-Length': '0', 'X-Container-Object-Count': '0', 'Accept-Ranges': 'bytes', 'X-Storage-Policy': 'Policy-0', 'Date': 'Fri, 16 Dec 2016 18:29:05 GMT', 'X-Timestamp': '1481912480.41664', 'X-Trans-Id': 'tx60ec128d9dbf44b9add68-0058543271dfw1', 'X-Container-Bytes-Used': '0', 'Content-Type': 'text/plain; charset=utf-8'}), dict(method='GET', uri='https://object-store.example.com/info', json=dict(swift={'max_file_size': 1000}, slo={'min_segment_size': 500})), dict(method='HEAD', uri='{endpoint}/{container}/{object}'.format(endpoint=endpoint, container=self.container_name, object=self.image_name), status_code=404), dict(method='PUT', uri='{endpoint}/{container}/{object}'.format(endpoint=endpoint, container=self.container_name, object=self.image_name), status_code=201, validate=dict(headers={'X-Object-Meta-x-sdk-md5': self.fake_image_dict['owner_specified.openstack.md5'], 'X-Object-Meta-x-sdk-sha256': self.fake_image_dict['owner_specified.openstack.sha256']})), dict(method='POST', uri=self.get_mock_url('image', append=['tasks'], base_url_append='v2'), json={'id': task_id, 'status': 'processing'}, validate=dict(json=dict(type='import', input={'import_from': '{container}/{object}'.format(container=self.container_name, object=self.image_name), 'image_properties': {'name': self.image_name}}))), dict(method='GET', uri=self.get_mock_url('image', append=['tasks', task_id], base_url_append='v2'), status_code=503, text='Random error'), dict(method='GET', uri=self.get_mock_url('image', append=['tasks', task_id], base_url_append='v2'), json=args), dict(method='GET', uri=self.get_mock_url('image', append=['images', self.image_id], base_url_append='v2'), json=image_no_checksums), dict(method='PATCH', uri=self.get_mock_url('image', append=['images', self.image_id], base_url_append='v2'), validate=dict(json=sorted([{'op': 'add', 'value': '{container}/{object}'.format(container=self.container_name, object=self.image_name), 'path': '/owner_specified.openstack.object'}, {'op': 'add', 'value': self.fake_image_dict['owner_specified.openstack.md5'], 'path': '/owner_specified.openstack.md5'}, {'op': 'add', 'value': self.fake_image_dict['owner_specified.openstack.sha256'], 'path': '/owner_specified.openstack.sha256'}], key=operator.itemgetter('path')), headers={'Content-Type': 'application/openstack-images-v2.1-json-patch'}), json=self.fake_search_return), dict(method='HEAD', uri='{endpoint}/{container}/{object}'.format(endpoint=endpoint, container=self.container_name, object=self.image_name), headers={'X-Timestamp': '1429036140.50253', 'X-Trans-Id': 'txbbb825960a3243b49a36f-005a0dadaedfw1', 'Content-Length': '1290170880', 'Last-Modified': 'Tue, 14 Apr 2015 18:29:01 GMT', 'X-Object-Meta-X-Sdk-Sha256': self.fake_image_dict['owner_specified.openstack.sha256'], 'X-Object-Meta-X-Sdk-Md5': self.fake_image_dict['owner_specified.openstack.md5'], 'Date': 'Thu, 16 Nov 2017 15:24:30 GMT', 'Accept-Ranges': 'bytes', 'Content-Type': 'application/octet-stream', 'Etag': fakes.NO_MD5}), dict(method='DELETE', uri='{endpoint}/{container}/{object}'.format(endpoint=endpoint, container=self.container_name, object=self.image_name)), dict(method='GET', uri=self.get_mock_url('image', append=['images'], base_url_append='v2'), complete_qs=True, json=self.fake_search_return)])
    self.cloud.create_image(self.image_name, self.imagefile.name, wait=True, timeout=1, disk_format='vhd', container_format='ovf', is_public=False, validate_checksum=True, container=self.container_name)
    self.assert_calls()