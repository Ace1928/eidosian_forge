from __future__ import absolute_import
from __future__ import division
from __future__ import unicode_literals
import collections
import copy
import datetime
import io
import os.path
import shutil
import tarfile
import uuid
from apitools.base.py import exceptions as apitools_exceptions
from googlecloudsdk.api_lib.cloudbuild import snapshot
from googlecloudsdk.api_lib.clouddeploy import client_util
from googlecloudsdk.api_lib.clouddeploy import delivery_pipeline
from googlecloudsdk.api_lib.storage import storage_api
from googlecloudsdk.calliope import base
from googlecloudsdk.calliope import exceptions as c_exceptions
from googlecloudsdk.command_lib.code.cloud import cloudrun
from googlecloudsdk.command_lib.deploy import deploy_util
from googlecloudsdk.command_lib.deploy import exceptions
from googlecloudsdk.command_lib.deploy import rollout_util
from googlecloudsdk.command_lib.deploy import staging_bucket_util
from googlecloudsdk.command_lib.deploy import target_util
from googlecloudsdk.core import exceptions as core_exceptions
from googlecloudsdk.core import log
from googlecloudsdk.core import resources
from googlecloudsdk.core import yaml
from googlecloudsdk.core.resource import resource_projector
from googlecloudsdk.core.resource import resource_transform
from googlecloudsdk.core.resource import yaml_printer
from googlecloudsdk.core.util import files
from googlecloudsdk.core.util import times
import six
def _UploadTarballGeneratedSkaffoldAndManifest(kubernetes_manifest, cloud_run_manifest, from_run_container, services, gcs_client, gcs_source_staging, ignore_file, hide_logs, release_config, pipeline_obj):
    """Generates a Skaffold file and uploads the file and k8 manifest to GCS.

  Args:
    kubernetes_manifest: path to kubernetes manifest (e.g. /home/user/k8.yaml).
      If provided, a Skaffold file will be generated and uploaded to GCS on
      behalf of the customer.
    cloud_run_manifest: path to Cloud Run manifest (e.g.
      /home/user/service.yaml). If provided, a Skaffold file will be generated
      and uploaded to GCS on behalf of the customer.
    from_run_container: the container image to be used. The Cloud Run manifest
      and Skaffold file will be generated and uploaded to GCS
      on behalf of the customer.
    services: the map from target_id to service_name in case from_run_container
      is used.
    gcs_client: client for Google Cloud Storage API.
    gcs_source_staging: directory in google cloud storage to use for staging
    ignore_file: the ignore file to use
    hide_logs: whether to show logs, defaults to False
    release_config: a Release message
    pipeline_obj: the pipeline_obj used for this release.
  """
    with files.TemporaryDirectory() as temp_dir:
        skaffold_template = ''
        if from_run_container:
            skaffold, target_to_target_properties = _GetCloudRunManifestSkaffold(from_run_container, services, pipeline_obj)
            for target_id in target_to_target_properties:
                manifest_path = os.path.join(temp_dir, '{}_manifest.yaml'.format(target_id))
                with files.FileWriter(manifest_path) as f:
                    f.write('# Auto-generated by Google Cloud Deploy\n')
                    f.write(target_to_target_properties[target_id].manifest)
            skaffold_path = os.path.join(temp_dir, GENERATED_SKAFFOLD)
            with files.FileWriter(skaffold_path) as f:
                yaml.dump(skaffold, f, round_trip=True)
        else:
            manifest = ''
            if kubernetes_manifest:
                manifest = kubernetes_manifest
                skaffold_template = GKE_GENERATED_SKAFFOLD_TEMPLATE
            elif cloud_run_manifest:
                manifest = cloud_run_manifest
                skaffold_template = CLOUD_RUN_GENERATED_SKAFFOLD_TEMPLATE
            if not os.path.exists(manifest):
                raise c_exceptions.BadFileException('could not find manifest file [{src}]'.format(src=manifest))
            manifest_file_name = os.path.basename(manifest)
            shutil.copy(manifest, temp_dir)
            skaffold_yaml = yaml.load(skaffold_template.format(manifest_file_name), round_trip=True)
            skaffold_path = os.path.join(temp_dir, GENERATED_SKAFFOLD)
            with files.FileWriter(skaffold_path) as f:
                f.write('# Auto-generated by Google Cloud Deploy\n')
                yaml.dump(skaffold_yaml, f, round_trip=True)
        _CreateAndUploadTarball(gcs_client, gcs_source_staging, temp_dir, ignore_file, hide_logs, release_config, True)