from __future__ import absolute_import
from __future__ import division
from __future__ import unicode_literals
import collections
import re
from googlecloudsdk.api_lib.containeranalysis import filter_util
from googlecloudsdk.api_lib.containeranalysis import requests as ca_requests
from googlecloudsdk.api_lib.services import enable_api
import six
class PackageVulnerabilitySummary:
    """PackageVulnerabilitySummary holds package vulnerability information."""

    def __init__(self):
        self.vulnerabilities = {}
        self.counts = []

    def AddOccurrence(self, occ):
        sev = six.text_type(occ.vulnerability.effectiveSeverity)
        self.vulnerabilities.setdefault(sev, []).append(occ)

    def AddSummary(self, summary):
        self.counts += summary.counts

    def AddCount(self, count):
        self.counts.append(count)

    def ArtifactsDescribeView(self):
        """Returns a dictionary representing package vulnerability metadata.

    The returned dictionary is used by artifacts docker images describe command.
    """
        messages = ca_requests.GetMessages()
        view = {}
        if self.vulnerabilities:
            view['vulnerabilities'] = self.vulnerabilities
        for count in self.counts:
            if count.severity == messages.FixableTotalByDigest.SeverityValueValuesEnum.SEVERITY_UNSPECIFIED:
                view['not_fixed_vulnerability_count'] = count.totalCount - count.fixableCount
                view['total_vulnerability_count'] = count.totalCount
                break
        return view

    def ImagesListView(self):
        """Returns a dictionary representing package vulnerability metadata.

    The returned dictionary is used by artifacts docker images list command.
    """
        messages = ca_requests.GetMessages()
        view = {}
        if self.vulnerabilities:
            view['PACKAGE_VULNERABILITY'] = self.vulnerabilities
        vuln_counts = {}
        for count in self.counts:
            sev = count.severity
            if sev and sev != messages.FixableTotalByDigest.SeverityValueValuesEnum.SEVERITY_UNSPECIFIED:
                vuln_counts.update({sev: vuln_counts.get(sev, 0) + count.totalCount})
        if vuln_counts:
            view['vuln_counts'] = vuln_counts
        return view