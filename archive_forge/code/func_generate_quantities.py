import os
import platform
import re
import shutil
import subprocess
import sys
import tempfile
import threading
from collections import OrderedDict
from concurrent.futures import ThreadPoolExecutor
from io import StringIO
from multiprocessing import cpu_count
from typing import (
import pandas as pd
from tqdm.auto import tqdm
from cmdstanpy import (
from cmdstanpy.cmdstan_args import (
from cmdstanpy.stanfit import (
from cmdstanpy.utils import (
from cmdstanpy.utils.filesystem import temp_inits, temp_single_json
from . import progress as progbar
def generate_quantities(self, data: Union[Mapping[str, Any], str, os.PathLike, None]=None, previous_fit: Union[Fit, List[str], None]=None, seed: Optional[int]=None, gq_output_dir: OptionalPath=None, sig_figs: Optional[int]=None, show_console: bool=False, refresh: Optional[int]=None, time_fmt: str='%Y%m%d%H%M%S', timeout: Optional[float]=None, *, mcmc_sample: Union[CmdStanMCMC, List[str], None]=None) -> CmdStanGQ[Fit]:
    """
        Run CmdStan's generate_quantities method which runs the generated
        quantities block of a model given an existing sample.

        This function takes one of the Stan fit objects
        :class:`CmdStanMCMC`, :class:`CmdStanMLE`, or :class:`CmdStanVB`
        and the data required for the model and calls to the CmdStan
        ``generate_quantities`` method to generate additional quantities of
        interest.

        The :class:`CmdStanGQ` object records the command, the return code,
        and the paths to the generate method output CSV and console files.
        The output files are written either to a specified output directory
        or to a temporary directory which is deleted upon session exit.

        Output files are either written to a temporary directory or to the
        specified output directory.  Output filenames correspond to the template
        '<model_name>-<YYYYMMDDHHMM>-<chain_id>' plus the file suffix which is
        either '.csv' for the CmdStan output or '.txt' for
        the console messages, e.g. 'bernoulli-201912081451-1.csv'.
        Output files written to the temporary directory contain an additional
        8-character random string, e.g. 'bernoulli-201912081451-1-5nm6as7u.csv'.

        :param data: Values for all data variables in the model, specified
            either as a dictionary with entries matching the data variables,
            or as the path of a data file in JSON or Rdump format.

        :param previous_fit: Can be either a :class:`CmdStanMCMC`,
            :class:`CmdStanMLE`, or :class:`CmdStanVB` or a list of
            stan-csv files generated by fitting the model to the data
            using any Stan interface.

        :param seed: The seed for random number generator. Must be an integer
            between 0 and 2^32 - 1. If unspecified,
            :func:`numpy.random.default_rng`
            is used to generate a seed which will be used for all chains.
            *NOTE: Specifying the seed will guarantee the same result for
            multiple invocations of this method with the same inputs.  However
            this will not reproduce results from the sample method given
            the same inputs because the RNG will be in a different state.*

        :param gq_output_dir:  Name of the directory in which the CmdStan output
            files are saved.  If unspecified, files will be written to a
            temporary directory which is deleted upon session exit.

        :param sig_figs: Numerical precision used for output CSV and text files.
            Must be an integer between 1 and 18.  If unspecified, the default
            precision for the system file I/O is used; the usual value is 6.
            Introduced in CmdStan-2.25.

        :param show_console: If ``True``, stream CmdStan messages sent to
            stdout and stderr to the console.  Default is ``False``.

        :param refresh: Specify the number of iterations CmdStan will take
            between progress messages. Default value is 100.

        :param time_fmt: A format string passed to
            :meth:`~datetime.datetime.strftime` to decide the file names for
            output CSVs. Defaults to "%Y%m%d%H%M%S"

        :param timeout: Duration at which generation times out in seconds.

        :return: CmdStanGQ object
        """
    if mcmc_sample is not None:
        if previous_fit:
            raise ValueError("Cannot supply both 'previous_fit' and deprecated argument 'mcmc_sample'")
        get_logger().warning('Argument name `mcmc_sample` is deprecated, please rename to `previous_fit`.')
        previous_fit = mcmc_sample
    if isinstance(previous_fit, (CmdStanMCMC, CmdStanMLE, CmdStanVB)):
        fit_object = previous_fit
        fit_csv_files = previous_fit.runset.csv_files
    elif isinstance(previous_fit, list):
        if len(previous_fit) < 1:
            raise ValueError('Expecting list of Stan CSV files, found empty list')
        try:
            fit_csv_files = previous_fit
            fit_object = from_csv(fit_csv_files)
        except ValueError as e:
            raise ValueError('Invalid sample from Stan CSV files, error:\n\t{}\n\t while processing files\n\t{}'.format(repr(e), '\n\t'.join(previous_fit))) from e
    else:
        raise ValueError('Previous fit must be either CmdStanPy fit object or list of paths to Stan CSV files.')
    if isinstance(fit_object, CmdStanMCMC):
        chains = fit_object.chains
        chain_ids = fit_object.chain_ids
        if fit_object._save_warmup:
            get_logger().warning('Sample contains saved warmup draws which will be used to generate additional quantities of interest.')
    elif isinstance(fit_object, CmdStanMLE):
        if cmdstan_version_before(2, 31):
            raise RuntimeError('Method generate_quantities was not available for non-HMC until CmdStan 2.31')
        chains = 1
        chain_ids = [1]
        if fit_object._save_iterations:
            get_logger().warning('MLE contains saved iterations which will be used to generate additional quantities of interest.')
    else:
        if cmdstan_version_before(2, 31):
            raise RuntimeError('Method generate_quantities was not available for non-HMC until CmdStan 2.31')
        chains = 1
        chain_ids = [1]
    generate_quantities_args = GenerateQuantitiesArgs(csv_files=fit_csv_files)
    generate_quantities_args.validate(chains)
    with temp_single_json(data) as _data:
        args = CmdStanArgs(self._name, self._exe_file, chain_ids=chain_ids, data=_data, seed=seed, output_dir=gq_output_dir, sig_figs=sig_figs, method_args=generate_quantities_args, refresh=refresh)
        runset = RunSet(args=args, chains=chains, chain_ids=chain_ids, time_fmt=time_fmt)
        parallel_chains_avail = cpu_count()
        parallel_chains = max(min(parallel_chains_avail - 2, chains), 1)
        with ThreadPoolExecutor(max_workers=parallel_chains) as executor:
            for i in range(chains):
                executor.submit(self._run_cmdstan, runset, i, show_console=show_console, timeout=timeout)
        runset.raise_for_timeouts()
        errors = runset.get_err_msgs()
        if errors:
            msg = f'Error during generate_quantities:\n{errors}\nCommand and output files:\n{repr(runset)}'
            if not show_console:
                msg += '\nConsider re-running with show_console=True if the above output is unclear!'
            raise RuntimeError(msg)
        quantities = CmdStanGQ(runset=runset, previous_fit=fit_object)
    return quantities