import warnings
from scipy._lib import _pep440
import numpy as np
from numpy.testing import (assert_array_almost_equal,
import pytest
from pytest import raises as assert_raises
from numpy import array, spacing, sin, pi, sort, sqrt
from scipy.signal import (argrelextrema, BadCoefficients, bessel, besselap, bilinear,
from scipy.signal._filter_design import (_cplxreal, _cplxpair, _norm_factor,
class TestButter:

    def test_degenerate(self):
        b, a = butter(0, 1, analog=True)
        assert_array_equal(b, [1])
        assert_array_equal(a, [1])
        b, a = butter(1, 1, analog=True)
        assert_array_almost_equal(b, [1])
        assert_array_almost_equal(a, [1, 1])
        z, p, k = butter(1, 0.3, output='zpk')
        assert_array_equal(z, [-1])
        assert_allclose(p, [0.3249196962329063], rtol=1e-14)
        assert_allclose(k, 0.3375401518835469, rtol=1e-14)

    def test_basic(self):
        for N in range(25):
            wn = 0.01
            z, p, k = butter(N, wn, 'low', analog=True, output='zpk')
            assert_array_almost_equal([], z)
            assert_(len(p) == N)
            assert_array_almost_equal(wn, abs(p))
            assert_(all(np.real(p) <= 0))
            assert_array_almost_equal(wn ** N, k)
        for N in range(25):
            wn = 0.01
            z, p, k = butter(N, wn, 'high', analog=False, output='zpk')
            assert_array_equal(np.ones(N), z)
            assert_(all(np.abs(p) <= 1))
        b1, a1 = butter(2, 1, analog=True)
        assert_array_almost_equal(b1, [1])
        assert_array_almost_equal(a1, [1, np.sqrt(2), 1])
        b2, a2 = butter(5, 1, analog=True)
        assert_array_almost_equal(b2, [1])
        assert_array_almost_equal(a2, [1, 3.2361, 5.2361, 5.2361, 3.2361, 1], decimal=4)
        b3, a3 = butter(10, 1, analog=True)
        assert_array_almost_equal(b3, [1])
        assert_array_almost_equal(a3, [1, 6.3925, 20.4317, 42.8021, 64.8824, 74.2334, 64.8824, 42.8021, 20.4317, 6.3925, 1], decimal=4)
        b2, a2 = butter(19, 1.0441379169150726, analog=True)
        assert_array_almost_equal(b2, [2.272], decimal=4)
        assert_array_almost_equal(a2, 10000.0 * np.array([0.0001, 0.0013, 0.008, 0.0335, 0.1045, 0.257, 0.5164, 0.8669, 1.2338, 1.501, 1.5672, 1.4044, 1.0759, 0.6986, 0.3791, 0.1681, 0.0588, 0.0153, 0.0026, 0.0002]), decimal=0)
        b, a = butter(5, 0.4)
        assert_array_almost_equal(b, [0.0219, 0.1097, 0.2194, 0.2194, 0.1097, 0.0219], decimal=4)
        assert_array_almost_equal(a, [1.0, -0.9853, 0.9738, -0.3864, 0.1112, -0.0113], decimal=4)

    def test_highpass(self):
        z, p, k = butter(28, 0.43, 'high', output='zpk')
        z2 = np.ones(28)
        p2 = [0.2068257195514592 + 0.9238294351481734j, 0.2068257195514592 - 0.9238294351481734j, 0.1874933103892023 + 0.8269455076775277j, 0.1874933103892023 - 0.8269455076775277j, 0.1717435567330153 + 0.7383078571194629j, 0.1717435567330153 - 0.7383078571194629j, 0.1588266870755982 + 0.6564623730651094j, 0.1588266870755982 - 0.6564623730651094j, 0.1481881532502603 + 0.5802343458081779j, 0.1481881532502603 - 0.5802343458081779j, 0.1394122576319697 + 0.5086609000582009j, 0.1394122576319697 - 0.5086609000582009j, 0.1321840881809715 + 0.4409411734716436j, 0.1321840881809715 - 0.4409411734716436j, 0.1262633413354405 + 0.3763990035551881j, 0.1262633413354405 - 0.3763990035551881j, 0.1214660449478046 + 0.3144545234797277j, 0.1214660449478046 - 0.3144545234797277j, 0.110486876665032 + 0.02771505404367791j, 0.110486876665032 - 0.02771505404367791j, 0.1111768629525075 + 0.08331369153155753j, 0.1111768629525075 - 0.08331369153155753j, 0.1125740630842972 + 0.1394219509611784j, 0.1125740630842972 - 0.1394219509611784j, 0.1147138487992747 + 0.1963932363793666j, 0.1147138487992747 - 0.1963932363793666j, 0.1176516491045901 + 0.2546021573417188j, 0.1176516491045901 - 0.2546021573417188j]
        k2 = 1.446671081817286e-06
        assert_array_equal(z, z2)
        assert_allclose(sorted(p, key=np.imag), sorted(p2, key=np.imag), rtol=1e-07)
        assert_allclose(k, k2, rtol=1e-10)
        z, p, k = butter(27, 0.56, 'high', output='zpk')
        z2 = np.ones(27)
        p2 = [-0.1772572785680147 + 0.9276431102995948j, -0.1772572785680147 - 0.9276431102995948j, -0.1600766565322114 + 0.8264026279893268j, -0.1600766565322114 - 0.8264026279893268j, -0.1461948419016121 + 0.7341841939120078j, -0.1461948419016121 - 0.7341841939120078j, -0.1348975284762046 + 0.6493235066053785j, -0.1348975284762046 - 0.6493235066053785j, -0.1256628210712206 + 0.5704921366889227j, -0.1256628210712206 - 0.5704921366889227j, -0.1181038235962314 + 0.496612055123163j, -0.1181038235962314 - 0.496612055123163j, -0.1119304913239356 + 0.4267938916403775j, -0.1119304913239356 - 0.4267938916403775j, -0.1069237739782691 + 0.3602914879527338j, -0.1069237739782691 - 0.3602914879527338j, -0.1029178030691416 + 0.2964677964142126j, -0.1029178030691416 - 0.2964677964142126j, -0.099787475008161 + 0.2347687643085738j, -0.099787475008161 - 0.2347687643085738j, -0.09743974496324025 + 0.1747028739092479j, -0.09743974496324025 - 0.1747028739092479j, -0.09580754551625957 + 0.1158246860771989j, -0.09580754551625957 - 0.1158246860771989j, -0.09484562207782568 + 0.05772118357151691j, -0.09484562207782568 - 0.05772118357151691j, -0.09452783117928215]
        k2 = 9.58568668885107e-09
        assert_array_equal(z, z2)
        assert_allclose(sorted(p, key=np.imag), sorted(p2, key=np.imag), rtol=1e-08)
        assert_allclose(k, k2)

    def test_bandpass(self):
        z, p, k = butter(8, [0.25, 0.33], 'band', output='zpk')
        z2 = [1, 1, 1, 1, 1, 1, 1, 1, -1, -1, -1, -1, -1, -1, -1, -1]
        p2 = [0.4979909925436156 + 0.8367609424799387j, 0.4979909925436156 - 0.8367609424799387j, 0.4913338722555539 + 0.7866774509868817j, 0.4913338722555539 - 0.7866774509868817j, 0.5035229361778706 + 0.740114737672675j, 0.5035229361778706 - 0.740114737672675j, 0.5307617160406101 + 0.7029184459442954j, 0.5307617160406101 - 0.7029184459442954j, 0.5680556159453138 + 0.6788228792952775j, 0.5680556159453138 - 0.6788228792952775j, 0.6100962560818854 + 0.6693849403338664j, 0.6100962560818854 - 0.6693849403338664j, 0.6904694312740631 + 0.6930501690145245j, 0.6904694312740631 - 0.6930501690145245j, 0.6521767004237027 + 0.6744414640183752j, 0.6521767004237027 - 0.6744414640183752j]
        k2 = 3.398854055800844e-08
        assert_array_equal(z, z2)
        assert_allclose(sorted(p, key=np.imag), sorted(p2, key=np.imag), rtol=1e-13)
        assert_allclose(k, k2, rtol=1e-13)
        z, p, k = butter(4, [90.5, 110.5], 'bp', analog=True, output='zpk')
        z2 = np.zeros(4)
        p2 = [-4.179137760733086 + 109.5935899082837j, -4.179137760733086 - 109.5935899082837j, -9.593598668443835 + 103.4745398029734j, -9.593598668443835 - 103.4745398029734j, -8.883991981781929 + 95.8208711556716j, -8.883991981781929 - 95.8208711556716j, -3.474530886568715 + 91.11599925805801j, -3.474530886568715 - 91.11599925805801j]
        k2 = 160000.0000000001
        assert_array_equal(z, z2)
        assert_allclose(sorted(p, key=np.imag), sorted(p2, key=np.imag))
        assert_allclose(k, k2, rtol=1e-15)

    def test_bandstop(self):
        z, p, k = butter(7, [0.45, 0.56], 'stop', output='zpk')
        z2 = [-0.01594474531383421 + 0.999872874467988j, -0.01594474531383421 - 0.999872874467988j, -0.01594474531383421 + 0.999872874467988j, -0.01594474531383421 - 0.999872874467988j, -0.01594474531383421 + 0.999872874467988j, -0.01594474531383421 - 0.999872874467988j, -0.01594474531383421 + 0.999872874467988j, -0.01594474531383421 - 0.999872874467988j, -0.01594474531383421 + 0.999872874467988j, -0.01594474531383421 - 0.999872874467988j, -0.01594474531383421 + 0.999872874467988j, -0.01594474531383421 - 0.999872874467988j, -0.01594474531383421 + 0.999872874467988j, -0.01594474531383421 - 0.999872874467988j]
        p2 = [-0.1766850742887729 + 0.94669512586739j, -0.1766850742887729 - 0.94669512586739j, 0.1467897662432886 + 0.9515917126462422j, 0.1467897662432886 - 0.9515917126462422j, -0.1370083529426906 + 0.8880376681273993j, -0.1370083529426906 - 0.8880376681273993j, 0.108677454470139 + 0.8915240810704319j, 0.108677454470139 - 0.8915240810704319j, -0.07982704457700891 + 0.8506056315273435j, -0.07982704457700891 - 0.8506056315273435j, 0.05238812787110331 + 0.8524011102699969j, 0.05238812787110331 - 0.8524011102699969j, -0.0135754500049131 + 0.8382287744986582j, -0.0135754500049131 - 0.8382287744986582j]
        k2 = 0.4577122512960063
        assert_allclose(sorted(z, key=np.imag), sorted(z2, key=np.imag))
        assert_allclose(sorted(p, key=np.imag), sorted(p2, key=np.imag))
        assert_allclose(k, k2, rtol=1e-14)

    def test_ba_output(self):
        b, a = butter(4, [100, 300], 'bandpass', analog=True)
        b2 = [1600000000.0, 0, 0, 0, 0]
        a2 = [1.0, 522.6251859505511, 256568.5424949238, 67941274.1735716, 15194112549.69542, 2038238225207.147, 230911688245431.2, 1.411088002066486e+16, 8.099999999999991e+17]
        assert_allclose(b, b2, rtol=1e-14)
        assert_allclose(a, a2, rtol=1e-14)

    def test_fs_param(self):
        for fs in (900, 900.1, 1234.567):
            for N in (0, 1, 2, 3, 10):
                for fc in (100, 100.1, 432.12345):
                    for btype in ('lp', 'hp'):
                        ba1 = butter(N, fc, btype, fs=fs)
                        ba2 = butter(N, fc / (fs / 2), btype)
                        assert_allclose(ba1, ba2)
                for fc in ((100, 200), (100.1, 200.2), (321.123, 432.123)):
                    for btype in ('bp', 'bs'):
                        ba1 = butter(N, fc, btype, fs=fs)
                        for seq in (list, tuple, array):
                            fcnorm = seq([f / (fs / 2) for f in fc])
                            ba2 = butter(N, fcnorm, btype)
                            assert_allclose(ba1, ba2)