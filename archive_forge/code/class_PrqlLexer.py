from pygments.lexer import RegexLexer, combined, words, include, bygroups
from pygments.token import Comment, Literal, Keyword, Name, Number, Operator, \
class PrqlLexer(RegexLexer):
    """
    For PRQL source code.

    .. versionadded:: 2.17

    grammar: https://github.com/PRQL/prql/tree/main/grammars
    """
    name = 'PRQL'
    url = 'https://prql-lang.org/'
    aliases = ['prql']
    filenames = ['*.prql']
    mimetypes = ['application/prql', 'application/x-prql']
    builtinTypes = words(('bool', 'int', 'int8', 'int16', 'int32', 'int64', 'int128', 'float', 'text', 'set'), suffix='\\b')

    def innerstring_rules(ttype):
        return [('\\{((\\w+)((\\.\\w+)|(\\[[^\\]]+\\]))*)?(\\:(.?[<>=\\^])?[-+ ]?#?0?(\\d+)?,?(\\.\\d+)?[E-GXb-gnosx%]?)?\\}', String.Interpol), ('[^\\\\\\\'"%{\\n]+', ttype), ('[\\\'"\\\\]', ttype), ('%|(\\{{1,2})', ttype)]

    def fstring_rules(ttype):
        return [('\\}', String.Interpol), ('\\{', String.Interpol, 'expr-inside-fstring'), ('[^\\\\\\\'"{}\\n]+', ttype), ('[\\\'"\\\\]', ttype)]
    tokens = {'root': [('#!.*', String.Doc), ('#.*', Comment.Single), ('\\s+', Whitespace), ('^(\\s*)(module)(\\s*)', bygroups(Whitespace, Keyword.Namespace, Whitespace), 'imports'), (builtinTypes, Keyword.Type), ('^prql ', Keyword.Reserved), ('let', Keyword.Declaration), include('keywords'), include('expr'), ('^[A-Za-z_][a-zA-Z0-9_]*', Keyword)], 'expr': [('(f)(""")', bygroups(String.Affix, String.Double), combined('fstringescape', 'tdqf')), ("(f)(''')", bygroups(String.Affix, String.Single), combined('fstringescape', 'tsqf')), ('(f)(")', bygroups(String.Affix, String.Double), combined('fstringescape', 'dqf')), ("(f)(')", bygroups(String.Affix, String.Single), combined('fstringescape', 'sqf')), ('(s)(""")', bygroups(String.Affix, String.Double), combined('stringescape', 'tdqf')), ("(s)(''')", bygroups(String.Affix, String.Single), combined('stringescape', 'tsqf')), ('(s)(")', bygroups(String.Affix, String.Double), combined('stringescape', 'dqf')), ("(s)(')", bygroups(String.Affix, String.Single), combined('stringescape', 'sqf')), ('(?i)(r)(""")', bygroups(String.Affix, String.Double), 'tdqs'), ("(?i)(r)(''')", bygroups(String.Affix, String.Single), 'tsqs'), ('(?i)(r)(")', bygroups(String.Affix, String.Double), 'dqs'), ("(?i)(r)(')", bygroups(String.Affix, String.Single), 'sqs'), ('"""', String.Double, combined('stringescape', 'tdqs')), ("'''", String.Single, combined('stringescape', 'tsqs')), ('"', String.Double, combined('stringescape', 'dqs')), ("'", String.Single, combined('stringescape', 'sqs')), ('@\\d{4}-\\d{2}-\\d{2}T\\d{2}(:\\d{2})?(:\\d{2})?(\\.\\d{1,6})?(Z|[+-]\\d{1,2}(:\\d{1,2})?)?', Literal.Date), ('@\\d{4}-\\d{2}-\\d{2}', Literal.Date), ('@\\d{2}(:\\d{2})?(:\\d{2})?(\\.\\d{1,6})?(Z|[+-]\\d{1,2}(:\\d{1,2})?)?', Literal.Date), ('[^\\S\\n]+', Text), include('numbers'), ('->|=>|==|!=|>=|<=|~=|&&|\\|\\||\\?\\?|\\/\\/', Operator), ('[-~+/*%=<>&^|.@]', Operator), ('[]{}:(),;[]', Punctuation), include('functions'), ('[A-Za-z_][a-zA-Z0-9_]*', Name.Variable)], 'numbers': [('(\\d(?:_?\\d)*\\.(?:\\d(?:_?\\d)*)?|(?:\\d(?:_?\\d)*)?\\.\\d(?:_?\\d)*)([eE][+-]?\\d(?:_?\\d)*)?', Number.Float), ('\\d(?:_?\\d)*[eE][+-]?\\d(?:_?\\d)*j?', Number.Float), ('0[oO](?:_?[0-7])+', Number.Oct), ('0[bB](?:_?[01])+', Number.Bin), ('0[xX](?:_?[a-fA-F0-9])+', Number.Hex), ('\\d(?:_?\\d)*', Number.Integer)], 'fstringescape': [include('stringescape')], 'bytesescape': [('\\\\([\\\\bfnrt"\\\']|\\n|x[a-fA-F0-9]{2}|[0-7]{1,3})', String.Escape)], 'stringescape': [('\\\\(N\\{.*?\\}|u\\{[a-fA-F0-9]{1,6}\\})', String.Escape), include('bytesescape')], 'fstrings-single': fstring_rules(String.Single), 'fstrings-double': fstring_rules(String.Double), 'strings-single': innerstring_rules(String.Single), 'strings-double': innerstring_rules(String.Double), 'dqf': [('"', String.Double, '#pop'), ('\\\\\\\\|\\\\"|\\\\\\n', String.Escape), include('fstrings-double')], 'sqf': [("'", String.Single, '#pop'), ("\\\\\\\\|\\\\'|\\\\\\n", String.Escape), include('fstrings-single')], 'dqs': [('"', String.Double, '#pop'), ('\\\\\\\\|\\\\"|\\\\\\n', String.Escape), include('strings-double')], 'sqs': [("'", String.Single, '#pop'), ("\\\\\\\\|\\\\'|\\\\\\n", String.Escape), include('strings-single')], 'tdqf': [('"""', String.Double, '#pop'), include('fstrings-double'), ('\\n', String.Double)], 'tsqf': [("'''", String.Single, '#pop'), include('fstrings-single'), ('\\n', String.Single)], 'tdqs': [('"""', String.Double, '#pop'), include('strings-double'), ('\\n', String.Double)], 'tsqs': [("'''", String.Single, '#pop'), include('strings-single'), ('\\n', String.Single)], 'expr-inside-fstring': [('[{([]', Punctuation, 'expr-inside-fstring-inner'), ('(=\\s*)?\\}', String.Interpol, '#pop'), ('(=\\s*)?:', String.Interpol, '#pop'), ('\\s+', Whitespace), include('expr')], 'expr-inside-fstring-inner': [('[{([]', Punctuation, 'expr-inside-fstring-inner'), ('[])}]', Punctuation, '#pop'), ('\\s+', Whitespace), include('expr')], 'keywords': [(words(('into', 'case', 'type', 'module', 'internal'), suffix='\\b'), Keyword), (words(('true', 'false', 'null'), suffix='\\b'), Keyword.Constant)], 'functions': [(words(('min', 'max', 'sum', 'average', 'stddev', 'every', 'any', 'concat_array', 'count', 'lag', 'lead', 'first', 'last', 'rank', 'rank_dense', 'row_number', 'round', 'as', 'in', 'tuple_every', 'tuple_map', 'tuple_zip', '_eq', '_is_null', 'from_text', 'lower', 'upper', 'read_parquet', 'read_csv'), suffix='\\b'), Name.Function)], 'comment': [('-(?!\\})', Comment.Multiline), ('\\{-', Comment.Multiline, 'comment'), ('[^-}]', Comment.Multiline), ('-\\}', Comment.Multiline, '#pop')], 'imports': [('\\w+(\\.\\w+)*', Name.Class, '#pop')]}