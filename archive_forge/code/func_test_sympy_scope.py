import numpy as np
import pytest
import sympy
from sympy.parsing import sympy_parser
import cirq
def test_sympy_scope():
    q = cirq.LineQubit(0)
    a, b, c, d = sympy.symbols('a b c d')
    inner = cirq.Circuit(cirq.measure(q, key='a'), cirq.X(q).with_classical_controls(a & b).with_classical_controls(c | d))
    middle = cirq.Circuit(cirq.measure(q, key='b'), cirq.measure(q, key=cirq.MeasurementKey('c', ('0',))), cirq.CircuitOperation(inner.freeze(), repetitions=2))
    outer_subcircuit = cirq.CircuitOperation(middle.freeze(), repetitions=2)
    circuit = outer_subcircuit.mapped_circuit(deep=True)
    internal_controls = [str(k) for op in circuit.all_operations() for k in cirq.control_keys(op)]
    assert set(internal_controls) == {'0:0:a', '0:1:a', '1:0:a', '1:1:a', '0:b', '1:b', 'c', 'd'}
    assert cirq.control_keys(outer_subcircuit) == {'c', 'd'}
    assert cirq.control_keys(circuit) == {'c', 'd'}
    assert circuit == cirq.Circuit(cirq.decompose(outer_subcircuit))
    cirq.testing.assert_has_diagram(cirq.Circuit(outer_subcircuit), "\n      [                      [ 0: ───M───X(conditions=[c | d, a & b])─── ]             ]\n      [                      [       ║   ║                               ]             ]\n      [                      [ a: ═══@═══^══════════════════════════════ ]             ]\n      [                      [           ║                               ]             ]\n      [ 0: ───M───M('0:c')───[ b: ═══════^══════════════════════════════ ]──────────── ]\n      [       ║              [           ║                               ]             ]\n      [       ║              [ c: ═══════^══════════════════════════════ ]             ]\n0: ───[       ║              [           ║                               ]             ]────────────\n      [       ║              [ d: ═══════^══════════════════════════════ ](loops=2)    ]\n      [       ║              ║                                                         ]\n      [ b: ═══@══════════════╬════════════════════════════════════════════════════════ ]\n      [                      ║                                                         ]\n      [ c: ══════════════════╬════════════════════════════════════════════════════════ ]\n      [                      ║                                                         ]\n      [ d: ══════════════════╩════════════════════════════════════════════════════════ ](loops=2)\n      ║\nc: ═══╬═════════════════════════════════════════════════════════════════════════════════════════════\n      ║\nd: ═══╩═════════════════════════════════════════════════════════════════════════════════════════════\n", use_unicode_characters=True)
    cirq.testing.assert_has_diagram(circuit, "\n0: ───────M───M('0:0:c')───M───X(conditions=[c | d, 0:0:a & 0:b])───M───X(conditions=[c | d, 0:1:a & 0:b])───M───M('1:0:c')───M───X(conditions=[c | d, 1:0:a & 1:b])───M───X(conditions=[c | d, 1:1:a & 1:b])───\n          ║                ║   ║                                    ║   ║                                    ║                ║   ║                                    ║   ║\n0:0:a: ═══╬════════════════@═══^════════════════════════════════════╬═══╬════════════════════════════════════╬════════════════╬═══╬════════════════════════════════════╬═══╬════════════════════════════════════\n          ║                    ║                                    ║   ║                                    ║                ║   ║                                    ║   ║\n0:1:a: ═══╬════════════════════╬════════════════════════════════════@═══^════════════════════════════════════╬════════════════╬═══╬════════════════════════════════════╬═══╬════════════════════════════════════\n          ║                    ║                                        ║                                    ║                ║   ║                                    ║   ║\n0:b: ═════@════════════════════^════════════════════════════════════════^════════════════════════════════════╬════════════════╬═══╬════════════════════════════════════╬═══╬════════════════════════════════════\n                               ║                                        ║                                    ║                ║   ║                                    ║   ║\n1:0:a: ════════════════════════╬════════════════════════════════════════╬════════════════════════════════════╬════════════════@═══^════════════════════════════════════╬═══╬════════════════════════════════════\n                               ║                                        ║                                    ║                    ║                                    ║   ║\n1:1:a: ════════════════════════╬════════════════════════════════════════╬════════════════════════════════════╬════════════════════╬════════════════════════════════════@═══^════════════════════════════════════\n                               ║                                        ║                                    ║                    ║                                        ║\n1:b: ══════════════════════════╬════════════════════════════════════════╬════════════════════════════════════@════════════════════^════════════════════════════════════════^════════════════════════════════════\n                               ║                                        ║                                                         ║                                        ║\nc: ════════════════════════════^════════════════════════════════════════^═════════════════════════════════════════════════════════^════════════════════════════════════════^════════════════════════════════════\n                               ║                                        ║                                                         ║                                        ║\nd: ════════════════════════════^════════════════════════════════════════^═════════════════════════════════════════════════════════^════════════════════════════════════════^════════════════════════════════════\n", use_unicode_characters=True)