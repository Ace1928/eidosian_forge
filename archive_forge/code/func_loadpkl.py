import sys
import pickle
import errno
import subprocess as sp
import gzip
import hashlib
import locale
from hashlib import md5
import os
import os.path as op
import re
import shutil
import contextlib
import posixpath
from pathlib import Path
import simplejson as json
from time import sleep, time
from .. import logging, config, __version__ as version
from .misc import is_container
def loadpkl(infile):
    """Load a zipped or plain cPickled file."""
    infile = Path(infile)
    fmlogger.debug('Loading pkl: %s', infile)
    pklopen = gzip.open if infile.suffix == '.pklz' else open
    t = time()
    timeout = float(config.get('execution', 'job_finished_timeout'))
    timed_out = True
    while time() - t < timeout:
        if infile.exists():
            timed_out = False
            break
        fmlogger.debug("'{}' missing; waiting 2s".format(infile))
        sleep(2)
    if timed_out:
        error_message = 'Result file {0} expected, but does not exist after ({1}) seconds.'.format(infile, timeout)
        raise IOError(error_message)
    with pklopen(str(infile), 'rb') as pkl_file:
        pkl_contents = pkl_file.read()
    pkl_metadata = None
    idx = pkl_contents.find(b'\n')
    if idx >= 0:
        try:
            pkl_metadata = json.loads(pkl_contents[:idx])
        except (UnicodeDecodeError, json.JSONDecodeError):
            pass
        else:
            pkl_contents = pkl_contents[idx + 1:]
    unpkl = None
    try:
        with indirectory(infile.parent):
            unpkl = pickle.loads(pkl_contents)
    except UnicodeDecodeError:
        with indirectory(infile.parent):
            unpkl = pickle.loads(pkl_contents, fix_imports=True, encoding='utf-8')
        fmlogger.info('Successfully loaded pkl in compatibility mode.')
    except Exception as e:
        if pkl_metadata and 'version' in pkl_metadata:
            if pkl_metadata['version'] != version:
                fmlogger.error('Attempted to open a results file generated by Nipype version %s, with an incompatible Nipype version (%s)', pkl_metadata['version'], version)
                raise e
        fmlogger.warning('No metadata was found in the pkl file. Make sure you are currently using the same Nipype version from the generated pkl.')
        raise e
    if unpkl is None:
        raise ValueError('Loading %s resulted in None.' % infile)
    return unpkl