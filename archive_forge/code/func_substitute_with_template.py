import contextlib
import functools
import hashlib
import os
import re
import sys
import textwrap
from argparse import Namespace
from dataclasses import fields, is_dataclass
from enum import auto, Enum
from typing import (
from typing_extensions import Self
from torchgen.code_template import CodeTemplate
def substitute_with_template(self, template_fn: str, env_callable: Callable[[], Union[str, Dict[str, Any]]]) -> str:
    template_path = os.path.join(self.template_dir, template_fn)
    env = env_callable()
    if isinstance(env, dict):
        if 'generated_comment' not in env:
            comment = '@' + 'generated by torchgen/gen.py'
            comment += f' from {os.path.basename(template_path)}'
            env['generated_comment'] = comment
        template = _read_template(template_path)
        return template.substitute(env)
    elif isinstance(env, str):
        return env
    else:
        assert_never(env)