import http.client as http
from oslo_serialization import jsonutils
import requests
from glance.tests.functional.v2 import metadef_base
def test_properties_lifecycle(self):
    path = self._url('/v2/metadefs/namespaces/MyNamespace')
    response = requests.get(path, headers=self._headers())
    self.assertEqual(http.NOT_FOUND, response.status_code)
    path = self._url('/v2/metadefs/namespaces')
    headers = self._headers({'content-type': 'application/json'})
    namespace_name = 'MyNamespace'
    resource_type_name = 'MyResourceType'
    resource_type_prefix = 'MyPrefix'
    data = jsonutils.dumps({'namespace': namespace_name, 'display_name': 'My User Friendly Namespace', 'description': 'My description', 'visibility': 'public', 'protected': False, 'owner': 'The Test Owner', 'resource_type_associations': [{'name': resource_type_name, 'prefix': resource_type_prefix}]})
    response = requests.post(path, headers=headers, data=data)
    self.assertEqual(http.CREATED, response.status_code)
    path = self._url('/v2/metadefs/namespaces/MyNamespace/properties/property1')
    response = requests.get(path, headers=self._headers())
    self.assertEqual(http.NOT_FOUND, response.status_code)
    path = self._url('/v2/metadefs/namespaces/MyNamespace/properties')
    headers = self._headers({'content-type': 'application/json'})
    property_name = 'property1'
    data = jsonutils.dumps({'name': property_name, 'type': 'integer', 'title': 'property1', 'description': 'property1 description', 'default': 100, 'minimum': 100, 'maximum': 30000369, 'readonly': False})
    response = requests.post(path, headers=headers, data=data)
    self.assertEqual(http.CREATED, response.status_code)
    response = requests.post(path, headers=headers, data=data)
    self.assertEqual(http.CONFLICT, response.status_code)
    path = self._url('/v2/metadefs/namespaces/%s/properties/%s' % (namespace_name, property_name))
    response = requests.get(path, headers=self._headers())
    self.assertEqual(http.OK, response.status_code)
    property_object = jsonutils.loads(response.text)
    self.assertEqual('integer', property_object['type'])
    self.assertEqual('property1', property_object['title'])
    self.assertEqual('property1 description', property_object['description'])
    self.assertEqual('100', property_object['default'])
    self.assertEqual(100, property_object['minimum'])
    self.assertEqual(30000369, property_object['maximum'])
    path = self._url('/v2/metadefs/namespaces/%s/properties/%s%s' % (namespace_name, property_name, '='.join(['?resource_type', resource_type_name])))
    response = requests.get(path, headers=self._headers())
    self.assertEqual(http.NOT_FOUND, response.status_code)
    property_name_with_prefix = ''.join([resource_type_prefix, property_name])
    path = self._url('/v2/metadefs/namespaces/%s/properties/%s%s' % (namespace_name, property_name_with_prefix, '='.join(['?resource_type', resource_type_name])))
    response = requests.get(path, headers=self._headers())
    self.assertEqual(http.OK, response.status_code)
    property_object = jsonutils.loads(response.text)
    self.assertEqual('integer', property_object['type'])
    self.assertEqual('property1', property_object['title'])
    self.assertEqual('property1 description', property_object['description'])
    self.assertEqual('100', property_object['default'])
    self.assertEqual(100, property_object['minimum'])
    self.assertEqual(30000369, property_object['maximum'])
    self.assertFalse(property_object['readonly'])
    property_object = jsonutils.loads(response.text)
    checked_keys = set(['name', 'type', 'title', 'description', 'default', 'minimum', 'maximum', 'readonly'])
    self.assertEqual(set(property_object.keys()), checked_keys)
    expected_metadata_property = {'type': 'integer', 'title': 'property1', 'description': 'property1 description', 'default': '100', 'minimum': 100, 'maximum': 30000369, 'readonly': False}
    for key, value in expected_metadata_property.items():
        self.assertEqual(property_object[key], value, key)
    path = self._url('/v2/metadefs/namespaces/%s/properties/%s' % (namespace_name, property_name))
    media_type = 'application/json'
    headers = self._headers({'content-type': media_type})
    property_name = 'property1-UPDATED'
    data = jsonutils.dumps({'name': property_name, 'type': 'string', 'title': 'string property', 'description': 'desc-UPDATED', 'operators': ['<or>'], 'default': 'value-UPDATED', 'minLength': 5, 'maxLength': 10, 'readonly': True})
    response = requests.put(path, headers=headers, data=data)
    self.assertEqual(http.OK, response.status_code, response.text)
    property_object = jsonutils.loads(response.text)
    self.assertEqual('string', property_object['type'])
    self.assertEqual('desc-UPDATED', property_object['description'])
    self.assertEqual('value-UPDATED', property_object['default'])
    self.assertEqual(['<or>'], property_object['operators'])
    self.assertEqual(5, property_object['minLength'])
    self.assertEqual(10, property_object['maxLength'])
    self.assertTrue(property_object['readonly'])
    path = self._url('/v2/metadefs/namespaces/%s/properties/%s' % (namespace_name, property_name))
    response = requests.get(path, headers=self._headers())
    self.assertEqual('string', property_object['type'])
    self.assertEqual('desc-UPDATED', property_object['description'])
    self.assertEqual('value-UPDATED', property_object['default'])
    self.assertEqual(['<or>'], property_object['operators'])
    self.assertEqual(5, property_object['minLength'])
    self.assertEqual(10, property_object['maxLength'])
    path = self._url('/v2/metadefs/namespaces/%s/properties/%s' % (namespace_name, property_name))
    response = requests.delete(path, headers=self._headers())
    self.assertEqual(http.NO_CONTENT, response.status_code)
    path = self._url('/v2/metadefs/namespaces/%s/properties/%s' % (namespace_name, property_name))
    response = requests.get(path, headers=self._headers())
    self.assertEqual(http.NOT_FOUND, response.status_code)