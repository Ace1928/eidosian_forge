from __future__ import annotations
import collections
import fnmatch
import os
import re
import warnings
from collections import defaultdict
from typing import TYPE_CHECKING, Any
import numpy as np
from monty.io import zopen
from monty.json import MSONable
from pymatgen.core.structure import Structure
from pymatgen.electronic_structure.bandstructure import LobsterBandStructureSymmLine
from pymatgen.electronic_structure.core import Orbital, Spin
from pymatgen.electronic_structure.dos import Dos, LobsterCompleteDos
from pymatgen.io.vasp.inputs import Kpoints
from pymatgen.io.vasp.outputs import Vasprun, VolumetricData
from pymatgen.util.due import Doi, due
class Charge(MSONable):
    """
    Class to read CHARGE files generated by LOBSTER.

    Attributes:
        atomlist (list[str]): List of atoms in CHARGE.lobster.
        types (list[str]): List of types of atoms in CHARGE.lobster.
        mulliken (list[float]): List of Mulliken charges of atoms in CHARGE.lobster.
        loewdin (list[float]): List of Loewdin charges of atoms in CHARGE.Loewdin.
        num_atoms (int): Number of atoms in CHARGE.lobster.
    """

    def __init__(self, filename: str='CHARGE.lobster', num_atoms: int | None=None, atomlist: list[str] | None=None, types: list[str] | None=None, mulliken: list[float] | None=None, loewdin: list[float] | None=None):
        """
        Args:
            filename: filename for the CHARGE file, typically "CHARGE.lobster".
            num_atoms: number of atoms in the structure
            atomlist: list of atoms in the structure
            types: list of unique species in the structure
            mulliken: list of Mulliken charges
            loewdin: list of Loewdin charges
        """
        self._filename = filename
        self.num_atoms = num_atoms
        self.types = [] if types is None else types
        self.atomlist = [] if atomlist is None else atomlist
        self.mulliken = [] if mulliken is None else mulliken
        self.loewdin = [] if loewdin is None else loewdin
        if self.num_atoms is None:
            with zopen(filename, mode='rt') as file:
                data = file.read().split('\n')[3:-3]
            if len(data) == 0:
                raise OSError('CHARGES file contains no data.')
            self.num_atoms = len(data)
            for atom in range(self.num_atoms):
                line = data[atom].split()
                self.atomlist += [line[1] + line[0]]
                self.types += [line[1]]
                self.mulliken += [float(line[2])]
                self.loewdin += [float(line[3])]

    def get_structure_with_charges(self, structure_filename):
        """
        Get a Structure with Mulliken and Loewdin charges as site properties

        Args:
            structure_filename: filename of POSCAR

        Returns:
            Structure Object with Mulliken and Loewdin charges as site properties.
        """
        struct = Structure.from_file(structure_filename)
        mulliken = self.mulliken
        loewdin = self.loewdin
        site_properties = {'Mulliken Charges': mulliken, 'Loewdin Charges': loewdin}
        return struct.copy(site_properties=site_properties)

    @property
    def Mulliken(self):
        warnings.warn('`Mulliken` attribute is deprecated. Use `mulliken` instead.', DeprecationWarning, stacklevel=2)
        return self.mulliken

    @property
    def Loewdin(self):
        warnings.warn('`Loewdin` attribute is deprecated. Use `loewdin` instead.', DeprecationWarning, stacklevel=2)
        return self.loewdin