import pandas as pd
import sqlite3
import math
import numpy as np
from typing import List, Dict, Any

# Constants
# The path to the database file
DB_PATH = "stock_data.db"

stock_data_frame: pd.DataFrame = pd.DataFrame(
    columns=[
        "date",
        "open",
        "high",
        "low",
        "close",
        "volume",
        "dividends",
        "stock_splits",
        "adjusted_close",
        "adjusted_volume",
        "moving_average_50",
        "moving_average_200",
        "exponential_moving_average_50",
        "exponential_moving_average_200",
        "rsi_14",
        "macd_12_26_9",
        "macd_signal_12_26_9",
        "macd_histogram_12_26_9",
        "bollinger_bands_20_2",
        "bollinger_band_upper_20_2",
        "bollinger_band_lower_20_2",
        "stochastic_oscillator_14_3_3",
        "stochastic_oscillator_signal_14_3_3",
        "average_true_range_14",
        "on_balance_volume",
        "chaikin_money_flow_20",
        "price_volume_trend",
        "negative_volume_index",
        "accumulation_distribution_line",
        "commodity_channel_index_20",
        "directional_movement_index_14",
        "minus_directional_indicator_14",
        "plus_directional_indicator_14",
        "average_directional_index_14",
        "parabolic_sar_0_02_0_2",
        "keltner_channels_20_2",
        "keltner_channel_upper_20_2",
        "keltner_channel_lower_20_2",
        "ultimate_oscillator_7_14_28",
        "williams_percent_range_14",
        "trix_30_9",
        "mass_index_9_25",
        "vortex_indicator_positive_14",
        "vortex_indicator_negative_14",
        "know_sure_thing_oscillator_10_3",
        "true_strength_index_25_13",
        "ichimoku_cloud_9_26_52_26",
        "ichimoku_cloud_conversion_line_9_26_52_26",
        "ichimoku_cloud_base_line_9_26_52_26",
        "ichimoku_cloud_leading_span_a_9_26_52_26",
        "ichimoku_cloud_leading_span_b_9_26_52_26",
        "ichimoku_cloud_lagging_span_9_26_52_26",
        "aroon_up_25",
        "aroon_down_25",
        "aroon_oscillator_25",
        "chandelier_exit_long_22_3",
        "chandelier_exit_short_22_3",
        "qstick_10",
        "twiggs_money_flow_21",
        "chande_momentum_oscillator_14",
        "choppiness_index_14",
        "coppock_curve_11_14_10",
        "detrended_price_oscillator_20",
        "ease_of_movement_14_100000000",
        "force_index_13",
        "hull_moving_average_9",
        "kst_oscillator_10_15_20_30_10_10_10_15",
        "mesa_sine_wave_20_25",
        "schaff_trend_cycle_23_50_10",
        "center_of_gravity_oscillator_10",
        "donchian_channel_20",
        "donchian_channel_upper_20",
        "donchian_channel_lower_20",
        "donchian_channel_middle_20",
        "super_trend_10_3",
        "ema_crossover_50_200",
        "sma_crossover_50_200",
        "price_relative_50_200",
        "price_relative_20_50",
        "price_relative_20_200",
        "volume_relative_50",
        "volume_relative_200",
        "volume_obv_divergence",
        "on_balance_volume_ema_50",
        "chaikin_oscillator_3_10",
        "chaikin_volatility_10_10",
        "volatility_atr_based_14",
        "volatility_std_dev_based_20",
        "volatility_rvi_14",
        "volatility_rvi_std_dev_20",
        "trend_adx_14",
        "trend_adx_pos_di_14",
        "trend_adx_neg_di_14",
        "trend_cci_14",
        "trend_macd_12_26_9",
        "trend_macd_signal_12_26_9",
        "trend_macd_diff_12_26_9",
        "trend_ema_fast_12",
        "trend_ema_slow_26",
        "trend_ichimoku_a_9_26_52",
        "trend_ichimoku_b_9_26_52",
        "trend_ichimoku_base_line_9_26_52",
        "trend_ichimoku_conversion_line_9_26_52",
        "trend_kst_10_15_20_30",
        "trend_kst_sig_10_15_20_30",
        "trend_kst_diff_10_15_20_30",
        "trend_psar_0_02_0_2",
        "trend_psar_up_indicator",
        "trend_psar_down_indicator",
        "trend_stc_10_12_26_9",
        "trend_trix_30_9",
        "trend_vortex_ind_pos_14",
        "trend_vortex_ind_neg_14",
        "trend_vortex_ind_diff_14",
        "momentum_rsi_14",
        "momentum_mfi_14",
        "momentum_tsi_25_13",
        "momentum_uo_7_14_28",
        "momentum_stoch_rsi_14",
        "momentum_stoch_rsi_k_14",
        "momentum_stoch_rsi_d_14",
        "momentum_wr_14",
        "momentum_ao",
        "momentum_kama_10_2_30",
        "momentum_ppo_12_26_9",
        "momentum_ppo_signal_12_26_9",
        "momentum_ppo_hist_12_26_9",
        "momentum_pvo_12_26_9",
        "momentum_pvo_signal_12_26_9",
        "momentum_pvo_hist_12_26_9",
        "momentum_roc_10",
        "momentum_roc_100",
        "momentum_roc_100_sma_10",
        "volume_adi",
        "volume_obv",
        "volume_cmf_20",
        "volume_fi_13",
        "volume_em_14_100000000",
        "volume_sma_em_14_100000000",
        "volume_vpt",
        "volume_nvi",
        "volume_vwap",
        "volatility_bbands_20_2",
        "volatility_bbands_upper_20_2",
        "volatility_bbands_lower_20_2",
        "volatility_bbands_middle_20_2",
        "volatility_kc_20_2",
        "volatility_kc_upper_20_2",
        "volatility_kc_lower_20_2",
        "volatility_kc_middle_20_2",
        "volatility_dch_20",
        "volatility_dch_upper_20",
        "volatility_dch_lower_20",
        "volatility_dch_middle_20",
        "volatility_atr_14",
        "volatility_true_range_14",
        "volatility_natr_14",
        "cycle_ht_dcperiod",
        "cycle_ht_dcphase",
        "cycle_ht_phasor_inphase",
        "cycle_ht_phasor_quadrature",
        "cycle_ht_sine_sine",
        "cycle_ht_sine_leadsine",
        "cycle_ht_trendmode",
        "cycle_ht_trendline",
        "pattern_recognition_cdl2crows",
        "pattern_recognition_cdl3blackcrows",
        "pattern_recognition_cdl3inside",
        "pattern_recognition_cdl3linestrike",
        "pattern_recognition_cdl3outside",
        "pattern_recognition_cdl3starsinsouth",
        "pattern_recognition_cdl3whitesoldiers",
        "pattern_recognition_cdlabandonedbaby",
        "pattern_recognition_cdladvanceblock",
        "pattern_recognition_cdlbelthold",
        "pattern_recognition_cdlbreakaway",
        "pattern_recognition_cdlclosingmarubozu",
        "pattern_recognition_cdlconcealbabyswall",
        "pattern_recognition_cdlcounterattack",
        "pattern_recognition_cdldarkcloudcover",
        "pattern_recognition_cdldoji",
        "pattern_recognition_cdldojistar",
        "pattern_recognition_cdldragonflydoji",
        "pattern_recognition_cdlengulfing",
        "pattern_recognition_cdleveningdojistar",
        "pattern_recognition_cdleveningstar",
        "pattern_recognition_cdlgapsidesidewhite",
        "pattern_recognition_cdlgravestonedoji",
        "pattern_recognition_cdlhammer",
        "pattern_recognition_cdlhangingman",
        "pattern_recognition_cdlharami",
        "pattern_recognition_cdlharamicross",
        "pattern_recognition_cdlhighwave",
        "pattern_recognition_cdlhikkake",
        "pattern_recognition_cdlhikkakemod",
        "pattern_recognition_cdlhomingpigeon",
        "pattern_recognition_cdlidentical3crows",
        "pattern_recognition_cdlinneck",
        "pattern_recognition_cdlinvertedhammer",
        "pattern_recognition_cdlkicking",
        "pattern_recognition_cdlkickingbylength",
        "pattern_recognition_cdlladderbottom",
        "pattern_recognition_cdllongleggeddoji",
        "pattern_recognition_cdllongline",
        "pattern_recognition_cdlmarubozu",
        "pattern_recognition_cdlmatchinglow",
        "pattern_recognition_cdlmathold",
        "pattern_recognition_cdlmorningdojistar",
        "pattern_recognition_cdlmorningstar",
        "pattern_recognition_cdlonneck",
        "pattern_recognition_cdlpiercing",
        "pattern_recognition_cdlrickshawman",
        "pattern_recognition_cdlrisefall3methods",
        "pattern_recognition_cdlseparatinglines",
        "pattern_recognition_cdlshootingstar",
        "pattern_recognition_cdlshortline",
        "pattern_recognition_cdlspinningtop",
        "pattern_recognition_cdlstalledpattern",
        "pattern_recognition_cdlsticksandwich",
        "pattern_recognition_cdltakuri",
        "pattern_recognition_cdltasukigap",
        "pattern_recognition_cdlthrusting",
        "pattern_recognition_cdltristar",
        "pattern_recognition_cdlunique3river",
        "pattern_recognition_cdlupsidegap2crows",
        "pattern_recognition_cdlxsidegap3methods",
        "statistic_beta",
        "statistic_correlation_coefficient",
        "statistic_linear_regression_angle",
        "statistic_linear_regression_intercept",
        "statistic_linear_regression_slope",
        "statistic_standard_deviation",
        "statistic_standard_error",
        "statistic_time_series_forecast",
        "statistic_variance",
        "math_transform_acos",
        "math_transform_asin",
        "math_transform_atan",
        "math_transform_ceil",
        "math_transform_cos",
        "math_transform_cosh",
        "math_transform_exp",
        "math_transform_floor",
        "math_transform_ln",
        "math_transform_log10",
        "math_transform_sin",
        "math_transform_sinh",
        "math_transform_sqrt",
        "math_transform_tan",
        "math_transform_tanh",
        "math_transform_add",
        "math_transform_div",
        "math_transform_max",
        "math_transform_maxindex",
        "math_transform_min",
        "math_transform_minindex",
        "math_transform_minmax",
        "math_transform_minmaxindex",
        "math_transform_mult",
        "math_transform_sub",
        "math_transform_sum",
        "math_operator_abs",
        "math_operator_acos",
        "math_operator_add",
        "math_operator_asin",
        "math_operator_atan",
        "math_operator_ceil",
        "math_operator_cos",
        "math_operator_cosh",
        "math_operator_div",
        "math_operator_exp",
        "math_operator_floor",
        "math_operator_ln",
        "math_operator_log10",
        "math_operator_max",
        "math_operator_maxindex",
        "math_operator_min",
        "math_operator_minindex",
        "math_operator_minmax",
        "math_operator_minmaxindex",
        "math_operator_mult",
        "math_operator_round",
        "math_operator_sin",
        "math_operator_sinh",
        "math_operator_sqrt",
        "math_operator_sub",
        "math_operator_sum",
        "math_operator_tan",
        "math_operator_tanh",
        "math_operator_todeg",
        "math_operator_torad",
        "math_operator_trunc",
    ]
)


class StockDatabase:
    def __init__(self, db_path: str):
        """Initialize the database connection."""
        self.conn = sqlite3.connect(db_path)
        self.cursor = self.conn.cursor()
        self.initialize_database()

    def execute_query(self, query: str, params: tuple = ()):
        """Execute a single SQL query."""
        self.cursor.execute(query, params)
        self.conn.commit()

    def initialize_database(self):
        """Create tables if they do not exist."""
        tables = {
            "Market_Data": """
                CREATE TABLE IF NOT EXISTS Market_Data (
                    ticker TEXT,
                    date TEXT,
                    open REAL,
                    high REAL,
                    low REAL,
                    close REAL,
                    volume INTEGER
                )
            """,
            "Adjusted_Market_Data": """
                CREATE TABLE IF NOT EXISTS Adjusted_Market_Data (
                    ticker TEXT,
                    adjusted_close REAL,
                    adjusted_volume INTEGER
                )
            """,
            # Add similar queries for all other tables.
            # Due to the vast number of tables, only a few are showcased here.
            # Each table creation string follows the pattern established.
        }
        for table, query in tables.items():
            self.execute_query(query)

    def update_table(self, table: str, data: Dict[str, Any]):
        """Update a specific table with a dictionary of data."""
        columns = ", ".join(data.keys())
        placeholders = ", ".join(["?" for _ in data])
        query = f"INSERT INTO {table} ({columns}) VALUES ({placeholders})"
        self.execute_query(query, tuple(data.values()))

    def fetch_data(self, query: str, params: tuple = ()) -> List[Dict[str, Any]]:
        """Fetch data from the database."""
        self.cursor.execute(query, params)
        columns = [column[0] for column in self.cursor.description]
        return [dict(zip(columns, row)) for row in self.cursor.fetchall()]


# Example usage
db = StockDatabase(DB_PATH)
