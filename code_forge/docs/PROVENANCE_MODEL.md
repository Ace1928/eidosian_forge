# Code Forge Provenance Model

## Purpose
Provide deterministic links between Code Forge artifacts, Knowledge Forge nodes, GraphRAG exports, and downstream analysis.

## Artifacts
- `provenance_links.json`
- `provenance_registry.json`

Generated by:
- `run_archive_digester(...)` at `output_dir/provenance_links.json`
- `run_roundtrip_pipeline(...)` at `workspace_dir/provenance_links.json`
- `run_archive_digester(...)` at `output_dir/provenance_registry.json`
- `run_roundtrip_pipeline(...)` at `workspace_dir/provenance_registry.json`

## Schema (v1)
Top-level fields:
- `generated_at`: ISO timestamp
- `stage`: `archive_digester|roundtrip`
- `root_path`: processed source root
- `source_run_id`: ingestion run id that produced the stage
- `integration_policy`: `run|effective_run|global`
- `integration_run_id`: run scope used for Knowledge/GraphRAG exports (nullable for `global`)
- `provenance_id`: deterministic hash over root/run/policy and artifact checksums
- `artifacts`: list of records:
  - `artifact_kind`
  - `path`
  - `exists`
  - `sha256`
- `knowledge_links`:
  - `count`
  - `links` (`unit_id`, `node_id`, `status`)
- `memory_links`:
  - `count`
  - `links` (`unit_id`, `memory_id`, `status`)
- `graphrag_links`:
  - `count`
  - `documents` (`unit_id`, `qualified_name`, `language`, `unit_type`, `source_file_path`, `document_path`)
  - `manifest_path`
- `extra`: stage-specific metadata

## Registry Schema (v1)
`provenance_registry.json` enriches link data into a unified, query-friendly index.

Top-level fields:
- `schema_version`
- `generated_at`
- `registry_id`
- `provenance_id`
- `stage`
- `root_path`
- `integration_policy`
- `integration_run_id`
- `source_run_id`
- `artifact_count`
- `artifacts`
- `links`:
  - `knowledge_count`
  - `memory_count`
  - `graphrag_count`
  - `unit_link_count`
  - `unit_links`:
    - `unit_id`
    - `knowledge_node_id`
    - `knowledge_status`
    - `memory_id`
    - `memory_status`
    - `graphrag_document_path`
    - `qualified_name`
    - `language`
    - `unit_type`
    - `source_file_path`
- `drift`:
  - `warnings`
  - `warning_count`
  - `max_abs_delta`
  - `top_changes`
- `benchmark` (optional):
  - `path`
  - `generated_at`
  - `ingestion_units_per_s_mean`
  - `search_p95_ms`
  - `graph_build_ms`
  - `gate_pass`
  - `gate_violations`
- `stage_summary_path`
- `stage_summary`

## Query Patterns
Example queries supported by this schema:
1. Which extracted modules were synced to knowledge and where?
2. Which extracted modules were synced to memory and which memory IDs were created?
3. Which GraphRAG documents were generated from a given ingestion run?
4. Which stage artifacts contributed to a benchmark or drift report?
5. Show all modules extracted from archive and their benchmark envelope.
6. List knowledge/memory facts derived during drift detection stages.
7. Locate all unit_ids with missing memory or knowledge linkage.

## MCP Access
Use `code_forge_provenance` via `eidos_mcp` to list/query available provenance records.

Parameters:
- `root_path`: optional absolute/relative root filter.
- `stage`: optional stage filter (`archive_digester` or `roundtrip`).
- `limit`: maximum records.
- `unit_id`: optional unit-level filter.
- `include_unit_links`: include joined unit link rows.
- `include_benchmark`: include benchmark summary if present.
